<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>libgimpprint API Reference: src/main/curve.c Source File</title>
<link href="doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.6 -->
<div class="qindex"><a class="qindex" href="index.html">Main&nbsp;Page</a> | <a class="qindex" href="modules.html">Modules</a> | <a class="qindex" href="classes.html">Alphabetical&nbsp;List</a> | <a class="qindex" href="annotated.html">Data&nbsp;Structures</a> | <a class="qindex" href="files.html">File&nbsp;List</a> | <a class="qindex" href="functions.html">Data&nbsp;Fields</a> | <a class="qindex" href="globals.html">Globals</a> | <a class="qindex" href="pages.html">Related&nbsp;Pages</a></div>
<h1>src/main/curve.c</h1><a href="curve_8c.html">Go to the documentation of this file.</a><div class="fragment"><pre>00001 <span class="comment">/*</span>
00002 <span class="comment"> * "$Id: curve_8c-source.html,v 1.1.1.2 2004/12/22 23:48:57 jlovell Exp $"</span>
00003 <span class="comment"> *</span>
00004 <span class="comment"> *   Print plug-in driver utility functions for the GIMP.</span>
00005 <span class="comment"> *</span>
00006 <span class="comment"> *   Copyright 1997-2000 Michael Sweet (mike@easysw.com) and</span>
00007 <span class="comment"> *      Robert Krawitz (rlk@alum.mit.edu)</span>
00008 <span class="comment"> *</span>
00009 <span class="comment"> *   This program is free software; you can redistribute it and/or modify it</span>
00010 <span class="comment"> *   under the terms of the GNU General Public License as published by the Free</span>
00011 <span class="comment"> *   Software Foundation; either version 2 of the License, or (at your option)</span>
00012 <span class="comment"> *   any later version.</span>
00013 <span class="comment"> *</span>
00014 <span class="comment"> *   This program is distributed in the hope that it will be useful, but</span>
00015 <span class="comment"> *   WITHOUT ANY WARRANTY; without even the implied warranty of MERCHANTABILITY</span>
00016 <span class="comment"> *   or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License</span>
00017 <span class="comment"> *   for more details.</span>
00018 <span class="comment"> *</span>
00019 <span class="comment"> *   You should have received a copy of the GNU General Public License</span>
00020 <span class="comment"> *   along with this program; if not, write to the Free Software</span>
00021 <span class="comment"> *   Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA 02111-1307, USA.</span>
00022 <span class="comment"> */</span>
00023 
00024 <span class="preprocessor">#ifdef HAVE_CONFIG_H</span>
00025 <span class="preprocessor"></span><span class="preprocessor">#include &lt;config.h&gt;</span>
00026 <span class="preprocessor">#endif</span>
00027 <span class="preprocessor"></span><span class="preprocessor">#include &lt;<a class="code" href="gimp-print_8h.html">gimp-print/gimp-print.h</a>&gt;</span>
00028 <span class="preprocessor">#include "<a class="code" href="gimp-print-internal_8h.html">gimp-print-internal.h</a>"</span>
00029 <span class="preprocessor">#include &lt;<a class="code" href="gimp-print-intl-internal_8h.html">gimp-print/gimp-print-intl-internal.h</a>&gt;</span>
00030 <span class="preprocessor">#include &lt;math.h&gt;</span>
00031 <span class="preprocessor">#ifdef sun</span>
00032 <span class="preprocessor"></span><span class="preprocessor">#include &lt;ieeefp.h&gt;</span>
00033 <span class="preprocessor">#endif</span>
00034 <span class="preprocessor"></span><span class="preprocessor">#include &lt;string.h&gt;</span>
00035 <span class="preprocessor">#include &lt;stdlib.h&gt;</span>
00036 <span class="preprocessor">#include &lt;limits.h&gt;</span>
00037 <span class="preprocessor">#include &lt;unistd.h&gt;</span>
00038 <span class="preprocessor">#include &lt;sys/types.h&gt;</span>
00039 <span class="preprocessor">#include &lt;sys/stat.h&gt;</span>
00040 
00041 <span class="preprocessor">#ifdef __GNUC__</span>
00042 <span class="preprocessor"></span><span class="preprocessor">#define inline __inline__</span>
00043 <span class="preprocessor"></span><span class="preprocessor">#endif</span>
00044 <span class="preprocessor"></span>
00045 <span class="preprocessor">#undef inline</span>
<a name="l00046"></a><a class="code" href="curve_8c.html#a0">00046</a> <span class="preprocessor"></span><span class="preprocessor">#define inline</span>
00047 <span class="preprocessor"></span>
<a name="l00048"></a><a class="code" href="curve_8c.html#a3">00048</a> <span class="keyword">static</span> <span class="keyword">const</span> <span class="keywordtype">int</span> <a class="code" href="curve_8c.html#a3">curve_point_limit</a> = 1048576;
00049 
<a name="l00050"></a><a class="code" href="structstp__curve.html">00050</a> <span class="keyword">struct </span><a class="code" href="structstp__curve.html">stp_curve</a>
00051 {
<a name="l00052"></a><a class="code" href="structstp__curve.html#o0">00052</a>   <a class="code" href="group__curve.html#ga47">stp_curve_type_t</a> <a class="code" href="structstp__curve.html#o0">curve_type</a>;
<a name="l00053"></a><a class="code" href="structstp__curve.html#o1">00053</a>   <a class="code" href="group__curve.html#ga48">stp_curve_wrap_mode_t</a> <a class="code" href="structstp__curve.html#o1">wrap_mode</a>;
<a name="l00054"></a><a class="code" href="structstp__curve.html#o2">00054</a>   <span class="keywordtype">int</span> <a class="code" href="structstp__curve.html#o2">piecewise</a>;
<a name="l00055"></a><a class="code" href="structstp__curve.html#o3">00055</a>   <span class="keywordtype">int</span> <a class="code" href="structstp__curve.html#o3">recompute_interval</a>;       <span class="comment">/* Do we need to recompute the deltas? */</span>
<a name="l00056"></a><a class="code" href="structstp__curve.html#o4">00056</a>   <span class="keywordtype">double</span> <a class="code" href="structstp__curve.html#o4">gamma</a>;                 <span class="comment">/* 0.0 means that the curve is not a gamma */</span>
<a name="l00057"></a><a class="code" href="structstp__curve.html#o5">00057</a>   <a class="code" href="structstp__sequence.html">stp_sequence_t</a> *<a class="code" href="structstp__curve.html#o5">seq</a>;          <span class="comment">/* Sequence (contains the curve data) */</span>
<a name="l00058"></a><a class="code" href="structstp__curve.html#o6">00058</a>   <span class="keywordtype">double</span> *<a class="code" href="structstp__curve.html#o6">interval</a>;             <span class="comment">/* We allocate an extra slot for the</span>
00059 <span class="comment">                                   wrap-around value. */</span>
00060 
00061 };
00062 
<a name="l00063"></a><a class="code" href="curve_8c.html#a4">00063</a> <span class="keyword">static</span> <span class="keyword">const</span> <span class="keywordtype">char</span> *<span class="keyword">const</span> <a class="code" href="curve_8c.html#a4">stpi_curve_type_names</a>[] =
00064   {
00065     <span class="stringliteral">"linear"</span>,
00066     <span class="stringliteral">"spline"</span>,
00067   };
00068 
<a name="l00069"></a><a class="code" href="curve_8c.html#a5">00069</a> <span class="keyword">static</span> <span class="keyword">const</span> <span class="keywordtype">int</span> <a class="code" href="curve_8c.html#a5">stpi_curve_type_count</a> =
00070 (<span class="keyword">sizeof</span>(<a class="code" href="curve_8c.html#a4">stpi_curve_type_names</a>) / <span class="keyword">sizeof</span>(<span class="keyword">const</span> <span class="keywordtype">char</span> *));
00071 
<a name="l00072"></a><a class="code" href="curve_8c.html#a6">00072</a> <span class="keyword">static</span> <span class="keyword">const</span> <span class="keywordtype">char</span> *<span class="keyword">const</span> <a class="code" href="curve_8c.html#a6">stpi_wrap_mode_names</a>[] =
00073   {
00074     <span class="stringliteral">"nowrap"</span>,
00075     <span class="stringliteral">"wrap"</span>
00076   };
00077 
<a name="l00078"></a><a class="code" href="curve_8c.html#a7">00078</a> <span class="keyword">static</span> <span class="keyword">const</span> <span class="keywordtype">int</span> <a class="code" href="curve_8c.html#a7">stpi_wrap_mode_count</a> =
00079 (<span class="keyword">sizeof</span>(<a class="code" href="curve_8c.html#a6">stpi_wrap_mode_names</a>) / <span class="keyword">sizeof</span>(<span class="keyword">const</span> <span class="keywordtype">char</span> *));
00080 
00081 <span class="comment">/*</span>
00082 <span class="comment"> * We could do more sanity checks here if we want.</span>
00083 <span class="comment"> */</span>
00084 <span class="keyword">static</span> <span class="keywordtype">void</span>
<a name="l00085"></a><a class="code" href="curve_8c.html#a8">00085</a> <a class="code" href="curve_8c.html#a8">check_curve</a>(<span class="keyword">const</span> <a class="code" href="structstp__curve.html">stp_curve_t</a> *curve)
00086 {
00087   <span class="keywordflow">if</span> (curve == NULL)
00088     {
00089       <a class="code" href="print-util_8c.html#a20">stp_erprintf</a>(<span class="stringliteral">"Null curve! Please report this bug.\n"</span>);
00090       <a class="code" href="group__util.html#ga3">stp_abort</a>();
00091     }
00092   <span class="keywordflow">if</span> (curve-&gt;<a class="code" href="structstp__curve.html#o5">seq</a> == NULL)
00093     {
00094       <a class="code" href="print-util_8c.html#a20">stp_erprintf</a>(<span class="stringliteral">"Bad curve (seq == NULL)! Please report this bug.\n"</span>);
00095       <a class="code" href="group__util.html#ga3">stp_abort</a>();
00096     }
00097 }
00098 
00099 <span class="comment">/*</span>
00100 <span class="comment"> * Get the total number of points in the base sequence class</span>
00101 <span class="comment"> */</span>
00102 <span class="keyword">static</span> size_t
<a name="l00103"></a><a class="code" href="curve_8c.html#a9">00103</a> <a class="code" href="curve_8c.html#a9">get_real_point_count</a>(<span class="keyword">const</span> <a class="code" href="structstp__curve.html">stp_curve_t</a> *curve)
00104 {
00105   <span class="keywordflow">if</span> (curve-&gt;<a class="code" href="structstp__curve.html#o2">piecewise</a>)
00106     <span class="keywordflow">return</span> <a class="code" href="group__sequence.html#ga16">stp_sequence_get_size</a>(curve-&gt;<a class="code" href="structstp__curve.html#o5">seq</a>) / 2;
00107   <span class="keywordflow">else</span>
00108     <span class="keywordflow">return</span> <a class="code" href="group__sequence.html#ga16">stp_sequence_get_size</a>(curve-&gt;<a class="code" href="structstp__curve.html#o5">seq</a>);
00109 }
00110 
00111 <span class="comment">/*</span>
00112 <span class="comment"> * Get the number of points used by the curve (that are visible to the</span>
00113 <span class="comment"> * user).  This is the real point count, but is decreased by 1 if the</span>
00114 <span class="comment"> * curve wraps around.</span>
00115 <span class="comment"> */</span>
00116 <span class="keyword">static</span> size_t
<a name="l00117"></a><a class="code" href="curve_8c.html#a10">00117</a> <a class="code" href="curve_8c.html#a10">get_point_count</a>(<span class="keyword">const</span> <a class="code" href="structstp__curve.html">stp_curve_t</a> *curve)
00118 {
00119   size_t count = <a class="code" href="curve_8c.html#a9">get_real_point_count</a>(curve);
00120   <span class="keywordflow">if</span> (curve-&gt;<a class="code" href="structstp__curve.html#o1">wrap_mode</a> == <a class="code" href="group__curve.html#gga48a4">STP_CURVE_WRAP_AROUND</a>)
00121     count -= 1;
00122 
00123   <span class="keywordflow">return</span> count;
00124 }
00125 
00126 <span class="keyword">static</span> <span class="keywordtype">void</span>
<a name="l00127"></a><a class="code" href="curve_8c.html#a11">00127</a> <a class="code" href="curve_8c.html#a11">invalidate_auxiliary_data</a>(<a class="code" href="structstp__curve.html">stp_curve_t</a> *curve)
00128 {
00129   <a class="code" href="group__util.html#ga52">STP_SAFE_FREE</a>(curve-&gt;<a class="code" href="structstp__curve.html#o6">interval</a>);
00130 }
00131 
00132 <span class="keyword">static</span> <span class="keywordtype">void</span>
<a name="l00133"></a><a class="code" href="curve_8c.html#a12">00133</a> <a class="code" href="curve_8c.html#a12">clear_curve_data</a>(<a class="code" href="structstp__curve.html">stp_curve_t</a> *curve)
00134 {
00135   <span class="keywordflow">if</span> (curve-&gt;<a class="code" href="structstp__curve.html#o5">seq</a>)
00136     <a class="code" href="group__sequence.html#ga15">stp_sequence_set_size</a>(curve-&gt;<a class="code" href="structstp__curve.html#o5">seq</a>, 0);
00137   curve-&gt;<a class="code" href="structstp__curve.html#o3">recompute_interval</a> = 0;
00138   <a class="code" href="curve_8c.html#a11">invalidate_auxiliary_data</a>(curve);
00139 }
00140 
00141 <span class="keyword">static</span> <span class="keywordtype">void</span>
<a name="l00142"></a><a class="code" href="curve_8c.html#a13">00142</a> <a class="code" href="curve_8c.html#a13">compute_linear_deltas</a>(<a class="code" href="structstp__curve.html">stp_curve_t</a> *curve)
00143 {
00144   <span class="keywordtype">int</span> i;
00145   size_t delta_count;
00146   size_t seq_point_count;
00147   <span class="keyword">const</span> <span class="keywordtype">double</span> *data;
00148 
00149   <a class="code" href="group__sequence.html#ga19">stp_sequence_get_data</a>(curve-&gt;<a class="code" href="structstp__curve.html#o5">seq</a>, &amp;seq_point_count, &amp;data);
00150   <span class="keywordflow">if</span> (data == NULL)
00151     <span class="keywordflow">return</span>;
00152 
00153   delta_count = <a class="code" href="curve_8c.html#a9">get_real_point_count</a>(curve);
00154 
00155   <span class="keywordflow">if</span> (delta_count &lt;= 1) <span class="comment">/* No intervals can be computed */</span>
00156     <span class="keywordflow">return</span>;
00157   delta_count--; <span class="comment">/* One less than the real point count.  Note size_t</span>
00158 <span class="comment">                    is unsigned. */</span>
00159 
00160   curve-&gt;<a class="code" href="structstp__curve.html#o6">interval</a> = <a class="code" href="group__util.html#ga28">stp_malloc</a>(<span class="keyword">sizeof</span>(<span class="keywordtype">double</span>) * delta_count);
00161   <span class="keywordflow">for</span> (i = 0; i &lt; delta_count; i++)
00162     {
00163       <span class="keywordflow">if</span> (curve-&gt;<a class="code" href="structstp__curve.html#o2">piecewise</a>)
00164         curve-&gt;<a class="code" href="structstp__curve.html#o6">interval</a>[i] = data[(2 * (i + 1)) + 1] - data[(2 * i) + 1];
00165       <span class="keywordflow">else</span>
00166         curve-&gt;<a class="code" href="structstp__curve.html#o6">interval</a>[i] = data[i + 1] - data[i];
00167     }
00168 }
00169 
00170 <span class="keyword">static</span> <span class="keywordtype">void</span>
<a name="l00171"></a><a class="code" href="curve_8c.html#a14">00171</a> <a class="code" href="curve_8c.html#a14">compute_spline_deltas_piecewise</a>(<a class="code" href="structstp__curve.html">stp_curve_t</a> *curve)
00172 {
00173   <span class="keywordtype">int</span> i;
00174   <span class="keywordtype">int</span> k;
00175   <span class="keywordtype">double</span> *u;
00176   <span class="keywordtype">double</span> *y2;
00177   <span class="keyword">const</span> <span class="keywordtype">double</span> *data = NULL;
00178   <span class="keyword">const</span> <a class="code" href="structstp__curve__point__t.html">stp_curve_point_t</a> *dp;
00179   size_t point_count;
00180   size_t real_point_count;
00181   <span class="keywordtype">double</span> sig;
00182   <span class="keywordtype">double</span> p;
00183 
00184   point_count = <a class="code" href="curve_8c.html#a10">get_point_count</a>(curve);
00185 
00186   <a class="code" href="group__sequence.html#ga19">stp_sequence_get_data</a>(curve-&gt;<a class="code" href="structstp__curve.html#o5">seq</a>, &amp;real_point_count, &amp;data);
00187   dp = (<span class="keyword">const</span> <a class="code" href="structstp__curve__point__t.html">stp_curve_point_t</a> *)data;
00188   real_point_count = real_point_count / 2;
00189 
00190   u = <a class="code" href="group__util.html#ga28">stp_malloc</a>(<span class="keyword">sizeof</span>(<span class="keywordtype">double</span>) * real_point_count);
00191   y2 = <a class="code" href="group__util.html#ga28">stp_malloc</a>(<span class="keyword">sizeof</span>(<span class="keywordtype">double</span>) * real_point_count);
00192 
00193   <span class="keywordflow">if</span> (curve-&gt;<a class="code" href="structstp__curve.html#o1">wrap_mode</a> == <a class="code" href="group__curve.html#gga48a4">STP_CURVE_WRAP_AROUND</a>)
00194     {
00195       <span class="keywordtype">int</span> reps = 3;
00196       <span class="keywordtype">int</span> count = reps * real_point_count;
00197       <span class="keywordtype">double</span> *y2a = <a class="code" href="group__util.html#ga28">stp_malloc</a>(<span class="keyword">sizeof</span>(<span class="keywordtype">double</span>) * count);
00198       <span class="keywordtype">double</span> *ua = <a class="code" href="group__util.html#ga28">stp_malloc</a>(<span class="keyword">sizeof</span>(<span class="keywordtype">double</span>) * count);
00199       y2a[0] = 0.0;
00200       ua[0] = 0.0;
00201       <span class="keywordflow">for</span> (i = 1; i &lt; count - 1; i++)
00202         {
00203           <span class="keywordtype">int</span> im1 = (i - 1) % point_count;
00204           <span class="keywordtype">int</span> ia = i % point_count;
00205           <span class="keywordtype">int</span> ip1 = (i + 1) % point_count;
00206 
00207           sig = (dp[ia].<a class="code" href="structstp__curve__point__t.html#o0">x</a> - dp[im1].x) / (dp[ip1].x - dp[im1].x);
00208           p = sig * y2a[im1] + 2.0;
00209           y2a[i] = (sig - 1.0) / p;
00210 
00211           ua[i] = ((dp[ip1].y - dp[ia].y) / (dp[ip1].x - dp[ia].x)) -
00212             ((dp[ia].y - dp[im1].y) / (dp[ia].x - dp[im1].x));
00213           ua[i] =
00214             (((6.0 * ua[ia]) / (dp[ip1].x - dp[im1].x)) - (sig * ua[im1])) / p;
00215         }
00216       y2a[count - 1] = 0.0;
00217       <span class="keywordflow">for</span> (k = count - 2 ; k &gt;= 0; k--)
00218         y2a[k] = y2a[k] * y2a[k + 1] + ua[k];
00219       memcpy(u, ua + ((reps / 2) * point_count),
00220              <span class="keyword">sizeof</span>(<span class="keywordtype">double</span>) * real_point_count);
00221       memcpy(y2, y2a + ((reps / 2) * point_count),
00222              <span class="keyword">sizeof</span>(<span class="keywordtype">double</span>) * real_point_count);
00223       <a class="code" href="group__util.html#ga31">stp_free</a>(y2a);
00224       <a class="code" href="group__util.html#ga31">stp_free</a>(ua);
00225     }
00226   <span class="keywordflow">else</span>
00227     {
00228       <span class="keywordtype">int</span> count = real_point_count - 1;
00229 
00230       y2[0] = 0;
00231       u[0] = 2 * (dp[1].<a class="code" href="structstp__curve__point__t.html#o1">y</a> - dp[0].y);
00232       <span class="keywordflow">for</span> (i = 1; i &lt; count; i++)
00233         {
00234           <span class="keywordtype">int</span> im1 = (i - 1);
00235           <span class="keywordtype">int</span> ip1 = (i + 1);
00236 
00237           sig = (dp[i].x - dp[im1].x) / (dp[ip1].x - dp[im1].x);
00238           p = sig * y2[im1] + 2.0;
00239           y2[i] = (sig - 1.0) / p;
00240 
00241           u[i] = ((dp[ip1].y - dp[i].y) / (dp[ip1].x - dp[i].x)) -
00242             ((dp[i].y - dp[im1].y) / (dp[i].x - dp[im1].x));
00243           u[i] =
00244             (((6.0 * u[i]) / (dp[ip1].x - dp[im1].x)) - (sig * u[im1])) / p;
00245           <a class="code" href="print-util_8c.html#a24">stp_deprintf</a>(<a class="code" href="group__util.html#ga50">STP_DBG_CURVE</a>,
00246                        <span class="stringliteral">"%d sig %f p %f y2 %f u %f x %f %f %f y %f %f %f\n"</span>,
00247                        i, sig, p, y2[i], u[i],
00248                        dp[im1].x, dp[i].x, dp[ip1].x,
00249                        dp[im1].y, dp[i].y, dp[ip1].y);
00250         }
00251       y2[count] = 0.0;
00252       u[count] = 0.0;
00253       <span class="keywordflow">for</span> (k = real_point_count - 2; k &gt;= 0; k--)
00254         y2[k] = y2[k] * y2[k + 1] + u[k];
00255     }
00256 
00257   curve-&gt;<a class="code" href="structstp__curve.html#o6">interval</a> = y2;
00258   <a class="code" href="group__util.html#ga31">stp_free</a>(u);
00259 }
00260 
00261 <span class="keyword">static</span> <span class="keywordtype">void</span>
<a name="l00262"></a><a class="code" href="curve_8c.html#a15">00262</a> <a class="code" href="curve_8c.html#a15">compute_spline_deltas_dense</a>(<a class="code" href="structstp__curve.html">stp_curve_t</a> *curve)
00263 {
00264   <span class="keywordtype">int</span> i;
00265   <span class="keywordtype">int</span> k;
00266   <span class="keywordtype">double</span> *u;
00267   <span class="keywordtype">double</span> *y2;
00268   <span class="keyword">const</span> <span class="keywordtype">double</span> *y;
00269   size_t point_count;
00270   size_t real_point_count;
00271   <span class="keywordtype">double</span> sig;
00272   <span class="keywordtype">double</span> p;
00273 
00274   point_count = <a class="code" href="curve_8c.html#a10">get_point_count</a>(curve);
00275 
00276   <a class="code" href="group__sequence.html#ga19">stp_sequence_get_data</a>(curve-&gt;<a class="code" href="structstp__curve.html#o5">seq</a>, &amp;real_point_count, &amp;y);
00277   u = <a class="code" href="group__util.html#ga28">stp_malloc</a>(<span class="keyword">sizeof</span>(<span class="keywordtype">double</span>) * real_point_count);
00278   y2 = <a class="code" href="group__util.html#ga28">stp_malloc</a>(<span class="keyword">sizeof</span>(<span class="keywordtype">double</span>) * real_point_count);
00279 
00280   <span class="keywordflow">if</span> (curve-&gt;<a class="code" href="structstp__curve.html#o1">wrap_mode</a> == <a class="code" href="group__curve.html#gga48a4">STP_CURVE_WRAP_AROUND</a>)
00281     {
00282       <span class="keywordtype">int</span> reps = 3;
00283       <span class="keywordtype">int</span> count = reps * real_point_count;
00284       <span class="keywordtype">double</span> *y2a = <a class="code" href="group__util.html#ga28">stp_malloc</a>(<span class="keyword">sizeof</span>(<span class="keywordtype">double</span>) * count);
00285       <span class="keywordtype">double</span> *ua = <a class="code" href="group__util.html#ga28">stp_malloc</a>(<span class="keyword">sizeof</span>(<span class="keywordtype">double</span>) * count);
00286       y2a[0] = 0.0;
00287       ua[0] = 0.0;
00288       <span class="keywordflow">for</span> (i = 1; i &lt; count - 1; i++)
00289         {
00290           <span class="keywordtype">int</span> im1 = (i - 1);
00291           <span class="keywordtype">int</span> ip1 = (i + 1);
00292           <span class="keywordtype">int</span> im1a = im1 % point_count;
00293           <span class="keywordtype">int</span> ia = i % point_count;
00294           <span class="keywordtype">int</span> ip1a = ip1 % point_count;
00295 
00296           sig = (i - im1) / (ip1 - im1);
00297           p = sig * y2a[im1] + 2.0;
00298           y2a[i] = (sig - 1.0) / p;
00299 
00300           ua[i] = y[ip1a] - 2 * y[ia] + y[im1a];
00301           ua[i] = 3.0 * ua[i] - sig * ua[im1] / p;
00302         }
00303       y2a[count - 1] = 0.0;
00304       <span class="keywordflow">for</span> (k = count - 2 ; k &gt;= 0; k--)
00305         y2a[k] = y2a[k] * y2a[k + 1] + ua[k];
00306       memcpy(u, ua + ((reps / 2) * point_count),
00307              <span class="keyword">sizeof</span>(<span class="keywordtype">double</span>) * real_point_count);
00308       memcpy(y2, y2a + ((reps / 2) * point_count),
00309              <span class="keyword">sizeof</span>(<span class="keywordtype">double</span>) * real_point_count);
00310       <a class="code" href="group__util.html#ga31">stp_free</a>(y2a);
00311       <a class="code" href="group__util.html#ga31">stp_free</a>(ua);
00312     }
00313   <span class="keywordflow">else</span>
00314     {
00315       <span class="keywordtype">int</span> count = real_point_count - 1;
00316 
00317       y2[0] = 0;
00318       u[0] = 2 * (y[1] - y[0]);
00319       <span class="keywordflow">for</span> (i = 1; i &lt; count; i++)
00320         {
00321           <span class="keywordtype">int</span> im1 = (i - 1);
00322           <span class="keywordtype">int</span> ip1 = (i + 1);
00323 
00324           sig = (i - im1) / (ip1 - im1);
00325           p = sig * y2[im1] + 2.0;
00326           y2[i] = (sig - 1.0) / p;
00327 
00328           u[i] = y[ip1] - 2 * y[i] + y[im1];
00329           u[i] = 3.0 * u[i] - sig * u[im1] / p;
00330         }
00331 
00332       u[count] = 2 * (y[count] - y[count - 1]);
00333       y2[count] = 0.0;
00334 
00335       u[count] = 0.0;
00336       <span class="keywordflow">for</span> (k = real_point_count - 2; k &gt;= 0; k--)
00337         y2[k] = y2[k] * y2[k + 1] + u[k];
00338     }
00339 
00340   curve-&gt;<a class="code" href="structstp__curve.html#o6">interval</a> = y2;
00341   <a class="code" href="group__util.html#ga31">stp_free</a>(u);
00342 }
00343 
00344 <span class="keyword">static</span> <span class="keywordtype">void</span>
<a name="l00345"></a><a class="code" href="curve_8c.html#a16">00345</a> <a class="code" href="curve_8c.html#a16">compute_spline_deltas</a>(<a class="code" href="structstp__curve.html">stp_curve_t</a> *curve)
00346 {
00347   <span class="keywordflow">if</span> (curve-&gt;<a class="code" href="structstp__curve.html#o2">piecewise</a>)
00348     <a class="code" href="curve_8c.html#a14">compute_spline_deltas_piecewise</a>(curve);
00349   <span class="keywordflow">else</span>
00350     <a class="code" href="curve_8c.html#a15">compute_spline_deltas_dense</a>(curve);
00351 }
00352 
00353 <span class="comment">/*</span>
00354 <span class="comment"> * Recompute the delta values for interpolation.</span>
00355 <span class="comment"> * When we actually do support spline curves, this routine will</span>
00356 <span class="comment"> * compute the second derivatives for that purpose, too.</span>
00357 <span class="comment"> */</span>
00358 <span class="keyword">static</span> <span class="keywordtype">void</span>
<a name="l00359"></a><a class="code" href="curve_8c.html#a17">00359</a> <a class="code" href="curve_8c.html#a17">compute_intervals</a>(<a class="code" href="structstp__curve.html">stp_curve_t</a> *curve)
00360 {
00361   <span class="keywordflow">if</span> (curve-&gt;<a class="code" href="structstp__curve.html#o6">interval</a>)
00362     {
00363       <a class="code" href="group__util.html#ga31">stp_free</a>(curve-&gt;<a class="code" href="structstp__curve.html#o6">interval</a>);
00364       curve-&gt;<a class="code" href="structstp__curve.html#o6">interval</a> = NULL;
00365     }
00366   <span class="keywordflow">if</span> (<a class="code" href="group__sequence.html#ga16">stp_sequence_get_size</a>(curve-&gt;<a class="code" href="structstp__curve.html#o5">seq</a>) &gt; 0)
00367     {
00368       <span class="keywordflow">switch</span> (curve-&gt;<a class="code" href="structstp__curve.html#o0">curve_type</a>)
00369         {
00370         <span class="keywordflow">case</span> <a class="code" href="group__curve.html#gga47a2">STP_CURVE_TYPE_SPLINE</a>:
00371           <a class="code" href="curve_8c.html#a16">compute_spline_deltas</a>(curve);
00372           <span class="keywordflow">break</span>;
00373         <span class="keywordflow">case</span> <a class="code" href="group__curve.html#gga47a1">STP_CURVE_TYPE_LINEAR</a>:
00374           <a class="code" href="curve_8c.html#a13">compute_linear_deltas</a>(curve);
00375           <span class="keywordflow">break</span>;
00376         }
00377     }
00378   curve-&gt;<a class="code" href="structstp__curve.html#o3">recompute_interval</a> = 0;
00379 }
00380 
00381 <span class="keyword">static</span> <span class="keywordtype">int</span>
<a name="l00382"></a><a class="code" href="curve_8c.html#a18">00382</a> <a class="code" href="curve_8c.html#a18">stpi_curve_set_points</a>(<a class="code" href="structstp__curve.html">stp_curve_t</a> *curve, size_t points)
00383 {
00384   <span class="keywordflow">if</span> (points &lt; 2)
00385     <span class="keywordflow">return</span> 0;
00386   <span class="keywordflow">if</span> (points &gt; <a class="code" href="curve_8c.html#a3">curve_point_limit</a> ||
00387       (curve-&gt;<a class="code" href="structstp__curve.html#o1">wrap_mode</a> == <a class="code" href="group__curve.html#gga48a4">STP_CURVE_WRAP_AROUND</a> &amp;&amp;
00388        points &gt; <a class="code" href="curve_8c.html#a3">curve_point_limit</a> - 1))
00389     <span class="keywordflow">return</span> 0;
00390   <a class="code" href="curve_8c.html#a12">clear_curve_data</a>(curve);
00391   <span class="keywordflow">if</span> (curve-&gt;<a class="code" href="structstp__curve.html#o1">wrap_mode</a> == <a class="code" href="group__curve.html#gga48a4">STP_CURVE_WRAP_AROUND</a>)
00392     points++;
00393   <span class="keywordflow">if</span> (curve-&gt;<a class="code" href="structstp__curve.html#o2">piecewise</a>)
00394     points *= 2;
00395   <span class="keywordflow">if</span> ((<a class="code" href="group__sequence.html#ga15">stp_sequence_set_size</a>(curve-&gt;<a class="code" href="structstp__curve.html#o5">seq</a>, points)) == 0)
00396     <span class="keywordflow">return</span> 0;
00397   <span class="keywordflow">return</span> 1;
00398 }
00399 
00400 <span class="comment">/*</span>
00401 <span class="comment"> * Create a default curve</span>
00402 <span class="comment"> */</span>
00403 <span class="keyword">static</span> <span class="keywordtype">void</span>
<a name="l00404"></a><a class="code" href="curve_8c.html#a19">00404</a> <a class="code" href="curve_8c.html#a19">stpi_curve_ctor</a>(<a class="code" href="structstp__curve.html">stp_curve_t</a> *curve, stp_curve_wrap_mode_t wrap_mode)
00405 {
00406   curve-&gt;<a class="code" href="structstp__curve.html#o5">seq</a> = <a class="code" href="group__sequence.html#ga1">stp_sequence_create</a>();
00407   <a class="code" href="group__sequence.html#ga11">stp_sequence_set_bounds</a>(curve-&gt;<a class="code" href="structstp__curve.html#o5">seq</a>, 0.0, 1.0);
00408   curve-&gt;<a class="code" href="structstp__curve.html#o0">curve_type</a> = <a class="code" href="group__curve.html#gga47a1">STP_CURVE_TYPE_LINEAR</a>;
00409   curve-&gt;<a class="code" href="structstp__curve.html#o1">wrap_mode</a> = wrap_mode;
00410   curve-&gt;<a class="code" href="structstp__curve.html#o2">piecewise</a> = 0;
00411   <a class="code" href="curve_8c.html#a18">stpi_curve_set_points</a>(curve, 2);
00412   curve-&gt;recompute_interval = 1;
00413   if (wrap_mode == <a class="code" href="group__curve.html#gga48a3">STP_CURVE_WRAP_NONE</a>)
00414     curve-&gt;gamma = 1.0;
00415   <a class="code" href="group__sequence.html#ga13">stp_sequence_set_point</a>(curve-&gt;seq, 0, 0);
00416   <a class="code" href="group__sequence.html#ga13">stp_sequence_set_point</a>(curve-&gt;seq, 1, 1);
00417 }
00418 
00419 <a class="code" href="structstp__curve.html">stp_curve_t</a> *
<a name="l00420"></a><a class="code" href="group__curve.html#ga20">00420</a> <a class="code" href="group__curve.html#ga20">stp_curve_create</a>(stp_curve_wrap_mode_t wrap_mode)
00421 {
00422   <a class="code" href="structstp__curve.html">stp_curve_t</a> *ret;
00423   <span class="keywordflow">if</span> (wrap_mode != <a class="code" href="group__curve.html#gga48a3">STP_CURVE_WRAP_NONE</a> &amp;&amp; wrap_mode != <a class="code" href="group__curve.html#gga48a4">STP_CURVE_WRAP_AROUND</a>)
00424     <span class="keywordflow">return</span> NULL;
00425   ret = <a class="code" href="group__util.html#ga29">stp_zalloc</a>(<span class="keyword">sizeof</span>(<a class="code" href="structstp__curve.html">stp_curve_t</a>));
00426   <a class="code" href="curve_8c.html#a19">stpi_curve_ctor</a>(ret, wrap_mode);
00427   <span class="keywordflow">return</span> ret;
00428 }
00429 
00430 <span class="keyword">static</span> <span class="keywordtype">void</span>
<a name="l00431"></a><a class="code" href="curve_8c.html#a21">00431</a> <a class="code" href="curve_8c.html#a21">curve_dtor</a>(<a class="code" href="structstp__curve.html">stp_curve_t</a> *curve)
00432 {
00433   <a class="code" href="curve_8c.html#a8">check_curve</a>(curve);
00434   <a class="code" href="curve_8c.html#a12">clear_curve_data</a>(curve);
00435   <span class="keywordflow">if</span> (curve-&gt;<a class="code" href="structstp__curve.html#o5">seq</a>)
00436     <a class="code" href="group__sequence.html#ga8">stp_sequence_destroy</a>(curve-&gt;<a class="code" href="structstp__curve.html#o5">seq</a>);
00437   memset(curve, 0, <span class="keyword">sizeof</span>(<a class="code" href="structstp__curve.html">stp_curve_t</a>));
00438   curve-&gt;<a class="code" href="structstp__curve.html#o0">curve_type</a> = -1;
00439 }
00440 
00441 <span class="keywordtype">void</span>
<a name="l00442"></a><a class="code" href="group__curve.html#ga22">00442</a> <a class="code" href="group__curve.html#ga22">stp_curve_destroy</a>(<a class="code" href="structstp__curve.html">stp_curve_t</a> *curve)
00443 {
00444   <a class="code" href="curve_8c.html#a21">curve_dtor</a>(curve);
00445   <a class="code" href="group__util.html#ga31">stp_free</a>(curve);
00446 }
00447 
00448 <span class="keywordtype">void</span>
<a name="l00449"></a><a class="code" href="group__curve.html#ga23">00449</a> <a class="code" href="group__curve.html#ga23">stp_curve_copy</a>(<a class="code" href="structstp__curve.html">stp_curve_t</a> *dest, <span class="keyword">const</span> <a class="code" href="structstp__curve.html">stp_curve_t</a> *source)
00450 {
00451   <a class="code" href="curve_8c.html#a8">check_curve</a>(dest);
00452   <a class="code" href="curve_8c.html#a8">check_curve</a>(source);
00453   <a class="code" href="curve_8c.html#a21">curve_dtor</a>(dest);
00454   dest-&gt;<a class="code" href="structstp__curve.html#o0">curve_type</a> = source-&gt;<a class="code" href="structstp__curve.html#o0">curve_type</a>;
00455   dest-&gt;<a class="code" href="structstp__curve.html#o1">wrap_mode</a> = source-&gt;<a class="code" href="structstp__curve.html#o1">wrap_mode</a>;
00456   dest-&gt;<a class="code" href="structstp__curve.html#o4">gamma</a> = source-&gt;<a class="code" href="structstp__curve.html#o4">gamma</a>;
00457   dest-&gt;<a class="code" href="structstp__curve.html#o5">seq</a> = <a class="code" href="group__sequence.html#ga10">stp_sequence_create_copy</a>(source-&gt;<a class="code" href="structstp__curve.html#o5">seq</a>);
00458   dest-&gt;<a class="code" href="structstp__curve.html#o2">piecewise</a> = source-&gt;<a class="code" href="structstp__curve.html#o2">piecewise</a>;
00459   dest-&gt;<a class="code" href="structstp__curve.html#o3">recompute_interval</a> = 1;
00460 }
00461 
00462 <a class="code" href="structstp__curve.html">stp_curve_t</a> *
<a name="l00463"></a><a class="code" href="group__curve.html#ga24">00463</a> <a class="code" href="group__curve.html#ga24">stp_curve_create_copy</a>(<span class="keyword">const</span> <a class="code" href="structstp__curve.html">stp_curve_t</a> *curve)
00464 {
00465   <a class="code" href="structstp__curve.html">stp_curve_t</a> *ret;
00466   <a class="code" href="curve_8c.html#a8">check_curve</a>(curve);
00467   ret = <a class="code" href="group__curve.html#ga20">stp_curve_create</a>(curve-&gt;<a class="code" href="structstp__curve.html#o1">wrap_mode</a>);
00468   <a class="code" href="group__curve.html#ga23">stp_curve_copy</a>(ret, curve);
00469   <span class="keywordflow">return</span> ret;
00470 }
00471 
00472 <span class="keywordtype">int</span>
<a name="l00473"></a><a class="code" href="group__curve.html#ga25">00473</a> <a class="code" href="group__curve.html#ga25">stp_curve_set_bounds</a>(<a class="code" href="structstp__curve.html">stp_curve_t</a> *curve, <span class="keywordtype">double</span> low, <span class="keywordtype">double</span> high)
00474 {
00475   <a class="code" href="curve_8c.html#a8">check_curve</a>(curve);
00476   <span class="keywordflow">return</span> <a class="code" href="group__sequence.html#ga11">stp_sequence_set_bounds</a>(curve-&gt;<a class="code" href="structstp__curve.html#o5">seq</a>, low, high);
00477 }
00478 
00479 <span class="keywordtype">void</span>
<a name="l00480"></a><a class="code" href="group__curve.html#ga26">00480</a> <a class="code" href="group__curve.html#ga26">stp_curve_get_bounds</a>(<span class="keyword">const</span> <a class="code" href="structstp__curve.html">stp_curve_t</a> *curve, <span class="keywordtype">double</span> *low, <span class="keywordtype">double</span> *high)
00481 {
00482   <a class="code" href="curve_8c.html#a8">check_curve</a>(curve);
00483   <a class="code" href="group__sequence.html#ga12">stp_sequence_get_bounds</a>(curve-&gt;<a class="code" href="structstp__curve.html#o5">seq</a>, low, high);
00484 }
00485 
00486 <span class="comment">/*</span>
00487 <span class="comment"> * Find the minimum and maximum points on the curve.  This does not</span>
00488 <span class="comment"> * attempt to find the minimum and maximum interpolations; with cubic</span>
00489 <span class="comment"> * splines these could exceed the boundaries.  That's OK; the interpolation</span>
00490 <span class="comment"> * code will clip them to the bounds.</span>
00491 <span class="comment"> */</span>
00492 <span class="keywordtype">void</span>
<a name="l00493"></a><a class="code" href="group__curve.html#ga27">00493</a> <a class="code" href="group__curve.html#ga27">stp_curve_get_range</a>(<span class="keyword">const</span> <a class="code" href="structstp__curve.html">stp_curve_t</a> *curve, <span class="keywordtype">double</span> *low, <span class="keywordtype">double</span> *high)
00494 {
00495   <a class="code" href="curve_8c.html#a8">check_curve</a>(curve);
00496   <a class="code" href="group__sequence.html#ga14">stp_sequence_get_range</a>(curve-&gt;<a class="code" href="structstp__curve.html#o5">seq</a>, low, high);
00497 }
00498 
00499 size_t
<a name="l00500"></a><a class="code" href="group__curve.html#ga28">00500</a> <a class="code" href="group__curve.html#ga28">stp_curve_count_points</a>(<span class="keyword">const</span> <a class="code" href="structstp__curve.html">stp_curve_t</a> *curve)
00501 {
00502   <a class="code" href="curve_8c.html#a8">check_curve</a>(curve);
00503   <span class="keywordflow">return</span> <a class="code" href="curve_8c.html#a10">get_point_count</a>(curve);
00504 }
00505 
00506 <a class="code" href="group__curve.html#ga48">stp_curve_wrap_mode_t</a>
<a name="l00507"></a><a class="code" href="group__curve.html#ga29">00507</a> <a class="code" href="group__curve.html#ga29">stp_curve_get_wrap</a>(<span class="keyword">const</span> <a class="code" href="structstp__curve.html">stp_curve_t</a> *curve)
00508 {
00509   <a class="code" href="curve_8c.html#a8">check_curve</a>(curve);
00510   <span class="keywordflow">return</span> curve-&gt;<a class="code" href="structstp__curve.html#o1">wrap_mode</a>;
00511 }
00512 
00513 <span class="keywordtype">int</span>
<a name="l00514"></a><a class="code" href="group__curve.html#ga30">00514</a> <a class="code" href="group__curve.html#ga30">stp_curve_is_piecewise</a>(<span class="keyword">const</span> <a class="code" href="structstp__curve.html">stp_curve_t</a> *curve)
00515 {
00516   <a class="code" href="curve_8c.html#a8">check_curve</a>(curve);
00517   <span class="keywordflow">return</span> curve-&gt;<a class="code" href="structstp__curve.html#o2">piecewise</a>;
00518 }
00519 
00520 <span class="keywordtype">int</span>
<a name="l00521"></a><a class="code" href="group__curve.html#ga31">00521</a> <a class="code" href="group__curve.html#ga31">stp_curve_set_interpolation_type</a>(<a class="code" href="structstp__curve.html">stp_curve_t</a> *curve, stp_curve_type_t itype)
00522 {
00523   <a class="code" href="curve_8c.html#a8">check_curve</a>(curve);
00524   <span class="keywordflow">if</span> (itype &lt; 0 || itype &gt;= <a class="code" href="curve_8c.html#a5">stpi_curve_type_count</a>)
00525     <span class="keywordflow">return</span> 0;
00526   curve-&gt;<a class="code" href="structstp__curve.html#o0">curve_type</a> = itype;
00527   <span class="keywordflow">return</span> 1;
00528 }
00529 
00530 <a class="code" href="group__curve.html#ga47">stp_curve_type_t</a>
<a name="l00531"></a><a class="code" href="group__curve.html#ga32">00531</a> <a class="code" href="group__curve.html#ga32">stp_curve_get_interpolation_type</a>(<span class="keyword">const</span> <a class="code" href="structstp__curve.html">stp_curve_t</a> *curve)
00532 {
00533   <a class="code" href="curve_8c.html#a8">check_curve</a>(curve);
00534   <span class="keywordflow">return</span> curve-&gt;<a class="code" href="structstp__curve.html#o0">curve_type</a>;
00535 }
00536 
00537 <span class="keywordtype">int</span>
<a name="l00538"></a><a class="code" href="group__curve.html#ga33">00538</a> <a class="code" href="group__curve.html#ga33">stp_curve_set_gamma</a>(<a class="code" href="structstp__curve.html">stp_curve_t</a> *curve, <span class="keywordtype">double</span> fgamma)
00539 {
00540   <a class="code" href="curve_8c.html#a8">check_curve</a>(curve);
00541   <span class="keywordflow">if</span> (curve-&gt;<a class="code" href="structstp__curve.html#o1">wrap_mode</a> || ! finite(fgamma) || fgamma == 0.0)
00542     <span class="keywordflow">return</span> 0;
00543   <a class="code" href="curve_8c.html#a12">clear_curve_data</a>(curve);
00544   curve-&gt;<a class="code" href="structstp__curve.html#o4">gamma</a> = fgamma;
00545   <a class="code" href="group__curve.html#ga51">stp_curve_resample</a>(curve, 2);
00546   <span class="keywordflow">return</span> 1;
00547 }
00548 
00549 <span class="keywordtype">double</span>
<a name="l00550"></a><a class="code" href="group__curve.html#ga34">00550</a> <a class="code" href="group__curve.html#ga34">stp_curve_get_gamma</a>(<span class="keyword">const</span> <a class="code" href="structstp__curve.html">stp_curve_t</a> *curve)
00551 {
00552   <a class="code" href="curve_8c.html#a8">check_curve</a>(curve);
00553   <span class="keywordflow">return</span> curve-&gt;<a class="code" href="structstp__curve.html#o4">gamma</a>;
00554 }
00555 
00556 <span class="keywordtype">int</span>
<a name="l00557"></a><a class="code" href="group__curve.html#ga35">00557</a> <a class="code" href="group__curve.html#ga35">stp_curve_set_data</a>(<a class="code" href="structstp__curve.html">stp_curve_t</a> *curve, size_t count, <span class="keyword">const</span> <span class="keywordtype">double</span> *data)
00558 {
00559   size_t i;
00560   size_t real_count = count;
00561   <span class="keywordtype">double</span> low, high;
00562   <a class="code" href="curve_8c.html#a8">check_curve</a>(curve);
00563   <span class="keywordflow">if</span> (count &lt; 2)
00564     <span class="keywordflow">return</span> 0;
00565   <span class="keywordflow">if</span> (curve-&gt;<a class="code" href="structstp__curve.html#o1">wrap_mode</a> == <a class="code" href="group__curve.html#gga48a4">STP_CURVE_WRAP_AROUND</a>)
00566     real_count++;
00567   <span class="keywordflow">if</span> (real_count &gt; <a class="code" href="curve_8c.html#a3">curve_point_limit</a>)
00568     <span class="keywordflow">return</span> 0;
00569 
00570   <span class="comment">/* Validate the data before we commit to it. */</span>
00571   <a class="code" href="group__sequence.html#ga12">stp_sequence_get_bounds</a>(curve-&gt;<a class="code" href="structstp__curve.html#o5">seq</a>, &amp;low, &amp;high);
00572   <span class="keywordflow">for</span> (i = 0; i &lt; count; i++)
00573     <span class="keywordflow">if</span> (! finite(data[i]) || data[i] &lt; low || data[i] &gt; high)
00574       {
00575         <a class="code" href="print-util_8c.html#a24">stp_deprintf</a>(<a class="code" href="group__util.html#ga51">STP_DBG_CURVE_ERRORS</a>,
00576                      <span class="stringliteral">"stp_curve_set_data: datum out of bounds: "</span>
00577                      <span class="stringliteral">"%g (require %g &lt;= x &lt;= %g), n = %d\n"</span>,
00578                      data[i], low, high, i);
00579         <span class="keywordflow">return</span> 0;
00580       }
00581   <span class="comment">/* Allocate sequence; also accounts for WRAP_MODE */</span>
00582   <a class="code" href="curve_8c.html#a18">stpi_curve_set_points</a>(curve, count);
00583   curve-&gt;<a class="code" href="structstp__curve.html#o4">gamma</a> = 0.0;
00584   <a class="code" href="group__sequence.html#ga18">stp_sequence_set_subrange</a>(curve-&gt;<a class="code" href="structstp__curve.html#o5">seq</a>, 0, count, data);
00585 
00586   <span class="keywordflow">if</span> (curve-&gt;<a class="code" href="structstp__curve.html#o1">wrap_mode</a> == <a class="code" href="group__curve.html#gga48a4">STP_CURVE_WRAP_AROUND</a>)
00587     <a class="code" href="group__sequence.html#ga20">stp_sequence_set_point</a>(curve-&gt;<a class="code" href="structstp__curve.html#o5">seq</a>, count, data[0]);
00588   curve-&gt;<a class="code" href="structstp__curve.html#o3">recompute_interval</a> = 1;
00589   curve-&gt;<a class="code" href="structstp__curve.html#o2">piecewise</a> = 0;
00590 
00591   <span class="keywordflow">return</span> 1;
00592 }
00593 
00594 <span class="keywordtype">int</span>
<a name="l00595"></a><a class="code" href="group__curve.html#ga36">00595</a> <a class="code" href="group__curve.html#ga36">stp_curve_set_data_points</a>(<a class="code" href="structstp__curve.html">stp_curve_t</a> *curve, size_t count,
00596                           <span class="keyword">const</span> <a class="code" href="structstp__curve__point__t.html">stp_curve_point_t</a> *data)
00597 {
00598   size_t i;
00599   size_t real_count = count;
00600   <span class="keywordtype">double</span> low, high;
00601   <span class="keywordtype">double</span> last_x = -1;
00602   <a class="code" href="curve_8c.html#a8">check_curve</a>(curve);
00603   <span class="keywordflow">if</span> (count &lt; 2)
00604     {
00605       <a class="code" href="print-util_8c.html#a24">stp_deprintf</a>(<a class="code" href="group__util.html#ga51">STP_DBG_CURVE_ERRORS</a>,
00606                    <span class="stringliteral">"stp_curve_set_data_points: too few points %d\n"</span>, count);
00607       <span class="keywordflow">return</span> 0;
00608     }
00609   <span class="keywordflow">if</span> (curve-&gt;<a class="code" href="structstp__curve.html#o1">wrap_mode</a> == <a class="code" href="group__curve.html#gga48a4">STP_CURVE_WRAP_AROUND</a>)
00610     real_count++;
00611   <span class="keywordflow">if</span> (real_count &gt; <a class="code" href="curve_8c.html#a3">curve_point_limit</a>)
00612     {
00613       <a class="code" href="print-util_8c.html#a24">stp_deprintf</a>(<a class="code" href="group__util.html#ga51">STP_DBG_CURVE_ERRORS</a>,
00614                    <span class="stringliteral">"stp_curve_set_data_points: too many points %d\n"</span>,
00615                    real_count);
00616       <span class="keywordflow">return</span> 0;
00617     }
00618 
00619   <span class="comment">/* Validate the data before we commit to it. */</span>
00620   <a class="code" href="group__sequence.html#ga12">stp_sequence_get_bounds</a>(curve-&gt;<a class="code" href="structstp__curve.html#o5">seq</a>, &amp;low, &amp;high);
00621   <span class="keywordflow">for</span> (i = 0; i &lt; count; i++)
00622     {
00623       <span class="keywordflow">if</span> (! finite(data[i].y) || data[i].<a class="code" href="structstp__curve__point__t.html#o1">y</a> &lt; low || data[i].<a class="code" href="structstp__curve__point__t.html#o1">y</a> &gt; high)
00624         {
00625           <a class="code" href="print-util_8c.html#a24">stp_deprintf</a>(<a class="code" href="group__util.html#ga51">STP_DBG_CURVE_ERRORS</a>,
00626                        <span class="stringliteral">"stp_curve_set_data_points: datum out of bounds: "</span>
00627                        <span class="stringliteral">"%g (require %g &lt;= x &lt;= %g), n = %d\n"</span>,
00628                        data[i].y, low, high, i);
00629           <span class="keywordflow">return</span> 0;
00630         }
00631       <span class="keywordflow">if</span> (i == 0 &amp;&amp; data[i].<a class="code" href="structstp__curve__point__t.html#o0">x</a> != 0.0)
00632         {
00633           <a class="code" href="print-util_8c.html#a24">stp_deprintf</a>(<a class="code" href="group__util.html#ga51">STP_DBG_CURVE_ERRORS</a>,
00634                        <span class="stringliteral">"stp_curve_set_data_points: first point must have x=0\n"</span>);
00635           <span class="keywordflow">return</span> 0;
00636         }
00637       <span class="keywordflow">if</span> (curve-&gt;<a class="code" href="structstp__curve.html#o1">wrap_mode</a> == <a class="code" href="group__curve.html#gga48a3">STP_CURVE_WRAP_NONE</a> &amp;&amp; i == count - 1 &amp;&amp;
00638           data[i].x != 1.0)
00639         {
00640           <a class="code" href="print-util_8c.html#a24">stp_deprintf</a>(<a class="code" href="group__util.html#ga51">STP_DBG_CURVE_ERRORS</a>,
00641                        <span class="stringliteral">"stp_curve_set_data_points: last point must have x=1\n"</span>);
00642           <span class="keywordflow">return</span> 0;
00643         }
00644       <span class="keywordflow">if</span> (curve-&gt;<a class="code" href="structstp__curve.html#o1">wrap_mode</a> == <a class="code" href="group__curve.html#gga48a4">STP_CURVE_WRAP_AROUND</a> &amp;&amp;
00645           data[i].x &gt;= 1.0 - .000001)
00646         {
00647           <a class="code" href="print-util_8c.html#a24">stp_deprintf</a>(<a class="code" href="group__util.html#ga51">STP_DBG_CURVE_ERRORS</a>,
00648                        <span class="stringliteral">"stp_curve_set_data_points: horizontal value must "</span>
00649                        <span class="stringliteral">"not exceed .99999\n"</span>);
00650           <span class="keywordflow">return</span> 0;
00651         }         
00652       <span class="keywordflow">if</span> (data[i].x &lt; 0 || data[i].x &gt; 1)
00653         {
00654           <a class="code" href="print-util_8c.html#a24">stp_deprintf</a>(<a class="code" href="group__util.html#ga51">STP_DBG_CURVE_ERRORS</a>,
00655                        <span class="stringliteral">"stp_curve_set_data_points: horizontal position out of bounds: "</span>
00656                        <span class="stringliteral">"%g, n = %d\n"</span>,
00657                        data[i].x, i);
00658           <span class="keywordflow">return</span> 0;
00659         }
00660       <span class="keywordflow">if</span> (data[i].x - .000001 &lt; last_x)
00661         {
00662           <a class="code" href="print-util_8c.html#a24">stp_deprintf</a>(<a class="code" href="group__util.html#ga51">STP_DBG_CURVE_ERRORS</a>,
00663                        <span class="stringliteral">"stp_curve_set_data_points: horizontal position must "</span>
00664                        <span class="stringliteral">"exceed previous position by .000001: %g, %g, n = %d\n"</span>,
00665                        data[i].x, last_x, i);
00666           <span class="keywordflow">return</span> 0;
00667         }
00668       last_x = data[i].x;
00669     }
00670   <span class="comment">/* Allocate sequence; also accounts for WRAP_MODE */</span>
00671   curve-&gt;<a class="code" href="structstp__curve.html#o2">piecewise</a> = 1;
00672   <a class="code" href="curve_8c.html#a18">stpi_curve_set_points</a>(curve, count);
00673   curve-&gt;<a class="code" href="structstp__curve.html#o4">gamma</a> = 0.0;
00674   <a class="code" href="group__sequence.html#ga18">stp_sequence_set_subrange</a>(curve-&gt;<a class="code" href="structstp__curve.html#o5">seq</a>, 0, count * 2, (<span class="keyword">const</span> <span class="keywordtype">double</span> *) data);
00675 
00676   <span class="keywordflow">if</span> (curve-&gt;<a class="code" href="structstp__curve.html#o1">wrap_mode</a> == <a class="code" href="group__curve.html#gga48a4">STP_CURVE_WRAP_AROUND</a>)
00677     {
00678       <a class="code" href="group__sequence.html#ga20">stp_sequence_set_point</a>(curve-&gt;<a class="code" href="structstp__curve.html#o5">seq</a>, count * 2, data[0].x);
00679       <a class="code" href="group__sequence.html#ga20">stp_sequence_set_point</a>(curve-&gt;<a class="code" href="structstp__curve.html#o5">seq</a>, count * 2 + 1, data[0].y);
00680     }
00681   curve-&gt;<a class="code" href="structstp__curve.html#o3">recompute_interval</a> = 1;
00682 
00683   <span class="keywordflow">return</span> 1;
00684 }
00685 
00686 
00687 <span class="comment">/*</span>
00688 <span class="comment"> * Note that we return a pointer to the raw data here.</span>
00689 <span class="comment"> * A lot of operations change the data vector, that's why we don't</span>
00690 <span class="comment"> * guarantee it across non-const calls.</span>
00691 <span class="comment"> */</span>
00692 <span class="keyword">const</span> <span class="keywordtype">double</span> *
<a name="l00693"></a><a class="code" href="group__curve.html#ga37">00693</a> <a class="code" href="group__curve.html#ga37">stp_curve_get_data</a>(<span class="keyword">const</span> <a class="code" href="structstp__curve.html">stp_curve_t</a> *curve, size_t *count)
00694 {
00695   <span class="keyword">const</span> <span class="keywordtype">double</span> *ret;
00696   <a class="code" href="curve_8c.html#a8">check_curve</a>(curve);
00697   <span class="keywordflow">if</span> (curve-&gt;<a class="code" href="structstp__curve.html#o2">piecewise</a>)
00698     <span class="keywordflow">return</span> NULL;
00699   <a class="code" href="group__sequence.html#ga19">stp_sequence_get_data</a>(curve-&gt;<a class="code" href="structstp__curve.html#o5">seq</a>, count, &amp;ret);
00700   *count = <a class="code" href="curve_8c.html#a10">get_point_count</a>(curve);
00701   <span class="keywordflow">return</span> ret;
00702 }
00703 
00704 <span class="keyword">const</span> <a class="code" href="structstp__curve__point__t.html">stp_curve_point_t</a> *
<a name="l00705"></a><a class="code" href="group__curve.html#ga38">00705</a> <a class="code" href="group__curve.html#ga38">stp_curve_get_data_points</a>(<span class="keyword">const</span> <a class="code" href="structstp__curve.html">stp_curve_t</a> *curve, size_t *count)
00706 {
00707   <span class="keyword">const</span> <a class="code" href="structstp__curve__point__t.html">stp_curve_point_t</a> *ret;
00708   <a class="code" href="curve_8c.html#a8">check_curve</a>(curve);
00709   <span class="keywordflow">if</span> (!curve-&gt;<a class="code" href="structstp__curve.html#o2">piecewise</a>)
00710     <span class="keywordflow">return</span> NULL;
00711   <a class="code" href="group__sequence.html#ga19">stp_sequence_get_data</a>(curve-&gt;<a class="code" href="structstp__curve.html#o5">seq</a>, count, (<span class="keyword">const</span> <span class="keywordtype">double</span> **) &amp;ret);
00712   *count = <a class="code" href="curve_8c.html#a10">get_point_count</a>(curve);
00713   <span class="keywordflow">return</span> ret;
00714 }
00715 
00716 <span class="keyword">static</span> <span class="keyword">const</span> <span class="keywordtype">double</span> *
<a name="l00717"></a><a class="code" href="curve_8c.html#a39">00717</a> <a class="code" href="curve_8c.html#a39">stpi_curve_get_data_internal</a>(<span class="keyword">const</span> <a class="code" href="structstp__curve.html">stp_curve_t</a> *curve, size_t *count)
00718 {
00719   <span class="keyword">const</span> <span class="keywordtype">double</span> *ret;
00720   <a class="code" href="curve_8c.html#a8">check_curve</a>(curve);
00721   <a class="code" href="group__sequence.html#ga19">stp_sequence_get_data</a>(curve-&gt;<a class="code" href="structstp__curve.html#o5">seq</a>, count, &amp;ret);
00722   *count = <a class="code" href="curve_8c.html#a10">get_point_count</a>(curve);
00723   <span class="keywordflow">if</span> (curve-&gt;<a class="code" href="structstp__curve.html#o2">piecewise</a>)
00724     *count *= 2;
00725   <span class="keywordflow">return</span> ret;
00726 }
00727 
00728 
00729 <span class="comment">/* "Overloaded" functions */</span>
00730 
<a name="l00731"></a><a class="code" href="curve_8c.html#a1">00731</a> <span class="preprocessor">#define DEFINE_DATA_SETTER(t, name)                                        \</span>
00732 <span class="preprocessor">int                                                                        \</span>
00733 <span class="preprocessor">stp_curve_set_##name##_data(stp_curve_t *curve, size_t count, const t *data) \</span>
00734 <span class="preprocessor">{                                                                          \</span>
00735 <span class="preprocessor">  double *tmp_data;                                                        \</span>
00736 <span class="preprocessor">  size_t i;                                                                \</span>
00737 <span class="preprocessor">  int status;                                                              \</span>
00738 <span class="preprocessor">  size_t real_count = count;                                               \</span>
00739 <span class="preprocessor">                                                                           \</span>
00740 <span class="preprocessor">  check_curve(curve);                                                      \</span>
00741 <span class="preprocessor">  if (count &lt; 2)                                                           \</span>
00742 <span class="preprocessor">    return 0;                                                              \</span>
00743 <span class="preprocessor">  if (curve-&gt;wrap_mode == STP_CURVE_WRAP_AROUND)                           \</span>
00744 <span class="preprocessor">    real_count++;                                                          \</span>
00745 <span class="preprocessor">  if (real_count &gt; curve_point_limit)                                      \</span>
00746 <span class="preprocessor">    return 0;                                                              \</span>
00747 <span class="preprocessor">  tmp_data = stp_malloc(count * sizeof(double));                           \</span>
00748 <span class="preprocessor">  for (i = 0; i &lt; count; i++)                                              \</span>
00749 <span class="preprocessor">    tmp_data[i] = (double) data[i];                                        \</span>
00750 <span class="preprocessor">  status = stp_curve_set_data(curve, count, tmp_data);                     \</span>
00751 <span class="preprocessor">  stp_free(tmp_data);                                                      \</span>
00752 <span class="preprocessor">  return status;                                                           \</span>
00753 <span class="preprocessor"> }</span>
00754 <span class="preprocessor"></span>
00755 <a class="code" href="curve_8c.html#a1">DEFINE_DATA_SETTER</a>(<span class="keywordtype">float</span>, <span class="keywordtype">float</span>)
00756 <a class="code" href="curve_8c.html#a1">DEFINE_DATA_SETTER</a>(<span class="keywordtype">long</span>, <span class="keywordtype">long</span>)
00757 <a class="code" href="curve_8c.html#a1">DEFINE_DATA_SETTER</a>(<span class="keywordtype">unsigned</span> <span class="keywordtype">long</span>, ulong)
00758 <a class="code" href="curve_8c.html#a1">DEFINE_DATA_SETTER</a>(<span class="keywordtype">int</span>, <span class="keywordtype">int</span>)
00759 <a class="code" href="curve_8c.html#a1">DEFINE_DATA_SETTER</a>(<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span>, uint)
00760 <a class="code" href="curve_8c.html#a1">DEFINE_DATA_SETTER</a>(<span class="keywordtype">short</span>, <span class="keywordtype">short</span>)
00761 <a class="code" href="curve_8c.html#a1">DEFINE_DATA_SETTER</a>(<span class="keywordtype">unsigned</span> <span class="keywordtype">short</span>, ushort)
00762 
00763 
<a name="l00764"></a><a class="code" href="curve_8c.html#a2">00764</a> #define <a class="code" href="curve_8c.html#a2">DEFINE_DATA_ACCESSOR</a>(t, name)                                   \
00765 <span class="keyword">const</span> t *                                                               \
00766 stp_curve_get_##name##_data(<span class="keyword">const</span> <a class="code" href="structstp__curve.html">stp_curve_t</a> *curve, size_t *count)    \
00767 {                                                                       \
00768   <span class="keywordflow">if</span> (curve-&gt;piecewise)                                                 \
00769     <span class="keywordflow">return</span> 0;                                                           \
00770   <span class="keywordflow">return</span> stp_sequence_get_##name##_data(curve-&gt;seq, count);             \
00771 }
00772 
00773 <a class="code" href="curve_8c.html#a2">DEFINE_DATA_ACCESSOR</a>(<span class="keywordtype">float</span>, <span class="keywordtype">float</span>)
00774 <a class="code" href="curve_8c.html#a2">DEFINE_DATA_ACCESSOR</a>(<span class="keywordtype">long</span>, <span class="keywordtype">long</span>)
00775 <a class="code" href="curve_8c.html#a2">DEFINE_DATA_ACCESSOR</a>(<span class="keywordtype">unsigned</span> <span class="keywordtype">long</span>, ulong)
00776 <a class="code" href="curve_8c.html#a2">DEFINE_DATA_ACCESSOR</a>(<span class="keywordtype">int</span>, <span class="keywordtype">int</span>)
00777 <a class="code" href="curve_8c.html#a2">DEFINE_DATA_ACCESSOR</a>(<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span>, uint)
00778 <a class="code" href="curve_8c.html#a2">DEFINE_DATA_ACCESSOR</a>(<span class="keywordtype">short</span>, <span class="keywordtype">short</span>)
00779 <a class="code" href="curve_8c.html#a2">DEFINE_DATA_ACCESSOR</a>(<span class="keywordtype">unsigned</span> <span class="keywordtype">short</span>, ushort)
00780 
00781 
00782 <a class="code" href="structstp__curve.html">stp_curve_t</a> *
<a name="l00783"></a><a class="code" href="group__curve.html#ga40">00783</a> <a class="code" href="group__curve.html#ga40">stp_curve_get_subrange</a>(<span class="keyword">const</span> <a class="code" href="structstp__curve.html">stp_curve_t</a> *curve, size_t start, size_t count)
00784 {
00785   <a class="code" href="structstp__curve.html">stp_curve_t</a> *retval;
00786   size_t ncount;
00787   <span class="keywordtype">double</span> blo, bhi;
00788   <span class="keyword">const</span> <span class="keywordtype">double</span> *data;
00789   <span class="keywordflow">if</span> (start + count &gt; <a class="code" href="group__curve.html#ga28">stp_curve_count_points</a>(curve) || count &lt; 2)
00790     <span class="keywordflow">return</span> NULL;
00791   <span class="keywordflow">if</span> (curve-&gt;<a class="code" href="structstp__curve.html#o2">piecewise</a>)
00792     <span class="keywordflow">return</span> NULL;
00793   retval = <a class="code" href="group__curve.html#ga20">stp_curve_create</a>(<a class="code" href="group__curve.html#gga48a3">STP_CURVE_WRAP_NONE</a>);
00794   <a class="code" href="group__curve.html#ga26">stp_curve_get_bounds</a>(curve, &amp;blo, &amp;bhi);
00795   <a class="code" href="group__curve.html#ga25">stp_curve_set_bounds</a>(retval, blo, bhi);
00796   data = <a class="code" href="group__curve.html#ga37">stp_curve_get_data</a>(curve, &amp;ncount);
00797   <span class="keywordflow">if</span> (! <a class="code" href="group__curve.html#ga35">stp_curve_set_data</a>(retval, count, data + start))
00798     {
00799       <a class="code" href="group__curve.html#ga22">stp_curve_destroy</a>(retval);
00800       <span class="keywordflow">return</span> NULL;
00801     }
00802   <span class="keywordflow">return</span> retval;
00803 }
00804 
00805 <span class="keywordtype">int</span>
<a name="l00806"></a><a class="code" href="group__curve.html#ga41">00806</a> <a class="code" href="group__curve.html#ga41">stp_curve_set_subrange</a>(<a class="code" href="structstp__curve.html">stp_curve_t</a> *curve, <span class="keyword">const</span> <a class="code" href="structstp__curve.html">stp_curve_t</a> *range,
00807                        size_t start)
00808 {
00809   <span class="keywordtype">double</span> blo, bhi;
00810   <span class="keywordtype">double</span> rlo, rhi;
00811   <span class="keyword">const</span> <span class="keywordtype">double</span> *data;
00812   size_t count;
00813   <a class="code" href="curve_8c.html#a8">check_curve</a>(curve);
00814   <span class="keywordflow">if</span> (start + <a class="code" href="group__curve.html#ga28">stp_curve_count_points</a>(range) &gt; <a class="code" href="group__curve.html#ga28">stp_curve_count_points</a>(curve))
00815     <span class="keywordflow">return</span> 0;
00816   <span class="keywordflow">if</span> (curve-&gt;<a class="code" href="structstp__curve.html#o2">piecewise</a>)
00817     <span class="keywordflow">return</span> 0;
00818   <a class="code" href="group__sequence.html#ga12">stp_sequence_get_bounds</a>(curve-&gt;<a class="code" href="structstp__curve.html#o5">seq</a>, &amp;blo, &amp;bhi);
00819   <a class="code" href="group__sequence.html#ga14">stp_sequence_get_range</a>(curve-&gt;<a class="code" href="structstp__curve.html#o5">seq</a>, &amp;rlo, &amp;rhi);
00820   <span class="keywordflow">if</span> (rlo &lt; blo || rhi &gt; bhi)
00821     <span class="keywordflow">return</span> 0;
00822   <a class="code" href="group__sequence.html#ga19">stp_sequence_get_data</a>(range-&gt;<a class="code" href="structstp__curve.html#o5">seq</a>, &amp;count, &amp;data);
00823   curve-&gt;<a class="code" href="structstp__curve.html#o3">recompute_interval</a> = 1;
00824   curve-&gt;<a class="code" href="structstp__curve.html#o4">gamma</a> = 0.0;
00825   <a class="code" href="curve_8c.html#a11">invalidate_auxiliary_data</a>(curve);
00826   <a class="code" href="group__sequence.html#ga18">stp_sequence_set_subrange</a>(curve-&gt;<a class="code" href="structstp__curve.html#o5">seq</a>, start, <a class="code" href="group__curve.html#ga10">stp_curve_count_points</a>(range),
00827                             data);
00828   <span class="keywordflow">return</span> 1;
00829 }
00830 
00831 
00832 <span class="keywordtype">int</span>
<a name="l00833"></a><a class="code" href="group__curve.html#ga42">00833</a> <a class="code" href="group__curve.html#ga42">stp_curve_set_point</a>(<a class="code" href="structstp__curve.html">stp_curve_t</a> *curve, size_t where, <span class="keywordtype">double</span> data)
00834 {
00835   <a class="code" href="curve_8c.html#a8">check_curve</a>(curve);
00836   <span class="keywordflow">if</span> (where &gt;= <a class="code" href="curve_8c.html#a10">get_point_count</a>(curve))
00837     <span class="keywordflow">return</span> 0;
00838   curve-&gt;<a class="code" href="structstp__curve.html#o4">gamma</a> = 0.0;
00839 
00840   <span class="keywordflow">if</span> (curve-&gt;<a class="code" href="structstp__curve.html#o2">piecewise</a>)
00841     <span class="keywordflow">return</span> 0;
00842   <span class="keywordflow">if</span> ((<a class="code" href="group__sequence.html#ga20">stp_sequence_set_point</a>(curve-&gt;<a class="code" href="structstp__curve.html#o5">seq</a>, where, data)) == 0)
00843     <span class="keywordflow">return</span> 0;
00844   <span class="keywordflow">if</span> (where == 0 &amp;&amp; curve-&gt;<a class="code" href="structstp__curve.html#o1">wrap_mode</a> == <a class="code" href="group__curve.html#gga48a4">STP_CURVE_WRAP_AROUND</a>)
00845     <span class="keywordflow">if</span> ((<a class="code" href="group__sequence.html#ga20">stp_sequence_set_point</a>(curve-&gt;<a class="code" href="structstp__curve.html#o5">seq</a>,
00846                                 <a class="code" href="curve_8c.html#a10">get_point_count</a>(curve), data)) == 0)
00847       <span class="keywordflow">return</span> 0;
00848   <a class="code" href="curve_8c.html#a11">invalidate_auxiliary_data</a>(curve);
00849   <span class="keywordflow">return</span> 1;
00850 }
00851 
00852 <span class="keywordtype">int</span>
<a name="l00853"></a><a class="code" href="group__curve.html#ga43">00853</a> <a class="code" href="group__curve.html#ga43">stp_curve_get_point</a>(<span class="keyword">const</span> <a class="code" href="structstp__curve.html">stp_curve_t</a> *curve, size_t where, <span class="keywordtype">double</span> *data)
00854 {
00855   <a class="code" href="curve_8c.html#a8">check_curve</a>(curve);
00856   <span class="keywordflow">if</span> (where &gt;= <a class="code" href="curve_8c.html#a10">get_point_count</a>(curve))
00857     <span class="keywordflow">return</span> 0;
00858   <span class="keywordflow">if</span> (curve-&gt;<a class="code" href="structstp__curve.html#o2">piecewise</a>)
00859     <span class="keywordflow">return</span> 0;
00860   <span class="keywordflow">return</span> <a class="code" href="group__sequence.html#ga21">stp_sequence_get_point</a>(curve-&gt;<a class="code" href="structstp__curve.html#o5">seq</a>, where, data);
00861 }
00862 
00863 <span class="keyword">const</span> <a class="code" href="structstp__sequence.html">stp_sequence_t</a> *
<a name="l00864"></a><a class="code" href="group__curve.html#ga44">00864</a> <a class="code" href="group__curve.html#ga44">stp_curve_get_sequence</a>(<span class="keyword">const</span> <a class="code" href="structstp__curve.html">stp_curve_t</a> *curve)
00865 {
00866   <a class="code" href="curve_8c.html#a8">check_curve</a>(curve);
00867   <span class="keywordflow">if</span> (curve-&gt;<a class="code" href="structstp__curve.html#o2">piecewise</a>)
00868     <span class="keywordflow">return</span> NULL;
00869   <span class="keywordflow">return</span> curve-&gt;<a class="code" href="structstp__curve.html#o5">seq</a>;
00870 }
00871 
00872 <span class="keywordtype">int</span>
<a name="l00873"></a><a class="code" href="group__curve.html#ga45">00873</a> <a class="code" href="group__curve.html#ga45">stp_curve_rescale</a>(<a class="code" href="structstp__curve.html">stp_curve_t</a> *curve, <span class="keywordtype">double</span> scale,
00874                   stp_curve_compose_t mode, stp_curve_bounds_t bounds_mode)
00875 {
00876   size_t real_point_count;
00877   <span class="keywordtype">int</span> i;
00878   <span class="keywordtype">double</span> nblo;
00879   <span class="keywordtype">double</span> nbhi;
00880   size_t count;
00881 
00882   <a class="code" href="curve_8c.html#a8">check_curve</a>(curve);
00883 
00884   real_point_count = <a class="code" href="curve_8c.html#a9">get_real_point_count</a>(curve);
00885 
00886   <a class="code" href="group__sequence.html#ga12">stp_sequence_get_bounds</a>(curve-&gt;<a class="code" href="structstp__curve.html#o5">seq</a>, &amp;nblo, &amp;nbhi);
00887   <span class="keywordflow">if</span> (bounds_mode == <a class="code" href="group__curve.html#gga50a8">STP_CURVE_BOUNDS_RESCALE</a>)
00888     {
00889       <span class="keywordflow">switch</span> (mode)
00890         {
00891         <span class="keywordflow">case</span> <a class="code" href="group__curve.html#gga49a5">STP_CURVE_COMPOSE_ADD</a>:
00892           nblo += scale;
00893           nbhi += scale;
00894           <span class="keywordflow">break</span>;
00895         <span class="keywordflow">case</span> <a class="code" href="group__curve.html#gga49a6">STP_CURVE_COMPOSE_MULTIPLY</a>:
00896           <span class="keywordflow">if</span> (scale &lt; 0)
00897             {
00898               <span class="keywordtype">double</span> tmp = nblo * scale;
00899               nblo = nbhi * scale;
00900               nbhi = tmp;
00901             }
00902           <span class="keywordflow">else</span>
00903             {
00904               nblo *= scale;
00905               nbhi *= scale;
00906             }
00907           <span class="keywordflow">break</span>;
00908         <span class="keywordflow">case</span> <a class="code" href="group__curve.html#gga49a7">STP_CURVE_COMPOSE_EXPONENTIATE</a>:
00909           <span class="keywordflow">if</span> (scale == 0.0)
00910             <span class="keywordflow">return</span> 0;
00911           <span class="keywordflow">if</span> (nblo &lt; 0)
00912             <span class="keywordflow">return</span> 0;
00913           nblo = pow(nblo, scale);
00914           nbhi = pow(nbhi, scale);
00915           <span class="keywordflow">break</span>;
00916         <span class="keywordflow">default</span>:
00917           <span class="keywordflow">return</span> 0;
00918         }
00919     }
00920 
00921   <span class="keywordflow">if</span> (! finite(nbhi) || ! finite(nblo))
00922     <span class="keywordflow">return</span> 0;
00923 
00924   count = <a class="code" href="curve_8c.html#a10">get_point_count</a>(curve);
00925   <span class="keywordflow">if</span> (count)
00926     {
00927       <span class="keywordtype">double</span> *tmp;
00928       size_t scount;
00929       <span class="keywordtype">int</span> stride = 1;
00930       <span class="keywordtype">int</span> offset = 0;
00931       <span class="keyword">const</span> <span class="keywordtype">double</span> *data;
00932       <span class="keywordflow">if</span> (curve-&gt;<a class="code" href="structstp__curve.html#o2">piecewise</a>)
00933         {
00934           stride = 2;
00935           offset = 1;
00936         }
00937       <a class="code" href="group__sequence.html#ga19">stp_sequence_get_data</a>(curve-&gt;<a class="code" href="structstp__curve.html#o5">seq</a>, &amp;scount, &amp;data);
00938       tmp = <a class="code" href="group__util.html#ga28">stp_malloc</a>(<span class="keyword">sizeof</span>(<span class="keywordtype">double</span>) * scount);
00939       memcpy(tmp, data, scount * <span class="keyword">sizeof</span>(<span class="keywordtype">double</span>));
00940       <span class="keywordflow">for</span> (i = offset; i &lt; scount; i += stride)
00941         {
00942           <span class="keywordflow">switch</span> (mode)
00943             {
00944             <span class="keywordflow">case</span> <a class="code" href="group__curve.html#gga49a5">STP_CURVE_COMPOSE_ADD</a>:
00945               tmp[i] = tmp[i] + scale;
00946               <span class="keywordflow">break</span>;
00947             <span class="keywordflow">case</span> <a class="code" href="group__curve.html#gga49a6">STP_CURVE_COMPOSE_MULTIPLY</a>:
00948               tmp[i] = tmp[i] * scale;
00949               <span class="keywordflow">break</span>;
00950             <span class="keywordflow">case</span> <a class="code" href="group__curve.html#gga49a7">STP_CURVE_COMPOSE_EXPONENTIATE</a>:
00951               tmp[i] = pow(tmp[i], scale);
00952               <span class="keywordflow">break</span>;
00953             }
00954           <span class="keywordflow">if</span> (tmp[i] &gt; nbhi || tmp[i] &lt; nblo)
00955             {
00956               <span class="keywordflow">if</span> (bounds_mode == <a class="code" href="group__curve.html#gga50a10">STP_CURVE_BOUNDS_ERROR</a>)
00957                 {
00958                   <a class="code" href="group__util.html#ga31">stp_free</a>(tmp);
00959                   <span class="keywordflow">return</span>(0);
00960                 }
00961               <span class="keywordflow">else</span> <span class="keywordflow">if</span> (tmp[i] &gt; nbhi)
00962                 tmp[i] = nbhi;
00963               <span class="keywordflow">else</span>
00964                 tmp[i] = nblo;
00965             }
00966         }
00967       <a class="code" href="group__sequence.html#ga11">stp_sequence_set_bounds</a>(curve-&gt;<a class="code" href="structstp__curve.html#o5">seq</a>, nblo, nbhi);
00968       curve-&gt;<a class="code" href="structstp__curve.html#o4">gamma</a> = 0.0;
00969       <a class="code" href="curve_8c.html#a18">stpi_curve_set_points</a>(curve, count);
00970       <a class="code" href="group__sequence.html#ga18">stp_sequence_set_subrange</a>(curve-&gt;<a class="code" href="structstp__curve.html#o5">seq</a>, 0, scount, tmp);
00971       <a class="code" href="group__util.html#ga31">stp_free</a>(tmp);
00972       curve-&gt;<a class="code" href="structstp__curve.html#o3">recompute_interval</a> = 1;
00973       <a class="code" href="curve_8c.html#a11">invalidate_auxiliary_data</a>(curve);
00974     }
00975   <span class="keywordflow">return</span> 1;
00976 }
00977 
00978 <span class="keyword">static</span> <span class="keywordtype">int</span>
<a name="l00979"></a><a class="code" href="curve_8c.html#a46">00979</a> <a class="code" href="curve_8c.html#a46">stpi_curve_check_parameters</a>(<a class="code" href="structstp__curve.html">stp_curve_t</a> *curve, size_t points)
00980 {
00981   <span class="keywordtype">double</span> blo, bhi;
00982   <span class="keywordflow">if</span> (curve-&gt;<a class="code" href="structstp__curve.html#o4">gamma</a> &amp;&amp; curve-&gt;<a class="code" href="structstp__curve.html#o1">wrap_mode</a>)
00983     {
00984       <a class="code" href="print-util_8c.html#a24">stp_deprintf</a>(<a class="code" href="group__util.html#ga51">STP_DBG_CURVE_ERRORS</a>,
00985                    <span class="stringliteral">"curve sets both gamma and wrap_mode\n"</span>);
00986       <span class="keywordflow">return</span> 0;
00987     }
00988   <a class="code" href="group__sequence.html#ga12">stp_sequence_get_bounds</a>(curve-&gt;<a class="code" href="structstp__curve.html#o5">seq</a>, &amp;blo, &amp;bhi);
00989   <span class="keywordflow">if</span> (blo &gt; bhi)
00990     {
00991       <a class="code" href="print-util_8c.html#a24">stp_deprintf</a>(<a class="code" href="group__util.html#ga51">STP_DBG_CURVE_ERRORS</a>,
00992                    <span class="stringliteral">"curve low bound is greater than high bound\n"</span>);
00993       <span class="keywordflow">return</span> 0;
00994     }
00995   <span class="keywordflow">return</span> 1;
00996 }
00997 
00998 <span class="keyword">static</span> <span class="keyword">inline</span> <span class="keywordtype">double</span>
<a name="l00999"></a><a class="code" href="curve_8c.html#a47">00999</a> <a class="code" href="curve_8c.html#a47">interpolate_gamma_internal</a>(<span class="keyword">const</span> <a class="code" href="structstp__curve.html">stp_curve_t</a> *curve, <span class="keywordtype">double</span> where)
01000 {
01001   <span class="keywordtype">double</span> fgamma = curve-&gt;<a class="code" href="structstp__curve.html#o4">gamma</a>;
01002   <span class="keywordtype">double</span> blo, bhi;
01003   size_t real_point_count;
01004 
01005   real_point_count = <a class="code" href="curve_8c.html#a9">get_real_point_count</a>(curve);;
01006 
01007   <span class="keywordflow">if</span> (real_point_count)
01008     where /= (real_point_count - 1);
01009   <span class="keywordflow">if</span> (fgamma &lt; 0)
01010     {
01011       where = 1.0 - where;
01012       fgamma = -fgamma;
01013     }
01014   <a class="code" href="group__sequence.html#ga12">stp_sequence_get_bounds</a>(curve-&gt;<a class="code" href="structstp__curve.html#o5">seq</a>, &amp;blo, &amp;bhi);
01015   <a class="code" href="print-util_8c.html#a24">stp_deprintf</a>(<a class="code" href="group__util.html#ga50">STP_DBG_CURVE</a>,
01016                <span class="stringliteral">"interpolate_gamma %f %f %f %f %f\n"</span>, where, fgamma,
01017                blo, bhi, pow(where, fgamma));
01018   <span class="keywordflow">return</span> blo + (bhi - blo) * pow(where, fgamma);
01019 }
01020 
01021 <span class="keyword">static</span> <span class="keyword">inline</span> <span class="keywordtype">double</span>
<a name="l01022"></a><a class="code" href="curve_8c.html#a48">01022</a> <a class="code" href="curve_8c.html#a48">do_interpolate_spline</a>(<span class="keywordtype">double</span> low, <span class="keywordtype">double</span> high, <span class="keywordtype">double</span> frac,
01023                       <span class="keywordtype">double</span> interval_low, <span class="keywordtype">double</span> interval_high,
01024                       <span class="keywordtype">double</span> x_interval)
01025 {
01026   <span class="keywordtype">double</span> a = 1.0 - frac;
01027   <span class="keywordtype">double</span> b = frac;
01028   <span class="keywordtype">double</span> retval = 
01029     ((a * a * a - a) * interval_low) + ((b * b * b - b) * interval_high);
01030   retval = retval * x_interval * x_interval / 6;
01031   retval += (a * low) + (b * high);
01032   <span class="keywordflow">return</span> retval;
01033 }
01034 
01035 <span class="keyword">static</span> <span class="keyword">inline</span> <span class="keywordtype">double</span>
<a name="l01036"></a><a class="code" href="curve_8c.html#a49">01036</a> <a class="code" href="curve_8c.html#a49">interpolate_point_internal</a>(<a class="code" href="structstp__curve.html">stp_curve_t</a> *curve, <span class="keywordtype">double</span> where)
01037 {
01038   <span class="keywordtype">int</span> integer = where;
01039   <span class="keywordtype">double</span> frac = where - (<span class="keywordtype">double</span>) integer;
01040   <span class="keywordtype">double</span> bhi, blo;
01041 
01042   <span class="keywordflow">if</span> (frac == 0.0)
01043     {
01044       <span class="keywordtype">double</span> val;
01045       <span class="keywordflow">if</span> ((<a class="code" href="group__sequence.html#ga21">stp_sequence_get_point</a>(curve-&gt;<a class="code" href="structstp__curve.html#o5">seq</a>, integer, &amp;val)) == 0)
01046         <span class="keywordflow">return</span> HUGE_VAL; <span class="comment">/* Infinity */</span>
01047       <span class="keywordflow">return</span> val;
01048     }
01049   <span class="keywordflow">if</span> (curve-&gt;<a class="code" href="structstp__curve.html#o3">recompute_interval</a>)
01050     <a class="code" href="curve_8c.html#a17">compute_intervals</a>(curve);
01051   <span class="keywordflow">if</span> (curve-&gt;<a class="code" href="structstp__curve.html#o0">curve_type</a> == <a class="code" href="group__curve.html#gga47a1">STP_CURVE_TYPE_LINEAR</a>)
01052     {
01053       <span class="keywordtype">double</span> val;
01054       <span class="keywordflow">if</span> ((<a class="code" href="group__sequence.html#ga21">stp_sequence_get_point</a>(curve-&gt;<a class="code" href="structstp__curve.html#o5">seq</a>, integer, &amp;val)) == 0)
01055         <span class="keywordflow">return</span> HUGE_VAL; <span class="comment">/* Infinity */</span>
01056       <span class="keywordflow">return</span> val + frac * curve-&gt;<a class="code" href="structstp__curve.html#o6">interval</a>[integer];
01057     }
01058   <span class="keywordflow">else</span>
01059     {
01060       size_t point_count;
01061       <span class="keywordtype">double</span> ival, ip1val;
01062       <span class="keywordtype">double</span> retval;
01063       <span class="keywordtype">int</span> i = integer;
01064       <span class="keywordtype">int</span> ip1 = integer + 1;
01065 
01066       point_count = <a class="code" href="curve_8c.html#a10">get_point_count</a>(curve);
01067 
01068       <span class="keywordflow">if</span> (ip1 &gt;= point_count)
01069         ip1 -= point_count;
01070 
01071       <span class="keywordflow">if</span> ((<a class="code" href="group__sequence.html#ga21">stp_sequence_get_point</a>(curve-&gt;<a class="code" href="structstp__curve.html#o5">seq</a>, i, &amp;ival)) == 0 ||
01072           (<a class="code" href="group__sequence.html#ga21">stp_sequence_get_point</a>(curve-&gt;<a class="code" href="structstp__curve.html#o5">seq</a>, ip1, &amp;ip1val)) == 0)
01073         <span class="keywordflow">return</span> HUGE_VAL; <span class="comment">/* Infinity */</span>
01074 
01075       retval = <a class="code" href="curve_8c.html#a48">do_interpolate_spline</a>(ival, ip1val, frac, curve-&gt;<a class="code" href="structstp__curve.html#o6">interval</a>[i],
01076                                      curve-&gt;<a class="code" href="structstp__curve.html#o6">interval</a>[ip1], 1.0);
01077 
01078       <a class="code" href="group__sequence.html#ga6">stp_sequence_get_bounds</a>(curve-&gt;<a class="code" href="structstp__curve.html#o5">seq</a>, &amp;blo, &amp;bhi);
01079       if (retval &gt; bhi)
01080         retval = bhi;
01081       <span class="keywordflow">if</span> (retval &lt; blo)
01082         retval = blo;
01083       <span class="keywordflow">return</span> retval;
01084     }
01085 }
01086 
01087 <span class="keywordtype">int</span>
<a name="l01088"></a><a class="code" href="group__curve.html#ga50">01088</a> <a class="code" href="group__curve.html#ga50">stp_curve_interpolate_value</a>(<span class="keyword">const</span> <a class="code" href="structstp__curve.html">stp_curve_t</a> *curve, <span class="keywordtype">double</span> where,
01089                             <span class="keywordtype">double</span> *result)
01090 {
01091   size_t limit;
01092 
01093   <a class="code" href="curve_8c.html#a8">check_curve</a>(curve);
01094   <span class="keywordflow">if</span> (curve-&gt;piecewise)
01095     <span class="keywordflow">return</span> 0;
01096 
01097   limit = <a class="code" href="curve_8c.html#a9">get_real_point_count</a>(curve);
01098 
01099   <span class="keywordflow">if</span> (where &lt; 0 || where &gt; limit)
01100     <span class="keywordflow">return</span> 0;
01101   <span class="keywordflow">if</span> (curve-&gt;gamma)     <span class="comment">/* this means a pure gamma curve */</span>
01102     *result = <a class="code" href="curve_8c.html#a47">interpolate_gamma_internal</a>(curve, where);
01103   <span class="keywordflow">else</span>
01104     *result = <a class="code" href="curve_8c.html#a49">interpolate_point_internal</a>((<a class="code" href="structstp__curve.html">stp_curve_t</a> *) curve, where);
01105   <span class="keywordflow">return</span> 1;
01106 }
01107 
01108 <span class="keywordtype">int</span>
<a name="l01109"></a><a class="code" href="group__curve.html#ga51">01109</a> <a class="code" href="group__curve.html#ga51">stp_curve_resample</a>(stp_curve_t *curve, size_t points)
01110 {
01111   size_t limit = points;
01112   size_t old;
01113   size_t i;
01114   <span class="keywordtype">double</span> *new_vec;
01115 
01116   <a class="code" href="curve_8c.html#a8">check_curve</a>(curve);
01117 
01118   <span class="keywordflow">if</span> (points == <a class="code" href="curve_8c.html#a10">get_point_count</a>(curve) &amp;&amp; curve-&gt;seq &amp;&amp; !(curve-&gt;piecewise))
01119     <span class="keywordflow">return</span> 1;
01120 
01121   if (points &lt; 2)
01122     <span class="keywordflow">return</span> 1;
01123 
01124   <span class="keywordflow">if</span> (curve-&gt;wrap_mode == STP_CURVE_WRAP_AROUND)
01125     limit++;
01126   if (limit &gt; curve_point_limit)
01127     <span class="keywordflow">return</span> 0;
01128   old = <a class="code" href="curve_8c.html#a9">get_real_point_count</a>(curve);
01129   <span class="keywordflow">if</span> (old)
01130     old--;
01131   <span class="keywordflow">if</span> (!old)
01132     old = 1;
01133 
01134   new_vec = <a class="code" href="group__util.html#ga28">stp_malloc</a>(<span class="keyword">sizeof</span>(<span class="keywordtype">double</span>) * limit);
01135 
01136   <span class="comment">/*</span>
01137 <span class="comment">   * Be very careful how we calculate the location along the scale!</span>
01138 <span class="comment">   * If we're not careful how we do it, we might get a small roundoff</span>
01139 <span class="comment">   * error</span>
01140 <span class="comment">   */</span>
01141   <span class="keywordflow">if</span> (curve-&gt;piecewise)
01142     {
01143       <span class="keywordtype">double</span> blo, bhi;
01144       <span class="keywordtype">int</span> curpos = 0;
01145       <a class="code" href="group__sequence.html#ga6">stp_sequence_get_bounds</a>(curve-&gt;seq, &amp;blo, &amp;bhi);
01146       if (curve-&gt;recompute_interval)
01147         <a class="code" href="curve_8c.html#a17">compute_intervals</a>(curve);
01148       <span class="keywordflow">for</span> (i = 0; i &lt; old; i++)
01149         {
01150           <span class="keywordtype">double</span> low;
01151           <span class="keywordtype">double</span> high;
01152           <span class="keywordtype">double</span> low_y;
01153           <span class="keywordtype">double</span> high_y;
01154           <span class="keywordtype">double</span> x_delta;
01155           <span class="keywordflow">if</span> (!<a class="code" href="group__sequence.html#ga21">stp_sequence_get_point</a>(curve-&gt;seq, i * 2, &amp;low))
01156             {
01157               <a class="code" href="group__util.html#ga27">stp_free</a>(new_vec);
01158               <span class="keywordflow">return</span> 0;
01159             }
01160           <span class="keywordflow">if</span> (i == old - 1)
01161             high = 1.0;
01162           <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!<a class="code" href="group__sequence.html#ga21">stp_sequence_get_point</a>(curve-&gt;seq, ((i + 1) * 2), &amp;high))
01163             {
01164               <a class="code" href="group__util.html#ga27">stp_free</a>(new_vec);
01165               <span class="keywordflow">return</span> 0;
01166             }
01167           <span class="keywordflow">if</span> (!<a class="code" href="group__sequence.html#ga21">stp_sequence_get_point</a>(curve-&gt;seq, (i * 2) + 1, &amp;low_y))
01168             {
01169               <a class="code" href="group__util.html#ga27">stp_free</a>(new_vec);
01170               <span class="keywordflow">return</span> 0;
01171             }
01172           <span class="keywordflow">if</span> (!<a class="code" href="group__sequence.html#ga21">stp_sequence_get_point</a>(curve-&gt;seq, ((i + 1) * 2) + 1, &amp;high_y))
01173             {
01174               <a class="code" href="group__util.html#ga27">stp_free</a>(new_vec);
01175               <span class="keywordflow">return</span> 0;
01176             }
01177           <a class="code" href="print-util_8c.html#a24">stp_deprintf</a>(STP_DBG_CURVE,
01178                        <span class="stringliteral">"Filling slots at %d %d: %f %f  %f %f  %d\n"</span>,
01179                        i,curpos, high, low, high_y, low_y, limit);
01180           x_delta = high - low;
01181           high *= (limit - 1);
01182           low *= (limit - 1);
01183           <span class="keywordflow">while</span> (curpos &lt;= high)
01184             {
01185               <span class="keywordtype">double</span> frac = (curpos - low) / (high - low);
01186               <span class="keywordflow">if</span> (curve-&gt;curve_type == STP_CURVE_TYPE_LINEAR)
01187                 new_vec[curpos] = low_y + frac * (high_y - low_y);
01188               <span class="keywordflow">else</span>
01189                 new_vec[curpos] =
01190                   <a class="code" href="curve_8c.html#a48">do_interpolate_spline</a>(low_y, high_y, frac,
01191                                         curve-&gt;interval[i],
01192                                         curve-&gt;interval[i + 1],
01193                                         x_delta);
01194               if (new_vec[curpos] &lt; blo)
01195                 new_vec[curpos] = blo;
01196               <span class="keywordflow">if</span> (new_vec[curpos] &gt; bhi)
01197                 new_vec[curpos] = bhi;
01198               <a class="code" href="print-util_8c.html#a24">stp_deprintf</a>(STP_DBG_CURVE,
01199                            <span class="stringliteral">"  Filling slot %d %f %f\n"</span>,
01200                            curpos, frac, new_vec[curpos]);
01201               curpos++;
01202             }
01203         }
01204       curve-&gt;piecewise = 0;
01205     }
01206   <span class="keywordflow">else</span>
01207     {
01208       <span class="keywordflow">for</span> (i = 0; i &lt; limit; i++)
01209         <span class="keywordflow">if</span> (curve-&gt;gamma)
01210           new_vec[i] =
01211             <a class="code" href="curve_8c.html#a47">interpolate_gamma_internal</a>(curve, ((<span class="keywordtype">double</span>) i * (<span class="keywordtype">double</span>) old /
01212                                                (<span class="keywordtype">double</span>) (limit - 1)));
01213         <span class="keywordflow">else</span>
01214           new_vec[i] =
01215             <a class="code" href="curve_8c.html#a49">interpolate_point_internal</a>(curve, ((<span class="keywordtype">double</span>) i * (<span class="keywordtype">double</span>) old /
01216                                                (<span class="keywordtype">double</span>) (limit - 1)));
01217     }
01218   <a class="code" href="curve_8c.html#a18">stpi_curve_set_points</a>(curve, points);
01219   <a class="code" href="group__sequence.html#ga18">stp_sequence_set_subrange</a>(curve-&gt;seq, 0, limit, new_vec);
01220   curve-&gt;recompute_interval = 1;
01221   <a class="code" href="group__util.html#ga31">stp_free</a>(new_vec);
01222   <span class="keywordflow">return</span> 1;
01223 }
01224 
01225 <span class="keyword">static</span> <span class="keywordtype">unsigned</span>
<a name="l01226"></a><a class="code" href="curve_8c.html#a52">01226</a> <a class="code" href="print-weave_8c.html#a5">gcd</a>(<span class="keywordtype">unsigned</span> a, <span class="keywordtype">unsigned</span> b)
01227 {
01228   <span class="keywordtype">unsigned</span> tmp;
01229   <span class="keywordflow">if</span> (b &gt; a)
01230     {
01231       tmp = a;
01232       a = b;
01233       b = tmp;
01234     }
01235   <span class="keywordflow">while</span> (1)
01236     {
01237       tmp = a % b;
01238       <span class="keywordflow">if</span> (tmp == 0)
01239         <span class="keywordflow">return</span> b;
01240       a = b;
01241       b = tmp;
01242     }
01243 }
01244 
01245 <span class="keyword">static</span> <span class="keywordtype">unsigned</span>
<a name="l01246"></a><a class="code" href="curve_8c.html#a53">01246</a> <a class="code" href="print-escp2_8c.html#a82">lcm</a>(<span class="keywordtype">unsigned</span> a, <span class="keywordtype">unsigned</span> b)
01247 {
01248   <span class="keywordflow">if</span> (a == b)
01249     <span class="keywordflow">return</span> a;
01250   <span class="keywordflow">else</span> <span class="keywordflow">if</span> (a * b == 0)
01251     <span class="keywordflow">return</span> a &gt; b ? a : b;
01252   <span class="keywordflow">else</span>
01253     {
01254       <span class="keywordtype">double</span> rval = (<span class="keywordtype">double</span>) a / <a class="code" href="print-weave_8c.html#a5">gcd</a>(a, b) * b;
01255       <span class="keywordflow">if</span> (rval &gt; <a class="code" href="curve_8c.html#a3">curve_point_limit</a>)
01256         <span class="keywordflow">return</span> <a class="code" href="curve_8c.html#a3">curve_point_limit</a>;
01257       <span class="keywordflow">else</span>
01258         <span class="keywordflow">return</span> rval;
01259     }
01260 }
01261 
01262 <span class="keyword">static</span> <span class="keywordtype">int</span>
<a name="l01263"></a><a class="code" href="curve_8c.html#a54">01263</a> <a class="code" href="curve_8c.html#a54">create_gamma_curve</a>(stp_curve_t **retval, <span class="keywordtype">double</span> lo, <span class="keywordtype">double</span> hi, <span class="keywordtype">double</span> fgamma,
01264                    <span class="keywordtype">int</span> points)
01265 {
01266   *retval = <a class="code" href="group__curve.html#ga20">stp_curve_create</a>(<a class="code" href="group__curve.html#gga48a3">STP_CURVE_WRAP_NONE</a>);
01267   <span class="keywordflow">if</span> (<a class="code" href="group__curve.html#ga25">stp_curve_set_bounds</a>(*retval, lo, hi) &amp;&amp;
01268       <a class="code" href="group__curve.html#ga33">stp_curve_set_gamma</a>(*retval, fgamma) &amp;&amp;
01269       <a class="code" href="group__curve.html#ga51">stp_curve_resample</a>(*retval, points))
01270     <span class="keywordflow">return</span> 1;
01271   <a class="code" href="group__curve.html#ga22">stp_curve_destroy</a>(*retval);
01272   *retval = 0;
01273   <span class="keywordflow">return</span> 0;
01274 }
01275 
01276 <span class="keyword">static</span> <span class="keywordtype">int</span>
<a name="l01277"></a><a class="code" href="curve_8c.html#a55">01277</a> <a class="code" href="curve_8c.html#a55">interpolate_points</a>(stp_curve_t *a, stp_curve_t *b,
01278                    stp_curve_compose_t mode,
01279                    <span class="keywordtype">int</span> points, <span class="keywordtype">double</span> *tmp_data)
01280 {
01281   <span class="keywordtype">double</span> pa, pb;
01282   <span class="keywordtype">int</span> i;
01283   size_t points_a = <a class="code" href="group__curve.html#ga28">stp_curve_count_points</a>(a);
01284   size_t points_b = <a class="code" href="group__curve.html#ga28">stp_curve_count_points</a>(b);
01285   <span class="keywordflow">for</span> (i = 0; i &lt; points; i++)
01286     {
01287       <span class="keywordflow">if</span> (!<a class="code" href="group__curve.html#ga38">stp_curve_interpolate_value</a>
01288           (a, (<span class="keywordtype">double</span>) i * (points_a - 1) / (points - 1), &amp;pa))
01289         {
01290           <a class="code" href="print-util_8c.html#a24">stp_deprintf</a>(<a class="code" href="group__util.html#ga51">STP_DBG_CURVE_ERRORS</a>,
01291                        <span class="stringliteral">"interpolate_points: interpolate curve a value failed\n"</span>);
01292           <span class="keywordflow">return</span> 0;
01293         }
01294       <span class="keywordflow">if</span> (!<a class="code" href="group__curve.html#ga38">stp_curve_interpolate_value</a>
01295           (b, (<span class="keywordtype">double</span>) i * (points_b - 1) / (points - 1), &amp;pb))
01296         {
01297           <a class="code" href="print-util_8c.html#a24">stp_deprintf</a>(<a class="code" href="group__util.html#ga51">STP_DBG_CURVE_ERRORS</a>,
01298                        <span class="stringliteral">"interpolate_points: interpolate curve b value failed\n"</span>);
01299           <span class="keywordflow">return</span> 0;
01300         }
01301       <span class="keywordflow">if</span> (mode == <a class="code" href="group__curve.html#gga49a5">STP_CURVE_COMPOSE_ADD</a>)
01302         pa += pb;
01303       <span class="keywordflow">else</span>
01304         pa *= pb;
01305       <span class="keywordflow">if</span> (! finite(pa))
01306         {
01307           <a class="code" href="print-util_8c.html#a24">stp_deprintf</a>(<a class="code" href="group__util.html#ga51">STP_DBG_CURVE_ERRORS</a>,
01308                        <span class="stringliteral">"interpolate_points: interpolated point %lu is invalid\n"</span>,
01309                        (<span class="keywordtype">unsigned</span> <span class="keywordtype">long</span>) i);
01310           <span class="keywordflow">return</span> 0;
01311         }
01312       tmp_data[i] = pa;
01313     }
01314   <span class="keywordflow">return</span> 1;
01315 }
01316 
01317 <span class="keywordtype">int</span>
<a name="l01318"></a><a class="code" href="group__curve.html#ga56">01318</a> <a class="code" href="group__curve.html#ga56">stp_curve_compose</a>(stp_curve_t **retval,
01319                   stp_curve_t *a, stp_curve_t *b,
01320                   stp_curve_compose_t mode, <span class="keywordtype">int</span> points)
01321 {
01322   <a class="code" href="group__curve.html#ga0">stp_curve_t</a> *ret;
01323   <span class="keywordtype">double</span> *tmp_data;
01324   <span class="keywordtype">double</span> gamma_a = <a class="code" href="group__curve.html#ga34">stp_curve_get_gamma</a>(a);
01325   <span class="keywordtype">double</span> gamma_b = <a class="code" href="group__curve.html#ga34">stp_curve_get_gamma</a>(b);
01326   <span class="keywordtype">unsigned</span> points_a = <a class="code" href="group__curve.html#ga28">stp_curve_count_points</a>(a);
01327   <span class="keywordtype">unsigned</span> points_b = <a class="code" href="group__curve.html#ga28">stp_curve_count_points</a>(b);
01328   <span class="keywordtype">double</span> alo, ahi, blo, bhi;
01329 
01330   <span class="keywordflow">if</span> (a-&gt;<a class="code" href="structstp__curve.html#o2">piecewise</a> &amp;&amp; b-&gt;<a class="code" href="structstp__curve.html#o2">piecewise</a>)
01331     <span class="keywordflow">return</span> 0;
01332   <span class="keywordflow">if</span> (a-&gt;<a class="code" href="structstp__curve.html#o2">piecewise</a>)
01333     {
01334       <a class="code" href="group__curve.html#ga0">stp_curve_t</a> *a_save = a;
01335       a = <a class="code" href="group__curve.html#ga24">stp_curve_create_copy</a>(a_save);
01336       <a class="code" href="group__curve.html#ga51">stp_curve_resample</a>(a, <a class="code" href="group__curve.html#ga28">stp_curve_count_points</a>(b));
01337     }
01338   <span class="keywordflow">if</span> (b-&gt;<a class="code" href="structstp__curve.html#o2">piecewise</a>)
01339     {
01340       <a class="code" href="group__curve.html#ga0">stp_curve_t</a> *b_save = b;
01341       b = <a class="code" href="group__curve.html#ga24">stp_curve_create_copy</a>(b_save);
01342       <a class="code" href="group__curve.html#ga51">stp_curve_resample</a>(b, <a class="code" href="group__curve.html#ga28">stp_curve_count_points</a>(a));
01343     }
01344 
01345   <span class="keywordflow">if</span> (mode != <a class="code" href="group__curve.html#gga49a5">STP_CURVE_COMPOSE_ADD</a> &amp;&amp; mode != <a class="code" href="group__curve.html#gga49a6">STP_CURVE_COMPOSE_MULTIPLY</a>)
01346     <span class="keywordflow">return</span> 0;
01347   <span class="keywordflow">if</span> (<a class="code" href="group__curve.html#ga29">stp_curve_get_wrap</a>(a) != <a class="code" href="group__curve.html#ga29">stp_curve_get_wrap</a>(b))
01348     <span class="keywordflow">return</span> 0;
01349   <a class="code" href="group__curve.html#ga26">stp_curve_get_bounds</a>(a, &amp;alo, &amp;ahi);
01350   <a class="code" href="group__curve.html#ga26">stp_curve_get_bounds</a>(b, &amp;blo, &amp;bhi);
01351   <span class="keywordflow">if</span> (mode == <a class="code" href="group__curve.html#gga49a6">STP_CURVE_COMPOSE_MULTIPLY</a> &amp;&amp; (alo &lt; 0 || blo &lt; 0))
01352     <span class="keywordflow">return</span> 0;
01353 
01354   <span class="keywordflow">if</span> (<a class="code" href="group__curve.html#ga29">stp_curve_get_wrap</a>(a) == <a class="code" href="group__curve.html#gga48a4">STP_CURVE_WRAP_AROUND</a>)
01355     {
01356       points_a++;
01357       points_b++;
01358     }
01359   <span class="keywordflow">if</span> (points == -1)
01360     {
01361       points = <a class="code" href="print-escp2_8c.html#a82">lcm</a>(points_a, points_b);
01362       <span class="keywordflow">if</span> (<a class="code" href="group__curve.html#ga29">stp_curve_get_wrap</a>(a) == <a class="code" href="group__curve.html#gga48a4">STP_CURVE_WRAP_AROUND</a>)
01363         points--;
01364     }
01365   <span class="keywordflow">if</span> (points &lt; 2 || points &gt; <a class="code" href="curve_8c.html#a3">curve_point_limit</a> ||
01366       ((<a class="code" href="group__curve.html#ga29">stp_curve_get_wrap</a>(a) == <a class="code" href="group__curve.html#gga48a4">STP_CURVE_WRAP_AROUND</a>) &amp;&amp;
01367        points &gt; <a class="code" href="curve_8c.html#a3">curve_point_limit</a> - 1))
01368     <span class="keywordflow">return</span> 0;
01369 
01370   <span class="keywordflow">if</span> (gamma_a &amp;&amp; gamma_b &amp;&amp; gamma_a * gamma_b &gt; 0 &amp;&amp;
01371       mode == <a class="code" href="group__curve.html#gga49a6">STP_CURVE_COMPOSE_MULTIPLY</a>)
01372     <span class="keywordflow">return</span> <a class="code" href="curve_8c.html#a54">create_gamma_curve</a>(retval, alo * blo, ahi * bhi, gamma_a + gamma_b,
01373                               points);
01374   tmp_data = <a class="code" href="group__util.html#ga28">stp_malloc</a>(<span class="keyword">sizeof</span>(<span class="keywordtype">double</span>) * points);
01375   <span class="keywordflow">if</span> (!<a class="code" href="curve_8c.html#a55">interpolate_points</a>(a, b, mode, points, tmp_data))
01376     {
01377       <a class="code" href="group__util.html#ga31">stp_free</a>(tmp_data);
01378       <span class="keywordflow">return</span> 0;
01379     }
01380   ret = <a class="code" href="group__curve.html#ga20">stp_curve_create</a>(<a class="code" href="group__curve.html#ga29">stp_curve_get_wrap</a>(a));
01381   <span class="keywordflow">if</span> (mode == <a class="code" href="group__curve.html#gga49a5">STP_CURVE_COMPOSE_ADD</a>)
01382     {
01383       <a class="code" href="group__curve.html#ga45">stp_curve_rescale</a>(ret, (ahi - alo) + (bhi - blo),
01384                         <a class="code" href="group__curve.html#gga49a6">STP_CURVE_COMPOSE_MULTIPLY</a>, <a class="code" href="group__curve.html#gga50a8">STP_CURVE_BOUNDS_RESCALE</a>);
01385       <a class="code" href="group__curve.html#ga45">stp_curve_rescale</a>(ret, alo + blo,
01386                         <a class="code" href="group__curve.html#gga49a5">STP_CURVE_COMPOSE_ADD</a>, <a class="code" href="group__curve.html#gga50a8">STP_CURVE_BOUNDS_RESCALE</a>);
01387     }
01388   <span class="keywordflow">else</span>
01389     {
01390       <a class="code" href="group__curve.html#ga45">stp_curve_rescale</a>(ret, (ahi - alo) * (bhi - blo),
01391                         <a class="code" href="group__curve.html#gga49a6">STP_CURVE_COMPOSE_MULTIPLY</a>, <a class="code" href="group__curve.html#gga50a8">STP_CURVE_BOUNDS_RESCALE</a>);
01392       <a class="code" href="group__curve.html#ga45">stp_curve_rescale</a>(ret, alo * blo,
01393                         <a class="code" href="group__curve.html#gga49a5">STP_CURVE_COMPOSE_ADD</a>, <a class="code" href="group__curve.html#gga50a8">STP_CURVE_BOUNDS_RESCALE</a>);
01394     }
01395   <span class="keywordflow">if</span> (! <a class="code" href="group__curve.html#ga35">stp_curve_set_data</a>(ret, points, tmp_data))
01396     <span class="keywordflow">goto</span> bad1;
01397   *retval = ret;
01398   <a class="code" href="group__util.html#ga31">stp_free</a>(tmp_data);
01399   <span class="keywordflow">return</span> 1;
01400  bad1:
01401   <a class="code" href="group__curve.html#ga22">stp_curve_destroy</a>(ret);
01402   <a class="code" href="group__util.html#ga31">stp_free</a>(tmp_data);
01403   <span class="keywordflow">return</span> 0;
01404 }
01405 
01406 
01407 <a class="code" href="group__curve.html#ga0">stp_curve_t</a> *
<a name="l01408"></a><a class="code" href="curve_8c.html#a57">01408</a> <a class="code" href="curve_8c.html#a57">stp_curve_create_from_xmltree</a>(<a class="code" href="structstp__mxml__node__s.html">stp_mxml_node_t</a> *curve)  <span class="comment">/* The curve node */</span>
01409 {
01410   <span class="keyword">const</span> <span class="keywordtype">char</span> *stmp;                       <span class="comment">/* Temporary string */</span>
01411   <a class="code" href="structstp__mxml__node__s.html">stp_mxml_node_t</a> *child;                 <span class="comment">/* Child sequence node */</span>
01412   <a class="code" href="group__curve.html#ga0">stp_curve_t</a> *ret = NULL;                <span class="comment">/* Curve to return */</span>
01413   <a class="code" href="group__curve.html#ga47">stp_curve_type_t</a> curve_type;            <span class="comment">/* Type of curve */</span>
01414   <a class="code" href="group__curve.html#ga48">stp_curve_wrap_mode_t</a> wrap_mode;        <span class="comment">/* Curve wrap mode */</span>
01415   <span class="keywordtype">double</span> fgamma;                          <span class="comment">/* Gamma value */</span>
01416   <a class="code" href="structstp__sequence.html">stp_sequence_t</a> *seq = NULL;             <span class="comment">/* Sequence data */</span>
01417   <span class="keywordtype">double</span> low, high;                       <span class="comment">/* Sequence bounds */</span>
01418   <span class="keywordtype">int</span> piecewise = 0;
01419 
01420   <a class="code" href="xml_8h.html#a10">stp_xml_init</a>();
01421   <span class="comment">/* Get curve type */</span>
01422   stmp = <a class="code" href="mxml-attr_8c.html#a0">stp_mxmlElementGetAttr</a>(curve, <span class="stringliteral">"type"</span>);
01423   <span class="keywordflow">if</span> (stmp)
01424     {
01425       <span class="keywordflow">if</span> (!strcmp(stmp, <span class="stringliteral">"linear"</span>))
01426           curve_type = <a class="code" href="group__curve.html#gga47a1">STP_CURVE_TYPE_LINEAR</a>;
01427       <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!strcmp(stmp, <span class="stringliteral">"spline"</span>))
01428           curve_type = <a class="code" href="group__curve.html#gga47a2">STP_CURVE_TYPE_SPLINE</a>;
01429       <span class="keywordflow">else</span>
01430         {
01431           <a class="code" href="print-util_8c.html#a24">stp_deprintf</a>(<a class="code" href="group__util.html#ga51">STP_DBG_CURVE_ERRORS</a>,
01432                        <span class="stringliteral">"stp_curve_create_from_xmltree: %s: \"type\" invalid\n"</span>, stmp);
01433           <span class="keywordflow">goto</span> error;
01434         }
01435     }
01436   <span class="keywordflow">else</span>
01437     {
01438       <a class="code" href="print-util_8c.html#a24">stp_deprintf</a>(<a class="code" href="group__util.html#ga51">STP_DBG_CURVE_ERRORS</a>,
01439                    <span class="stringliteral">"stp_curve_create_from_xmltree: \"type\" missing\n"</span>);
01440       <span class="keywordflow">goto</span> error;
01441     }
01442   <span class="comment">/* Get curve wrap mode */</span>
01443   stmp = <a class="code" href="mxml-attr_8c.html#a0">stp_mxmlElementGetAttr</a>(curve, <span class="stringliteral">"wrap"</span>);
01444   <span class="keywordflow">if</span> (stmp)
01445     {
01446       <span class="keywordflow">if</span> (!strcmp(stmp, <span class="stringliteral">"nowrap"</span>))
01447         wrap_mode = <a class="code" href="group__curve.html#gga48a3">STP_CURVE_WRAP_NONE</a>;
01448       <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!strcmp(stmp, <span class="stringliteral">"wrap"</span>))
01449         {
01450           wrap_mode = <a class="code" href="group__curve.html#gga48a4">STP_CURVE_WRAP_AROUND</a>;
01451         }
01452       <span class="keywordflow">else</span>
01453         {
01454           <a class="code" href="print-util_8c.html#a24">stp_deprintf</a>(<a class="code" href="group__util.html#ga51">STP_DBG_CURVE_ERRORS</a>,
01455                        <span class="stringliteral">"stp_curve_create_from_xmltree: %s: \"wrap\" invalid\n"</span>, stmp);
01456           <span class="keywordflow">goto</span> error;
01457         }
01458     }
01459   <span class="keywordflow">else</span>
01460     {
01461       <a class="code" href="print-util_8c.html#a24">stp_deprintf</a>(<a class="code" href="group__util.html#ga51">STP_DBG_CURVE_ERRORS</a>,
01462                    <span class="stringliteral">"stp_curve_create_from_xmltree: \"wrap\" missing\n"</span>);
01463       <span class="keywordflow">goto</span> error;
01464     }
01465   <span class="comment">/* Get curve gamma */</span>
01466   stmp = <a class="code" href="mxml-attr_8c.html#a0">stp_mxmlElementGetAttr</a>(curve, <span class="stringliteral">"gamma"</span>);
01467   <span class="keywordflow">if</span> (stmp)
01468     {
01469       fgamma = <a class="code" href="xml_8c.html#a23">stp_xmlstrtod</a>(stmp);
01470     }
01471   <span class="keywordflow">else</span>
01472     {
01473       <a class="code" href="print-util_8c.html#a24">stp_deprintf</a>(<a class="code" href="group__util.html#ga51">STP_DBG_CURVE_ERRORS</a>,
01474                    <span class="stringliteral">"stp_curve_create_from_xmltree: \"gamma\" missing\n"</span>);
01475       <span class="keywordflow">goto</span> error;
01476     }
01477   <span class="comment">/* If gamma is set, wrap_mode must be STP_CURVE_WRAP_NONE */</span>
01478   <span class="keywordflow">if</span> (fgamma &amp;&amp; wrap_mode != <a class="code" href="group__curve.html#gga48a3">STP_CURVE_WRAP_NONE</a>)
01479     {
01480       <a class="code" href="print-util_8c.html#a24">stp_deprintf</a>(<a class="code" href="group__util.html#ga51">STP_DBG_CURVE_ERRORS</a>, <span class="stringliteral">"stp_curve_create_from_xmltree: "</span>
01481                    <span class="stringliteral">"gamma set and \"wrap\" is not STP_CURVE_WRAP_NONE\n"</span>);
01482       <span class="keywordflow">goto</span> error;
01483     }
01484   stmp = <a class="code" href="mxml-attr_8c.html#a0">stp_mxmlElementGetAttr</a>(curve, <span class="stringliteral">"piecewise"</span>);
01485   <span class="keywordflow">if</span> (stmp &amp;&amp; strcmp(stmp, <span class="stringliteral">"true"</span>) == 0)
01486     piecewise = 1;
01487 
01488   <span class="comment">/* Set up the curve */</span>
01489   ret = <a class="code" href="group__curve.html#ga20">stp_curve_create</a>(wrap_mode);
01490   <a class="code" href="group__curve.html#ga31">stp_curve_set_interpolation_type</a>(ret, curve_type);
01491 
01492   child = <a class="code" href="mxml-search_8c.html#a0">stp_mxmlFindElement</a>(curve, curve, <span class="stringliteral">"sequence"</span>, NULL, NULL, <a class="code" href="mxml_8h.html#a4">STP_MXML_DESCEND</a>);
01493   <span class="keywordflow">if</span> (child)
01494     seq = <a class="code" href="sequence_8c.html#a22">stp_sequence_create_from_xmltree</a>(child);
01495 
01496   <span class="keywordflow">if</span> (seq == NULL)
01497     {
01498       <a class="code" href="print-util_8c.html#a24">stp_deprintf</a>(<a class="code" href="group__util.html#ga51">STP_DBG_CURVE_ERRORS</a>,
01499                    <span class="stringliteral">"stp_curve_create_from_xmltree: sequence read failed\n"</span>);
01500       <span class="keywordflow">goto</span> error;
01501     }
01502 
01503   <span class="comment">/* Set curve bounds */</span>
01504   <a class="code" href="group__sequence.html#ga12">stp_sequence_get_bounds</a>(seq, &amp;low, &amp;high);
01505   <a class="code" href="group__curve.html#ga25">stp_curve_set_bounds</a>(ret, low, high);
01506 
01507   <span class="keywordflow">if</span> (fgamma)
01508     <a class="code" href="group__curve.html#ga33">stp_curve_set_gamma</a>(ret, fgamma);
01509   <span class="keywordflow">else</span> <span class="comment">/* Not a gamma curve, so set points */</span>
01510     {
01511       size_t seq_count;
01512       <span class="keyword">const</span> <span class="keywordtype">double</span>* data;
01513 
01514       <a class="code" href="group__sequence.html#ga19">stp_sequence_get_data</a>(seq, &amp;seq_count, &amp;data);
01515       <span class="keywordflow">if</span> (piecewise)
01516         {
01517           <span class="keywordflow">if</span> ((seq_count % 2) != 0)
01518             {
01519               <a class="code" href="print-util_8c.html#a24">stp_deprintf</a>(<a class="code" href="group__util.html#ga51">STP_DBG_CURVE_ERRORS</a>,
01520                            <span class="stringliteral">"stp_curve_create_from_xmltree: invalid data count %d\n"</span>,
01521                            seq_count);
01522               <span class="keywordflow">goto</span> error;
01523             }
01524           <span class="keywordflow">if</span> (<a class="code" href="group__curve.html#ga36">stp_curve_set_data_points</a>(ret, seq_count / 2,
01525                                         (<span class="keyword">const</span> <a class="code" href="structstp__curve__point__t.html">stp_curve_point_t</a> *) data) == 0)
01526             {
01527               <a class="code" href="print-util_8c.html#a24">stp_deprintf</a>(<a class="code" href="group__util.html#ga51">STP_DBG_CURVE_ERRORS</a>,
01528                            <span class="stringliteral">"stp_curve_create_from_xmltree: failed to set curve data points\n"</span>);
01529               <span class="keywordflow">goto</span> error;
01530             }
01531         }
01532       <span class="keywordflow">else</span>
01533         {
01534           <span class="keywordflow">if</span> (<a class="code" href="group__curve.html#ga35">stp_curve_set_data</a>(ret, seq_count, data) == 0)
01535             {
01536               <a class="code" href="print-util_8c.html#a24">stp_deprintf</a>(<a class="code" href="group__util.html#ga51">STP_DBG_CURVE_ERRORS</a>,
01537                            <span class="stringliteral">"stp_curve_create_from_xmltree: failed to set curve data\n"</span>);
01538               <span class="keywordflow">goto</span> error;
01539             }
01540         }
01541     }
01542 
01543   <span class="keywordflow">if</span> (seq)
01544     {
01545       <a class="code" href="group__sequence.html#ga8">stp_sequence_destroy</a>(seq);
01546       seq = NULL;
01547     }
01548 
01549     <span class="comment">/* Validate curve */</span>
01550   <span class="keywordflow">if</span> (<a class="code" href="curve_8c.html#a46">stpi_curve_check_parameters</a>(ret, <a class="code" href="group__curve.html#ga28">stp_curve_count_points</a>(ret)) == 0)
01551     {
01552       <a class="code" href="print-util_8c.html#a24">stp_deprintf</a>(<a class="code" href="group__util.html#ga51">STP_DBG_CURVE_ERRORS</a>,
01553                    <span class="stringliteral">"stp_curve_create_from_xmltree: parameter check failed\n"</span>);
01554       <span class="keywordflow">goto</span> error;
01555     }
01556 
01557   <a class="code" href="xml_8h.html#a11">stp_xml_exit</a>();
01558 
01559   <span class="keywordflow">return</span> ret;
01560 
01561  error:
01562   <a class="code" href="print-util_8c.html#a24">stp_deprintf</a>(<a class="code" href="group__util.html#ga51">STP_DBG_CURVE_ERRORS</a>,
01563                <span class="stringliteral">"stp_curve_create_from_xmltree: error during curve read\n"</span>);
01564   <span class="keywordflow">if</span> (ret)
01565     <a class="code" href="group__curve.html#ga22">stp_curve_destroy</a>(ret);
01566   <a class="code" href="xml_8h.html#a11">stp_xml_exit</a>();
01567   <span class="keywordflow">return</span> NULL;
01568 }
01569 
01570 
01571 <a class="code" href="structstp__mxml__node__s.html">stp_mxml_node_t</a> *
<a name="l01572"></a><a class="code" href="curve_8c.html#a58">01572</a> <a class="code" href="curve_8c.html#a58">stp_xmltree_create_from_curve</a>(<span class="keyword">const</span> stp_curve_t *curve)  <span class="comment">/* The curve */</span>
01573 {
01574   <a class="code" href="group__curve.html#ga48">stp_curve_wrap_mode_t</a> wrapmode;
01575   <a class="code" href="group__curve.html#ga47">stp_curve_type_t</a> interptype;
01576   <span class="keywordtype">double</span> gammaval, low, high;
01577   <a class="code" href="structstp__sequence.html">stp_sequence_t</a> *seq;
01578 
01579   <span class="keywordtype">char</span> *cgamma;
01580 
01581   <a class="code" href="structstp__mxml__node__s.html">stp_mxml_node_t</a> *curvenode = NULL;
01582   <a class="code" href="structstp__mxml__node__s.html">stp_mxml_node_t</a> *child = NULL;
01583 
01584   <a class="code" href="xml_8h.html#a10">stp_xml_init</a>();
01585 
01586   <span class="comment">/* Get curve details */</span>
01587   wrapmode = <a class="code" href="group__curve.html#ga29">stp_curve_get_wrap</a>(curve);
01588   interptype = <a class="code" href="group__curve.html#ga32">stp_curve_get_interpolation_type</a>(curve);
01589   gammaval = <a class="code" href="group__curve.html#ga34">stp_curve_get_gamma</a>(curve);
01590 
01591   <span class="keywordflow">if</span> (gammaval &amp;&amp; wrapmode != <a class="code" href="group__curve.html#gga48a3">STP_CURVE_WRAP_NONE</a>)
01592     {
01593       <a class="code" href="print-util_8c.html#a24">stp_deprintf</a>(<a class="code" href="group__util.html#ga51">STP_DBG_CURVE_ERRORS</a>, <span class="stringliteral">"stp_xmltree_create_from_curve: "</span>
01594                    <span class="stringliteral">"curve sets gamma and wrap_mode is not STP_CURVE_WRAP_NONE\n"</span>);
01595       <span class="keywordflow">goto</span> error;
01596     }
01597 
01598   <span class="comment">/* Construct the allocated strings required */</span>
01599   <a class="code" href="print-util_8c.html#a8">stp_asprintf</a>(&amp;cgamma, <span class="stringliteral">"%g"</span>, gammaval);
01600 
01601   curvenode = <a class="code" href="mxml-node_8c.html#a3">stp_mxmlNewElement</a>(NULL, <span class="stringliteral">"curve"</span>);
01602   <a class="code" href="mxml-attr_8c.html#a1">stp_mxmlElementSetAttr</a>(curvenode, <span class="stringliteral">"wrap"</span>, <a class="code" href="curve_8c.html#a6">stpi_wrap_mode_names</a>[wrapmode]);
01603   <a class="code" href="mxml-attr_8c.html#a1">stp_mxmlElementSetAttr</a>(curvenode, <span class="stringliteral">"type"</span>, <a class="code" href="curve_8c.html#a4">stpi_curve_type_names</a>[interptype]);
01604   <a class="code" href="mxml-attr_8c.html#a1">stp_mxmlElementSetAttr</a>(curvenode, <span class="stringliteral">"gamma"</span>, cgamma);
01605   <span class="keywordflow">if</span> (curve-&gt;<a class="code" href="structstp__curve.html#o2">piecewise</a>)
01606     <a class="code" href="mxml-attr_8c.html#a1">stp_mxmlElementSetAttr</a>(curvenode, <span class="stringliteral">"piecewise"</span>, <span class="stringliteral">"true"</span>);
01607   <span class="keywordflow">else</span>
01608     <a class="code" href="mxml-attr_8c.html#a1">stp_mxmlElementSetAttr</a>(curvenode, <span class="stringliteral">"piecewise"</span>, <span class="stringliteral">"false"</span>);
01609 
01610   <a class="code" href="group__util.html#ga31">stp_free</a>(cgamma);
01611 
01612   seq = <a class="code" href="group__sequence.html#ga1">stp_sequence_create</a>();
01613   <a class="code" href="group__curve.html#ga26">stp_curve_get_bounds</a>(curve, &amp;low, &amp;high);
01614   <a class="code" href="group__sequence.html#ga11">stp_sequence_set_bounds</a>(seq, low, high);
01615   <span class="keywordflow">if</span> (gammaval != 0) <span class="comment">/* A gamma curve does not require sequence data */</span>
01616     {
01617       <a class="code" href="group__sequence.html#ga15">stp_sequence_set_size</a>(seq, 0);
01618     }
01619   <span class="keywordflow">else</span>
01620     {
01621       <span class="keyword">const</span> <span class="keywordtype">double</span> *data;
01622       size_t count;
01623       data = <a class="code" href="curve_8c.html#a39">stpi_curve_get_data_internal</a>(curve, &amp;count);
01624       <a class="code" href="group__sequence.html#ga17">stp_sequence_set_data</a>(seq, count, data);
01625     }
01626 
01627   child = <a class="code" href="sequence_8c.html#a23">stp_xmltree_create_from_sequence</a>(seq);
01628 
01629   <span class="keywordflow">if</span> (seq)
01630     {
01631       <a class="code" href="group__sequence.html#ga8">stp_sequence_destroy</a>(seq);
01632       seq = NULL;
01633     }
01634 
01635   <span class="keywordflow">if</span> (child == NULL)
01636     {
01637       <a class="code" href="print-util_8c.html#a24">stp_deprintf</a>(<a class="code" href="group__util.html#ga51">STP_DBG_CURVE_ERRORS</a>,
01638                    <span class="stringliteral">"stp_xmltree_create_from_curve: sequence node is NULL\n"</span>);
01639       <span class="keywordflow">goto</span> error;
01640     }
01641   <a class="code" href="mxml-node_8c.html#a1">stp_mxmlAdd</a>(curvenode, <a class="code" href="mxml_8h.html#a12">STP_MXML_ADD_AFTER</a>, NULL, child);
01642 
01643   <a class="code" href="xml_8h.html#a11">stp_xml_exit</a>();
01644 
01645   <span class="keywordflow">return</span> curvenode;
01646 
01647  error:
01648   <a class="code" href="print-util_8c.html#a24">stp_deprintf</a>(<a class="code" href="group__util.html#ga51">STP_DBG_CURVE_ERRORS</a>,
01649                <span class="stringliteral">"stp_xmltree_create_from_curve: error during xmltree creation\n"</span>);
01650   <span class="keywordflow">if</span> (curvenode)
01651     <a class="code" href="mxml-node_8c.html#a2">stp_mxmlDelete</a>(curvenode);
01652   <span class="keywordflow">if</span> (child)
01653     <a class="code" href="mxml-node_8c.html#a2">stp_mxmlDelete</a>(child);
01654   <a class="code" href="xml_8h.html#a11">stp_xml_exit</a>();
01655 
01656   <span class="keywordflow">return</span> NULL;
01657 }
01658 
01659 <span class="keyword">static</span> <a class="code" href="structstp__mxml__node__s.html">stp_mxml_node_t</a> *
<a name="l01660"></a><a class="code" href="curve_8c.html#a59">01660</a> <a class="code" href="curve_8c.html#a59">xmldoc_create_from_curve</a>(<span class="keyword">const</span> stp_curve_t *curve)
01661 {
01662   <a class="code" href="structstp__mxml__node__s.html">stp_mxml_node_t</a> *xmldoc;
01663   <a class="code" href="structstp__mxml__node__s.html">stp_mxml_node_t</a> *rootnode;
01664   <a class="code" href="structstp__mxml__node__s.html">stp_mxml_node_t</a> *curvenode;
01665 
01666   <span class="comment">/* Get curve details */</span>
01667   curvenode = <a class="code" href="curve_8c.html#a58">stp_xmltree_create_from_curve</a>(curve);
01668   <span class="keywordflow">if</span> (curvenode == NULL)
01669     {
01670       <a class="code" href="print-util_8c.html#a24">stp_deprintf</a>(<a class="code" href="group__util.html#ga51">STP_DBG_CURVE_ERRORS</a>,
01671                    <span class="stringliteral">"xmldoc_create_from_curve: error creating curve node\n"</span>);
01672       <span class="keywordflow">return</span> NULL;
01673     }
01674   <span class="comment">/* Create the XML tree */</span>
01675   xmldoc = <a class="code" href="xml_8h.html#a13">stp_xmldoc_create_generic</a>();
01676   <span class="keywordflow">if</span> (xmldoc == NULL)
01677     {
01678       <a class="code" href="print-util_8c.html#a24">stp_deprintf</a>(<a class="code" href="group__util.html#ga51">STP_DBG_CURVE_ERRORS</a>,
01679                    <span class="stringliteral">"xmldoc_create_from_curve: error creating XML document\n"</span>);
01680       <span class="keywordflow">return</span> NULL;
01681     }
01682   rootnode = xmldoc-&gt;<a class="code" href="structstp__mxml__node__s.html#o4">child</a>;
01683   <span class="keywordflow">if</span> (rootnode == NULL)
01684     {
01685       <a class="code" href="mxml-node_8c.html#a2">stp_mxmlDelete</a>(xmldoc);
01686       <a class="code" href="print-util_8c.html#a24">stp_deprintf</a>(<a class="code" href="group__util.html#ga51">STP_DBG_CURVE_ERRORS</a>,
01687                    <span class="stringliteral">"xmldoc_create_from_curve: error getting XML document root node\n"</span>);
01688       <span class="keywordflow">return</span> NULL;
01689     }
01690 
01691   <a class="code" href="mxml-node_8c.html#a1">stp_mxmlAdd</a>(rootnode, <a class="code" href="mxml_8h.html#a12">STP_MXML_ADD_AFTER</a>, NULL, curvenode);
01692 
01693   <span class="keywordflow">return</span> xmldoc;
01694 }
01695 
01696 <span class="keyword">static</span> <span class="keywordtype">int</span>
<a name="l01697"></a><a class="code" href="curve_8c.html#a60">01697</a> <a class="code" href="curve_8c.html#a60">curve_whitespace_callback</a>(<a class="code" href="structstp__mxml__node__s.html">stp_mxml_node_t</a> *node, <span class="keywordtype">int</span> where)
01698 {
01699   <span class="keywordflow">if</span> (node-&gt;<a class="code" href="structstp__mxml__node__s.html#o0">type</a> != <a class="code" href="mxml_8h.html#a43a20">STP_MXML_ELEMENT</a>)
01700     <span class="keywordflow">return</span> 0;
01701   <span class="keywordflow">if</span> (strcasecmp(node-&gt;<a class="code" href="structstp__mxml__node__s.html#o6">value</a>.<a class="code" href="unionstp__mxml__value__u.html#o0">element</a>.<a class="code" href="structstp__mxml__value__s.html#o0">name</a>, <span class="stringliteral">"gimp-print"</span>) == 0)
01702     {
01703       <span class="keywordflow">switch</span> (where)
01704         {
01705         <span class="keywordflow">case</span> <a class="code" href="mxml_8h.html#a8">STP_MXML_WS_AFTER_OPEN</a>:
01706         <span class="keywordflow">case</span> <a class="code" href="mxml_8h.html#a9">STP_MXML_WS_BEFORE_CLOSE</a>:
01707         <span class="keywordflow">case</span> <a class="code" href="mxml_8h.html#a10">STP_MXML_WS_AFTER_CLOSE</a>:
01708           <span class="keywordflow">return</span> <span class="charliteral">'\n'</span>;
01709         <span class="keywordflow">case</span> <a class="code" href="mxml_8h.html#a7">STP_MXML_WS_BEFORE_OPEN</a>:
01710         <span class="keywordflow">default</span>:
01711           <span class="keywordflow">return</span> 0;
01712         }
01713     }
01714   <span class="keywordflow">else</span> <span class="keywordflow">if</span> (strcasecmp(node-&gt;<a class="code" href="structstp__mxml__node__s.html#o6">value</a>.<a class="code" href="unionstp__mxml__value__u.html#o0">element</a>.<a class="code" href="structstp__mxml__value__s.html#o0">name</a>, <span class="stringliteral">"curve"</span>) == 0)
01715     {
01716       <span class="keywordflow">switch</span> (where)
01717         {
01718         <span class="keywordflow">case</span> <a class="code" href="mxml_8h.html#a8">STP_MXML_WS_AFTER_OPEN</a>:
01719           <span class="keywordflow">return</span> <span class="charliteral">'\n'</span>;
01720         <span class="keywordflow">case</span> <a class="code" href="mxml_8h.html#a9">STP_MXML_WS_BEFORE_CLOSE</a>:
01721         <span class="keywordflow">case</span> <a class="code" href="mxml_8h.html#a10">STP_MXML_WS_AFTER_CLOSE</a>:
01722         <span class="keywordflow">case</span> <a class="code" href="mxml_8h.html#a7">STP_MXML_WS_BEFORE_OPEN</a>:
01723         <span class="keywordflow">default</span>:
01724           <span class="keywordflow">return</span> 0;
01725         }
01726     }
01727   <span class="keywordflow">else</span> <span class="keywordflow">if</span> (strcasecmp(node-&gt;<a class="code" href="structstp__mxml__node__s.html#o6">value</a>.<a class="code" href="unionstp__mxml__value__u.html#o0">element</a>.<a class="code" href="structstp__mxml__value__s.html#o0">name</a>, <span class="stringliteral">"sequence"</span>) == 0)
01728     {
01729       <span class="keyword">const</span> <span class="keywordtype">char</span> *count;
01730       <span class="keywordflow">switch</span> (where)
01731         {
01732         <span class="keywordflow">case</span> <a class="code" href="mxml_8h.html#a9">STP_MXML_WS_BEFORE_CLOSE</a>:
01733           count = <a class="code" href="mxml-attr_8c.html#a0">stp_mxmlElementGetAttr</a>(node, <span class="stringliteral">"count"</span>);
01734           <span class="keywordflow">if</span> (strcmp(count, <span class="stringliteral">"0"</span>) == 0)
01735             <span class="keywordflow">return</span> 0;
01736           <span class="keywordflow">else</span>
01737             <span class="keywordflow">return</span> <span class="charliteral">'\n'</span>;
01738         <span class="keywordflow">case</span> <a class="code" href="mxml_8h.html#a8">STP_MXML_WS_AFTER_OPEN</a>:
01739         <span class="keywordflow">case</span> <a class="code" href="mxml_8h.html#a10">STP_MXML_WS_AFTER_CLOSE</a>:
01740           <span class="keywordflow">return</span> <span class="charliteral">'\n'</span>;
01741         <span class="keywordflow">case</span> <a class="code" href="mxml_8h.html#a7">STP_MXML_WS_BEFORE_OPEN</a>:
01742         <span class="keywordflow">default</span>:
01743           <span class="keywordflow">return</span> 0;
01744         }
01745     }
01746   <span class="keywordflow">else</span>
01747     <span class="keywordflow">return</span> 0;
01748 }
01749 
01750 
01751 <span class="keywordtype">int</span>
<a name="l01752"></a><a class="code" href="group__curve.html#ga61">01752</a> <a class="code" href="group__curve.html#ga61">stp_curve_write</a>(FILE *file, <span class="keyword">const</span> stp_curve_t *curve)  <span class="comment">/* The curve */</span>
01753 {
01754   <a class="code" href="structstp__mxml__node__s.html">stp_mxml_node_t</a> *xmldoc = NULL;
01755 
01756   <a class="code" href="xml_8h.html#a10">stp_xml_init</a>();
01757 
01758   xmldoc = <a class="code" href="curve_8c.html#a59">xmldoc_create_from_curve</a>(curve);
01759   <span class="keywordflow">if</span> (xmldoc == NULL)
01760     {
01761       <a class="code" href="xml_8h.html#a11">stp_xml_exit</a>();
01762       <span class="keywordflow">return</span> 1;
01763     }
01764 
01765   <a class="code" href="mxml-file_8c.html#a13">stp_mxmlSaveFile</a>(xmldoc, file, <a class="code" href="curve_8c.html#a60">curve_whitespace_callback</a>);
01766 
01767   <span class="keywordflow">if</span> (xmldoc)
01768     <a class="code" href="mxml-node_8c.html#a2">stp_mxmlDelete</a>(xmldoc);
01769 
01770   <a class="code" href="xml_8h.html#a11">stp_xml_exit</a>();
01771 
01772   <span class="keywordflow">return</span> 0;
01773 }
01774 
01775 <span class="keywordtype">char</span> *
<a name="l01776"></a><a class="code" href="group__curve.html#ga62">01776</a> <a class="code" href="group__curve.html#ga62">stp_curve_write_string</a>(<span class="keyword">const</span> stp_curve_t *curve)  <span class="comment">/* The curve */</span>
01777 {
01778   <a class="code" href="structstp__mxml__node__s.html">stp_mxml_node_t</a> *xmldoc = NULL;
01779   <span class="keywordtype">char</span> *retval;
01780 
01781   <a class="code" href="xml_8h.html#a10">stp_xml_init</a>();
01782 
01783   xmldoc = <a class="code" href="curve_8c.html#a59">xmldoc_create_from_curve</a>(curve);
01784   <span class="keywordflow">if</span> (xmldoc == NULL)
01785     {
01786       <a class="code" href="xml_8h.html#a11">stp_xml_exit</a>();
01787       <span class="keywordflow">return</span> NULL;
01788     }
01789 
01790   retval = <a class="code" href="mxml-file_8c.html#a12">stp_mxmlSaveAllocString</a>(xmldoc, <a class="code" href="curve_8c.html#a60">curve_whitespace_callback</a>);
01791 
01792   <span class="keywordflow">if</span> (xmldoc)
01793     <a class="code" href="mxml-node_8c.html#a2">stp_mxmlDelete</a>(xmldoc);
01794 
01795   <a class="code" href="xml_8h.html#a11">stp_xml_exit</a>();
01796 
01797   <span class="keywordflow">return</span> retval;
01798 }
01799 
01800 <span class="keyword">static</span> <a class="code" href="group__curve.html#ga0">stp_curve_t</a> *
<a name="l01801"></a><a class="code" href="curve_8c.html#a63">01801</a> <a class="code" href="curve_8c.html#a63">xml_doc_get_curve</a>(<a class="code" href="structstp__mxml__node__s.html">stp_mxml_node_t</a> *doc)
01802 {
01803   <a class="code" href="structstp__mxml__node__s.html">stp_mxml_node_t</a> *cur;
01804   <a class="code" href="structstp__mxml__node__s.html">stp_mxml_node_t</a> *xmlcurve;
01805   <a class="code" href="group__curve.html#ga0">stp_curve_t</a> *curve = NULL;
01806 
01807   <span class="keywordflow">if</span> (doc == NULL )
01808     {
01809       <a class="code" href="print-util_8c.html#a24">stp_deprintf</a>(<a class="code" href="group__util.html#ga51">STP_DBG_CURVE_ERRORS</a>,
01810                    <span class="stringliteral">"xml_doc_get_curve: XML file not parsed successfully.\n"</span>);
01811       <span class="keywordflow">return</span> NULL;
01812     }
01813 
01814   cur = doc-&gt;<a class="code" href="structstp__mxml__node__s.html#o4">child</a>;
01815 
01816   <span class="keywordflow">if</span> (cur == NULL)
01817     {
01818       <a class="code" href="print-util_8c.html#a24">stp_deprintf</a>(<a class="code" href="group__util.html#ga51">STP_DBG_CURVE_ERRORS</a>,
01819                    <span class="stringliteral">"xml_doc_get_curve: empty document\n"</span>);
01820       <span class="keywordflow">return</span> NULL;
01821     }
01822 
01823   xmlcurve = <a class="code" href="xml_8c.html#a24">stp_xml_get_node</a>(cur, <span class="stringliteral">"gimp-print"</span>, <span class="stringliteral">"curve"</span>, NULL);
01824 
01825   <span class="keywordflow">if</span> (xmlcurve)
01826     curve = <a class="code" href="curve_8c.html#a57">stp_curve_create_from_xmltree</a>(xmlcurve);
01827 
01828   <span class="keywordflow">return</span> curve;
01829 }
01830 
01831 <a class="code" href="group__curve.html#ga0">stp_curve_t</a> *
<a name="l01832"></a><a class="code" href="group__curve.html#ga64">01832</a> <a class="code" href="group__curve.html#ga64">stp_curve_create_from_file</a>(<span class="keyword">const</span> <span class="keywordtype">char</span>* file)
01833 {
01834   <a class="code" href="group__curve.html#ga0">stp_curve_t</a> *curve = NULL;
01835   <a class="code" href="structstp__mxml__node__s.html">stp_mxml_node_t</a> *doc;
01836   FILE *fp = fopen(file, <span class="stringliteral">"r"</span>);
01837   <span class="keywordflow">if</span> (!fp)
01838     {
01839       <a class="code" href="print-util_8c.html#a24">stp_deprintf</a>(<a class="code" href="group__util.html#ga51">STP_DBG_CURVE_ERRORS</a>,
01840                    <span class="stringliteral">"stp_curve_create_from_file: unable to open %s: %s\n"</span>,
01841                     file, strerror(errno));
01842       <span class="keywordflow">return</span> NULL;
01843     }
01844   <a class="code" href="print-util_8c.html#a24">stp_deprintf</a>(<a class="code" href="group__util.html#ga47">STP_DBG_XML</a>, <span class="stringliteral">"stp_curve_create_from_file: reading `%s'...\n"</span>,
01845                file);
01846 
01847   <a class="code" href="xml_8h.html#a10">stp_xml_init</a>();
01848 
01849   doc = <a class="code" href="mxml-file_8c.html#a10">stp_mxmlLoadFile</a>(NULL, fp, <a class="code" href="mxml_8h.html#a2">STP_MXML_NO_CALLBACK</a>);
01850 
01851   curve = <a class="code" href="curve_8c.html#a63">xml_doc_get_curve</a>(doc);
01852 
01853   <span class="keywordflow">if</span> (doc)
01854     <a class="code" href="mxml-node_8c.html#a2">stp_mxmlDelete</a>(doc);
01855 
01856   <a class="code" href="xml_8h.html#a11">stp_xml_exit</a>();
01857   (<span class="keywordtype">void</span>) fclose(fp);
01858   <span class="keywordflow">return</span> curve;
01859 
01860 }
01861 
01862 <a class="code" href="group__curve.html#ga0">stp_curve_t</a> *
<a name="l01863"></a><a class="code" href="group__curve.html#ga65">01863</a> <a class="code" href="group__curve.html#ga65">stp_curve_create_from_stream</a>(FILE* fp)
01864 {
01865   <a class="code" href="group__curve.html#ga0">stp_curve_t</a> *curve = NULL;
01866   <a class="code" href="structstp__mxml__node__s.html">stp_mxml_node_t</a> *doc;
01867   <a class="code" href="print-util_8c.html#a24">stp_deprintf</a>(<a class="code" href="group__util.html#ga47">STP_DBG_XML</a>, <span class="stringliteral">"stp_curve_create_from_fp: reading...\n"</span>);
01868 
01869   <a class="code" href="xml_8h.html#a10">stp_xml_init</a>();
01870 
01871   doc = <a class="code" href="mxml-file_8c.html#a10">stp_mxmlLoadFile</a>(NULL, fp, <a class="code" href="mxml_8h.html#a2">STP_MXML_NO_CALLBACK</a>);
01872 
01873   curve = <a class="code" href="curve_8c.html#a63">xml_doc_get_curve</a>(doc);
01874 
01875   <span class="keywordflow">if</span> (doc)
01876     <a class="code" href="mxml-node_8c.html#a2">stp_mxmlDelete</a>(doc);
01877 
01878   <a class="code" href="xml_8h.html#a11">stp_xml_exit</a>();
01879   <span class="keywordflow">return</span> curve;
01880 
01881 }
01882 
01883 <a class="code" href="group__curve.html#ga0">stp_curve_t</a> *
<a name="l01884"></a><a class="code" href="group__curve.html#ga66">01884</a> <a class="code" href="group__curve.html#ga66">stp_curve_create_from_string</a>(<span class="keyword">const</span> <span class="keywordtype">char</span>* string)
01885 {
01886   <a class="code" href="group__curve.html#ga0">stp_curve_t</a> *curve = NULL;
01887   <a class="code" href="structstp__mxml__node__s.html">stp_mxml_node_t</a> *doc;
01888   <a class="code" href="print-util_8c.html#a24">stp_deprintf</a>(<a class="code" href="group__util.html#ga47">STP_DBG_XML</a>,
01889                <span class="stringliteral">"stp_curve_create_from_string: reading '%s'...\n"</span>, string);
01890   <a class="code" href="xml_8h.html#a10">stp_xml_init</a>();
01891 
01892   doc = <a class="code" href="mxml-file_8c.html#a11">stp_mxmlLoadString</a>(NULL, string, <a class="code" href="mxml_8h.html#a2">STP_MXML_NO_CALLBACK</a>);
01893 
01894   curve = <a class="code" href="curve_8c.html#a63">xml_doc_get_curve</a>(doc);
01895 
01896   <span class="keywordflow">if</span> (doc)
01897     <a class="code" href="mxml-node_8c.html#a2">stp_mxmlDelete</a>(doc);
01898 
01899   <a class="code" href="xml_8h.html#a11">stp_xml_exit</a>();
01900   <span class="keywordflow">return</span> curve;
01901 }
</pre></div><hr size="1"><address style="align: right;"><small>Generated on Wed Aug 25 07:56:13 2004 for libgimpprint API Reference by
<a href="http://www.doxygen.org/index.html">
<img src="doxygen.png" alt="doxygen" align="middle" border=0 > </a>1.3.6 </small></address>
</body>
</html>
