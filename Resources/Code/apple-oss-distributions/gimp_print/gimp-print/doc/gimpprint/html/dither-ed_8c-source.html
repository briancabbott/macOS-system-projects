<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>libgimpprint API Reference: src/main/dither-ed.c Source File</title>
<link href="doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.6 -->
<div class="qindex"><a class="qindex" href="index.html">Main&nbsp;Page</a> | <a class="qindex" href="modules.html">Modules</a> | <a class="qindex" href="classes.html">Alphabetical&nbsp;List</a> | <a class="qindex" href="annotated.html">Data&nbsp;Structures</a> | <a class="qindex" href="files.html">File&nbsp;List</a> | <a class="qindex" href="functions.html">Data&nbsp;Fields</a> | <a class="qindex" href="globals.html">Globals</a> | <a class="qindex" href="pages.html">Related&nbsp;Pages</a></div>
<h1>src/main/dither-ed.c</h1><a href="dither-ed_8c.html">Go to the documentation of this file.</a><div class="fragment"><pre>00001 <span class="comment">/*</span>
00002 <span class="comment"> * "$Id: dither-ed_8c-source.html,v 1.1.1.2 2004/12/22 23:48:57 jlovell Exp $"</span>
00003 <span class="comment"> *</span>
00004 <span class="comment"> *   Error diffusion and closely related adaptive hybrid dither algorithm</span>
00005 <span class="comment"> *</span>
00006 <span class="comment"> *   Copyright 1997-2003 Michael Sweet (mike@easysw.com) and</span>
00007 <span class="comment"> *      Robert Krawitz (rlk@alum.mit.edu)</span>
00008 <span class="comment"> *</span>
00009 <span class="comment"> *   This program is free software; you can redistribute it and/or modify it</span>
00010 <span class="comment"> *   under the terms of the GNU General Public License as published by the Free</span>
00011 <span class="comment"> *   Software Foundation; either version 2 of the License, or (at your option)</span>
00012 <span class="comment"> *   any later version.</span>
00013 <span class="comment"> *</span>
00014 <span class="comment"> *   This program is distributed in the hope that it will be useful, but</span>
00015 <span class="comment"> *   WITHOUT ANY WARRANTY; without even the implied warranty of MERCHANTABILITY</span>
00016 <span class="comment"> *   or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License</span>
00017 <span class="comment"> *   for more details.</span>
00018 <span class="comment"> *</span>
00019 <span class="comment"> *   You should have received a copy of the GNU General Public License</span>
00020 <span class="comment"> *   along with this program; if not, write to the Free Software</span>
00021 <span class="comment"> *   Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA 02111-1307, USA.</span>
00022 <span class="comment"> *</span>
00023 <span class="comment"> * Revision History:</span>
00024 <span class="comment"> *</span>
00025 <span class="comment"> *   See ChangeLog</span>
00026 <span class="comment"> */</span>
00027 
00028 <span class="preprocessor">#ifdef HAVE_CONFIG_H</span>
00029 <span class="preprocessor"></span><span class="preprocessor">#include &lt;config.h&gt;</span>
00030 <span class="preprocessor">#endif</span>
00031 <span class="preprocessor"></span><span class="preprocessor">#include &lt;<a class="code" href="gimp-print_8h.html">gimp-print/gimp-print.h</a>&gt;</span>
00032 <span class="preprocessor">#include "<a class="code" href="gimp-print-internal_8h.html">gimp-print-internal.h</a>"</span>
00033 <span class="preprocessor">#include &lt;<a class="code" href="gimp-print-intl-internal_8h.html">gimp-print/gimp-print-intl-internal.h</a>&gt;</span>
00034 <span class="preprocessor">#include &lt;string.h&gt;</span>
00035 <span class="preprocessor">#include "<a class="code" href="dither-impl_8h.html">dither-impl.h</a>"</span>
00036 <span class="preprocessor">#include "<a class="code" href="dither-inlined-functions_8h.html">dither-inlined-functions.h</a>"</span>
00037 
00038 <span class="comment">/*</span>
00039 <span class="comment"> * Add the error to the input value.  Notice that we micro-optimize this</span>
00040 <span class="comment"> * to save a division when appropriate.  This has yielded measurable</span>
00041 <span class="comment"> * improvement -- rlk 20030119</span>
00042 <span class="comment"> */</span>
00043 
<a name="l00044"></a><a class="code" href="dither-ed_8c.html#a0">00044</a> <span class="preprocessor">#define UPDATE_COLOR(color, dither) (                                      \</span>
00045 <span class="preprocessor">((dither) &gt;= 0)? (color) + ((dither) &gt;&gt; 3) : (color) - ((-(dither)) &gt;&gt; 3))</span>
00046 <span class="preprocessor"></span>
00047 <span class="comment">/*</span>
00048 <span class="comment"> * For Floyd-Steinberg, distribute the error residual.  We spread the</span>
00049 <span class="comment"> * error to nearby points, spreading more broadly in lighter regions to</span>
00050 <span class="comment"> * achieve more uniform distribution of color.  The actual distribution</span>
00051 <span class="comment"> * is a triangular function.</span>
00052 <span class="comment"> */</span>
00053 
00054 <span class="keyword">static</span> <span class="keyword">inline</span> <span class="keywordtype">int</span>
<a name="l00055"></a><a class="code" href="dither-ed_8c.html#a1">00055</a> <a class="code" href="dither-ed_8c.html#a1">update_dither</a>(<a class="code" href="structdither.html">stpi_dither_t</a> *d, <span class="keywordtype">int</span> channel, <span class="keywordtype">int</span> width,
00056               <span class="keywordtype">int</span> direction, <span class="keywordtype">int</span> *error0, <span class="keywordtype">int</span> *error1)
00057 {
00058   <span class="keywordtype">int</span> r = <a class="code" href="dither-impl_8h.html#a16">CHANNEL</a>(d, channel).v;
00059   <span class="keywordtype">int</span> o = <a class="code" href="dither-impl_8h.html#a16">CHANNEL</a>(d, channel).o;
00060   <span class="keywordtype">int</span> tmp = r;
00061   <span class="keywordtype">int</span> i, dist, dist1;
00062   <span class="keywordtype">int</span> delta, delta1;
00063   <span class="keywordtype">int</span> offset;
00064   <span class="keywordflow">if</span> (tmp == 0)
00065     <span class="keywordflow">return</span> error0[direction];
00066   <span class="keywordflow">if</span> (tmp &gt; 65535)
00067     tmp = 65535;
00068   <span class="keywordflow">if</span> (d-&gt;<a class="code" href="structdither.html#o2">spread</a> &gt;= 16 || o &gt;= 2048)
00069     {
00070       tmp += tmp;
00071       tmp += tmp;
00072       error1[0] += tmp;
00073       <span class="keywordflow">return</span> error0[direction] + tmp;
00074     }
00075   <span class="keywordflow">else</span>
00076     {
00077       <span class="keywordtype">int</span> tmpo = o &lt;&lt; 5;
00078       offset = ((65535 - tmpo) &gt;&gt; d-&gt;<a class="code" href="structdither.html#o2">spread</a>) +
00079         ((tmp &amp; d-&gt;<a class="code" href="structdither.html#o3">spread_mask</a>) &gt; (tmpo &amp; d-&gt;<a class="code" href="structdither.html#o3">spread_mask</a>));
00080     }
00081   <span class="keywordflow">switch</span> (offset)
00082     {
00083     <span class="keywordflow">case</span> 0:
00084       tmp += tmp;
00085       tmp += tmp;
00086       error1[0] += tmp;
00087       <span class="keywordflow">return</span> error0[direction] + tmp;
00088     <span class="keywordflow">case</span> 1:
00089       error1[-1] += tmp;
00090       error1[1] += tmp;
00091       tmp += tmp;
00092       error1[0] += tmp;
00093       tmp += tmp;
00094       <span class="keywordflow">return</span> error0[direction] + tmp;
00095     <span class="keywordflow">default</span>:
00096       tmp += tmp;
00097       tmp += tmp;
00098       dist = tmp / d-&gt;<a class="code" href="structdither.html#o9">offset0_table</a>[offset];
00099       dist1 = tmp / d-&gt;<a class="code" href="structdither.html#o10">offset1_table</a>[offset];
00100       delta = dist;
00101       delta1 = dist1;
00102       <span class="keywordflow">for</span> (i = -offset; i; i++)
00103         {
00104           error1[i] += delta;
00105           error1[-i] += delta;
00106           error0[i] += delta1;
00107           error0[-i] += delta1;
00108           delta1 += dist1;
00109           delta += dist;
00110         }
00111       error1[0] += delta;
00112       <span class="keywordflow">return</span> error0[direction];
00113     }
00114 }
00115 
00116 
00117 <span class="comment">/*</span>
00118 <span class="comment"> * Print a single dot.  This routine has become awfully complicated</span>
00119 <span class="comment"> * awfully fast!</span>
00120 <span class="comment"> */</span>
00121 
00122 <span class="keyword">static</span> <span class="keyword">inline</span> <span class="keywordtype">int</span>
<a name="l00123"></a><a class="code" href="dither-ed_8c.html#a2">00123</a> <a class="code" href="dither-ed_8c.html#a2">print_color</a>(<span class="keyword">const</span> <a class="code" href="structdither.html">stpi_dither_t</a> *d, <a class="code" href="structdither__channel.html">stpi_dither_channel_t</a> *dc, <span class="keywordtype">int</span> x, <span class="keywordtype">int</span> y,
00124             <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> bit, <span class="keywordtype">int</span> length, <span class="keywordtype">int</span> dontprint, <span class="keywordtype">int</span> stpi_dither_type,
00125             <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> *mask)
00126 {
00127   <span class="keywordtype">int</span> base = dc-&gt;<a class="code" href="structdither__channel.html#o7">b</a>;
00128   <span class="keywordtype">int</span> density = dc-&gt;<a class="code" href="structdither__channel.html#o6">o</a>;
00129   <span class="keywordtype">int</span> adjusted = dc-&gt;<a class="code" href="structdither__channel.html#o5">v</a>;
00130   <span class="keywordtype">unsigned</span> randomizer = dc-&gt;<a class="code" href="structdither__channel.html#o0">randomizer</a>;
00131   <a class="code" href="structdither__matrix__impl.html">stp_dither_matrix_impl_t</a> *pick_matrix = &amp;(dc-&gt;<a class="code" href="structdither__channel.html#o14">pick</a>);
00132   <a class="code" href="structdither__matrix__impl.html">stp_dither_matrix_impl_t</a> *dither_matrix = &amp;(dc-&gt;<a class="code" href="structdither__channel.html#o15">dithermat</a>);
00133   <span class="keywordtype">unsigned</span> rangepoint = 32768;
00134   <span class="keywordtype">unsigned</span> vmatrix;
00135   <span class="keywordtype">int</span> i;
00136   <span class="keywordtype">int</span> j;
00137   <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> *tptr;
00138   <span class="keywordtype">unsigned</span> bits;
00139   <span class="keywordtype">unsigned</span> v;
00140   <span class="keywordtype">int</span> levels = dc-&gt;<a class="code" href="structdither__channel.html#o10">nlevels</a> - 1;
00141   <span class="keywordtype">int</span> dither_value = adjusted;
00142   <a class="code" href="structink__defn.html">stpi_ink_defn_t</a> *lower;
00143   <a class="code" href="structink__defn.html">stpi_ink_defn_t</a> *upper;
00144 
00145   <span class="keywordflow">if</span> (base &lt;= 0 || density &lt;= 0 ||
00146       (adjusted &lt;= 0 &amp;&amp; !(stpi_dither_type &amp; <a class="code" href="dither-impl_8h.html#a1">D_ADAPTIVE_BASE</a>)))
00147     <span class="keywordflow">return</span> adjusted;
00148   <span class="keywordflow">if</span> (density &gt; 65535)
00149     density = 65535;
00150 
00151   <span class="comment">/*</span>
00152 <span class="comment">   * Look for the appropriate range into which the input value falls.</span>
00153 <span class="comment">   * Notice that we use the input, not the error, to decide what dot type</span>
00154 <span class="comment">   * to print (if any).  We actually use the "density" input to permit</span>
00155 <span class="comment">   * the caller to use something other that simply the input value, if it's</span>
00156 <span class="comment">   * desired to use some function of overall density, rather than just</span>
00157 <span class="comment">   * this color's input, for this purpose.</span>
00158 <span class="comment">   */</span>
00159   <span class="keywordflow">for</span> (i = levels; i &gt;= 0; i--)
00160     {
00161       <a class="code" href="structdither__segment.html">stpi_dither_segment_t</a> *dd = &amp;(dc-&gt;<a class="code" href="structdither__channel.html#o11">ranges</a>[i]);
00162 
00163       <span class="keywordflow">if</span> (density &lt;= dd-&gt;<a class="code" href="structdither__segment.html#o0">lower</a>-&gt;<a class="code" href="structink__defn.html#o0">range</a>)
00164         <span class="keywordflow">continue</span>;
00165 
00166       <span class="comment">/*</span>
00167 <span class="comment">       * If we're using an adaptive dithering method, decide whether</span>
00168 <span class="comment">       * to use the Floyd-Steinberg or the ordered method based on the</span>
00169 <span class="comment">       * input value.</span>
00170 <span class="comment">       */</span>
00171       <span class="keywordflow">if</span> (stpi_dither_type &amp; <a class="code" href="dither-impl_8h.html#a1">D_ADAPTIVE_BASE</a>)
00172         {
00173           stpi_dither_type -= <a class="code" href="dither-impl_8h.html#a1">D_ADAPTIVE_BASE</a>;
00174 
00175           <span class="keywordflow">if</span> (i &lt; levels || base &lt;= d-&gt;<a class="code" href="structdither.html#o5">adaptive_limit</a>)
00176             {
00177               stpi_dither_type = <a class="code" href="dither-impl_8h.html#a4">D_ORDERED</a>;
00178               dither_value = base;
00179             }
00180           <span class="keywordflow">else</span> <span class="keywordflow">if</span> (adjusted &lt;= 0)
00181             <span class="keywordflow">return</span> adjusted;
00182         }
00183       <span class="comment">/*</span>
00184 <span class="comment">       * Where are we within the range.  If we're going to print at</span>
00185 <span class="comment">       * all, this determines the probability of printing the darker</span>
00186 <span class="comment">       * vs. the lighter ink.  If the inks are identical (same value</span>
00187 <span class="comment">       * and darkness), it doesn't matter.</span>
00188 <span class="comment">       *</span>
00189 <span class="comment">       * We scale the input linearly against the top and bottom of the</span>
00190 <span class="comment">       * range.</span>
00191 <span class="comment">       */</span>
00192 
00193       lower = dd-&gt;<a class="code" href="structdither__segment.html#o0">lower</a>;
00194       upper = dd-&gt;<a class="code" href="structdither__segment.html#o1">upper</a>;
00195 
00196       <span class="comment">/*</span>
00197 <span class="comment">       * Reduce the randomness as the base value increases, to get</span>
00198 <span class="comment">       * smoother output in the midtones.  Idea suggested by</span>
00199 <span class="comment">       * Thomas Tonino.</span>
00200 <span class="comment">       */</span>
00201       <span class="keywordflow">if</span> (stpi_dither_type &amp; <a class="code" href="dither-impl_8h.html#a3">D_ORDERED_BASE</a>)
00202         {
00203           rangepoint = density - dd-&gt;<a class="code" href="structdither__segment.html#o0">lower</a>-&gt;<a class="code" href="structink__defn.html#o0">range</a>;
00204           <span class="keywordflow">if</span> (dd-&gt;<a class="code" href="structdither__segment.html#o2">range_span</a> &lt; 65535)
00205             rangepoint = rangepoint * 65535 / dd-&gt;<a class="code" href="structdither__segment.html#o2">range_span</a>;
00206           vmatrix = 0;
00207         }
00208       <span class="keywordflow">else</span>
00209         {
00210 
00211           <span class="comment">/*</span>
00212 <span class="comment">           * Compute the virtual dot size that we're going to print.</span>
00213 <span class="comment">           * This is somewhere between the two candidate dot sizes.</span>
00214 <span class="comment">           * This is scaled between the high and low value.</span>
00215 <span class="comment">           */</span>
00216 
00217           <span class="keywordtype">unsigned</span> virtual_value;
00218           rangepoint = density - dd-&gt;<a class="code" href="structdither__segment.html#o0">lower</a>-&gt;<a class="code" href="structink__defn.html#o0">range</a>;
00219           <span class="keywordflow">if</span> (dd-&gt;<a class="code" href="structdither__segment.html#o2">range_span</a> &lt; 65535)
00220             rangepoint = rangepoint * 65535 / dd-&gt;<a class="code" href="structdither__segment.html#o2">range_span</a>;
00221           <span class="keywordflow">if</span> (dd-&gt;<a class="code" href="structdither__segment.html#o3">value_span</a> == 0)
00222             virtual_value = upper-&gt;<a class="code" href="structink__defn.html#o1">value</a>;
00223           <span class="keywordflow">else</span> <span class="comment">/* if (dd-&gt;range_span == 0) */</span>
00224             virtual_value = (upper-&gt;<a class="code" href="structink__defn.html#o1">value</a> + lower-&gt;<a class="code" href="structink__defn.html#o1">value</a>) / 2;
00225           <span class="comment">/*</span>
00226 <span class="comment">            else</span>
00227 <span class="comment">            virtual_value = lower-&gt;value + (dd-&gt;value_span * rangepoint / 65535);</span>
00228 <span class="comment">          */</span>
00229           randomizer = 0;
00230           <span class="keywordflow">if</span> (randomizer &gt; 0)
00231             {
00232               <span class="keywordflow">if</span> (base &gt; d-&gt;<a class="code" href="structdither.html#o11">d_cutoff</a>)
00233                 randomizer = 0;
00234               <span class="keywordflow">else</span> <span class="keywordflow">if</span> (base &gt; d-&gt;<a class="code" href="structdither.html#o11">d_cutoff</a> / 2)
00235                 randomizer = randomizer * 2 * (d-&gt;<a class="code" href="structdither.html#o11">d_cutoff</a> - base) / d-&gt;<a class="code" href="structdither.html#o11">d_cutoff</a>;
00236             }
00237 
00238           <span class="comment">/*</span>
00239 <span class="comment">           * Compute the comparison value to decide whether to print at</span>
00240 <span class="comment">           * all.  If there is no randomness, simply divide the virtual</span>
00241 <span class="comment">           * dotsize by 2 to get standard "pure" Floyd-Steinberg (or "pure"</span>
00242 <span class="comment">           * matrix dithering, which degenerates to a threshold).</span>
00243 <span class="comment">           */</span>
00244           <span class="keywordflow">if</span> (randomizer == 0)
00245             vmatrix = virtual_value / 2;
00246           <span class="keywordflow">else</span>
00247             {
00248               <span class="comment">/*</span>
00249 <span class="comment">               * First, compute a value between 0 and 65535 that will be</span>
00250 <span class="comment">               * scaled to produce an offset from the desired threshold.</span>
00251 <span class="comment">               */</span>
00252               vmatrix = <a class="code" href="dither-inlined-functions_8h.html#a0">ditherpoint</a>(d, dither_matrix, x);
00253               <span class="comment">/*</span>
00254 <span class="comment">               * Now, scale the virtual dot size appropriately.  Note that</span>
00255 <span class="comment">               * we'll get something evenly distributed between 0 and</span>
00256 <span class="comment">               * the virtual dot size, centered on the dot size / 2,</span>
00257 <span class="comment">               * which is the normal threshold value.</span>
00258 <span class="comment">               */</span>
00259               vmatrix = vmatrix * virtual_value / 65535;
00260               <span class="keywordflow">if</span> (randomizer != 65535)
00261                 {
00262                   <span class="comment">/*</span>
00263 <span class="comment">                   * We want vmatrix to be scaled between 0 and</span>
00264 <span class="comment">                   * virtual_value when randomizer is 65535 (fully random).</span>
00265 <span class="comment">                   * When it's less, we want it to scale through part of</span>
00266 <span class="comment">                   * that range. In all cases, it should center around</span>
00267 <span class="comment">                   * virtual_value / 2.</span>
00268 <span class="comment">                   *</span>
00269 <span class="comment">                   * vbase is the bottom of the scaling range.</span>
00270 <span class="comment">                   */</span>
00271                   <span class="keywordtype">unsigned</span> vbase = virtual_value * (65535u - randomizer) /
00272                     131070u;
00273                   vmatrix = vmatrix * randomizer / 65535;
00274                   vmatrix += vbase;
00275                 }
00276             } <span class="comment">/* randomizer != 0 */</span>
00277         }
00278       <span class="comment">/*</span>
00279 <span class="comment">       * After all that, printing is almost an afterthought.</span>
00280 <span class="comment">       * Pick the actual dot size (using a matrix here) and print it.</span>
00281 <span class="comment">       */</span>
00282       <span class="keywordflow">if</span> (dither_value &gt; 0 &amp;&amp; dither_value &gt;= vmatrix)
00283         {
00284           <a class="code" href="structink__defn.html">stpi_ink_defn_t</a> *subc;
00285 
00286           <span class="keywordflow">if</span> (dd-&gt;<a class="code" href="structdither__segment.html#o4">is_same_ink</a>)
00287             subc = upper;
00288           <span class="keywordflow">else</span>
00289             {
00290               <span class="keywordflow">if</span> (rangepoint &gt;= <a class="code" href="dither-inlined-functions_8h.html#a0">ditherpoint</a>(d, pick_matrix, x))
00291                 subc = upper;
00292               <span class="keywordflow">else</span>
00293                 subc = lower;
00294             }
00295           v = subc-&gt;<a class="code" href="structink__defn.html#o1">value</a>;
00296           <span class="keywordflow">if</span> (!mask || (*(mask + d-&gt;<a class="code" href="structdither.html#o13">ptr_offset</a>) &amp; bit))
00297             {
00298               <span class="keywordflow">if</span> (dc-&gt;<a class="code" href="structdither__channel.html#o17">ptr</a>)
00299                 {
00300                   tptr = dc-&gt;<a class="code" href="structdither__channel.html#o17">ptr</a> + d-&gt;<a class="code" href="structdither.html#o13">ptr_offset</a>;
00301 
00302                   <span class="comment">/*</span>
00303 <span class="comment">                   * Lay down all of the bits in the pixel.</span>
00304 <span class="comment">                   */</span>
00305                   <span class="keywordflow">if</span> (dontprint &lt; v)
00306                     {
00307                       bits = subc-&gt;<a class="code" href="structink__defn.html#o2">bits</a>;
00308                       <a class="code" href="dither-inlined-functions_8h.html#a1">set_row_ends</a>(dc, x);
00309                       <span class="keywordflow">for</span> (j = 1; j &lt;= bits; j += j, tptr += length)
00310                         {
00311                           <span class="keywordflow">if</span> (j &amp; bits)
00312                             tptr[0] |= bit;
00313                         }
00314                     }
00315                 }
00316             }
00317           <span class="keywordflow">if</span> (stpi_dither_type &amp; <a class="code" href="dither-impl_8h.html#a3">D_ORDERED_BASE</a>)
00318             {
00319               <span class="keywordtype">double</span> adj = -(<span class="keywordtype">int</span>) v;
00320               adj /= 2.0;
00321               adjusted = adj;
00322             }
00323           <span class="keywordflow">else</span>
00324             {
00325               <span class="keywordtype">double</span> adj = v;
00326               adjusted -= adj;
00327             }
00328         }
00329       <span class="keywordflow">return</span> adjusted;
00330     }
00331   <span class="keywordflow">return</span> adjusted;
00332 }
00333 
00334 <span class="keyword">static</span> <span class="keywordtype">int</span>
<a name="l00335"></a><a class="code" href="dither-ed_8c.html#a3">00335</a> <a class="code" href="dither-ed_8c.html#a3">shared_ed_initializer</a>(<a class="code" href="structdither.html">stpi_dither_t</a> *d,
00336                       <span class="keywordtype">int</span> row,
00337                       <span class="keywordtype">int</span> duplicate_line,
00338                       <span class="keywordtype">int</span> zero_mask,
00339                       <span class="keywordtype">int</span> length,
00340                       <span class="keywordtype">int</span> direction,
00341                       <span class="keywordtype">int</span> ****error,
00342                       <span class="keywordtype">int</span> **ndither)
00343 {
00344   <span class="keywordtype">int</span> i, j;
00345   <span class="keywordflow">for</span> (i = 0; i &lt; <a class="code" href="dither-impl_8h.html#a17">CHANNEL_COUNT</a>(d); i++)
00346     <a class="code" href="dither-impl_8h.html#a16">CHANNEL</a>(d, i).error_rows = 2;
00347   <span class="keywordflow">if</span> (!duplicate_line)
00348     {
00349       <span class="keywordflow">if</span> ((zero_mask &amp; ((1 &lt;&lt; <a class="code" href="dither-impl_8h.html#a17">CHANNEL_COUNT</a>(d)) - 1)) !=
00350           ((1 &lt;&lt; <a class="code" href="dither-impl_8h.html#a17">CHANNEL_COUNT</a>(d)) - 1))
00351         d-&gt;<a class="code" href="structdither.html#o12">last_line_was_empty</a> = 0;
00352       <span class="keywordflow">else</span>
00353         d-&gt;<a class="code" href="structdither.html#o12">last_line_was_empty</a>++;
00354     }
00355   <span class="keywordflow">else</span> <span class="keywordflow">if</span> (d-&gt;<a class="code" href="structdither.html#o12">last_line_was_empty</a>)
00356     d-&gt;<a class="code" href="structdither.html#o12">last_line_was_empty</a>++;
00357   <span class="keywordflow">if</span> (d-&gt;<a class="code" href="structdither.html#o12">last_line_was_empty</a> &gt;= 5)
00358     <span class="keywordflow">return</span> 0;
00359   <span class="keywordflow">else</span> <span class="keywordflow">if</span> (d-&gt;<a class="code" href="structdither.html#o12">last_line_was_empty</a> == 4)
00360     {
00361       <span class="keywordflow">for</span> (i = 0; i &lt; <a class="code" href="dither-impl_8h.html#a17">CHANNEL_COUNT</a>(d); i++)
00362         <span class="keywordflow">for</span> (j = 0; j &lt; d-&gt;<a class="code" href="structdither.html#o14">error_rows</a>; j++)
00363           memset(<a class="code" href="dither-main_8c.html#a17">stpi_dither_get_errline</a>(d, row + j, i), 0,
00364                  d-&gt;<a class="code" href="structdither.html#o1">dst_width</a> * <span class="keyword">sizeof</span>(<span class="keywordtype">int</span>));
00365       <span class="keywordflow">return</span> 0;
00366     }
00367   d-&gt;<a class="code" href="structdither.html#o13">ptr_offset</a> = (direction == 1) ? 0 : length - 1;
00368 
00369   *error = <a class="code" href="group__util.html#ga28">stp_malloc</a>(<a class="code" href="dither-impl_8h.html#a17">CHANNEL_COUNT</a>(d) * <span class="keyword">sizeof</span>(<span class="keywordtype">int</span> **));
00370   *ndither = <a class="code" href="group__util.html#ga28">stp_malloc</a>(<a class="code" href="dither-impl_8h.html#a17">CHANNEL_COUNT</a>(d) * <span class="keyword">sizeof</span>(<span class="keywordtype">int</span>));
00371   <span class="keywordflow">for</span> (i = 0; i &lt; <a class="code" href="dither-impl_8h.html#a17">CHANNEL_COUNT</a>(d); i++)
00372     {
00373       (*error)[i] = <a class="code" href="group__util.html#ga28">stp_malloc</a>(d-&gt;<a class="code" href="structdither.html#o14">error_rows</a> * <span class="keyword">sizeof</span>(<span class="keywordtype">int</span> *));
00374       <span class="keywordflow">for</span> (j = 0; j &lt; d-&gt;<a class="code" href="structdither.html#o14">error_rows</a>; j++)
00375         {
00376           (*error)[i][j] = <a class="code" href="dither-main_8c.html#a17">stpi_dither_get_errline</a>(d, row + j, i);
00377           <span class="keywordflow">if</span> (j == d-&gt;<a class="code" href="structdither.html#o14">error_rows</a> - 1)
00378             memset((*error)[i][j], 0, d-&gt;<a class="code" href="structdither.html#o1">dst_width</a> * <span class="keyword">sizeof</span>(<span class="keywordtype">int</span>));
00379           <span class="keywordflow">if</span> (direction == -1)
00380             (*error)[i][j] += d-&gt;<a class="code" href="structdither.html#o1">dst_width</a> - 1;
00381         }
00382       (*ndither)[i] = (*error)[i][0][0];
00383     }
00384   <span class="keywordflow">return</span> 1;
00385 }
00386 
00387 <span class="keyword">static</span> <span class="keywordtype">void</span>
<a name="l00388"></a><a class="code" href="dither-ed_8c.html#a4">00388</a> <a class="code" href="dither-ed_8c.html#a4">shared_ed_deinitializer</a>(<a class="code" href="structdither.html">stpi_dither_t</a> *d,
00389                         <span class="keywordtype">int</span> ***error,
00390                         <span class="keywordtype">int</span> *ndither)
00391 {
00392   <span class="keywordtype">int</span> i;
00393   <span class="keywordflow">for</span> (i = 0; i &lt; <a class="code" href="dither-impl_8h.html#a17">CHANNEL_COUNT</a>(d); i++)
00394     {
00395       <a class="code" href="group__util.html#ga52">STP_SAFE_FREE</a>(error[i]);
00396     }
00397   <a class="code" href="group__util.html#ga52">STP_SAFE_FREE</a>(error);
00398   <a class="code" href="group__util.html#ga52">STP_SAFE_FREE</a>(ndither);
00399 }
00400 
00401 <span class="keywordtype">void</span>
<a name="l00402"></a><a class="code" href="dither-ed_8c.html#a5">00402</a> <a class="code" href="dither-ed_8c.html#a5">stpi_dither_ed</a>(<a class="code" href="structstp__vars.html">stp_vars_t</a> *v,
00403                <span class="keywordtype">int</span> row,
00404                <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">short</span> *<a class="code" href="structraw.html">raw</a>,
00405                <span class="keywordtype">int</span> duplicate_line,
00406                <span class="keywordtype">int</span> zero_mask,
00407                <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> *mask)
00408 {
00409   <a class="code" href="structdither.html">stpi_dither_t</a> *d = (<a class="code" href="structdither.html">stpi_dither_t</a> *) <a class="code" href="group__vars.html#ga20">stp_get_component_data</a>(v, <span class="stringliteral">"Dither"</span>);
00410   <span class="keywordtype">int</span>           x,
00411                 length;
00412   <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> bit;
00413   <span class="keywordtype">int</span>           i;
00414   <span class="keywordtype">int</span>           *ndither;
00415   <span class="keywordtype">int</span>           ***error;
00416 
00417   <span class="keywordtype">int</span>           terminate;
00418   <span class="keywordtype">int</span>           direction = row &amp; 1 ? 1 : -1;
00419   <span class="keywordtype">int</span> xerror, xstep, xmod;
00420 
00421   length = (d-&gt;<a class="code" href="structdither.html#o1">dst_width</a> + 7) / 8;
00422   <span class="keywordflow">if</span> (d-&gt;<a class="code" href="structdither.html#o4">stpi_dither_type</a> &amp; <a class="code" href="dither-impl_8h.html#a1">D_ADAPTIVE_BASE</a>)
00423     <span class="keywordflow">for</span> (i = 0; i &lt; <a class="code" href="dither-impl_8h.html#a17">CHANNEL_COUNT</a>(d); i++)
00424       <span class="keywordflow">if</span> (<a class="code" href="dither-impl_8h.html#a16">CHANNEL</a>(d, i).nlevels &gt; 1)
00425         {
00426           <a class="code" href="dither-ordered_8c.html#a1">stpi_dither_ordered</a>(v, row, raw, duplicate_line, zero_mask, mask);
00427           <span class="keywordflow">return</span>;
00428         }
00429   <span class="keywordflow">if</span> (!<a class="code" href="dither-ed_8c.html#a3">shared_ed_initializer</a>(d, row, duplicate_line, zero_mask, length,
00430                              direction, &amp;error, &amp;ndither))
00431     <span class="keywordflow">return</span>;
00432 
00433   x = (direction == 1) ? 0 : d-&gt;<a class="code" href="structdither.html#o1">dst_width</a> - 1;
00434   bit = 1 &lt;&lt; (7 - (x &amp; 7));
00435   xstep  = <a class="code" href="dither-impl_8h.html#a17">CHANNEL_COUNT</a>(d) * (d-&gt;<a class="code" href="structdither.html#o0">src_width</a> / d-&gt;<a class="code" href="structdither.html#o1">dst_width</a>);
00436   xmod   = d-&gt;<a class="code" href="structdither.html#o0">src_width</a> % d-&gt;<a class="code" href="structdither.html#o1">dst_width</a>;
00437   xerror = (xmod * x) % d-&gt;<a class="code" href="structdither.html#o1">dst_width</a>;
00438   terminate = (direction == 1) ? d-&gt;<a class="code" href="structdither.html#o1">dst_width</a> : -1;
00439 
00440   <span class="keywordflow">if</span> (direction == -1)
00441     raw += (<a class="code" href="dither-impl_8h.html#a17">CHANNEL_COUNT</a>(d) * (d-&gt;<a class="code" href="structdither.html#o0">src_width</a> - 1));
00442 
00443   <span class="keywordflow">for</span> (; x != terminate; x += direction)
00444     {
00445       <span class="keywordflow">for</span> (i = 0; i &lt; <a class="code" href="dither-impl_8h.html#a17">CHANNEL_COUNT</a>(d); i++)
00446         {
00447           <span class="keywordflow">if</span> (<a class="code" href="dither-impl_8h.html#a16">CHANNEL</a>(d, i).ptr)
00448             {
00449               <a class="code" href="dither-impl_8h.html#a16">CHANNEL</a>(d, i).v = raw[i];
00450               <a class="code" href="dither-impl_8h.html#a16">CHANNEL</a>(d, i).o = <a class="code" href="dither-impl_8h.html#a16">CHANNEL</a>(d, i).v;
00451               <a class="code" href="dither-impl_8h.html#a16">CHANNEL</a>(d, i).b = <a class="code" href="dither-impl_8h.html#a16">CHANNEL</a>(d, i).v;
00452               <a class="code" href="dither-impl_8h.html#a16">CHANNEL</a>(d, i).v = <a class="code" href="dither-ed_8c.html#a0">UPDATE_COLOR</a>(<a class="code" href="dither-impl_8h.html#a16">CHANNEL</a>(d, i).v, ndither[i]);
00453               <a class="code" href="dither-impl_8h.html#a16">CHANNEL</a>(d, i).v = <a class="code" href="dither-ed_8c.html#a2">print_color</a>(d, &amp;(<a class="code" href="dither-impl_8h.html#a16">CHANNEL</a>(d, i)), x, row, bit,
00454                                             length, 0, d-&gt;<a class="code" href="structdither.html#o4">stpi_dither_type</a>,
00455                                             mask);
00456               ndither[i] = <a class="code" href="dither-ed_8c.html#a1">update_dither</a>(d, i, d-&gt;<a class="code" href="structdither.html#o0">src_width</a>,
00457                                          direction, error[i][0], error[i][1]);
00458             }
00459         }
00460       <a class="code" href="dither-impl_8h.html#a21">ADVANCE_BIDIRECTIONAL</a>(d, bit, raw, direction, <a class="code" href="dither-impl_8h.html#a17">CHANNEL_COUNT</a>(d), xerror,
00461                             xstep, xmod, error, d-&gt;<a class="code" href="structdither.html#o14">error_rows</a>);
00462     }
00463   <a class="code" href="dither-ed_8c.html#a4">shared_ed_deinitializer</a>(d, error, ndither);
00464   <span class="keywordflow">if</span> (direction == -1)
00465     <a class="code" href="dither-main_8c.html#a14">stpi_dither_reverse_row_ends</a>(d);
00466 }
</pre></div><hr size="1"><address style="align: right;"><small>Generated on Wed Aug 25 07:56:13 2004 for libgimpprint API Reference by
<a href="http://www.doxygen.org/index.html">
<img src="doxygen.png" alt="doxygen" align="middle" border=0 > </a>1.3.6 </small></address>
</body>
</html>
