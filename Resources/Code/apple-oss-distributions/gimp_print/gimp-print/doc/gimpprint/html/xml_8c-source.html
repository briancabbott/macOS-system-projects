<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>libgimpprint API Reference: src/main/xml.c Source File</title>
<link href="doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.6 -->
<div class="qindex"><a class="qindex" href="index.html">Main&nbsp;Page</a> | <a class="qindex" href="modules.html">Modules</a> | <a class="qindex" href="classes.html">Alphabetical&nbsp;List</a> | <a class="qindex" href="annotated.html">Data&nbsp;Structures</a> | <a class="qindex" href="files.html">File&nbsp;List</a> | <a class="qindex" href="functions.html">Data&nbsp;Fields</a> | <a class="qindex" href="globals.html">Globals</a> | <a class="qindex" href="pages.html">Related&nbsp;Pages</a></div>
<h1>src/main/xml.c</h1><a href="xml_8c.html">Go to the documentation of this file.</a><div class="fragment"><pre>00001 <span class="comment">/*</span>
00002 <span class="comment"> * "$Id: xml_8c-source.html,v 1.1.1.2 2004/12/22 23:49:22 jlovell Exp $"</span>
00003 <span class="comment"> *</span>
00004 <span class="comment"> *   XML parser - process gimp-print XML data with mxml.</span>
00005 <span class="comment"> *</span>
00006 <span class="comment"> *   Copyright 2002-2003 Roger Leigh (rleigh@debian.org)</span>
00007 <span class="comment"> *</span>
00008 <span class="comment"> *   This program is free software; you can redistribute it and/or modify it</span>
00009 <span class="comment"> *   under the terms of the GNU General Public License as published by the Free</span>
00010 <span class="comment"> *   Software Foundation; either version 2 of the License, or (at your option)</span>
00011 <span class="comment"> *   any later version.</span>
00012 <span class="comment"> *</span>
00013 <span class="comment"> *   This program is distributed in the hope that it will be useful, but</span>
00014 <span class="comment"> *   WITHOUT ANY WARRANTY; without even the implied warranty of MERCHANTABILITY</span>
00015 <span class="comment"> *   or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License</span>
00016 <span class="comment"> *   for more details.</span>
00017 <span class="comment"> *</span>
00018 <span class="comment"> *   You should have received a copy of the GNU General Public License</span>
00019 <span class="comment"> *   along with this program; if not, write to the Free Software</span>
00020 <span class="comment"> *   Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA 02111-1307, USA.</span>
00021 <span class="comment"> */</span>
00022 
00023 
00024 <span class="preprocessor">#ifdef HAVE_CONFIG_H</span>
00025 <span class="preprocessor"></span><span class="preprocessor">#include &lt;config.h&gt;</span>
00026 <span class="preprocessor">#endif</span>
00027 <span class="preprocessor"></span><span class="preprocessor">#include &lt;<a class="code" href="gimp-print_8h.html">gimp-print/gimp-print.h</a>&gt;</span>
00028 <span class="preprocessor">#include "<a class="code" href="gimp-print-internal_8h.html">gimp-print-internal.h</a>"</span>
00029 <span class="preprocessor">#include &lt;<a class="code" href="gimp-print-intl-internal_8h.html">gimp-print/gimp-print-intl-internal.h</a>&gt;</span>
00030 <span class="preprocessor">#include &lt;assert.h&gt;</span>
00031 <span class="preprocessor">#include &lt;ctype.h&gt;</span>
00032 <span class="preprocessor">#include &lt;stdio.h&gt;</span>
00033 <span class="preprocessor">#include &lt;stdlib.h&gt;</span>
00034 <span class="preprocessor">#include &lt;string.h&gt;</span>
00035 <span class="preprocessor">#include &lt;math.h&gt;</span>
00036 <span class="preprocessor">#include &lt;errno.h&gt;</span>
00037 <span class="preprocessor">#ifdef HAVE_LIMITS_H</span>
00038 <span class="preprocessor"></span><span class="preprocessor">#include &lt;limits.h&gt;</span>
00039 <span class="preprocessor">#endif</span>
00040 <span class="preprocessor"></span><span class="preprocessor">#if defined(HAVE_VARARGS_H) &amp;&amp; !defined(HAVE_STDARG_H)</span>
00041 <span class="preprocessor"></span><span class="preprocessor">#include &lt;varargs.h&gt;</span>
00042 <span class="preprocessor">#else</span>
00043 <span class="preprocessor"></span><span class="preprocessor">#include &lt;stdarg.h&gt;</span>
00044 <span class="preprocessor">#endif</span>
00045 <span class="preprocessor"></span>
<a name="l00046"></a><a class="code" href="structstpi__xml__parse__registry.html">00046</a> <span class="keyword">typedef</span> <span class="keyword">struct</span>
00047 <span class="keyword"></span>{
<a name="l00048"></a><a class="code" href="structstpi__xml__parse__registry.html#o0">00048</a>   <span class="keywordtype">char</span> *name;
<a name="l00049"></a><a class="code" href="structstpi__xml__parse__registry.html#o1">00049</a>   <a class="code" href="xml_8h.html#a0">stp_xml_parse_func</a> parse_func;
00050 } <a class="code" href="structstpi__xml__parse__registry.html">stpi_xml_parse_registry</a>;
00051 
<a name="l00052"></a><a class="code" href="xml_8c.html#a0">00052</a> <span class="keyword">static</span> <a class="code" href="structstp__list.html">stp_list_t</a> *<a class="code" href="xml_8c.html#a0">stpi_xml_registry</a>;
00053 
<a name="l00054"></a><a class="code" href="xml_8c.html#a1">00054</a> <span class="keyword">static</span> <a class="code" href="structstp__list.html">stp_list_t</a> *<a class="code" href="xml_8c.html#a1">stpi_xml_preloads</a>;
00055 
00056 <span class="keyword">static</span> <span class="keyword">const</span> <span class="keywordtype">char</span> *
<a name="l00057"></a><a class="code" href="xml_8c.html#a6">00057</a> <a class="code" href="xml_8c.html#a6">xml_registry_namefunc</a>(<span class="keyword">const</span> <span class="keywordtype">void</span> *item)
00058 {
00059   <span class="keyword">const</span> <a class="code" href="structstpi__xml__parse__registry.html">stpi_xml_parse_registry</a> *xmlp = (<span class="keyword">const</span> <a class="code" href="structstpi__xml__parse__registry.html">stpi_xml_parse_registry</a> *) item;
00060   <span class="keywordflow">return</span> xmlp-&gt;<a class="code" href="structstpi__xml__parse__registry.html#o0">name</a>;
00061 }
00062 
00063 <span class="keyword">static</span> <span class="keywordtype">void</span>
<a name="l00064"></a><a class="code" href="xml_8c.html#a7">00064</a> <a class="code" href="xml_8c.html#a7">xml_registry_freefunc</a>(<span class="keywordtype">void</span> *item)
00065 {
00066   <a class="code" href="structstpi__xml__parse__registry.html">stpi_xml_parse_registry</a> *xmlp = (<a class="code" href="structstpi__xml__parse__registry.html">stpi_xml_parse_registry</a> *) item;
00067   <a class="code" href="group__util.html#ga31">stp_free</a>(xmlp-&gt;<a class="code" href="structstpi__xml__parse__registry.html#o0">name</a>);
00068   <a class="code" href="group__util.html#ga31">stp_free</a>(xmlp);
00069 }
00070 
00071 <span class="keyword">static</span> <span class="keyword">const</span> <span class="keywordtype">char</span> *
<a name="l00072"></a><a class="code" href="xml_8c.html#a8">00072</a> <a class="code" href="xml_8c.html#a8">xml_preload_namefunc</a>(<span class="keyword">const</span> <span class="keywordtype">void</span> *item)
00073 {
00074   <span class="keywordflow">return</span> (<span class="keyword">const</span> <span class="keywordtype">char</span> *) item;
00075 }
00076 
00077 <span class="keyword">static</span> <span class="keywordtype">void</span>
<a name="l00078"></a><a class="code" href="xml_8c.html#a9">00078</a> <a class="code" href="xml_8c.html#a9">xml_preload_freefunc</a>(<span class="keywordtype">void</span> *item)
00079 {
00080   <a class="code" href="group__util.html#ga31">stp_free</a>(item);
00081 }
00082 
00083 <span class="keywordtype">void</span>
<a name="l00084"></a><a class="code" href="xml_8c.html#a10">00084</a> <a class="code" href="xml_8c.html#a10">stp_register_xml_parser</a>(<span class="keyword">const</span> <span class="keywordtype">char</span> *name, <a class="code" href="xml_8h.html#a0">stp_xml_parse_func</a> parse_func)
00085 {
00086   <a class="code" href="structstpi__xml__parse__registry.html">stpi_xml_parse_registry</a> *xmlp;
00087   <a class="code" href="structstp__list__item.html">stp_list_item_t</a> *item = <a class="code" href="print-list_8c.html#a16">stp_list_get_item_by_name</a>(<a class="code" href="xml_8c.html#a0">stpi_xml_registry</a>, name);
00088   <span class="keywordflow">if</span> (item)
00089     xmlp = (<a class="code" href="structstpi__xml__parse__registry.html">stpi_xml_parse_registry</a> *) <a class="code" href="print-list_8c.html#a33">stp_list_item_get_data</a>(item);
00090   <span class="keywordflow">else</span>
00091     {
00092       xmlp = <a class="code" href="group__util.html#ga28">stp_malloc</a>(<span class="keyword">sizeof</span>(<a class="code" href="structstpi__xml__parse__registry.html">stpi_xml_parse_registry</a>));
00093       xmlp-&gt;<a class="code" href="structstpi__xml__parse__registry.html#o0">name</a> = <a class="code" href="group__util.html#ga35">stp_strdup</a>(name);
00094       <a class="code" href="print-list_8c.html#a29">stp_list_item_create</a>(<a class="code" href="xml_8c.html#a0">stpi_xml_registry</a>, NULL, xmlp);
00095     }
00096   xmlp-&gt;<a class="code" href="structstpi__xml__parse__registry.html#o1">parse_func</a> = parse_func;
00097 }
00098 
00099 <span class="keywordtype">void</span>
<a name="l00100"></a><a class="code" href="xml_8c.html#a11">00100</a> <a class="code" href="xml_8c.html#a11">stp_unregister_xml_parser</a>(<span class="keyword">const</span> <span class="keywordtype">char</span> *name)
00101 {
00102   <a class="code" href="structstp__list__item.html">stp_list_item_t</a> *item = <a class="code" href="print-list_8c.html#a16">stp_list_get_item_by_name</a>(<a class="code" href="xml_8c.html#a0">stpi_xml_registry</a>, name);
00103   <span class="keywordflow">if</span> (item)
00104     <a class="code" href="print-list_8c.html#a30">stp_list_item_destroy</a>(<a class="code" href="xml_8c.html#a0">stpi_xml_registry</a>, item);
00105 }
00106 
00107 <span class="keywordtype">void</span>
<a name="l00108"></a><a class="code" href="xml_8c.html#a12">00108</a> <a class="code" href="xml_8c.html#a12">stp_register_xml_preload</a>(<span class="keyword">const</span> <span class="keywordtype">char</span> *filename)
00109 {
00110   <a class="code" href="structstp__list__item.html">stp_list_item_t</a> *item = <a class="code" href="print-list_8c.html#a16">stp_list_get_item_by_name</a>(<a class="code" href="xml_8c.html#a1">stpi_xml_preloads</a>, filename);
00111   <span class="keywordflow">if</span> (!item)
00112     {
00113       <span class="keywordtype">char</span> *the_filename = <a class="code" href="group__util.html#ga35">stp_strdup</a>(filename);
00114       <a class="code" href="print-list_8c.html#a29">stp_list_item_create</a>(<a class="code" href="xml_8c.html#a1">stpi_xml_preloads</a>, NULL, the_filename);
00115     }
00116 }
00117 
00118 <span class="keywordtype">void</span>
<a name="l00119"></a><a class="code" href="xml_8c.html#a13">00119</a> <a class="code" href="xml_8c.html#a13">stp_unregister_xml_preload</a>(<span class="keyword">const</span> <span class="keywordtype">char</span> *name)
00120 {
00121   <a class="code" href="structstp__list__item.html">stp_list_item_t</a> *item = <a class="code" href="print-list_8c.html#a16">stp_list_get_item_by_name</a>(<a class="code" href="xml_8c.html#a1">stpi_xml_preloads</a>, name);
00122   <span class="keywordflow">if</span> (item)
00123     <a class="code" href="print-list_8c.html#a30">stp_list_item_destroy</a>(<a class="code" href="xml_8c.html#a1">stpi_xml_preloads</a>, item);
00124 }
00125 
00126 
00127 <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="xml_8c.html#a14">stpi_xml_process_gimpprint</a>(<a class="code" href="structstp__mxml__node__s.html">stp_mxml_node_t</a> *gimpprint, <span class="keyword">const</span> <span class="keywordtype">char</span> *file);
00128 
<a name="l00129"></a><a class="code" href="xml_8c.html#a2">00129</a> <span class="keyword">static</span> <span class="keywordtype">char</span> *<a class="code" href="xml_8c.html#a2">saved_lc_collate</a>;                 <span class="comment">/* Saved LC_COLLATE */</span>
<a name="l00130"></a><a class="code" href="xml_8c.html#a3">00130</a> <span class="keyword">static</span> <span class="keywordtype">char</span> *<a class="code" href="xml_8c.html#a3">saved_lc_ctype</a>;                   <span class="comment">/* Saved LC_CTYPE */</span>
<a name="l00131"></a><a class="code" href="xml_8c.html#a4">00131</a> <span class="keyword">static</span> <span class="keywordtype">char</span> *<a class="code" href="xml_8c.html#a4">saved_lc_numeric</a>;                 <span class="comment">/* Saved LC_NUMERIC */</span>
<a name="l00132"></a><a class="code" href="xml_8c.html#a5">00132</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="xml_8c.html#a5">xml_is_initialised</a>;                 <span class="comment">/* Flag for init */</span>
00133 
00134 <span class="keywordtype">void</span>
<a name="l00135"></a><a class="code" href="xml_8c.html#a15">00135</a> <a class="code" href="xml_8h.html#a14">stp_xml_preinit</a>(<span class="keywordtype">void</span>)
00136 {
00137   <span class="keyword">static</span> <span class="keywordtype">int</span> xml_is_preinitialized = 0;
00138   <span class="keywordflow">if</span> (!xml_is_preinitialized)
00139     {
00140       <a class="code" href="xml_8c.html#a0">stpi_xml_registry</a> = <a class="code" href="list_8h.html#a7">stp_list_create</a>();
00141       <a class="code" href="print-list_8c.html#a19">stp_list_set_freefunc</a>(<a class="code" href="xml_8c.html#a0">stpi_xml_registry</a>, <a class="code" href="xml_8c.html#a7">xml_registry_freefunc</a>);
00142       <a class="code" href="print-list_8c.html#a23">stp_list_set_namefunc</a>(<a class="code" href="xml_8c.html#a0">stpi_xml_registry</a>, <a class="code" href="xml_8c.html#a6">xml_registry_namefunc</a>);
00143       <a class="code" href="xml_8c.html#a1">stpi_xml_preloads</a> = <a class="code" href="list_8h.html#a7">stp_list_create</a>();
00144       <a class="code" href="print-list_8c.html#a19">stp_list_set_freefunc</a>(<a class="code" href="xml_8c.html#a1">stpi_xml_preloads</a>, <a class="code" href="xml_8c.html#a9">xml_preload_freefunc</a>);
00145       <a class="code" href="print-list_8c.html#a23">stp_list_set_namefunc</a>(<a class="code" href="xml_8c.html#a1">stpi_xml_preloads</a>, <a class="code" href="xml_8c.html#a8">xml_preload_namefunc</a>);
00146     }
00147 }    
00148 
00149 <span class="comment">/*</span>
00150 <span class="comment"> * Call before using any of the static functions in this file.  All</span>
00151 <span class="comment"> * public functions should call this before using any mxml</span>
00152 <span class="comment"> * functions.</span>
00153 <span class="comment"> */</span>
00154 <span class="keywordtype">void</span>
<a name="l00155"></a><a class="code" href="xml_8c.html#a16">00155</a> <a class="code" href="xml_8h.html#a10">stp_xml_init</a>(<span class="keywordtype">void</span>)
00156 {
00157   <span class="keywordflow">if</span> (<a class="code" href="xml_8c.html#a5">xml_is_initialised</a> &gt;= 1)
00158     {
00159       <a class="code" href="xml_8c.html#a5">xml_is_initialised</a>++;
00160       <span class="keywordflow">return</span>;
00161     }
00162 
00163   <span class="comment">/* Set some locale facets to "C" */</span>
00164   <a class="code" href="xml_8c.html#a2">saved_lc_collate</a> = setlocale(LC_COLLATE, <span class="stringliteral">"C"</span>);
00165   <a class="code" href="xml_8c.html#a3">saved_lc_ctype</a> = setlocale(LC_CTYPE, <span class="stringliteral">"C"</span>);
00166   <a class="code" href="xml_8c.html#a4">saved_lc_numeric</a> = setlocale(LC_NUMERIC, <span class="stringliteral">"C"</span>);
00167 
00168   <a class="code" href="xml_8c.html#a5">xml_is_initialised</a> = 1;
00169 }
00170 
00171 <span class="comment">/*</span>
00172 <span class="comment"> * Call after using any of the static functions in this file.  All</span>
00173 <span class="comment"> * public functions should call this after using any mxml functions.</span>
00174 <span class="comment"> */</span>
00175 <span class="keywordtype">void</span>
<a name="l00176"></a><a class="code" href="xml_8c.html#a17">00176</a> <a class="code" href="xml_8h.html#a11">stp_xml_exit</a>(<span class="keywordtype">void</span>)
00177 {
00178   <span class="keywordflow">if</span> (<a class="code" href="xml_8c.html#a5">xml_is_initialised</a> &gt; 1) <span class="comment">/* don't restore original state */</span>
00179     {
00180       <a class="code" href="xml_8c.html#a5">xml_is_initialised</a>--;
00181       <span class="keywordflow">return</span>;
00182     }
00183   <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<a class="code" href="xml_8c.html#a5">xml_is_initialised</a> &lt; 1)
00184     <span class="keywordflow">return</span>;
00185 
00186   <span class="comment">/* Restore locale */</span>
00187   setlocale(LC_COLLATE, <a class="code" href="xml_8c.html#a2">saved_lc_collate</a>);
00188   setlocale(LC_CTYPE, <a class="code" href="xml_8c.html#a3">saved_lc_ctype</a>);
00189   setlocale(LC_NUMERIC, <a class="code" href="xml_8c.html#a4">saved_lc_numeric</a>);
00190   <a class="code" href="xml_8c.html#a5">xml_is_initialised</a> = 0;
00191 }
00192 
00193 <span class="keywordtype">void</span>
<a name="l00194"></a><a class="code" href="xml_8c.html#a18">00194</a> <a class="code" href="xml_8c.html#a18">stp_xml_parse_file_named</a>(<span class="keyword">const</span> <span class="keywordtype">char</span> *name)
00195 {
00196   <a class="code" href="structstp__list.html">stp_list_t</a> *dir_list;                  <span class="comment">/* List of directories to scan */</span>
00197   <a class="code" href="structstp__list.html">stp_list_t</a> *file_list;                 <span class="comment">/* List of XML files */</span>
00198   <a class="code" href="structstp__list__item.html">stp_list_item_t</a> *item;                 <span class="comment">/* Pointer to current list item */</span>
00199   <span class="keywordflow">if</span> (!(dir_list = <a class="code" href="list_8h.html#a7">stp_list_create</a>()))
00200     <span class="keywordflow">return</span>;
00201   <a class="code" href="print-list_8c.html#a19">stp_list_set_freefunc</a>(dir_list, <a class="code" href="list_8h.html#a6">stp_list_node_free_data</a>);
00202   <span class="keywordflow">if</span> (getenv(<span class="stringliteral">"STP_DATA_PATH"</span>))
00203     <a class="code" href="path_8c.html#a9">stp_path_split</a>(dir_list, getenv(<span class="stringliteral">"STP_DATA_PATH"</span>));
00204   <span class="keywordflow">else</span>
00205     <a class="code" href="path_8c.html#a9">stp_path_split</a>(dir_list, PKGXMLDATADIR);
00206   file_list = <a class="code" href="path_8c.html#a8">stp_path_search</a>(dir_list, name);
00207   <a class="code" href="print-list_8c.html#a10">stp_list_destroy</a>(dir_list);
00208   item = <a class="code" href="print-list_8c.html#a12">stp_list_get_start</a>(file_list);
00209   <span class="keywordflow">while</span> (item)
00210     {
00211       <a class="code" href="print-util_8c.html#a24">stp_deprintf</a>(<a class="code" href="group__util.html#ga47">STP_DBG_XML</a>,
00212                    <span class="stringliteral">"stp_xml_parse_file_named: source file: %s\n"</span>,
00213                    (<span class="keyword">const</span> <span class="keywordtype">char</span> *) <a class="code" href="print-list_8c.html#a33">stp_list_item_get_data</a>(item));
00214       <a class="code" href="xml_8c.html#a20">stp_xml_parse_file</a>((<span class="keyword">const</span> <span class="keywordtype">char</span> *) <a class="code" href="print-list_8c.html#a33">stp_list_item_get_data</a>(item));
00215       item = <a class="code" href="print-list_8c.html#a32">stp_list_item_next</a>(item);
00216     }
00217   <a class="code" href="print-list_8c.html#a10">stp_list_destroy</a>(file_list);
00218 }
00219   
00220 
00221 <span class="comment">/*</span>
00222 <span class="comment"> * Read all available XML files.</span>
00223 <span class="comment"> */</span>
00224 <span class="keywordtype">int</span>
<a name="l00225"></a><a class="code" href="xml_8c.html#a19">00225</a> <a class="code" href="xml_8h.html#a5">stp_xml_init_defaults</a>(<span class="keywordtype">void</span>)
00226 {
00227   <a class="code" href="structstp__list__item.html">stp_list_item_t</a> *item;                 <span class="comment">/* Pointer to current list item */</span>
00228 
00229   <a class="code" href="xml_8h.html#a10">stp_xml_init</a>();
00230 
00231   <span class="comment">/* Parse each XML file */</span>
00232   item = <a class="code" href="print-list_8c.html#a12">stp_list_get_start</a>(<a class="code" href="xml_8c.html#a1">stpi_xml_preloads</a>);
00233   <span class="keywordflow">while</span> (item)
00234     {
00235       <a class="code" href="print-util_8c.html#a24">stp_deprintf</a>(<a class="code" href="group__util.html#ga47">STP_DBG_XML</a>, <span class="stringliteral">"stp_xml_init_defaults: source file: %s\n"</span>,
00236                    (<span class="keyword">const</span> <span class="keywordtype">char</span> *) <a class="code" href="print-list_8c.html#a33">stp_list_item_get_data</a>(item));
00237       <a class="code" href="xml_8c.html#a18">stp_xml_parse_file_named</a>((<span class="keyword">const</span> <span class="keywordtype">char</span> *) <a class="code" href="print-list_8c.html#a33">stp_list_item_get_data</a>(item));
00238       item = <a class="code" href="print-list_8c.html#a32">stp_list_item_next</a>(item);
00239     }
00240   <a class="code" href="print-list_8c.html#a10">stp_list_destroy</a>(<a class="code" href="xml_8c.html#a1">stpi_xml_preloads</a>);
00241 
00242   <a class="code" href="xml_8h.html#a11">stp_xml_exit</a>();
00243 
00244   <span class="keywordflow">return</span> 0;
00245 }
00246 
00247 
00248 <span class="comment">/*</span>
00249 <span class="comment"> * Parse a single XML file.</span>
00250 <span class="comment"> */</span>
00251 <span class="keywordtype">int</span>
<a name="l00252"></a><a class="code" href="xml_8c.html#a20">00252</a> <a class="code" href="xml_8c.html#a20">stp_xml_parse_file</a>(<span class="keyword">const</span> <span class="keywordtype">char</span> *file) <span class="comment">/* File to parse */</span>
00253 {
00254   <a class="code" href="structstp__mxml__node__s.html">stp_mxml_node_t</a> *doc;
00255   <a class="code" href="structstp__mxml__node__s.html">stp_mxml_node_t</a> *cur;
00256   FILE *fp;
00257 
00258   <a class="code" href="print-util_8c.html#a24">stp_deprintf</a>(<a class="code" href="group__util.html#ga47">STP_DBG_XML</a>, <span class="stringliteral">"stp_xml_parse_file: reading  `%s'...\n"</span>, file);
00259 
00260   fp = fopen(file, <span class="stringliteral">"r"</span>);
00261   <span class="keywordflow">if</span> (!fp)
00262     {
00263       <a class="code" href="print-util_8c.html#a20">stp_erprintf</a>(<span class="stringliteral">"stp_xml_parse_file: unable to open %s: %s\n"</span>, file,
00264                    strerror(errno));
00265       <span class="keywordflow">return</span> 1;
00266     }
00267 
00268   <a class="code" href="xml_8h.html#a10">stp_xml_init</a>();
00269 
00270   doc = <a class="code" href="mxml-file_8c.html#a10">stp_mxmlLoadFile</a>(NULL, fp, <a class="code" href="mxml_8h.html#a2">STP_MXML_NO_CALLBACK</a>);
00271   fclose(fp);
00272 
00273   cur = doc-&gt;<a class="code" href="structstp__mxml__node__s.html#o4">child</a>;
00274   <span class="keywordflow">while</span> (cur &amp;&amp;
00275          (cur-&gt;<a class="code" href="structstp__mxml__node__s.html#o0">type</a> != <a class="code" href="mxml_8h.html#a43a20">STP_MXML_ELEMENT</a> ||
00276           strcmp(cur-&gt;<a class="code" href="structstp__mxml__node__s.html#o6">value</a>.<a class="code" href="unionstp__mxml__value__u.html#o0">element</a>.<a class="code" href="structstp__mxml__value__s.html#o0">name</a>, <span class="stringliteral">"gimp-print"</span>) != 0))
00277     cur = cur-&gt;<a class="code" href="structstp__mxml__node__s.html#o1">next</a>;
00278 
00279   <span class="keywordflow">if</span> (cur == NULL || cur-&gt;<a class="code" href="structstp__mxml__node__s.html#o0">type</a> != <a class="code" href="mxml_8h.html#a43a20">STP_MXML_ELEMENT</a>)
00280     {
00281       <a class="code" href="print-util_8c.html#a20">stp_erprintf</a>(<span class="stringliteral">"stp_xml_parse_file: %s: parse error\n"</span>, file);
00282       <a class="code" href="mxml-node_8c.html#a2">stp_mxmlDelete</a>(doc);
00283       <span class="keywordflow">return</span> 1;
00284     }
00285 
00286   <span class="keywordflow">if</span> (strcmp(cur-&gt;<a class="code" href="structstp__mxml__node__s.html#o6">value</a>.<a class="code" href="unionstp__mxml__value__u.html#o0">element</a>.<a class="code" href="structstp__mxml__value__s.html#o0">name</a>, <span class="stringliteral">"gimp-print"</span>) != 0)
00287     {
00288       <a class="code" href="group__util.html#ga16">stp_erprintf</a>
00289         (<span class="stringliteral">"XML file of the wrong type, root node is %s != gimp-print"</span>,
00290          cur-&gt;<a class="code" href="structstp__mxml__node__s.html#o6">value</a>.<a class="code" href="unionstp__mxml__value__u.html#o0">element</a>.<a class="code" href="structstp__mxml__value__s.html#o0">name</a>);
00291       <a class="code" href="mxml-node_8c.html#a2">stp_mxmlDelete</a>(doc);
00292       <span class="keywordflow">return</span> 1;
00293     }
00294 
00295   <span class="comment">/* The XML file was read and is the right format */</span>
00296 
00297   <a class="code" href="xml_8c.html#a14">stpi_xml_process_gimpprint</a>(cur, file);
00298   <a class="code" href="mxml-node_8c.html#a2">stp_mxmlDelete</a>(doc);
00299 
00300   <a class="code" href="xml_8h.html#a11">stp_xml_exit</a>();
00301 
00302   <span class="keywordflow">return</span> 0;
00303 }
00304 
00305 <span class="comment">/*</span>
00306 <span class="comment"> * Convert a text string into an integer.</span>
00307 <span class="comment"> */</span>
00308 <span class="keywordtype">long</span>
<a name="l00309"></a><a class="code" href="xml_8c.html#a21">00309</a> <a class="code" href="xml_8c.html#a21">stp_xmlstrtol</a>(<span class="keyword">const</span> <span class="keywordtype">char</span> *textval)
00310 {
00311   <span class="keywordtype">long</span> val; <span class="comment">/* The value to return */</span>
00312   val = strtol(textval, (<span class="keywordtype">char</span> **)NULL, 10);
00313 
00314   <span class="keywordflow">return</span> val;
00315 }
00316 
00317 <span class="comment">/*</span>
00318 <span class="comment"> * Convert a text string into an unsigned int.</span>
00319 <span class="comment"> */</span>
00320 <span class="keywordtype">unsigned</span> <span class="keywordtype">long</span>
<a name="l00321"></a><a class="code" href="xml_8c.html#a22">00321</a> <a class="code" href="xml_8c.html#a22">stp_xmlstrtoul</a>(<span class="keyword">const</span> <span class="keywordtype">char</span> *textval)
00322 {
00323   <span class="keywordtype">unsigned</span> <span class="keywordtype">long</span> val; <span class="comment">/* The value to return */</span>
00324   val = strtoul(textval, (<span class="keywordtype">char</span> **)NULL, 10);
00325 
00326   <span class="keywordflow">return</span> val;
00327 }
00328 
00329 <span class="comment">/*</span>
00330 <span class="comment"> * Convert a text string into a double.</span>
00331 <span class="comment"> */</span>
00332 <span class="keywordtype">double</span>
<a name="l00333"></a><a class="code" href="xml_8c.html#a23">00333</a> <a class="code" href="xml_8c.html#a23">stp_xmlstrtod</a>(<span class="keyword">const</span> <span class="keywordtype">char</span> *textval)
00334 {
00335   <span class="keywordtype">double</span> val; <span class="comment">/* The value to return */</span>
00336   val = strtod(textval, (<span class="keywordtype">char</span> **)NULL);
00337 
00338   <span class="keywordflow">return</span> val;
00339 }
00340 
00341 
00342 <span class="comment">/*</span>
00343 <span class="comment"> * Find a node in an XML tree.  This function takes an xmlNodePtr,</span>
00344 <span class="comment"> * followed by a NULL-terminated list of nodes which are required.</span>
00345 <span class="comment"> * For example stp_xml_get_node(myroot, "gimp-print", "dither") will</span>
00346 <span class="comment"> * return the first dither node in the tree.  Additional dither nodes</span>
00347 <span class="comment"> * cannot be accessed with this function.</span>
00348 <span class="comment"> */</span>
00349 <a class="code" href="structstp__mxml__node__s.html">stp_mxml_node_t</a> *
<a name="l00350"></a><a class="code" href="xml_8c.html#a24">00350</a> <a class="code" href="xml_8c.html#a24">stp_xml_get_node</a>(<a class="code" href="structstp__mxml__node__s.html">stp_mxml_node_t</a> *xmlroot, ...)
00351 {
00352   <a class="code" href="structstp__mxml__node__s.html">stp_mxml_node_t</a> *child;
00353   va_list ap;
00354   <span class="keyword">const</span> <span class="keywordtype">char</span> *target = NULL;
00355 
00356   va_start(ap, xmlroot);
00357 
00358   child = xmlroot;
00359   target = va_arg(ap, <span class="keyword">const</span> <span class="keywordtype">char</span> *);
00360 
00361   <span class="keywordflow">while</span> (target &amp;&amp; child)
00362     {
00363       child = <a class="code" href="mxml-search_8c.html#a0">stp_mxmlFindElement</a>(child, child, target, NULL, NULL, <a class="code" href="mxml_8h.html#a4">STP_MXML_DESCEND</a>);
00364       target = va_arg(ap, <span class="keyword">const</span> <span class="keywordtype">char</span> *);
00365     }
00366   va_end(ap);
00367   <span class="keywordflow">return</span> child;
00368 }
00369 
00370 <span class="keyword">static</span> <span class="keywordtype">void</span>
<a name="l00371"></a><a class="code" href="xml_8c.html#a25">00371</a> <a class="code" href="xml_8c.html#a25">stpi_xml_process_node</a>(<a class="code" href="structstp__mxml__node__s.html">stp_mxml_node_t</a> *node, <span class="keyword">const</span> <span class="keywordtype">char</span> *file)
00372 {
00373   <a class="code" href="structstp__list__item.html">stp_list_item_t</a> *item =
00374     <a class="code" href="print-list_8c.html#a16">stp_list_get_item_by_name</a>(<a class="code" href="xml_8c.html#a0">stpi_xml_registry</a>, node-&gt;<a class="code" href="structstp__mxml__node__s.html#o6">value</a>.<a class="code" href="unionstp__mxml__value__u.html#o0">element</a>.<a class="code" href="structstp__mxml__value__s.html#o0">name</a>);
00375   <span class="keywordflow">if</span> (item)
00376     {
00377       <a class="code" href="structstpi__xml__parse__registry.html">stpi_xml_parse_registry</a> *xmlp =
00378         (<a class="code" href="structstpi__xml__parse__registry.html">stpi_xml_parse_registry</a> *) <a class="code" href="print-list_8c.html#a33">stp_list_item_get_data</a>(item);
00379       (xmlp-&gt;<a class="code" href="structstpi__xml__parse__registry.html#o1">parse_func</a>)(node, file);
00380     }
00381 }
00382 
00383 <span class="comment">/*</span>
00384 <span class="comment"> * Parse the &lt;gimp-print&gt; root node.</span>
00385 <span class="comment"> */</span>
00386 <span class="keyword">static</span> <span class="keywordtype">void</span>
<a name="l00387"></a><a class="code" href="xml_8c.html#a14">00387</a> <a class="code" href="xml_8c.html#a14">stpi_xml_process_gimpprint</a>(<a class="code" href="structstp__mxml__node__s.html">stp_mxml_node_t</a> *cur, <span class="keyword">const</span> <span class="keywordtype">char</span> *file) <span class="comment">/* The node to parse */</span>
00388 {
00389   <a class="code" href="structstp__mxml__node__s.html">stp_mxml_node_t</a> *child;                       <span class="comment">/* Child node pointer */</span>
00390 
00391   child = cur-&gt;<a class="code" href="structstp__mxml__node__s.html#o4">child</a>;
00392   <span class="keywordflow">while</span> (child)
00393     {
00394       <span class="comment">/* process nodes with corresponding parser */</span>
00395       <span class="keywordflow">if</span> (child-&gt;<a class="code" href="structstp__mxml__node__s.html#o0">type</a> == <a class="code" href="mxml_8h.html#a43a20">STP_MXML_ELEMENT</a>)
00396         <a class="code" href="xml_8c.html#a25">stpi_xml_process_node</a>(child, file);
00397       child = child-&gt;<a class="code" href="structstp__mxml__node__s.html#o1">next</a>;
00398     }
00399 }
00400 
00401 <span class="comment">/*</span>
00402 <span class="comment"> * Create a basic gimp-print XML document tree root</span>
00403 <span class="comment"> */</span>
00404 <a class="code" href="structstp__mxml__node__s.html">stp_mxml_node_t</a> *
<a name="l00405"></a><a class="code" href="xml_8c.html#a26">00405</a> <a class="code" href="xml_8h.html#a13">stp_xmldoc_create_generic</a>(<span class="keywordtype">void</span>)
00406 {
00407   <a class="code" href="structstp__mxml__node__s.html">stp_mxml_node_t</a> *doc;
00408   <a class="code" href="structstp__mxml__node__s.html">stp_mxml_node_t</a> *rootnode;
00409 
00410   <span class="comment">/* Create the XML tree */</span>
00411   doc = <a class="code" href="mxml-node_8c.html#a3">stp_mxmlNewElement</a>(NULL, <span class="stringliteral">"?xml"</span>);
00412   <a class="code" href="mxml-attr_8c.html#a1">stp_mxmlElementSetAttr</a>(doc, <span class="stringliteral">"version"</span>, <span class="stringliteral">"1.0"</span>);
00413 
00414   rootnode = <a class="code" href="mxml-node_8c.html#a3">stp_mxmlNewElement</a>(doc, <span class="stringliteral">"gimp-print"</span>);
00415   <a class="code" href="mxml_8h.html#a28">stp_mxmlElementSetAttr</a>
00416     (rootnode, <span class="stringliteral">"xmlns"</span>, <span class="stringliteral">"http://gimp-print.sourceforge.net/xsd/gp.xsd-1.0"</span>);
00417   <a class="code" href="mxml_8h.html#a28">stp_mxmlElementSetAttr</a>
00418     (rootnode, <span class="stringliteral">"xmlns:xsi"</span>, <span class="stringliteral">"http://www.w3.org/2001/XMLSchema-instance"</span>);
00419   <a class="code" href="mxml_8h.html#a28">stp_mxmlElementSetAttr</a>
00420     (rootnode, <span class="stringliteral">"xsi:schemaLocation"</span>,
00421      <span class="stringliteral">"http://gimp-print.sourceforge.net/xsd/gp.xsd-1.0 gimpprint.xsd"</span>);
00422 
00423   <span class="keywordflow">return</span> doc;
00424 }
00425 
00426 
00427 
</pre></div><hr size="1"><address style="align: right;"><small>Generated on Wed Aug 25 07:56:15 2004 for libgimpprint API Reference by
<a href="http://www.doxygen.org/index.html">
<img src="doxygen.png" alt="doxygen" align="middle" border=0 > </a>1.3.6 </small></address>
</body>
</html>
