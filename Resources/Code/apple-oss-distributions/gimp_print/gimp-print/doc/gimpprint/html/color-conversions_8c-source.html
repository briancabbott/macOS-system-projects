<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>libgimpprint API Reference: src/main/color-conversions.c Source File</title>
<link href="doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.6 -->
<div class="qindex"><a class="qindex" href="index.html">Main&nbsp;Page</a> | <a class="qindex" href="modules.html">Modules</a> | <a class="qindex" href="classes.html">Alphabetical&nbsp;List</a> | <a class="qindex" href="annotated.html">Data&nbsp;Structures</a> | <a class="qindex" href="files.html">File&nbsp;List</a> | <a class="qindex" href="functions.html">Data&nbsp;Fields</a> | <a class="qindex" href="globals.html">Globals</a> | <a class="qindex" href="pages.html">Related&nbsp;Pages</a></div>
<h1>src/main/color-conversions.c</h1><a href="color-conversions_8c.html">Go to the documentation of this file.</a><div class="fragment"><pre>00001 <span class="comment">/*</span>
00002 <span class="comment"> * "$Id: color-conversions_8c-source.html,v 1.1.1.2 2004/12/22 23:48:56 jlovell Exp $"</span>
00003 <span class="comment"> *</span>
00004 <span class="comment"> *   Gimp-Print color management module - traditional Gimp-Print algorithm.</span>
00005 <span class="comment"> *</span>
00006 <span class="comment"> *   Copyright 1997-2000 Michael Sweet (mike@easysw.com) and</span>
00007 <span class="comment"> *      Robert Krawitz (rlk@alum.mit.edu)</span>
00008 <span class="comment"> *</span>
00009 <span class="comment"> *   This program is free software; you can redistribute it and/or modify it</span>
00010 <span class="comment"> *   under the terms of the GNU General Public License as published by the Free</span>
00011 <span class="comment"> *   Software Foundation; either version 2 of the License, or (at your option)</span>
00012 <span class="comment"> *   any later version.</span>
00013 <span class="comment"> *</span>
00014 <span class="comment"> *   This program is distributed in the hope that it will be useful, but</span>
00015 <span class="comment"> *   WITHOUT ANY WARRANTY; without even the implied warranty of MERCHANTABILITY</span>
00016 <span class="comment"> *   or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License</span>
00017 <span class="comment"> *   for more details.</span>
00018 <span class="comment"> *</span>
00019 <span class="comment"> *   You should have received a copy of the GNU General Public License</span>
00020 <span class="comment"> *   along with this program; if not, write to the Free Software</span>
00021 <span class="comment"> *   Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA 02111-1307, USA.</span>
00022 <span class="comment"> */</span>
00023 
00024 <span class="comment">/*</span>
00025 <span class="comment"> * This file must include only standard C header files.  The core code must</span>
00026 <span class="comment"> * compile on generic platforms that don't support glib, gimp, gtk, etc.</span>
00027 <span class="comment"> */</span>
00028 
00029 <span class="preprocessor">#ifdef HAVE_CONFIG_H</span>
00030 <span class="preprocessor"></span><span class="preprocessor">#include &lt;config.h&gt;</span>
00031 <span class="preprocessor">#endif</span>
00032 <span class="preprocessor"></span><span class="preprocessor">#include &lt;<a class="code" href="gimp-print_8h.html">gimp-print/gimp-print.h</a>&gt;</span>
00033 <span class="preprocessor">#include "<a class="code" href="gimp-print-internal_8h.html">gimp-print-internal.h</a>"</span>
00034 <span class="preprocessor">#include &lt;<a class="code" href="gimp-print-intl-internal_8h.html">gimp-print/gimp-print-intl-internal.h</a>&gt;</span>
00035 <span class="preprocessor">#include &lt;<a class="code" href="curve-cache_8h.html">gimp-print/curve-cache.h</a>&gt;</span>
00036 <span class="preprocessor">#include &lt;math.h&gt;</span>
00037 <span class="preprocessor">#ifdef HAVE_LIMITS_H</span>
00038 <span class="preprocessor"></span><span class="preprocessor">#include &lt;limits.h&gt;</span>
00039 <span class="preprocessor">#endif</span>
00040 <span class="preprocessor"></span><span class="preprocessor">#include &lt;string.h&gt;</span>
00041 <span class="preprocessor">#include "<a class="code" href="color-conversion_8h.html">color-conversion.h</a>"</span>
00042 
00043 <span class="preprocessor">#ifdef __GNUC__</span>
00044 <span class="preprocessor"></span><span class="preprocessor">#define inline __inline__</span>
00045 <span class="preprocessor"></span><span class="preprocessor">#endif</span>
00046 <span class="preprocessor"></span>
00047 <span class="comment">/*</span>
00048 <span class="comment"> * RGB to grayscale luminance constants...</span>
00049 <span class="comment"> */</span>
00050 
<a name="l00051"></a><a class="code" href="color-conversions_8c.html#a0">00051</a> <span class="preprocessor">#define LUM_RED         31</span>
<a name="l00052"></a><a class="code" href="color-conversions_8c.html#a1">00052</a> <span class="preprocessor"></span><span class="preprocessor">#define LUM_GREEN       61</span>
<a name="l00053"></a><a class="code" href="color-conversions_8c.html#a2">00053</a> <span class="preprocessor"></span><span class="preprocessor">#define LUM_BLUE        8</span>
00054 <span class="preprocessor"></span>
00055 <span class="comment">/* rgb/hsl conversions taken from Gimp common/autostretch_hsv.c */</span>
00056 
<a name="l00057"></a><a class="code" href="color-conversions_8c.html#a3">00057</a> <span class="preprocessor">#define FMAX(a, b) ((a) &gt; (b) ? (a) : (b))</span>
<a name="l00058"></a><a class="code" href="color-conversions_8c.html#a4">00058</a> <span class="preprocessor"></span><span class="preprocessor">#define FMIN(a, b) ((a) &lt; (b) ? (a) : (b))</span>
00059 <span class="preprocessor"></span>
00060 <span class="keyword">static</span> <span class="keyword">inline</span> <span class="keywordtype">void</span>
<a name="l00061"></a><a class="code" href="color-conversions_8c.html#a40">00061</a> <a class="code" href="color-conversions_8c.html#a40">calc_rgb_to_hsl</a>(<span class="keywordtype">unsigned</span> <span class="keywordtype">short</span> *rgb, <span class="keywordtype">double</span> *hue, <span class="keywordtype">double</span> *sat,
00062                 <span class="keywordtype">double</span> *lightness)
00063 {
00064   <span class="keywordtype">double</span> red, green, blue;
00065   <span class="keywordtype">double</span> h, s, l;
00066   <span class="keywordtype">double</span> min, <a class="code" href="print-lexmark_8c.html#a6">max</a>;
00067   <span class="keywordtype">double</span> delta;
00068   <span class="keywordtype">int</span> maxval;
00069 
00070   red   = rgb[0] / 65535.0;
00071   green = rgb[1] / 65535.0;
00072   blue  = rgb[2] / 65535.0;
00073 
00074   <span class="keywordflow">if</span> (red &gt; green)
00075     {
00076       <span class="keywordflow">if</span> (red &gt; blue)
00077         {
00078           <a class="code" href="print-lexmark_8c.html#a6">max</a> = red;
00079           maxval = 0;
00080         }
00081       <span class="keywordflow">else</span>
00082         {
00083           <a class="code" href="print-lexmark_8c.html#a6">max</a> = blue;
00084           maxval = 2;
00085         }
00086       min = <a class="code" href="color-conversions_8c.html#a4">FMIN</a>(green, blue);
00087     }
00088   <span class="keywordflow">else</span>
00089     {
00090       <span class="keywordflow">if</span> (green &gt; blue)
00091         {
00092           <a class="code" href="print-lexmark_8c.html#a6">max</a> = green;
00093           maxval = 1;
00094         }
00095       <span class="keywordflow">else</span>
00096         {
00097           <a class="code" href="print-lexmark_8c.html#a6">max</a> = blue;
00098           maxval = 2;
00099         }
00100       min = <a class="code" href="color-conversions_8c.html#a4">FMIN</a>(red, blue);
00101     }
00102 
00103   l = (<a class="code" href="print-lexmark_8c.html#a6">max</a> + min) / 2.0;
00104   delta = <a class="code" href="print-lexmark_8c.html#a6">max</a> - min;
00105 
00106   <span class="keywordflow">if</span> (delta &lt; .000001)  <span class="comment">/* Suggested by Eugene Anikin &lt;eugene@anikin.com&gt; */</span>
00107     {
00108       s = 0.0;
00109       h = 0.0;
00110     }
00111   <span class="keywordflow">else</span>
00112     {
00113       <span class="keywordflow">if</span> (l &lt;= .5)
00114         s = delta / (<a class="code" href="print-lexmark_8c.html#a6">max</a> + min);
00115       <span class="keywordflow">else</span>
00116         s = delta / (2 - <a class="code" href="print-lexmark_8c.html#a6">max</a> - min);
00117 
00118       <span class="keywordflow">if</span> (maxval == 0)
00119         h = (green - blue) / delta;
00120       <span class="keywordflow">else</span> <span class="keywordflow">if</span> (maxval == 1)
00121         h = 2 + (blue - red) / delta;
00122       <span class="keywordflow">else</span>
00123         h = 4 + (red - green) / delta;
00124 
00125       <span class="keywordflow">if</span> (h &lt; 0.0)
00126         h += 6.0;
00127       <span class="keywordflow">else</span> <span class="keywordflow">if</span> (h &gt; 6.0)
00128         h -= 6.0;
00129     }
00130 
00131   *hue = h;
00132   *sat = s;
00133   *lightness = l;
00134 }
00135 
00136 <span class="keyword">static</span> <span class="keyword">inline</span> <span class="keywordtype">double</span>
<a name="l00137"></a><a class="code" href="color-conversions_8c.html#a41">00137</a> <a class="code" href="color-conversions_8c.html#a41">hsl_value</a>(<span class="keywordtype">double</span> n1, <span class="keywordtype">double</span> n2, <span class="keywordtype">double</span> hue)
00138 {
00139   <span class="keywordflow">if</span> (hue &lt; 0)
00140     hue += 6.0;
00141   <span class="keywordflow">else</span> <span class="keywordflow">if</span> (hue &gt; 6)
00142     hue -= 6.0;
00143   <span class="keywordflow">if</span> (hue &lt; 1.0)
00144     <span class="keywordflow">return</span> (n1 + (n2 - n1) * hue);
00145   <span class="keywordflow">else</span> <span class="keywordflow">if</span> (hue &lt; 3.0)
00146     <span class="keywordflow">return</span> (n2);
00147   <span class="keywordflow">else</span> <span class="keywordflow">if</span> (hue &lt; 4.0)
00148     <span class="keywordflow">return</span> (n1 + (n2 - n1) * (4.0 - hue));
00149   <span class="keywordflow">else</span>
00150     <span class="keywordflow">return</span> (n1);
00151 }
00152 
00153 <span class="keyword">static</span> <span class="keyword">inline</span> <span class="keywordtype">void</span>
<a name="l00154"></a><a class="code" href="color-conversions_8c.html#a42">00154</a> <a class="code" href="color-conversions_8c.html#a42">calc_hsl_to_rgb</a>(<span class="keywordtype">unsigned</span> <span class="keywordtype">short</span> *rgb, <span class="keywordtype">double</span> h, <span class="keywordtype">double</span> s, <span class="keywordtype">double</span> l)
00155 {
00156   <span class="keywordflow">if</span> (s &lt; .0000001)
00157     {
00158       <span class="keywordflow">if</span> (l &gt; 1)
00159         l = 1;
00160       <span class="keywordflow">else</span> <span class="keywordflow">if</span> (l &lt; 0)
00161         l = 0;
00162       rgb[0] = l * 65535;
00163       rgb[1] = l * 65535;
00164       rgb[2] = l * 65535;
00165     }
00166   <span class="keywordflow">else</span>
00167     {
00168       <span class="keywordtype">double</span> m1, m2;
00169       <span class="keywordtype">double</span> h1, h2;
00170       h1 = h + 2;
00171       h2 = h - 2;
00172 
00173       <span class="keywordflow">if</span> (l &lt; .5)
00174         m2 = l * (1 + s);
00175       <span class="keywordflow">else</span>
00176         m2 = l + s - (l * s);
00177       m1 = (l * 2) - m2;
00178       rgb[0] = 65535 * <a class="code" href="color-conversions_8c.html#a41">hsl_value</a>(m1, m2, h1);
00179       rgb[1] = 65535 * <a class="code" href="color-conversions_8c.html#a41">hsl_value</a>(m1, m2, h);
00180       rgb[2] = 65535 * <a class="code" href="color-conversions_8c.html#a41">hsl_value</a>(m1, m2, h2);
00181     }
00182 }
00183 
00184 <span class="keyword">static</span> <span class="keyword">inline</span> <span class="keywordtype">double</span>
<a name="l00185"></a><a class="code" href="color-conversions_8c.html#a43">00185</a> <a class="code" href="color-conversions_8c.html#a43">update_saturation</a>(<span class="keywordtype">double</span> sat, <span class="keywordtype">double</span> adjust, <span class="keywordtype">double</span> isat)
00186 {
00187   <span class="keywordflow">if</span> (adjust &lt; 1)
00188     sat *= adjust;
00189   <span class="keywordflow">else</span> <span class="keywordflow">if</span> (adjust &gt; 1)
00190     {
00191       <span class="keywordtype">double</span> s1 = sat * adjust;
00192       <span class="keywordtype">double</span> s2 = 1.0 - ((1.0 - sat) * isat);
00193       sat = <a class="code" href="color-conversions_8c.html#a4">FMIN</a>(s1, s2);
00194     }
00195   <span class="keywordflow">if</span> (sat &gt; 1)
00196     sat = 1.0;
00197   <span class="keywordflow">return</span> sat;
00198 }
00199 
00200 <span class="keyword">static</span> <span class="keyword">inline</span> <span class="keywordtype">double</span>
<a name="l00201"></a><a class="code" href="color-conversions_8c.html#a44">00201</a> <a class="code" href="color-conversions_8c.html#a44">interpolate_value</a>(<span class="keyword">const</span> <span class="keywordtype">double</span> *vec, <span class="keywordtype">double</span> val)
00202 {
00203   <span class="keywordtype">double</span> base = floor(val);
00204   <span class="keywordtype">double</span> frac = val - base;
00205   <span class="keywordtype">int</span> ibase = (<span class="keywordtype">int</span>) base;
00206   <span class="keywordtype">double</span> lval = vec[ibase];
00207   <span class="keywordflow">if</span> (frac &gt; 0)
00208     lval += (vec[ibase + 1] - lval) * frac;
00209   <span class="keywordflow">return</span> lval;
00210 }
00211 
00212 <span class="keyword">static</span> <span class="keyword">inline</span> <span class="keywordtype">void</span>
<a name="l00213"></a><a class="code" href="color-conversions_8c.html#a45">00213</a> <a class="code" href="color-conversions_8c.html#a45">update_saturation_from_rgb</a>(<span class="keywordtype">unsigned</span> <span class="keywordtype">short</span> *rgb,
00214                            <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">short</span> *brightness_lookup,
00215                            <span class="keywordtype">double</span> adjust, <span class="keywordtype">double</span> isat, <span class="keywordtype">int</span> do_usermap)
00216 {
00217   <span class="keywordtype">double</span> h, s, l;
00218   <a class="code" href="color-conversions_8c.html#a40">calc_rgb_to_hsl</a>(rgb, &amp;h, &amp;s, &amp;l);
00219   <span class="keywordflow">if</span> (do_usermap)
00220     {
00221       <span class="keywordtype">unsigned</span> <span class="keywordtype">short</span> ub = (<span class="keywordtype">unsigned</span> <span class="keywordtype">short</span>) (l * 65535);
00222       <span class="keywordtype">unsigned</span> <span class="keywordtype">short</span> val = brightness_lookup[ub];
00223       l = ((<span class="keywordtype">double</span>) val) / 65535;
00224       <span class="keywordflow">if</span> (val &lt; ub)
00225         s = s * (65535 - ub) / (65535 - val);
00226     }
00227   s = <a class="code" href="color-conversions_8c.html#a43">update_saturation</a>(s, adjust, isat);
00228   <a class="code" href="color-conversions_8c.html#a42">calc_hsl_to_rgb</a>(rgb, h, s, l);
00229 }
00230 
00231 <span class="keyword">static</span> <span class="keyword">inline</span> <span class="keywordtype">double</span>
<a name="l00232"></a><a class="code" href="color-conversions_8c.html#a46">00232</a> <a class="code" href="color-conversions_8c.html#a46">adjust_hue</a>(<span class="keyword">const</span> <span class="keywordtype">double</span> *hue_map, <span class="keywordtype">double</span> hue, size_t points)
00233 {
00234   <span class="keywordflow">if</span> (hue_map)
00235     {
00236       hue += <a class="code" href="color-conversions_8c.html#a44">interpolate_value</a>(hue_map, hue * points / 6.0);
00237       <span class="keywordflow">if</span> (hue &lt; 0.0)
00238         hue += 6.0;
00239       <span class="keywordflow">else</span> <span class="keywordflow">if</span> (hue &gt;= 6.0)
00240         hue -= 6.0;
00241     }
00242   <span class="keywordflow">return</span> hue;
00243 }
00244 
00245 <span class="keyword">static</span> <span class="keyword">inline</span> <span class="keywordtype">void</span>
<a name="l00246"></a><a class="code" href="color-conversions_8c.html#a47">00246</a> <a class="code" href="color-conversions_8c.html#a47">adjust_hsl</a>(<span class="keywordtype">unsigned</span> <span class="keywordtype">short</span> *rgbout, <a class="code" href="structlut__t.html">lut_t</a> *lut, <span class="keywordtype">double</span> ssat, <span class="keywordtype">double</span> isat,
00247            <span class="keywordtype">int</span> split_saturation)
00248 {
00249   <span class="keyword">const</span> <span class="keywordtype">double</span> *hue_map = <a class="code" href="curve-cache_8h.html#a1">CURVE_CACHE_FAST_DOUBLE</a>(&amp;(lut-&gt;<a class="code" href="structlut__t.html#o22">hue_map</a>));
00250   <span class="keyword">const</span> <span class="keywordtype">double</span> *lum_map = <a class="code" href="curve-cache_8h.html#a1">CURVE_CACHE_FAST_DOUBLE</a>(&amp;(lut-&gt;<a class="code" href="structlut__t.html#o23">lum_map</a>));
00251   <span class="keyword">const</span> <span class="keywordtype">double</span> *sat_map = <a class="code" href="curve-cache_8h.html#a1">CURVE_CACHE_FAST_DOUBLE</a>(&amp;(lut-&gt;<a class="code" href="structlut__t.html#o24">sat_map</a>));
00252   <span class="keywordflow">if</span> ((split_saturation || lum_map || hue_map || sat_map) &amp;&amp;
00253       (rgbout[0] != rgbout[1] || rgbout[0] != rgbout[2]))
00254     {
00255       size_t hue_count = <a class="code" href="curve-cache_8h.html#a2">CURVE_CACHE_FAST_COUNT</a>(&amp;(lut-&gt;<a class="code" href="structlut__t.html#o22">hue_map</a>));
00256       size_t lum_count = <a class="code" href="curve-cache_8h.html#a2">CURVE_CACHE_FAST_COUNT</a>(&amp;(lut-&gt;<a class="code" href="structlut__t.html#o23">lum_map</a>));
00257       size_t sat_count = <a class="code" href="curve-cache_8h.html#a2">CURVE_CACHE_FAST_COUNT</a>(&amp;(lut-&gt;<a class="code" href="structlut__t.html#o24">sat_map</a>));
00258       <span class="keywordtype">double</span> h, s, l;
00259       <span class="keywordtype">double</span> oh;
00260       rgbout[0] ^= 65535;
00261       rgbout[1] ^= 65535;
00262       rgbout[2] ^= 65535;
00263       <a class="code" href="color-conversions_8c.html#a40">calc_rgb_to_hsl</a>(rgbout, &amp;h, &amp;s, &amp;l);
00264       s = <a class="code" href="color-conversions_8c.html#a43">update_saturation</a>(s, ssat, isat);
00265       oh = h;
00266       h = <a class="code" href="color-conversions_8c.html#a46">adjust_hue</a>(hue_map, h, hue_count);
00267       <span class="keywordflow">if</span> (lut-&gt;<a class="code" href="structlut__t.html#o23">lum_map</a>.<a class="code" href="structstp__cached__curve__t.html#o1">d_cache</a> &amp;&amp; l &gt; 0.0001 &amp;&amp; l &lt; .9999)
00268         {
00269           <span class="keywordtype">double</span> nh = oh * lum_count / 6.0;
00270           <span class="keywordtype">double</span> el = <a class="code" href="color-conversions_8c.html#a44">interpolate_value</a>(lum_map, nh);
00271           <span class="keywordtype">double</span> sreflection = .8 - ((1.0 - el) / 1.3) ;
00272           <span class="keywordtype">double</span> isreflection = 1.0 - sreflection;
00273           <span class="keywordtype">double</span> sadj = l - sreflection;
00274           <span class="keywordtype">double</span> isadj = 1;
00275           <span class="keywordtype">double</span> sisadj = 1;
00276           <span class="keywordflow">if</span> (sadj &gt; 0)
00277             {
00278               isadj = (1.0 / isreflection) * (isreflection - sadj);
00279               sisadj = sqrt(isadj);
00280               <span class="comment">/*</span>
00281 <span class="comment">                s *= isadj * sisadj;</span>
00282 <span class="comment">              */</span>
00283               s *= sqrt(isadj * sisadj);
00284             }
00285           <span class="keywordflow">if</span> (el &lt; .9999)
00286             {
00287               <span class="keywordtype">double</span> es = s;
00288               es = 1 - es;
00289               es *= es * es;
00290               es = 1 - es;
00291               el = 1.0 + (es * (el - 1.0));
00292               l *= el;
00293             }
00294           <span class="keywordflow">else</span> <span class="keywordflow">if</span> (el &gt; 1.0001)
00295             l = 1.0 - pow(1.0 - l, el);
00296           <span class="keywordflow">if</span> (sadj &gt; 0)
00297             {
00298               <span class="comment">/*                  s *= sqrt(isadj); */</span>
00299               l = 1.0 - ((1.0 - l) * sqrt(sqrt(sisadj)));
00300             }
00301         }
00302       <span class="keywordflow">if</span> (lut-&gt;<a class="code" href="structlut__t.html#o24">sat_map</a>.<a class="code" href="structstp__cached__curve__t.html#o1">d_cache</a>)
00303         {
00304           <span class="keywordtype">double</span> nh = oh * sat_count / 6.0;
00305           <span class="keywordtype">double</span> tmp = <a class="code" href="color-conversions_8c.html#a44">interpolate_value</a>(sat_map, nh);
00306           <span class="keywordflow">if</span> (tmp &lt; .9999 || tmp &gt; 1.0001)
00307             {
00308               s = <a class="code" href="color-conversions_8c.html#a43">update_saturation</a>(s, tmp, tmp &gt; 1.0 ? 1.0 / tmp : 1.0);
00309             }
00310         }
00311       <a class="code" href="color-conversions_8c.html#a42">calc_hsl_to_rgb</a>(rgbout, h, s, l);
00312       rgbout[0] ^= 65535;
00313       rgbout[1] ^= 65535;
00314       rgbout[2] ^= 65535;
00315     }
00316 }
00317 
00318 <span class="keyword">static</span> <span class="keyword">inline</span> <span class="keywordtype">void</span>
<a name="l00319"></a><a class="code" href="color-conversions_8c.html#a48">00319</a> <a class="code" href="color-conversions_8c.html#a48">adjust_hsl_bright</a>(<span class="keywordtype">unsigned</span> <span class="keywordtype">short</span> *rgbout, <a class="code" href="structlut__t.html">lut_t</a> *lut, <span class="keywordtype">double</span> ssat, <span class="keywordtype">double</span> isat,
00320                   <span class="keywordtype">int</span> split_saturation)
00321 {
00322   <span class="keyword">const</span> <span class="keywordtype">double</span> *hue_map = <a class="code" href="curve-cache_8h.html#a1">CURVE_CACHE_FAST_DOUBLE</a>(&amp;(lut-&gt;<a class="code" href="structlut__t.html#o22">hue_map</a>));
00323   <span class="keyword">const</span> <span class="keywordtype">double</span> *lum_map = <a class="code" href="curve-cache_8h.html#a1">CURVE_CACHE_FAST_DOUBLE</a>(&amp;(lut-&gt;<a class="code" href="structlut__t.html#o23">lum_map</a>));
00324   <span class="keywordflow">if</span> ((split_saturation || lum_map || hue_map) &amp;&amp;
00325       (rgbout[0] != rgbout[1] || rgbout[0] != rgbout[2]))
00326     {
00327       size_t hue_count = <a class="code" href="curve-cache_8h.html#a2">CURVE_CACHE_FAST_COUNT</a>(&amp;(lut-&gt;<a class="code" href="structlut__t.html#o22">hue_map</a>));
00328       size_t lum_count = <a class="code" href="curve-cache_8h.html#a2">CURVE_CACHE_FAST_COUNT</a>(&amp;(lut-&gt;<a class="code" href="structlut__t.html#o23">lum_map</a>));
00329       <span class="keywordtype">double</span> h, s, l;
00330       rgbout[0] ^= 65535;
00331       rgbout[1] ^= 65535;
00332       rgbout[2] ^= 65535;
00333       <a class="code" href="color-conversions_8c.html#a40">calc_rgb_to_hsl</a>(rgbout, &amp;h, &amp;s, &amp;l);
00334       s = <a class="code" href="color-conversions_8c.html#a43">update_saturation</a>(s, ssat, isat);
00335       h = <a class="code" href="color-conversions_8c.html#a46">adjust_hue</a>(hue_map, h, hue_count);
00336       <span class="keywordflow">if</span> (lum_map &amp;&amp; l &gt; 0.0001 &amp;&amp; l &lt; .9999)
00337         {
00338           <span class="keywordtype">double</span> nh = h * lum_count / 6.0;
00339           <span class="keywordtype">double</span> el = <a class="code" href="color-conversions_8c.html#a44">interpolate_value</a>(lum_map, nh);
00340           el = 1.0 + (s * (el - 1.0));
00341           l = 1.0 - pow(1.0 - l, el);
00342         }
00343       <a class="code" href="color-conversions_8c.html#a42">calc_hsl_to_rgb</a>(rgbout, h, s, l);
00344       rgbout[0] ^= 65535;
00345       rgbout[1] ^= 65535;
00346       rgbout[2] ^= 65535;
00347     }
00348 }
00349 
00350 <span class="keyword">static</span> <span class="keyword">inline</span> <span class="keywordtype">void</span>
<a name="l00351"></a><a class="code" href="color-conversions_8c.html#a49">00351</a> <a class="code" href="color-conversions_8c.html#a49">lookup_rgb</a>(<a class="code" href="structlut__t.html">lut_t</a> *lut, <span class="keywordtype">unsigned</span> <span class="keywordtype">short</span> *rgbout,
00352            <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">short</span> *red, <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">short</span> *green,
00353            <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">short</span> *blue, <span class="keywordtype">unsigned</span> steps)
00354 {
00355   <span class="keywordflow">if</span> (steps == 65536)
00356     {
00357       rgbout[0] = red[rgbout[0]];
00358       rgbout[1] = green[rgbout[1]];
00359       rgbout[2] = blue[rgbout[2]];
00360     }
00361   <span class="keywordflow">else</span>
00362     {
00363       rgbout[0] = red[rgbout[0] / 257];
00364       rgbout[1] = green[rgbout[1] / 257];
00365       rgbout[2] = blue[rgbout[2] / 257];
00366     }
00367 }
00368 
00369 <span class="keyword">static</span> <span class="keyword">inline</span> <span class="keywordtype">int</span>
<a name="l00370"></a><a class="code" href="color-conversions_8c.html#a50">00370</a> <a class="code" href="color-conversions_8c.html#a50">short_eq</a>(<span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">short</span> *i1, <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">short</span> *i2, size_t count)
00371 {
00372 <span class="preprocessor">#if 1</span>
00373 <span class="preprocessor"></span>  <span class="keywordtype">int</span> i;
00374   <span class="keywordflow">for</span> (i = 0; i &lt; count; i++)
00375     <span class="keywordflow">if</span> (i1[i] != i2[i])
00376       <span class="keywordflow">return</span> 0;
00377   <span class="keywordflow">return</span> 1;
00378 <span class="preprocessor">#else</span>
00379 <span class="preprocessor"></span>  <span class="keywordflow">return</span> !memcmp(i1, i2, count * <span class="keyword">sizeof</span>(<span class="keywordtype">unsigned</span> <span class="keywordtype">short</span>));
00380 <span class="preprocessor">#endif</span>
00381 <span class="preprocessor"></span>}
00382 
00383 <span class="keyword">static</span> <span class="keyword">inline</span> <span class="keywordtype">void</span>
<a name="l00384"></a><a class="code" href="color-conversions_8c.html#a51">00384</a> <a class="code" href="color-conversions_8c.html#a51">short_copy</a>(<span class="keywordtype">unsigned</span> <span class="keywordtype">short</span> *out, <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">short</span> *in, size_t count)
00385 {
00386 <span class="preprocessor">#if 1</span>
00387 <span class="preprocessor"></span>  <span class="keywordtype">int</span> i;
00388   <span class="keywordflow">for</span> (i = 0; i &lt; count; i++)
00389     out[i] = in[i];
00390 <span class="preprocessor">#else</span>
00391 <span class="preprocessor"></span>  (<span class="keywordtype">void</span>) memcpy(out, in, count * <span class="keyword">sizeof</span>(<span class="keywordtype">unsigned</span> <span class="keywordtype">short</span>));
00392 <span class="preprocessor">#endif</span>
00393 <span class="preprocessor"></span>}
00394 
00395 <span class="keyword">static</span> <span class="keywordtype">unsigned</span>
<a name="l00396"></a><a class="code" href="color-conversions_8c.html#a52">00396</a> <a class="code" href="color-conversions_8c.html#a52">generic_cmy_to_kcmy</a>(<span class="keyword">const</span> <a class="code" href="structstp__vars.html">stp_vars_t</a> *vars, <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">short</span> *in,
00397                     <span class="keywordtype">unsigned</span> <span class="keywordtype">short</span> *out)
00398 {
00399   <a class="code" href="structlut__t.html">lut_t</a> *lut = (<a class="code" href="structlut__t.html">lut_t</a> *)(<a class="code" href="group__vars.html#ga20">stp_get_component_data</a>(vars, <span class="stringliteral">"Color"</span>));
00400   <span class="keywordtype">int</span> width = lut-&gt;<a class="code" href="structlut__t.html#o2">image_width</a>;
00401   <span class="keywordtype">int</span> step = 65535 / (lut-&gt;<a class="code" href="structlut__t.html#o0">steps</a> - 1); <span class="comment">/* 1 or 257 */</span>
00402 
00403   <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">short</span> *gcr_lookup;
00404   <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">short</span> *black_lookup;
00405   <span class="keywordtype">int</span> i;
00406   <span class="keywordtype">int</span> i0 = -1;
00407   <span class="keywordtype">int</span> i1 = -1;
00408   <span class="keywordtype">int</span> i2 = -1;
00409   <span class="keywordtype">unsigned</span> <span class="keywordtype">short</span> o0 = 0;
00410   <span class="keywordtype">unsigned</span> <span class="keywordtype">short</span> o1 = 0;
00411   <span class="keywordtype">unsigned</span> <span class="keywordtype">short</span> o2 = 0;
00412   <span class="keywordtype">unsigned</span> <span class="keywordtype">short</span> o3 = 0;
00413   <span class="keywordtype">unsigned</span> <span class="keywordtype">short</span> nz0 = 0;
00414   <span class="keywordtype">unsigned</span> <span class="keywordtype">short</span> nz1 = 0;
00415   <span class="keywordtype">unsigned</span> <span class="keywordtype">short</span> nz2 = 0;
00416   <span class="keywordtype">unsigned</span> <span class="keywordtype">short</span> nz3 = 0;
00417 
00418   <a class="code" href="group__curve.html#ga51">stp_curve_resample</a>(<a class="code" href="curve-cache_8c.html#a2">stp_curve_cache_get_curve</a>(&amp;(lut-&gt;<a class="code" href="structlut__t.html#o25">gcr_curve</a>)), lut-&gt;<a class="code" href="structlut__t.html#o0">steps</a>);
00419   gcr_lookup = <a class="code" href="curve-cache_8c.html#a7">stp_curve_cache_get_ushort_data</a>(&amp;(lut-&gt;<a class="code" href="structlut__t.html#o25">gcr_curve</a>));
00420   <a class="code" href="group__curve.html#ga51">stp_curve_resample</a>(<a class="code" href="curve-cache_8h.html#a5">stp_curve_cache_get_curve</a>
00421                      (&amp;(lut-&gt;<a class="code" href="structlut__t.html#o13">channel_curves</a>[<a class="code" href="color-conversion_8h.html#a0">CHANNEL_K</a>])), lut-&gt;<a class="code" href="structlut__t.html#o0">steps</a>);
00422   black_lookup =
00423     <a class="code" href="curve-cache_8c.html#a7">stp_curve_cache_get_ushort_data</a>(&amp;(lut-&gt;<a class="code" href="structlut__t.html#o13">channel_curves</a>[<a class="code" href="color-conversion_8h.html#a0">CHANNEL_K</a>]));
00424 
00425   <span class="keywordflow">for</span> (i = 0; i &lt; width; i++, out += 4, in += 3)
00426     {
00427       <span class="keywordflow">if</span> (i0 == in[0] &amp;&amp; i1 == in[1] &amp;&amp; i2 == in[2])
00428         {
00429           out[0] = o0;
00430           out[1] = o1;
00431           out[2] = o2;
00432           out[3] = o3;
00433         }
00434       <span class="keywordflow">else</span>
00435         {
00436           <span class="keywordtype">int</span> k;
00437           i0 = in[0];
00438           i1 = in[1];
00439           i2 = in[2];
00440           k = <a class="code" href="color-conversions_8c.html#a4">FMIN</a>(i0, <a class="code" href="color-conversions_8c.html#a4">FMIN</a>(i1, i2));
00441           out[0] = 0;
00442           out[1] = i0;
00443           out[2] = i1;
00444           out[3] = i2;
00445           <span class="keywordflow">if</span> (k &gt; 0)
00446             {
00447               <span class="keywordtype">int</span> where, resid;
00448               <span class="keywordtype">int</span> kk;
00449               <span class="keywordflow">if</span> (lut-&gt;<a class="code" href="structlut__t.html#o0">steps</a> == 65536)
00450                 kk = gcr_lookup[k];
00451               <span class="keywordflow">else</span>
00452                 {
00453                   where = k / step;
00454                   resid = k % step;
00455                   kk = gcr_lookup[where];
00456                   <span class="keywordflow">if</span> (resid &gt; 0)
00457                     kk += (gcr_lookup[where + 1] - gcr_lookup[where]) * resid /
00458                       step;
00459                 }
00460               <span class="keywordflow">if</span> (kk &gt; k)
00461                 kk = k;
00462               <span class="keywordflow">if</span> (kk &gt; 0)
00463                 {
00464                   <span class="keywordflow">if</span> (lut-&gt;<a class="code" href="structlut__t.html#o0">steps</a> == 65536)
00465                     out[0] = black_lookup[kk];
00466                   <span class="keywordflow">else</span>
00467                     {
00468                       <span class="keywordtype">int</span> k_out;
00469                       where = kk / step;
00470                       resid = kk % step;
00471                       k_out = black_lookup[where];
00472                       <span class="keywordflow">if</span> (resid &gt; 0)
00473                         k_out +=
00474                           (black_lookup[where + 1] - black_lookup[where]) *
00475                           resid / step;
00476                       out[0] = k_out;
00477                     }
00478                   out[1] -= kk;
00479                   out[2] -= kk;
00480                   out[3] -= kk;
00481                 }
00482             }
00483           o0 = out[0];
00484           o1 = out[1];
00485           o2 = out[2];
00486           o3 = out[3];
00487           nz0 |= o0;
00488           nz1 |= o1;
00489           nz2 |= o2;
00490           nz3 |= o3;
00491         }
00492     }
00493   <span class="keywordflow">return</span> (nz0 ? 0 : 1) + (nz1 ? 0 : 2) + (nz2 ? 0 : 4) + (nz3 ? 0 : 8);
00494 }
00495 
00496 <span class="keyword">static</span> <span class="keywordtype">unsigned</span>
<a name="l00497"></a><a class="code" href="color-conversions_8c.html#a53">00497</a> <a class="code" href="color-conversions_8c.html#a53">raw_cmy_to_kcmy</a>(<span class="keyword">const</span> <a class="code" href="structstp__vars.html">stp_vars_t</a> *vars, <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">short</span> *in,
00498                 <span class="keywordtype">unsigned</span> <span class="keywordtype">short</span> *out)
00499 {
00500   <a class="code" href="structlut__t.html">lut_t</a> *lut = (<a class="code" href="structlut__t.html">lut_t</a> *)(<a class="code" href="group__vars.html#ga20">stp_get_component_data</a>(vars, <span class="stringliteral">"Color"</span>));
00501   <span class="keywordtype">int</span> width = lut-&gt;<a class="code" href="structlut__t.html#o2">image_width</a>;
00502 
00503   <span class="keywordtype">int</span> i;
00504   <span class="keywordtype">int</span> j;
00505   <span class="keywordtype">unsigned</span> <span class="keywordtype">short</span> nz[4];
00506   <span class="keywordtype">unsigned</span> retval = 0;
00507   <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">short</span> *input_cache = NULL;
00508   <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">short</span> *output_cache = NULL;
00509 
00510   memset(nz, 0, <span class="keyword">sizeof</span>(nz));
00511 
00512   <span class="keywordflow">for</span> (i = 0; i &lt; width; i++, out += 4, in += 3)
00513     {
00514       <span class="keywordflow">if</span> (input_cache &amp;&amp; <a class="code" href="color-conversions_8c.html#a50">short_eq</a>(input_cache, in, 3))
00515         <a class="code" href="color-conversions_8c.html#a51">short_copy</a>(out, output_cache, 4);
00516       <span class="keywordflow">else</span>
00517         {
00518           <span class="keywordtype">int</span> c = in[0];
00519           <span class="keywordtype">int</span> m = in[1];
00520           <span class="keywordtype">int</span> y = in[2];
00521           <span class="keywordtype">int</span> k = <a class="code" href="color-conversions_8c.html#a4">FMIN</a>(c, <a class="code" href="color-conversions_8c.html#a4">FMIN</a>(m, y));
00522           input_cache = in;
00523           out[0] = 0;
00524           <span class="keywordflow">for</span> (j = 0; j &lt; 3; j++)
00525             out[j + 1] = in[j];
00526           <span class="keywordflow">if</span> (k &gt; 0)
00527             {
00528               out[0] = k;
00529               out[1] -= k;
00530               out[2] -= k;
00531               out[3] -= k;
00532             }
00533           output_cache = out;
00534           <span class="keywordflow">for</span> (j = 0; j &lt; 4; j++)
00535             <span class="keywordflow">if</span> (out[j])
00536               nz[j] = 1;
00537         }
00538     }
00539   <span class="keywordflow">for</span> (j = 0; j &lt; 4; j++)
00540     <span class="keywordflow">if</span> (nz[j] == 0)
00541       retval |= (1 &lt;&lt; j);
00542   <span class="keywordflow">return</span> retval;
00543 }
00544 
<a name="l00545"></a><a class="code" href="color-conversions_8c.html#a5">00545</a> <span class="preprocessor">#define GENERIC_COLOR_FUNC(fromname, toname)                            \</span>
00546 <span class="preprocessor">static unsigned                                                         \</span>
00547 <span class="preprocessor">fromname##_to_##toname(const stp_vars_t *vars, const unsigned char *in, \</span>
00548 <span class="preprocessor">                       unsigned short *out)                             \</span>
00549 <span class="preprocessor">{                                                                       \</span>
00550 <span class="preprocessor">  lut_t *lut = (lut_t *)(stp_get_component_data(vars, "Color"));        \</span>
00551 <span class="preprocessor">  if (!lut-&gt;printed_colorfunc)                                          \</span>
00552 <span class="preprocessor">    {                                                                   \</span>
00553 <span class="preprocessor">      lut-&gt;printed_colorfunc = 1;                                       \</span>
00554 <span class="preprocessor">      stp_dprintf(STP_DBG_COLORFUNC, vars,                              \</span>
00555 <span class="preprocessor">                   "Colorfunc is %s_%d_to_%s, %s, %s, %d, %d\n",        \</span>
00556 <span class="preprocessor">                   #fromname, lut-&gt;channel_depth, #toname,              \</span>
00557 <span class="preprocessor">                   lut-&gt;input_color_description-&gt;name,                  \</span>
00558 <span class="preprocessor">                   lut-&gt;output_color_description-&gt;name,                 \</span>
00559 <span class="preprocessor">                   lut-&gt;steps, lut-&gt;invert_output);                     \</span>
00560 <span class="preprocessor">    }                                                                   \</span>
00561 <span class="preprocessor">  if (lut-&gt;channel_depth == 8)                                          \</span>
00562 <span class="preprocessor">    return fromname##_8_to_##toname(vars, in, out);                     \</span>
00563 <span class="preprocessor">  else                                                                  \</span>
00564 <span class="preprocessor">    return fromname##_16_to_##toname(vars, in, out);                    \</span>
00565 <span class="preprocessor">}</span>
00566 <span class="preprocessor"></span>
<a name="l00567"></a><a class="code" href="color-conversions_8c.html#a6">00567</a> <span class="preprocessor">#define COLOR_TO_COLOR_FUNC(T, bits)                                         \</span>
00568 <span class="preprocessor">static unsigned                                                              \</span>
00569 <span class="preprocessor">color_##bits##_to_color(const stp_vars_t *vars, const unsigned char *in,     \</span>
00570 <span class="preprocessor">                        unsigned short *out)                                 \</span>
00571 <span class="preprocessor">{                                                                            \</span>
00572 <span class="preprocessor">  int i;                                                                     \</span>
00573 <span class="preprocessor">  double isat = 1.0;                                                         \</span>
00574 <span class="preprocessor">  double ssat = stp_get_float_parameter(vars, "Saturation");                 \</span>
00575 <span class="preprocessor">  double sbright = stp_get_float_parameter(vars, "Brightness");              \</span>
00576 <span class="preprocessor">  int i0 = -1;                                                               \</span>
00577 <span class="preprocessor">  int i1 = -1;                                                               \</span>
00578 <span class="preprocessor">  int i2 = -1;                                                               \</span>
00579 <span class="preprocessor">  unsigned short o0 = 0;                                                     \</span>
00580 <span class="preprocessor">  unsigned short o1 = 0;                                                     \</span>
00581 <span class="preprocessor">  unsigned short o2 = 0;                                                     \</span>
00582 <span class="preprocessor">  unsigned short nz0 = 0;                                                    \</span>
00583 <span class="preprocessor">  unsigned short nz1 = 0;                                                    \</span>
00584 <span class="preprocessor">  unsigned short nz2 = 0;                                                    \</span>
00585 <span class="preprocessor">  const unsigned short *red;                                                 \</span>
00586 <span class="preprocessor">  const unsigned short *green;                                               \</span>
00587 <span class="preprocessor">  const unsigned short *blue;                                                \</span>
00588 <span class="preprocessor">  const unsigned short *brightness;                                          \</span>
00589 <span class="preprocessor">  const unsigned short *contrast;                                            \</span>
00590 <span class="preprocessor">  const T *s_in = (const T *) in;                                            \</span>
00591 <span class="preprocessor">  lut_t *lut = (lut_t *)(stp_get_component_data(vars, "Color"));             \</span>
00592 <span class="preprocessor">  int compute_saturation = ssat &lt;= .99999 || ssat &gt;= 1.00001;                \</span>
00593 <span class="preprocessor">  int split_saturation = ssat &gt; 1.4;                                         \</span>
00594 <span class="preprocessor">  int bright_color_adjustment = 0;                                           \</span>
00595 <span class="preprocessor">  int do_user_adjustment = 0;                                                \</span>
00596 <span class="preprocessor">  if (lut-&gt;color_correction-&gt;correction == COLOR_CORRECTION_BRIGHT)          \</span>
00597 <span class="preprocessor">    bright_color_adjustment = 1;                                             \</span>
00598 <span class="preprocessor">  if (sbright != 1)                                                          \</span>
00599 <span class="preprocessor">    do_user_adjustment = 1;                                                  \</span>
00600 <span class="preprocessor">  compute_saturation |= do_user_adjustment;                                  \</span>
00601 <span class="preprocessor">                                                                             \</span>
00602 <span class="preprocessor">  for (i = CHANNEL_C; i &lt;= CHANNEL_Y; i++)                                   \</span>
00603 <span class="preprocessor">    stp_curve_resample(stp_curve_cache_get_curve(&amp;(lut-&gt;channel_curves[i])), \</span>
00604 <span class="preprocessor">                       1 &lt;&lt; bits);                                           \</span>
00605 <span class="preprocessor">  stp_curve_resample                                                         \</span>
00606 <span class="preprocessor">    (stp_curve_cache_get_curve(&amp;(lut-&gt;brightness_correction)), 65536);       \</span>
00607 <span class="preprocessor">  stp_curve_resample                                                         \</span>
00608 <span class="preprocessor">    (stp_curve_cache_get_curve(&amp;(lut-&gt;contrast_correction)), 1 &lt;&lt; bits);     \</span>
00609 <span class="preprocessor">  red =                                                                      \</span>
00610 <span class="preprocessor">    stp_curve_cache_get_ushort_data(&amp;(lut-&gt;channel_curves[CHANNEL_C]));      \</span>
00611 <span class="preprocessor">  green =                                                                    \</span>
00612 <span class="preprocessor">    stp_curve_cache_get_ushort_data(&amp;(lut-&gt;channel_curves[CHANNEL_M]));      \</span>
00613 <span class="preprocessor">  blue =                                                                     \</span>
00614 <span class="preprocessor">    stp_curve_cache_get_ushort_data(&amp;(lut-&gt;channel_curves[CHANNEL_Y]));      \</span>
00615 <span class="preprocessor">  brightness=                                                                \</span>
00616 <span class="preprocessor">    stp_curve_cache_get_ushort_data(&amp;(lut-&gt;brightness_correction));          \</span>
00617 <span class="preprocessor">  contrast =                                                                 \</span>
00618 <span class="preprocessor">    stp_curve_cache_get_ushort_data(&amp;(lut-&gt;contrast_correction));            \</span>
00619 <span class="preprocessor">  (void) stp_curve_cache_get_double_data(&amp;(lut-&gt;hue_map));                   \</span>
00620 <span class="preprocessor">  (void) stp_curve_cache_get_double_data(&amp;(lut-&gt;lum_map));                   \</span>
00621 <span class="preprocessor">  (void) stp_curve_cache_get_double_data(&amp;(lut-&gt;sat_map));                   \</span>
00622 <span class="preprocessor">                                                                             \</span>
00623 <span class="preprocessor">  if (split_saturation)                                                      \</span>
00624 <span class="preprocessor">    ssat = sqrt(ssat);                                                       \</span>
00625 <span class="preprocessor">  if (ssat &gt; 1)                                                              \</span>
00626 <span class="preprocessor">    isat = 1.0 / ssat;                                                       \</span>
00627 <span class="preprocessor">  for (i = 0; i &lt; lut-&gt;image_width; i++)                                     \</span>
00628 <span class="preprocessor">    {                                                                        \</span>
00629 <span class="preprocessor">      if (i0 == s_in[0] &amp;&amp; i1 == s_in[1] &amp;&amp; i2 == s_in[2])                   \</span>
00630 <span class="preprocessor">        {                                                                    \</span>
00631 <span class="preprocessor">          out[0] = o0;                                                       \</span>
00632 <span class="preprocessor">          out[1] = o1;                                                       \</span>
00633 <span class="preprocessor">          out[2] = o2;                                                       \</span>
00634 <span class="preprocessor">        }                                                                    \</span>
00635 <span class="preprocessor">      else                                                                   \</span>
00636 <span class="preprocessor">        {                                                                    \</span>
00637 <span class="preprocessor">          i0 = s_in[0];                                                      \</span>
00638 <span class="preprocessor">          i1 = s_in[1];                                                      \</span>
00639 <span class="preprocessor">          i2 = s_in[2];                                                      \</span>
00640 <span class="preprocessor">          out[0] = i0 * (65535u / (unsigned) ((1 &lt;&lt; bits) - 1));             \</span>
00641 <span class="preprocessor">          out[1] = i1 * (65535u / (unsigned) ((1 &lt;&lt; bits) - 1));             \</span>
00642 <span class="preprocessor">          out[2] = i2 * (65535u / (unsigned) ((1 &lt;&lt; bits) - 1));             \</span>
00643 <span class="preprocessor">          lookup_rgb(lut, out, contrast, contrast, contrast, 1 &lt;&lt; bits);     \</span>
00644 <span class="preprocessor">          if ((compute_saturation))                                          \</span>
00645 <span class="preprocessor">            update_saturation_from_rgb(out, brightness, ssat, isat,          \</span>
00646 <span class="preprocessor">                                       do_user_adjustment);                  \</span>
00647 <span class="preprocessor">          if (bright_color_adjustment)                                       \</span>
00648 <span class="preprocessor">            adjust_hsl_bright(out, lut, ssat, isat, split_saturation);       \</span>
00649 <span class="preprocessor">          else                                                               \</span>
00650 <span class="preprocessor">            adjust_hsl(out, lut, ssat, isat, split_saturation);              \</span>
00651 <span class="preprocessor">          lookup_rgb(lut, out, red, green, blue, 1 &lt;&lt; bits);                 \</span>
00652 <span class="preprocessor">          o0 = out[0];                                                       \</span>
00653 <span class="preprocessor">          o1 = out[1];                                                       \</span>
00654 <span class="preprocessor">          o2 = out[2];                                                       \</span>
00655 <span class="preprocessor">          nz0 |= o0;                                                         \</span>
00656 <span class="preprocessor">          nz1 |= o1;                                                         \</span>
00657 <span class="preprocessor">          nz2 |= o2;                                                         \</span>
00658 <span class="preprocessor">        }                                                                    \</span>
00659 <span class="preprocessor">      s_in += 3;                                                             \</span>
00660 <span class="preprocessor">      out += 3;                                                              \</span>
00661 <span class="preprocessor">    }                                                                        \</span>
00662 <span class="preprocessor">  return (nz0 ? 0 : 1) +  (nz1 ? 0 : 2) +  (nz2 ? 0 : 4);                    \</span>
00663 <span class="preprocessor">}</span>
00664 <span class="preprocessor"></span>
00665 <a class="code" href="color-conversions_8c.html#a6">COLOR_TO_COLOR_FUNC</a>(<span class="keywordtype">unsigned</span> <span class="keywordtype">char</span>, 8)
00666 <a class="code" href="color-conversions_8c.html#a6">COLOR_TO_COLOR_FUNC</a>(<span class="keywordtype">unsigned</span> <span class="keywordtype">short</span>, 16)
00667 <a class="code" href="color-conversions_8c.html#a5">GENERIC_COLOR_FUNC</a>(color, color)
00668 
00669 <span class="comment">/*</span>
00670 <span class="comment"> * 'rgb_to_rgb()' - Convert rgb image data to RGB.</span>
00671 <span class="comment"> */</span>
00672 
<a name="l00673"></a><a class="code" href="color-conversions_8c.html#a7">00673</a> #define <a class="code" href="color-conversions_8c.html#a7">FAST_COLOR_TO_COLOR_FUNC</a>(T, bits)                                     \
00674 <span class="keyword">static</span> <span class="keywordtype">unsigned</span>                                                               \
00675 color_##bits##_to_color_fast(<span class="keyword">const</span> <a class="code" href="structstp__vars.html">stp_vars_t</a> *vars, <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> *in, \
00676                              <span class="keywordtype">unsigned</span> <span class="keywordtype">short</span> *out)                             \
00677 {                                                                             \
00678   <span class="keywordtype">int</span> i;                                                                      \
00679   <span class="keywordtype">int</span> i0 = -1;                                                                \
00680   <span class="keywordtype">int</span> i1 = -1;                                                                \
00681   <span class="keywordtype">int</span> i2 = -1;                                                                \
00682   <span class="keywordtype">int</span> o0 = 0;                                                                 \
00683   <span class="keywordtype">int</span> o1 = 0;                                                                 \
00684   <span class="keywordtype">int</span> o2 = 0;                                                                 \
00685   <span class="keywordtype">int</span> nz0 = 0;                                                                \
00686   <span class="keywordtype">int</span> nz1 = 0;                                                                \
00687   <span class="keywordtype">int</span> nz2 = 0;                                                                \
00688   <span class="keyword">const</span> T *s_in = (<span class="keyword">const</span> T *) in;                                             \
00689   <a class="code" href="structlut__t.html">lut_t</a> *lut = (<a class="code" href="structlut__t.html">lut_t</a> *)(<a class="code" href="group__vars.html#ga20">stp_get_component_data</a>(vars, <span class="stringliteral">"Color"</span>));              \
00690   <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">short</span> *red;                                                  \
00691   <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">short</span> *green;                                                \
00692   <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">short</span> *blue;                                                 \
00693   <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">short</span> *brightness;                                           \
00694   <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">short</span> *contrast;                                             \
00695   <span class="keywordtype">double</span> isat = 1.0;                                                          \
00696   <span class="keywordtype">double</span> saturation = <a class="code" href="group__vars.html#ga70">stp_get_float_parameter</a>(vars, <span class="stringliteral">"Saturation"</span>);            \
00697   <span class="keywordtype">double</span> sbright = <a class="code" href="group__vars.html#ga70">stp_get_float_parameter</a>(vars, <span class="stringliteral">"Brightness"</span>);               \
00698   <span class="keywordtype">int</span> compute_saturation = saturation &lt;= .99999 || saturation &gt;= 1.00001;     \
00699   <span class="keywordtype">int</span> do_user_adjustment = 0;                                                 \
00700   <span class="keywordflow">if</span> (sbright != 1)                                                           \
00701     do_user_adjustment = 1;                                                   \
00702   compute_saturation |= do_user_adjustment;                                   \
00703                                                                               \
00704   <span class="keywordflow">for</span> (i = <a class="code" href="color-conversion_8h.html#a1">CHANNEL_C</a>; i &lt;= <a class="code" href="color-conversion_8h.html#a3">CHANNEL_Y</a>; i++)                                    \
00705     <a class="code" href="group__curve.html#ga51">stp_curve_resample</a>(lut-&gt;<a class="code" href="structlut__t.html#o13">channel_curves</a>[i].<a class="code" href="structstp__cached__curve__t.html#o0">curve</a>, 65536);                  \
00706   <a class="code" href="group__curve.html#ga39">stp_curve_resample</a>                                                          \
00707     (<a class="code" href="curve-cache_8c.html#a2">stp_curve_cache_get_curve</a>(&amp;(lut-&gt;<a class="code" href="structlut__t.html#o10">brightness_correction</a>)), 65536);        \
00708   <a class="code" href="group__curve.html#ga39">stp_curve_resample</a>                                                          \
00709     (<a class="code" href="curve-cache_8c.html#a2">stp_curve_cache_get_curve</a>(&amp;(lut-&gt;<a class="code" href="structlut__t.html#o11">contrast_correction</a>)), 1 &lt;&lt; bits);      \
00710   red =                                                                       \
00711     <a class="code" href="curve-cache_8c.html#a7">stp_curve_cache_get_ushort_data</a>(&amp;(lut-&gt;<a class="code" href="structlut__t.html#o13">channel_curves</a>[<a class="code" href="color-conversion_8h.html#a1">CHANNEL_C</a>]));       \
00712   green =                                                                     \
00713     <a class="code" href="curve-cache_8c.html#a7">stp_curve_cache_get_ushort_data</a>(&amp;(lut-&gt;<a class="code" href="structlut__t.html#o13">channel_curves</a>[<a class="code" href="color-conversion_8h.html#a2">CHANNEL_M</a>]));       \
00714   blue =                                                                      \
00715     <a class="code" href="curve-cache_8c.html#a7">stp_curve_cache_get_ushort_data</a>(&amp;(lut-&gt;<a class="code" href="structlut__t.html#o13">channel_curves</a>[<a class="code" href="color-conversion_8h.html#a3">CHANNEL_Y</a>]));       \
00716   brightness=                                                                 \
00717     <a class="code" href="curve-cache_8c.html#a7">stp_curve_cache_get_ushort_data</a>(&amp;(lut-&gt;<a class="code" href="structlut__t.html#o10">brightness_correction</a>));           \
00718   contrast =                                                                  \
00719     <a class="code" href="curve-cache_8c.html#a7">stp_curve_cache_get_ushort_data</a>(&amp;(lut-&gt;<a class="code" href="structlut__t.html#o11">contrast_correction</a>));             \
00720                                                                               \
00721   <span class="keywordflow">if</span> (saturation &gt; 1)                                                         \
00722     isat = 1.0 / saturation;                                                  \
00723   <span class="keywordflow">for</span> (i = 0; i &lt; lut-&gt;<a class="code" href="structlut__t.html#o2">image_width</a>; i++)                                      \
00724     {                                                                         \
00725       <span class="keywordflow">if</span> (i0 == s_in[0] &amp;&amp; i1 == s_in[1] &amp;&amp; i2 == s_in[2])                    \
00726         {                                                                     \
00727           out[0] = o0;                                                        \
00728           out[1] = o1;                                                        \
00729           out[2] = o2;                                                        \
00730         }                                                                     \
00731       <span class="keywordflow">else</span>                                                                    \
00732         {                                                                     \
00733           i0 = s_in[0];                                                       \
00734           i1 = s_in[1];                                                       \
00735           i2 = s_in[2];                                                       \
00736           out[0] = contrast[s_in[0]];                                         \
00737           out[1] = contrast[s_in[1]];                                         \
00738           out[2] = contrast[s_in[2]];                                         \
00739           <span class="keywordflow">if</span> ((compute_saturation))                                           \
00740             <a class="code" href="color-conversions_8c.html#a45">update_saturation_from_rgb</a>(out, brightness, saturation, isat, 1); \
00741           out[0] = red[out[0]];                                               \
00742           out[1] = green[out[1]];                                             \
00743           out[2] = blue[out[2]];                                              \
00744           o0 = out[0];                                                        \
00745           o1 = out[1];                                                        \
00746           o2 = out[2];                                                        \
00747           nz0 |= o0;                                                          \
00748           nz1 |= o1;                                                          \
00749           nz2 |= o2;                                                          \
00750         }                                                                     \
00751       s_in += 3;                                                              \
00752       out += 3;                                                               \
00753     }                                                                         \
00754   <span class="keywordflow">return</span> (nz0 ? 0 : 1) +  (nz1 ? 0 : 2) +  (nz2 ? 0 : 4);                     \
00755 }
00756 
00757 <a class="code" href="color-conversions_8c.html#a7">FAST_COLOR_TO_COLOR_FUNC</a>(<span class="keywordtype">unsigned</span> <span class="keywordtype">char</span>, 8)
00758 <a class="code" href="color-conversions_8c.html#a7">FAST_COLOR_TO_COLOR_FUNC</a>(<span class="keywordtype">unsigned</span> <span class="keywordtype">short</span>, 16)
00759 <a class="code" href="color-conversions_8c.html#a5">GENERIC_COLOR_FUNC</a>(color, color_fast)
00760 
<a name="l00761"></a><a class="code" href="color-conversions_8c.html#a8">00761</a> #define <a class="code" href="color-conversions_8c.html#a8">RAW_COLOR_TO_COLOR_FUNC</a>(T, bits)                                    \
00762 <span class="keyword">static</span> <span class="keywordtype">unsigned</span>                                                             \
00763 color_##bits##_to_color_raw(<span class="keyword">const</span> <a class="code" href="structstp__vars.html">stp_vars_t</a> *vars, <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> *in,\
00764                             <span class="keywordtype">unsigned</span> <span class="keywordtype">short</span> *out)                            \
00765 {                                                                           \
00766   <span class="keywordtype">int</span> i;                                                                    \
00767   <span class="keywordtype">int</span> j;                                                                    \
00768   <span class="keywordtype">int</span> nz = 0;                                                               \
00769   <span class="keyword">const</span> T *s_in = (<span class="keyword">const</span> T *) in;                                           \
00770   <a class="code" href="structlut__t.html">lut_t</a> *lut = (<a class="code" href="structlut__t.html">lut_t</a> *)(<a class="code" href="group__vars.html#ga20">stp_get_component_data</a>(vars, <span class="stringliteral">"Color"</span>));            \
00771   <span class="keywordtype">unsigned</span> mask = 0;                                                        \
00772   <span class="keywordflow">if</span> (lut-&gt;<a class="code" href="structlut__t.html#o6">invert_output</a>)                                                   \
00773     mask = 0xffff;                                                          \
00774                                                                             \
00775   <span class="keywordflow">for</span> (i = 0; i &lt; lut-&gt;<a class="code" href="structlut__t.html#o2">image_width</a>; i++)                                    \
00776     {                                                                       \
00777       <span class="keywordtype">unsigned</span> bit = 1;                                                     \
00778       <span class="keywordflow">for</span> (j = 0; j &lt; 3; j++, bit += bit)                                   \
00779         {                                                                   \
00780           out[j] = (s_in[j] * (65535 / ((1 &lt;&lt; bits) - 1))) ^ mask;          \
00781           <span class="keywordflow">if</span> (out[j])                                                       \
00782             nz |= bit;                                                      \
00783         }                                                                   \
00784       s_in += 3;                                                            \
00785       out += 3;                                                             \
00786     }                                                                       \
00787   <span class="keywordflow">return</span> nz;                                                                \
00788 }
00789 
00790 <a class="code" href="color-conversions_8c.html#a8">RAW_COLOR_TO_COLOR_FUNC</a>(<span class="keywordtype">unsigned</span> <span class="keywordtype">char</span>, 8)
00791 <a class="code" href="color-conversions_8c.html#a8">RAW_COLOR_TO_COLOR_FUNC</a>(<span class="keywordtype">unsigned</span> <span class="keywordtype">short</span>, 16)
00792 <a class="code" href="color-conversions_8c.html#a5">GENERIC_COLOR_FUNC</a>(color, color_raw)
00793 
00794 <span class="comment">/*</span>
00795 <span class="comment"> * 'gray_to_rgb()' - Convert gray image data to RGB.</span>
00796 <span class="comment"> */</span>
00797 
<a name="l00798"></a><a class="code" href="color-conversions_8c.html#a9">00798</a> #define <a class="code" href="color-conversions_8c.html#a9">GRAY_TO_COLOR_FUNC</a>(T, bits)                                         \
00799 <span class="keyword">static</span> <span class="keywordtype">unsigned</span>                                                             \
00800 gray_##bits##_to_color(<span class="keyword">const</span> <a class="code" href="structstp__vars.html">stp_vars_t</a> *vars, <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> *in,     \
00801                    <span class="keywordtype">unsigned</span> <span class="keywordtype">short</span> *out)                                     \
00802 {                                                                           \
00803   <span class="keywordtype">int</span> i;                                                                    \
00804   <span class="keywordtype">int</span> i0 = -1;                                                              \
00805   <span class="keywordtype">int</span> o0 = 0;                                                               \
00806   <span class="keywordtype">int</span> o1 = 0;                                                               \
00807   <span class="keywordtype">int</span> o2 = 0;                                                               \
00808   <span class="keywordtype">int</span> nz0 = 0;                                                              \
00809   <span class="keywordtype">int</span> nz1 = 0;                                                              \
00810   <span class="keywordtype">int</span> nz2 = 0;                                                              \
00811   <span class="keyword">const</span> T *s_in = (<span class="keyword">const</span> T *) in;                                           \
00812   <a class="code" href="structlut__t.html">lut_t</a> *lut = (<a class="code" href="structlut__t.html">lut_t</a> *)(<a class="code" href="group__vars.html#ga20">stp_get_component_data</a>(vars, <span class="stringliteral">"Color"</span>));            \
00813   <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">short</span> *red;                                                \
00814   <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">short</span> *green;                                              \
00815   <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">short</span> *blue;                                               \
00816   <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">short</span> *user;                                               \
00817                                                                             \
00818   <span class="keywordflow">for</span> (i = <a class="code" href="color-conversion_8h.html#a1">CHANNEL_C</a>; i &lt;= <a class="code" href="color-conversion_8h.html#a3">CHANNEL_Y</a>; i++)                                  \
00819     <a class="code" href="group__curve.html#ga51">stp_curve_resample</a>(lut-&gt;<a class="code" href="structlut__t.html#o13">channel_curves</a>[i].<a class="code" href="structstp__cached__curve__t.html#o0">curve</a>, 65536);                \
00820   <a class="code" href="group__curve.html#ga39">stp_curve_resample</a>                                                        \
00821     (<a class="code" href="curve-cache_8c.html#a2">stp_curve_cache_get_curve</a>(&amp;(lut-&gt;<a class="code" href="structlut__t.html#o12">user_color_correction</a>)), 1 &lt;&lt; bits);  \
00822   red =                                                                     \
00823     <a class="code" href="curve-cache_8c.html#a7">stp_curve_cache_get_ushort_data</a>(&amp;(lut-&gt;<a class="code" href="structlut__t.html#o13">channel_curves</a>[<a class="code" href="color-conversion_8h.html#a1">CHANNEL_C</a>]));     \
00824   green =                                                                   \
00825     <a class="code" href="curve-cache_8c.html#a7">stp_curve_cache_get_ushort_data</a>(&amp;(lut-&gt;<a class="code" href="structlut__t.html#o13">channel_curves</a>[<a class="code" href="color-conversion_8h.html#a2">CHANNEL_M</a>]));     \
00826   blue =                                                                    \
00827     <a class="code" href="curve-cache_8c.html#a7">stp_curve_cache_get_ushort_data</a>(&amp;(lut-&gt;<a class="code" href="structlut__t.html#o13">channel_curves</a>[<a class="code" href="color-conversion_8h.html#a3">CHANNEL_Y</a>]));     \
00828   user =                                                                    \
00829     <a class="code" href="curve-cache_8c.html#a7">stp_curve_cache_get_ushort_data</a>(&amp;(lut-&gt;<a class="code" href="structlut__t.html#o12">user_color_correction</a>));         \
00830                                                                             \
00831   <span class="keywordflow">for</span> (i = 0; i &lt; lut-&gt;<a class="code" href="structlut__t.html#o2">image_width</a>; i++)                                    \
00832     {                                                                       \
00833       <span class="keywordflow">if</span> (i0 == s_in[0])                                                    \
00834         {                                                                   \
00835           out[0] = o0;                                                      \
00836           out[1] = o1;                                                      \
00837           out[2] = o2;                                                      \
00838         }                                                                   \
00839       <span class="keywordflow">else</span>                                                                  \
00840         {                                                                   \
00841           i0 = s_in[0];                                                     \
00842           out[0] = red[user[s_in[0]]];                                      \
00843           out[1] = green[user[s_in[0]]];                                    \
00844           out[2] = blue[user[s_in[0]]];                                     \
00845           o0 = out[0];                                                      \
00846           o1 = out[1];                                                      \
00847           o2 = out[2];                                                      \
00848           nz0 |= o0;                                                        \
00849           nz1 |= o1;                                                        \
00850           nz2 |= o2;                                                        \
00851         }                                                                   \
00852       s_in += 1;                                                            \
00853       out += 3;                                                             \
00854     }                                                                       \
00855   <span class="keywordflow">return</span> (nz0 ? 0 : 1) +  (nz1 ? 0 : 2) +  (nz2 ? 0 : 4);                   \
00856 }
00857 
00858 <a class="code" href="color-conversions_8c.html#a9">GRAY_TO_COLOR_FUNC</a>(<span class="keywordtype">unsigned</span> <span class="keywordtype">char</span>, 8)
00859 <a class="code" href="color-conversions_8c.html#a9">GRAY_TO_COLOR_FUNC</a>(<span class="keywordtype">unsigned</span> <span class="keywordtype">short</span>, 16)
00860 <a class="code" href="color-conversions_8c.html#a5">GENERIC_COLOR_FUNC</a>(gray, color)
00861 
<a name="l00862"></a><a class="code" href="color-conversions_8c.html#a10">00862</a> #define <a class="code" href="color-conversions_8c.html#a10">GRAY_TO_COLOR_RAW_FUNC</a>(T, bits)                                    \
00863 <span class="keyword">static</span> <span class="keywordtype">unsigned</span>                                                            \
00864 gray_##bits##_to_color_raw(<span class="keyword">const</span> <a class="code" href="structstp__vars.html">stp_vars_t</a> *vars, <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> *in,\
00865                            <span class="keywordtype">unsigned</span> <span class="keywordtype">short</span> *out)                            \
00866 {                                                                          \
00867   <span class="keywordtype">int</span> i;                                                                   \
00868   <span class="keywordtype">int</span> nz = 7;                                                              \
00869   <span class="keyword">const</span> T *s_in = (<span class="keyword">const</span> T *) in;                                          \
00870   <a class="code" href="structlut__t.html">lut_t</a> *lut = (<a class="code" href="structlut__t.html">lut_t</a> *)(<a class="code" href="group__vars.html#ga20">stp_get_component_data</a>(vars, <span class="stringliteral">"Color"</span>));           \
00871   <span class="keywordtype">unsigned</span> mask = 0;                                                       \
00872   <span class="keywordflow">if</span> (lut-&gt;<a class="code" href="structlut__t.html#o6">invert_output</a>)                                                  \
00873     mask = 0xffff;                                                         \
00874                                                                            \
00875   <span class="keywordflow">for</span> (i = 0; i &lt; lut-&gt;<a class="code" href="structlut__t.html#o2">image_width</a>; i++)                                   \
00876     {                                                                      \
00877       <span class="keywordtype">unsigned</span> outval = (s_in[0] * (65535 / (1 &lt;&lt; bits))) ^ mask;          \
00878       out[0] = outval;                                                     \
00879       out[1] = outval;                                                     \
00880       out[2] = outval;                                                     \
00881       <span class="keywordflow">if</span> (outval)                                                          \
00882         nz = 0;                                                            \
00883       s_in++;                                                              \
00884       out += 3;                                                            \
00885     }                                                                      \
00886   <span class="keywordflow">return</span> nz;                                                               \
00887 }
00888 
00889 <a class="code" href="color-conversions_8c.html#a10">GRAY_TO_COLOR_RAW_FUNC</a>(<span class="keywordtype">unsigned</span> <span class="keywordtype">char</span>, 8)
00890 <a class="code" href="color-conversions_8c.html#a10">GRAY_TO_COLOR_RAW_FUNC</a>(<span class="keywordtype">unsigned</span> <span class="keywordtype">short</span>, 16)
00891 <a class="code" href="color-conversions_8c.html#a5">GENERIC_COLOR_FUNC</a>(gray, color_raw)
00892 
<a name="l00893"></a><a class="code" href="color-conversions_8c.html#a11">00893</a> #define <a class="code" href="color-conversions_8c.html#a11">COLOR_TO_KCMY_FUNC</a>(name, name2, name3, name4, bits)                 \
00894 <span class="keyword">static</span> <span class="keywordtype">unsigned</span>                                                             \
00895 name##<a class="code" href="group__intl__internal.html#ga5">_</a>##bits##_to_##name2(<span class="keyword">const</span> <a class="code" href="structstp__vars.html">stp_vars_t</a> *vars, <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> *in, \
00896                            <span class="keywordtype">unsigned</span> <span class="keywordtype">short</span> *out)                             \
00897 {                                                                           \
00898   <a class="code" href="structlut__t.html">lut_t</a> *lut = (<a class="code" href="structlut__t.html">lut_t</a> *)(<a class="code" href="group__vars.html#ga20">stp_get_component_data</a>(vars, <span class="stringliteral">"Color"</span>));            \
00899   size_t real_steps = lut-&gt;<a class="code" href="structlut__t.html#o0">steps</a>;                                           \
00900   <span class="keywordtype">unsigned</span> status;                                                          \
00901   <span class="keywordflow">if</span> (!lut-&gt;<a class="code" href="structlut__t.html#o27">cmy_tmp</a>)                                                        \
00902     lut-&gt;<a class="code" href="structlut__t.html#o27">cmy_tmp</a> = <a class="code" href="group__util.html#ga28">stp_malloc</a>(4 * 2 * lut-&gt;<a class="code" href="structlut__t.html#o2">image_width</a>);                    \
00903   name##<a class="code" href="group__intl__internal.html#ga5">_</a>##bits##_to_##name3(vars, in, lut-&gt;<a class="code" href="structlut__t.html#o27">cmy_tmp</a>);                       \
00904   lut-&gt;<a class="code" href="structlut__t.html#o0">steps</a> = 65536;                                                       \
00905   status = name4##_cmy_to_kcmy(vars, lut-&gt;<a class="code" href="structlut__t.html#o27">cmy_tmp</a>, out);                    \
00906   lut-&gt;<a class="code" href="structlut__t.html#o0">steps</a> = real_steps;                                                  \
00907   <span class="keywordflow">return</span> status;                                                            \
00908 }
00909 
00910 <a class="code" href="color-conversions_8c.html#a11">COLOR_TO_KCMY_FUNC</a>(gray, kcmy, color, generic, 8)
00911 <a class="code" href="color-conversions_8c.html#a11">COLOR_TO_KCMY_FUNC</a>(gray, kcmy, color, generic, 16)
00912 <a class="code" href="color-conversions_8c.html#a5">GENERIC_COLOR_FUNC</a>(gray, kcmy)
00913 
00914 <a class="code" href="color-conversions_8c.html#a11">COLOR_TO_KCMY_FUNC</a>(gray, kcmy_raw, color_raw, <a class="code" href="structraw.html">raw</a>, 8)
00915 <a class="code" href="color-conversions_8c.html#a11">COLOR_TO_KCMY_FUNC</a>(gray, kcmy_raw, color_raw, <a class="code" href="structraw.html">raw</a>, 16)
00916 <a class="code" href="color-conversions_8c.html#a5">GENERIC_COLOR_FUNC</a>(gray, kcmy_raw)
00917 
00918 <a class="code" href="color-conversions_8c.html#a11">COLOR_TO_KCMY_FUNC</a>(color, kcmy, color, generic, 8)
00919 <a class="code" href="color-conversions_8c.html#a11">COLOR_TO_KCMY_FUNC</a>(color, kcmy, color, generic, 16)
00920 <a class="code" href="color-conversions_8c.html#a5">GENERIC_COLOR_FUNC</a>(color, kcmy)
00921 
00922 <a class="code" href="color-conversions_8c.html#a11">COLOR_TO_KCMY_FUNC</a>(color, kcmy_fast, color_fast, generic, 8)
00923 <a class="code" href="color-conversions_8c.html#a11">COLOR_TO_KCMY_FUNC</a>(color, kcmy_fast, color_fast, generic, 16)
00924 <a class="code" href="color-conversions_8c.html#a5">GENERIC_COLOR_FUNC</a>(color, kcmy_fast)
00925 
00926 <a class="code" href="color-conversions_8c.html#a11">COLOR_TO_KCMY_FUNC</a>(color, kcmy_raw, color_raw, <a class="code" href="structraw.html">raw</a>, 8)
00927 <a class="code" href="color-conversions_8c.html#a11">COLOR_TO_KCMY_FUNC</a>(color, kcmy_raw, color_raw, <a class="code" href="structraw.html">raw</a>, 16)
00928 <a class="code" href="color-conversions_8c.html#a5">GENERIC_COLOR_FUNC</a>(color, kcmy_raw)
00929 
00930 
<a name="l00931"></a><a class="code" href="color-conversions_8c.html#a12">00931</a> #define <a class="code" href="color-conversions_8c.html#a12">COLOR_TO_KCMY_THRESHOLD_FUNC</a>(T, name)                           \
00932 <span class="keyword">static</span> <span class="keywordtype">unsigned</span>                                                         \
00933 name##_to_kcmy_threshold(<span class="keyword">const</span> <a class="code" href="structstp__vars.html">stp_vars_t</a> *vars,                        \
00934                         <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> *in,                        \
00935                         <span class="keywordtype">unsigned</span> <span class="keywordtype">short</span> *out)                            \
00936 {                                                                       \
00937   <span class="keywordtype">int</span> i;                                                                \
00938   <span class="keywordtype">int</span> z = 15;                                                           \
00939   <span class="keyword">const</span> T *s_in = (<span class="keyword">const</span> T *) in;                                       \
00940   <span class="keywordtype">unsigned</span> high_bit = ((1 &lt;&lt; ((<span class="keyword">sizeof</span>(T) * 8) - 1)));                   \
00941   <a class="code" href="structlut__t.html">lut_t</a> *lut = (<a class="code" href="structlut__t.html">lut_t</a> *)(<a class="code" href="group__vars.html#ga20">stp_get_component_data</a>(vars, <span class="stringliteral">"Color"</span>));        \
00942   <span class="keywordtype">int</span> width = lut-&gt;<a class="code" href="structlut__t.html#o2">image_width</a>;                                         \
00943   <span class="keywordtype">unsigned</span> mask = 0;                                                    \
00944   memset(out, 0, width * 4 * <span class="keyword">sizeof</span>(<span class="keywordtype">unsigned</span> <span class="keywordtype">short</span>));                   \
00945   <span class="keywordflow">if</span> (lut-&gt;<a class="code" href="structlut__t.html#o6">invert_output</a>)                                               \
00946     mask = (1 &lt;&lt; (<span class="keyword">sizeof</span>(T) * 8)) - 1;                                  \
00947                                                                         \
00948   <span class="keywordflow">for</span> (i = 0; i &lt; width; i++, out += 4, s_in += 3)                      \
00949     {                                                                   \
00950       <span class="keywordtype">unsigned</span> c = s_in[0] ^ mask;                                      \
00951       <span class="keywordtype">unsigned</span> m = s_in[1] ^ mask;                                      \
00952       <span class="keywordtype">unsigned</span> y = s_in[2] ^ mask;                                      \
00953       <span class="keywordtype">unsigned</span> k = (c &lt; m ? (c &lt; y ? c : y) : (m &lt; y ? m : y));         \
00954       <span class="keywordflow">if</span> (k &gt;= high_bit)                                                \
00955         {                                                               \
00956           c -= k;                                                       \
00957           m -= k;                                                       \
00958           y -= k;                                                       \
00959         }                                                               \
00960       <span class="keywordflow">if</span> (k &gt;= high_bit)                                                \
00961         {                                                               \
00962           z &amp;= 0xe;                                                     \
00963           out[0] = 65535;                                               \
00964         }                                                               \
00965       <span class="keywordflow">if</span> (c &gt;= high_bit)                                                \
00966         {                                                               \
00967           z &amp;= 0xd;                                                     \
00968           out[1] = 65535;                                               \
00969         }                                                               \
00970       <span class="keywordflow">if</span> (m &gt;= high_bit)                                                \
00971         {                                                               \
00972           z &amp;= 0xb;                                                     \
00973           out[2] = 65535;                                               \
00974         }                                                               \
00975       <span class="keywordflow">if</span> (y &gt;= high_bit)                                                \
00976         {                                                               \
00977           z &amp;= 0x7;                                                     \
00978           out[3] = 65535;                                               \
00979         }                                                               \
00980     }                                                                   \
00981   <span class="keywordflow">return</span> z;                                                             \
00982 }
00983 
00984 <a class="code" href="color-conversions_8c.html#a12">COLOR_TO_KCMY_THRESHOLD_FUNC</a>(<span class="keywordtype">unsigned</span> <span class="keywordtype">char</span>, color_8)
00985 <a class="code" href="color-conversions_8c.html#a12">COLOR_TO_KCMY_THRESHOLD_FUNC</a>(<span class="keywordtype">unsigned</span> <span class="keywordtype">short</span>, color_16)
00986 <a class="code" href="color-conversions_8c.html#a5">GENERIC_COLOR_FUNC</a>(color, kcmy_threshold)
00987 
<a name="l00988"></a><a class="code" href="color-conversions_8c.html#a13">00988</a> #define <a class="code" href="color-conversions_8c.html#a13">CMYK_TO_KCMY_THRESHOLD_FUNC</a>(T, name)                            \
00989 <span class="keyword">static</span> <span class="keywordtype">unsigned</span>                                                         \
00990 name##_to_kcmy_threshold(<span class="keyword">const</span> <a class="code" href="structstp__vars.html">stp_vars_t</a> *vars,                        \
00991                         <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> *in,                        \
00992                         <span class="keywordtype">unsigned</span> <span class="keywordtype">short</span> *out)                            \
00993 {                                                                       \
00994   <span class="keywordtype">int</span> i;                                                                \
00995   <span class="keywordtype">int</span> z = 15;                                                           \
00996   <span class="keyword">const</span> T *s_in = (<span class="keyword">const</span> T *) in;                                       \
00997   <span class="keywordtype">unsigned</span> desired_high_bit = 0;                                        \
00998   <span class="keywordtype">unsigned</span> high_bit = 1 &lt;&lt; ((<span class="keyword">sizeof</span>(T) * 8) - 1);                       \
00999   <a class="code" href="structlut__t.html">lut_t</a> *lut = (<a class="code" href="structlut__t.html">lut_t</a> *)(<a class="code" href="group__vars.html#ga20">stp_get_component_data</a>(vars, <span class="stringliteral">"Color"</span>));        \
01000   <span class="keywordtype">int</span> width = lut-&gt;<a class="code" href="structlut__t.html#o2">image_width</a>;                                         \
01001   memset(out, 0, width * 4 * <span class="keyword">sizeof</span>(<span class="keywordtype">unsigned</span> <span class="keywordtype">short</span>));                   \
01002   <span class="keywordflow">if</span> (!lut-&gt;<a class="code" href="structlut__t.html#o6">invert_output</a>)                                              \
01003     desired_high_bit = high_bit;                                        \
01004                                                                         \
01005   <span class="keywordflow">for</span> (i = 0; i &lt; width; i++, out += 4, s_in += 4)                      \
01006     {                                                                   \
01007       <span class="keywordflow">if</span> ((s_in[3] &amp; high_bit) == desired_high_bit)                     \
01008         {                                                               \
01009           z &amp;= 0xe;                                                     \
01010           out[0] = 65535;                                               \
01011         }                                                               \
01012       <span class="keywordflow">if</span> ((s_in[0] &amp; high_bit) == desired_high_bit)                     \
01013         {                                                               \
01014           z &amp;= 0xd;                                                     \
01015           out[1] = 65535;                                               \
01016         }                                                               \
01017       <span class="keywordflow">if</span> ((s_in[1] &amp; high_bit) == desired_high_bit)                     \
01018         {                                                               \
01019           z &amp;= 0xb;                                                     \
01020           out[2] = 65535;                                               \
01021         }                                                               \
01022       <span class="keywordflow">if</span> ((s_in[2] &amp; high_bit) == desired_high_bit)                     \
01023         {                                                               \
01024           z &amp;= 0x7;                                                     \
01025           out[3] = 65535;                                               \
01026         }                                                               \
01027     }                                                                   \
01028   <span class="keywordflow">return</span> z;                                                             \
01029 }
01030 
01031 <a class="code" href="color-conversions_8c.html#a13">CMYK_TO_KCMY_THRESHOLD_FUNC</a>(<span class="keywordtype">unsigned</span> <span class="keywordtype">char</span>, cmyk_8)
01032 <a class="code" href="color-conversions_8c.html#a13">CMYK_TO_KCMY_THRESHOLD_FUNC</a>(<span class="keywordtype">unsigned</span> <span class="keywordtype">short</span>, cmyk_16)
01033 <a class="code" href="color-conversions_8c.html#a5">GENERIC_COLOR_FUNC</a>(cmyk, kcmy_threshold)
01034 
<a name="l01035"></a><a class="code" href="color-conversions_8c.html#a14">01035</a> #define <a class="code" href="color-conversions_8c.html#a14">KCMY_TO_KCMY_THRESHOLD_FUNC</a>(T, name)                            \
01036 <span class="keyword">static</span> <span class="keywordtype">unsigned</span>                                                         \
01037 name##_to_kcmy_threshold(<span class="keyword">const</span> <a class="code" href="structstp__vars.html">stp_vars_t</a> *vars,                        \
01038                          <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> *in,                       \
01039                          <span class="keywordtype">unsigned</span> <span class="keywordtype">short</span> *out)                           \
01040 {                                                                       \
01041   <span class="keywordtype">int</span> i;                                                                \
01042   <span class="keywordtype">int</span> j;                                                                \
01043   <span class="keywordtype">unsigned</span> nz[4];                                                       \
01044   <span class="keywordtype">unsigned</span> z = 0xf;                                                     \
01045   <span class="keyword">const</span> T *s_in = (<span class="keyword">const</span> T *) in;                                       \
01046   <span class="keywordtype">unsigned</span> desired_high_bit = 0;                                        \
01047   <span class="keywordtype">unsigned</span> high_bit = 1 &lt;&lt; ((<span class="keyword">sizeof</span>(T) * 8) - 1);                       \
01048   <a class="code" href="structlut__t.html">lut_t</a> *lut = (<a class="code" href="structlut__t.html">lut_t</a> *)(<a class="code" href="group__vars.html#ga20">stp_get_component_data</a>(vars, <span class="stringliteral">"Color"</span>));        \
01049   <span class="keywordtype">int</span> width = lut-&gt;<a class="code" href="structlut__t.html#o2">image_width</a>;                                         \
01050   memset(out, 0, width * 4 * <span class="keyword">sizeof</span>(<span class="keywordtype">unsigned</span> <span class="keywordtype">short</span>));                   \
01051   <span class="keywordflow">if</span> (!lut-&gt;<a class="code" href="structlut__t.html#o6">invert_output</a>)                                              \
01052     desired_high_bit = high_bit;                                        \
01053   <span class="keywordflow">for</span> (i = 0; i &lt; 4; i++)                                               \
01054     nz[i] = z &amp; ~(1 &lt;&lt; i);                                              \
01055                                                                         \
01056   <span class="keywordflow">for</span> (i = 0; i &lt; width; i++)                                           \
01057     {                                                                   \
01058       <span class="keywordflow">for</span> (j = 0; j &lt; 4; j++)                                           \
01059         {                                                               \
01060           <span class="keywordflow">if</span> ((*s_in++ &amp; high_bit) == desired_high_bit)                 \
01061             {                                                           \
01062               z &amp;= nz[j];                                               \
01063               *out = 65535;                                             \
01064             }                                                           \
01065           out++;                                                        \
01066         }                                                               \
01067     }                                                                   \
01068   <span class="keywordflow">return</span> z;                                                             \
01069 }
01070 
01071 <a class="code" href="color-conversions_8c.html#a14">KCMY_TO_KCMY_THRESHOLD_FUNC</a>(<span class="keywordtype">unsigned</span> <span class="keywordtype">char</span>, kcmy_8)
01072 <a class="code" href="color-conversions_8c.html#a14">KCMY_TO_KCMY_THRESHOLD_FUNC</a>(<span class="keywordtype">unsigned</span> <span class="keywordtype">short</span>, kcmy_16)
01073 <a class="code" href="color-conversions_8c.html#a5">GENERIC_COLOR_FUNC</a>(kcmy, kcmy_threshold)
01074 
<a name="l01075"></a><a class="code" href="color-conversions_8c.html#a15">01075</a> #define <a class="code" href="color-conversions_8c.html#a15">GRAY_TO_COLOR_THRESHOLD_FUNC</a>(T, name, bits, channels)           \
01076 <span class="keyword">static</span> <span class="keywordtype">unsigned</span>                                                         \
01077 gray_##bits##_to_##name##_threshold(<span class="keyword">const</span> <a class="code" href="structstp__vars.html">stp_vars_t</a> *vars,             \
01078                                     <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> *in,            \
01079                                     <span class="keywordtype">unsigned</span> <span class="keywordtype">short</span> *out)                \
01080 {                                                                       \
01081   <span class="keywordtype">int</span> i;                                                                \
01082   <span class="keywordtype">int</span> z = (1 &lt;&lt; channels) - 1;                                          \
01083   <span class="keywordtype">int</span> desired_high_bit = 0;                                             \
01084   <span class="keywordtype">unsigned</span> high_bit = 1 &lt;&lt; ((<span class="keyword">sizeof</span>(T) * 8) - 1);                       \
01085   <span class="keyword">const</span> T *s_in = (<span class="keyword">const</span> T *) in;                                       \
01086   <a class="code" href="structlut__t.html">lut_t</a> *lut = (<a class="code" href="structlut__t.html">lut_t</a> *)(<a class="code" href="group__vars.html#ga20">stp_get_component_data</a>(vars, <span class="stringliteral">"Color"</span>));        \
01087   <span class="keywordtype">int</span> width = lut-&gt;<a class="code" href="structlut__t.html#o2">image_width</a>;                                         \
01088   memset(out, 0, width * channels * <span class="keyword">sizeof</span>(<span class="keywordtype">unsigned</span> <span class="keywordtype">short</span>));            \
01089   <span class="keywordflow">if</span> (!lut-&gt;<a class="code" href="structlut__t.html#o6">invert_output</a>)                                              \
01090     desired_high_bit = high_bit;                                        \
01091                                                                         \
01092   <span class="keywordflow">for</span> (i = 0; i &lt; width; i++, out += channels, s_in++)                  \
01093     {                                                                   \
01094       <span class="keywordflow">if</span> ((s_in[0] &amp; high_bit) == desired_high_bit)                     \
01095         {                                                               \
01096           <span class="keywordtype">int</span> j;                                                        \
01097           z = 0;                                                        \
01098           <span class="keywordflow">for</span> (j = 0; j &lt; channels; j++)                                \
01099             out[j] = 65535;                                             \
01100         }                                                               \
01101     }                                                                   \
01102   <span class="keywordflow">return</span> z;                                                             \
01103 }
01104 
01105 
01106 <a class="code" href="color-conversions_8c.html#a15">GRAY_TO_COLOR_THRESHOLD_FUNC</a>(<span class="keywordtype">unsigned</span> <span class="keywordtype">char</span>, color, 8, 3)
01107 <a class="code" href="color-conversions_8c.html#a15">GRAY_TO_COLOR_THRESHOLD_FUNC</a>(<span class="keywordtype">unsigned</span> <span class="keywordtype">short</span>, color, 16, 3)
01108 <a class="code" href="color-conversions_8c.html#a5">GENERIC_COLOR_FUNC</a>(gray, color_threshold)
01109 
01110 <a class="code" href="color-conversions_8c.html#a15">GRAY_TO_COLOR_THRESHOLD_FUNC</a>(<span class="keywordtype">unsigned</span> <span class="keywordtype">char</span>, kcmy, 8, 4)
01111 <a class="code" href="color-conversions_8c.html#a15">GRAY_TO_COLOR_THRESHOLD_FUNC</a>(<span class="keywordtype">unsigned</span> <span class="keywordtype">short</span>, kcmy, 16, 4)
01112 <a class="code" href="color-conversions_8c.html#a5">GENERIC_COLOR_FUNC</a>(gray, kcmy_threshold)
01113 
<a name="l01114"></a><a class="code" href="color-conversions_8c.html#a16">01114</a> #define <a class="code" href="color-conversions_8c.html#a16">COLOR_TO_COLOR_THRESHOLD_FUNC</a>(T, name)                          \
01115 <span class="keyword">static</span> <span class="keywordtype">unsigned</span>                                                         \
01116 name##_to_color_threshold(<span class="keyword">const</span> <a class="code" href="structstp__vars.html">stp_vars_t</a> *vars,                       \
01117                        <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> *in,                         \
01118                        <span class="keywordtype">unsigned</span> <span class="keywordtype">short</span> *out)                             \
01119 {                                                                       \
01120   <span class="keywordtype">int</span> i;                                                                \
01121   <span class="keywordtype">int</span> z = 7;                                                            \
01122   <span class="keywordtype">int</span> desired_high_bit = 0;                                             \
01123   <span class="keywordtype">unsigned</span> high_bit = ((1 &lt;&lt; ((<span class="keyword">sizeof</span>(T) * 8) - 1)) * 4);               \
01124   <span class="keyword">const</span> T *s_in = (<span class="keyword">const</span> T *) in;                                       \
01125   <a class="code" href="structlut__t.html">lut_t</a> *lut = (<a class="code" href="structlut__t.html">lut_t</a> *)(<a class="code" href="group__vars.html#ga20">stp_get_component_data</a>(vars, <span class="stringliteral">"Color"</span>));        \
01126   <span class="keywordtype">int</span> width = lut-&gt;<a class="code" href="structlut__t.html#o2">image_width</a>;                                         \
01127   memset(out, 0, width * 3 * <span class="keyword">sizeof</span>(<span class="keywordtype">unsigned</span> <span class="keywordtype">short</span>));                   \
01128   <span class="keywordflow">if</span> (!lut-&gt;<a class="code" href="structlut__t.html#o6">invert_output</a>)                                              \
01129     desired_high_bit = high_bit;                                        \
01130                                                                         \
01131   <span class="keywordflow">for</span> (i = 0; i &lt; width; i++, out += 3, s_in += 3)                      \
01132     {                                                                   \
01133       <span class="keywordflow">if</span> ((s_in[0] &amp; high_bit) == desired_high_bit)                     \
01134         {                                                               \
01135           z &amp;= 6;                                                       \
01136           out[0] = 65535;                                               \
01137         }                                                               \
01138       <span class="keywordflow">if</span> ((s_in[1] &amp; high_bit) == desired_high_bit)                     \
01139         {                                                               \
01140           z &amp;= 5;                                                       \
01141           out[1] = 65535;                                               \
01142         }                                                               \
01143       <span class="keywordflow">if</span> ((s_in[1] &amp; high_bit) == desired_high_bit)                     \
01144         {                                                               \
01145           z &amp;= 3;                                                       \
01146           out[2] = 65535;                                               \
01147         }                                                               \
01148     }                                                                   \
01149   <span class="keywordflow">return</span> z;                                                             \
01150 }
01151 
01152 <a class="code" href="color-conversions_8c.html#a16">COLOR_TO_COLOR_THRESHOLD_FUNC</a>(<span class="keywordtype">unsigned</span> <span class="keywordtype">char</span>, color_8)
01153 <a class="code" href="color-conversions_8c.html#a16">COLOR_TO_COLOR_THRESHOLD_FUNC</a>(<span class="keywordtype">unsigned</span> <span class="keywordtype">short</span>, color_16)
01154 <a class="code" href="color-conversions_8c.html#a5">GENERIC_COLOR_FUNC</a>(color, color_threshold)
01155 
<a name="l01156"></a><a class="code" href="color-conversions_8c.html#a17">01156</a> #define <a class="code" href="color-conversions_8c.html#a17">COLOR_TO_GRAY_THRESHOLD_FUNC</a>(T, name, channels, max_channels)   \
01157 <span class="keyword">static</span> <span class="keywordtype">unsigned</span>                                                         \
01158 name##_to_gray_threshold(<span class="keyword">const</span> <a class="code" href="structstp__vars.html">stp_vars_t</a> *vars,                        \
01159                         <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> *in,                        \
01160                         <span class="keywordtype">unsigned</span> <span class="keywordtype">short</span> *out)                            \
01161 {                                                                       \
01162   <span class="keywordtype">int</span> i;                                                                \
01163   <span class="keywordtype">int</span> z = 1;                                                            \
01164   <span class="keywordtype">int</span> desired_high_bit = 0;                                             \
01165   <span class="keywordtype">unsigned</span> high_bit = ((1 &lt;&lt; ((<span class="keyword">sizeof</span>(T) * 8) - 1)));                   \
01166   <span class="keyword">const</span> T *s_in = (<span class="keyword">const</span> T *) in;                                       \
01167   <a class="code" href="structlut__t.html">lut_t</a> *lut = (<a class="code" href="structlut__t.html">lut_t</a> *)(<a class="code" href="group__vars.html#ga20">stp_get_component_data</a>(vars, <span class="stringliteral">"Color"</span>));        \
01168   <span class="keywordtype">int</span> width = lut-&gt;<a class="code" href="structlut__t.html#o2">image_width</a>;                                         \
01169   memset(out, 0, width * <span class="keyword">sizeof</span>(<span class="keywordtype">unsigned</span> <span class="keywordtype">short</span>));                       \
01170   <span class="keywordflow">if</span> (!lut-&gt;<a class="code" href="structlut__t.html#o6">invert_output</a>)                                              \
01171     desired_high_bit = high_bit;                                        \
01172                                                                         \
01173   <span class="keywordflow">for</span> (i = 0; i &lt; width; i++, out++, s_in += channels)                  \
01174     {                                                                   \
01175       <span class="keywordtype">unsigned</span> gval =                                                   \
01176         (max_channels - channels) * (1 &lt;&lt; ((<span class="keyword">sizeof</span>(T) * 8) - 1));       \
01177       <span class="keywordtype">int</span> j;                                                            \
01178       <span class="keywordflow">for</span> (j = 0; j &lt; channels; j++)                                    \
01179         gval += s_in[j];                                                \
01180       gval /= channels;                                                 \
01181       <span class="keywordflow">if</span> ((gval &amp; high_bit) == desired_high_bit)                        \
01182         {                                                               \
01183           out[0] = 65535;                                               \
01184           z = 0;                                                        \
01185         }                                                               \
01186     }                                                                   \
01187   <span class="keywordflow">return</span> z;                                                             \
01188 }
01189 
01190 <a class="code" href="color-conversions_8c.html#a17">COLOR_TO_GRAY_THRESHOLD_FUNC</a>(<span class="keywordtype">unsigned</span> <span class="keywordtype">char</span>, cmyk_8, 4, 4)
01191 <a class="code" href="color-conversions_8c.html#a17">COLOR_TO_GRAY_THRESHOLD_FUNC</a>(<span class="keywordtype">unsigned</span> <span class="keywordtype">short</span>, cmyk_16, 4, 4)
01192 <a class="code" href="color-conversions_8c.html#a5">GENERIC_COLOR_FUNC</a>(cmyk, gray_threshold)
01193 
01194 <a class="code" href="color-conversions_8c.html#a17">COLOR_TO_GRAY_THRESHOLD_FUNC</a>(<span class="keywordtype">unsigned</span> <span class="keywordtype">char</span>, kcmy_8, 4, 4)
01195 <a class="code" href="color-conversions_8c.html#a17">COLOR_TO_GRAY_THRESHOLD_FUNC</a>(<span class="keywordtype">unsigned</span> <span class="keywordtype">short</span>, kcmy_16, 4, 4)
01196 <a class="code" href="color-conversions_8c.html#a5">GENERIC_COLOR_FUNC</a>(kcmy, gray_threshold)
01197 
01198 <a class="code" href="color-conversions_8c.html#a17">COLOR_TO_GRAY_THRESHOLD_FUNC</a>(<span class="keywordtype">unsigned</span> <span class="keywordtype">char</span>, color_8, 3, 3)
01199 <a class="code" href="color-conversions_8c.html#a17">COLOR_TO_GRAY_THRESHOLD_FUNC</a>(<span class="keywordtype">unsigned</span> <span class="keywordtype">short</span>, color_16, 3, 3)
01200 <a class="code" href="color-conversions_8c.html#a5">GENERIC_COLOR_FUNC</a>(color, gray_threshold)
01201 
01202 <a class="code" href="color-conversions_8c.html#a17">COLOR_TO_GRAY_THRESHOLD_FUNC</a>(<span class="keywordtype">unsigned</span> <span class="keywordtype">char</span>, gray_8, 1, 1)
01203 <a class="code" href="color-conversions_8c.html#a17">COLOR_TO_GRAY_THRESHOLD_FUNC</a>(<span class="keywordtype">unsigned</span> <span class="keywordtype">short</span>, gray_16, 1, 1)
01204 <a class="code" href="color-conversions_8c.html#a5">GENERIC_COLOR_FUNC</a>(gray, gray_threshold)
01205 
<a name="l01206"></a><a class="code" href="color-conversions_8c.html#a18">01206</a> #define <a class="code" href="color-conversions_8c.html#a18">CMYK_TO_COLOR_FUNC</a>(namein, name2, T, bits, offset)                    \
01207 <span class="keyword">static</span> <span class="keywordtype">unsigned</span>                                                               \
01208 namein##<a class="code" href="group__intl__internal.html#ga5">_</a>##bits##_to_##name2(<span class="keyword">const</span> <a class="code" href="structstp__vars.html">stp_vars_t</a> *vars, <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> *in, \
01209                            <span class="keywordtype">unsigned</span> <span class="keywordtype">short</span> *out)                               \
01210 {                                                                             \
01211   <span class="keywordtype">int</span> i;                                                                      \
01212   <a class="code" href="structlut__t.html">lut_t</a> *lut = (<a class="code" href="structlut__t.html">lut_t</a> *)(<a class="code" href="group__vars.html#ga20">stp_get_component_data</a>(vars, <span class="stringliteral">"Color"</span>));              \
01213   <span class="keywordtype">unsigned</span> status;                                                            \
01214   size_t real_steps = lut-&gt;<a class="code" href="structlut__t.html#o0">steps</a>;                                             \
01215   <span class="keyword">const</span> T *s_in = (<span class="keyword">const</span> T *) in;                                             \
01216   <span class="keywordtype">unsigned</span> <span class="keywordtype">short</span> *tmp;                                                        \
01217   <span class="keywordtype">int</span> width = lut-&gt;<a class="code" href="structlut__t.html#o2">image_width</a>;                                               \
01218   <span class="keywordtype">unsigned</span> mask = 0;                                                          \
01219                                                                               \
01220   <span class="keywordflow">if</span> (!lut-&gt;<a class="code" href="structlut__t.html#o27">cmy_tmp</a>)                                                          \
01221     lut-&gt;<a class="code" href="structlut__t.html#o27">cmy_tmp</a> = <a class="code" href="group__util.html#ga28">stp_malloc</a>(3 * 2 * lut-&gt;<a class="code" href="structlut__t.html#o2">image_width</a>);                      \
01222   tmp = lut-&gt;<a class="code" href="structlut__t.html#o27">cmy_tmp</a>;                                                         \
01223   memset(lut-&gt;<a class="code" href="structlut__t.html#o27">cmy_tmp</a>, 0, width * 3 * <span class="keyword">sizeof</span>(<span class="keywordtype">unsigned</span> <span class="keywordtype">short</span>));                \
01224   <span class="keywordflow">if</span> (lut-&gt;<a class="code" href="structlut__t.html#o6">invert_output</a>)                                                     \
01225     mask = 0xffff;                                                            \
01226                                                                               \
01227   <span class="keywordflow">for</span> (i = 0; i &lt; width; i++, tmp += 3, s_in += 4)                            \
01228     {                                                                         \
01229       <span class="keywordtype">unsigned</span> c = (s_in[0 + offset] + s_in[(3 + offset) % 4]) *              \
01230         (65535 / ((1 &lt;&lt; bits) - 1));                                          \
01231       <span class="keywordtype">unsigned</span> m = (s_in[1 + offset] + s_in[(3 + offset) % 4]) *              \
01232         (65535 / ((1 &lt;&lt; bits) - 1));                                          \
01233       <span class="keywordtype">unsigned</span> y = (s_in[2 + offset] + s_in[(3 + offset) % 4]) *              \
01234         (65535 / ((1 &lt;&lt; bits) - 1));                                          \
01235       <span class="keywordflow">if</span> (c &gt; 65535)                                                          \
01236         c = 65535;                                                            \
01237       <span class="keywordflow">if</span> (m &gt; 65535)                                                          \
01238         m = 65535;                                                            \
01239       <span class="keywordflow">if</span> (y &gt; 65535)                                                          \
01240         y = 65535;                                                            \
01241       tmp[0] = c ^ mask;                                                      \
01242       tmp[1] = m ^ mask;                                                      \
01243       tmp[2] = y ^ mask;                                                      \
01244     }                                                                         \
01245   lut-&gt;<a class="code" href="structlut__t.html#o0">steps</a> = 65536;                                                         \
01246   status =                                                                    \
01247     color_16_to_##name2(vars, (<span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> *) lut-&gt;<a class="code" href="structlut__t.html#o27">cmy_tmp</a>, out);     \
01248   lut-&gt;<a class="code" href="structlut__t.html#o0">steps</a> = real_steps;                                                    \
01249   <span class="keywordflow">return</span> status;                                                              \
01250 }
01251 
01252 <a class="code" href="color-conversions_8c.html#a18">CMYK_TO_COLOR_FUNC</a>(cmyk, color, <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span>, 8, 0)
01253 <a class="code" href="color-conversions_8c.html#a18">CMYK_TO_COLOR_FUNC</a>(cmyk, color, <span class="keywordtype">unsigned</span> <span class="keywordtype">short</span>, 16, 0)
01254 <a class="code" href="color-conversions_8c.html#a5">GENERIC_COLOR_FUNC</a>(cmyk, color)
01255 <a class="code" href="color-conversions_8c.html#a18">CMYK_TO_COLOR_FUNC</a>(kcmy, color, <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span>, 8, 1)
01256 <a class="code" href="color-conversions_8c.html#a18">CMYK_TO_COLOR_FUNC</a>(kcmy, color, <span class="keywordtype">unsigned</span> <span class="keywordtype">short</span>, 16, 1)
01257 <a class="code" href="color-conversions_8c.html#a5">GENERIC_COLOR_FUNC</a>(kcmy, color)
01258 <a class="code" href="color-conversions_8c.html#a18">CMYK_TO_COLOR_FUNC</a>(cmyk, color_threshold, <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span>, 8, 0)
01259 <a class="code" href="color-conversions_8c.html#a18">CMYK_TO_COLOR_FUNC</a>(cmyk, color_threshold, <span class="keywordtype">unsigned</span> <span class="keywordtype">short</span>, 16, 0)
01260 <a class="code" href="color-conversions_8c.html#a5">GENERIC_COLOR_FUNC</a>(cmyk, color_threshold)
01261 <a class="code" href="color-conversions_8c.html#a18">CMYK_TO_COLOR_FUNC</a>(kcmy, color_threshold, <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span>, 8, 1)
01262 <a class="code" href="color-conversions_8c.html#a18">CMYK_TO_COLOR_FUNC</a>(kcmy, color_threshold, <span class="keywordtype">unsigned</span> <span class="keywordtype">short</span>, 16, 1)
01263 <a class="code" href="color-conversions_8c.html#a5">GENERIC_COLOR_FUNC</a>(kcmy, color_threshold)
01264 <a class="code" href="color-conversions_8c.html#a18">CMYK_TO_COLOR_FUNC</a>(cmyk, color_fast, <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span>, 8, 0)
01265 <a class="code" href="color-conversions_8c.html#a18">CMYK_TO_COLOR_FUNC</a>(cmyk, color_fast, <span class="keywordtype">unsigned</span> <span class="keywordtype">short</span>, 16, 0)
01266 <a class="code" href="color-conversions_8c.html#a5">GENERIC_COLOR_FUNC</a>(cmyk, color_fast)
01267 <a class="code" href="color-conversions_8c.html#a18">CMYK_TO_COLOR_FUNC</a>(kcmy, color_fast, <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span>, 8, 1)
01268 <a class="code" href="color-conversions_8c.html#a18">CMYK_TO_COLOR_FUNC</a>(kcmy, color_fast, <span class="keywordtype">unsigned</span> <span class="keywordtype">short</span>, 16, 1)
01269 <a class="code" href="color-conversions_8c.html#a5">GENERIC_COLOR_FUNC</a>(kcmy, color_fast)
01270 <a class="code" href="color-conversions_8c.html#a18">CMYK_TO_COLOR_FUNC</a>(cmyk, color_raw, <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span>, 8, 0)
01271 <a class="code" href="color-conversions_8c.html#a18">CMYK_TO_COLOR_FUNC</a>(cmyk, color_raw, <span class="keywordtype">unsigned</span> <span class="keywordtype">short</span>, 16, 0)
01272 <a class="code" href="color-conversions_8c.html#a5">GENERIC_COLOR_FUNC</a>(cmyk, color_raw)
01273 <a class="code" href="color-conversions_8c.html#a18">CMYK_TO_COLOR_FUNC</a>(kcmy, color_raw, <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span>, 8, 1)
01274 <a class="code" href="color-conversions_8c.html#a18">CMYK_TO_COLOR_FUNC</a>(kcmy, color_raw, <span class="keywordtype">unsigned</span> <span class="keywordtype">short</span>, 16, 1)
01275 <a class="code" href="color-conversions_8c.html#a5">GENERIC_COLOR_FUNC</a>(kcmy, color_raw)
01276 
<a name="l01277"></a><a class="code" href="color-conversions_8c.html#a19">01277</a> #define <a class="code" href="color-conversions_8c.html#a19">CMYK_TO_KCMY_FUNC</a>(T, size)                                          \
01278 <span class="keyword">static</span> <span class="keywordtype">unsigned</span>                                                             \
01279 cmyk_##size##_to_kcmy(<span class="keyword">const</span> <a class="code" href="structstp__vars.html">stp_vars_t</a> *vars,                               \
01280                       <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> *in,                              \
01281                       <span class="keywordtype">unsigned</span> <span class="keywordtype">short</span> *out)                                  \
01282 {                                                                           \
01283   <span class="keywordtype">int</span> i;                                                                    \
01284   <span class="keywordtype">unsigned</span> retval = 0;                                                      \
01285   <span class="keywordtype">int</span> j;                                                                    \
01286   <span class="keywordtype">int</span> nz[4];                                                                \
01287   <span class="keyword">const</span> T *s_in = (<span class="keyword">const</span> T *) in;                                           \
01288   <a class="code" href="structlut__t.html">lut_t</a> *lut = (<a class="code" href="structlut__t.html">lut_t</a> *)(<a class="code" href="group__vars.html#ga20">stp_get_component_data</a>(vars, <span class="stringliteral">"Color"</span>));            \
01289   <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">short</span> *user;                                               \
01290   <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">short</span> *maps[4];                                            \
01291                                                                             \
01292   <span class="keywordflow">for</span> (i = 0; i &lt; 4; i++)                                                   \
01293     {                                                                       \
01294       <a class="code" href="group__curve.html#ga51">stp_curve_resample</a>(lut-&gt;<a class="code" href="structlut__t.html#o13">channel_curves</a>[i].<a class="code" href="structstp__cached__curve__t.html#o0">curve</a>, 65536);              \
01295       maps[i] = <a class="code" href="curve-cache_8c.html#a7">stp_curve_cache_get_ushort_data</a>(&amp;(lut-&gt;<a class="code" href="structlut__t.html#o13">channel_curves</a>[i])); \
01296     }                                                                       \
01297   <a class="code" href="group__curve.html#ga51">stp_curve_resample</a>(lut-&gt;<a class="code" href="structlut__t.html#o12">user_color_correction</a>.<a class="code" href="structstp__cached__curve__t.html#o0">curve</a>, 1 &lt;&lt; size);          \
01298   user = <a class="code" href="curve-cache_8c.html#a7">stp_curve_cache_get_ushort_data</a>(&amp;(lut-&gt;<a class="code" href="structlut__t.html#o12">user_color_correction</a>));    \
01299                                                                             \
01300   memset(nz, 0, <span class="keyword">sizeof</span>(nz));                                                \
01301                                                                             \
01302   <span class="keywordflow">for</span> (i = 0; i &lt; lut-&gt;<a class="code" href="structlut__t.html#o2">image_width</a>; i++, out += 4)                          \
01303     {                                                                       \
01304       <span class="keywordflow">for</span> (j = 0; j &lt; 4; j++)                                               \
01305         {                                                                   \
01306           <span class="keywordtype">int</span> outpos = (j + 1) &amp; 3;                                         \
01307           <span class="keywordtype">int</span> inval = *s_in++;                                              \
01308           nz[outpos] |= inval;                                              \
01309           out[outpos] = maps[outpos][user[inval]];                          \
01310         }                                                                   \
01311     }                                                                       \
01312   <span class="keywordflow">for</span> (j = 0; j &lt; 4; j++)                                                   \
01313     <span class="keywordflow">if</span> (nz[j] == 0)                                                         \
01314       retval |= (1 &lt;&lt; j);                                                   \
01315   <span class="keywordflow">return</span> retval;                                                            \
01316 }
01317 
01318 <a class="code" href="color-conversions_8c.html#a19">CMYK_TO_KCMY_FUNC</a>(<span class="keywordtype">unsigned</span> <span class="keywordtype">char</span>, 8)
01319 <a class="code" href="color-conversions_8c.html#a19">CMYK_TO_KCMY_FUNC</a>(<span class="keywordtype">unsigned</span> <span class="keywordtype">short</span>, 16)
01320 <a class="code" href="color-conversions_8c.html#a5">GENERIC_COLOR_FUNC</a>(cmyk, kcmy)
01321 
<a name="l01322"></a><a class="code" href="color-conversions_8c.html#a20">01322</a> #define <a class="code" href="color-conversions_8c.html#a20">KCMY_TO_KCMY_FUNC</a>(T, size)                                          \
01323 <span class="keyword">static</span> <span class="keywordtype">unsigned</span>                                                             \
01324 kcmy_##size##_to_kcmy(<span class="keyword">const</span> <a class="code" href="structstp__vars.html">stp_vars_t</a> *vars,                               \
01325                       <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> *in,                              \
01326                       <span class="keywordtype">unsigned</span> <span class="keywordtype">short</span> *out)                                  \
01327 {                                                                           \
01328   <span class="keywordtype">int</span> i;                                                                    \
01329   <span class="keywordtype">unsigned</span> retval = 0;                                                      \
01330   <span class="keywordtype">int</span> j;                                                                    \
01331   <span class="keywordtype">int</span> nz[4];                                                                \
01332   <span class="keyword">const</span> T *s_in = (<span class="keyword">const</span> T *) in;                                           \
01333   <a class="code" href="structlut__t.html">lut_t</a> *lut = (<a class="code" href="structlut__t.html">lut_t</a> *)(<a class="code" href="group__vars.html#ga20">stp_get_component_data</a>(vars, <span class="stringliteral">"Color"</span>));            \
01334   <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">short</span> *user;                                               \
01335   <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">short</span> *maps[4];                                            \
01336                                                                             \
01337   <span class="keywordflow">for</span> (i = 0; i &lt; 4; i++)                                                   \
01338     {                                                                       \
01339       <a class="code" href="group__curve.html#ga51">stp_curve_resample</a>(lut-&gt;<a class="code" href="structlut__t.html#o13">channel_curves</a>[i].<a class="code" href="structstp__cached__curve__t.html#o0">curve</a>, 65536);              \
01340       maps[i] = <a class="code" href="curve-cache_8c.html#a7">stp_curve_cache_get_ushort_data</a>(&amp;(lut-&gt;<a class="code" href="structlut__t.html#o13">channel_curves</a>[i])); \
01341     }                                                                       \
01342   <a class="code" href="group__curve.html#ga51">stp_curve_resample</a>(lut-&gt;<a class="code" href="structlut__t.html#o12">user_color_correction</a>.<a class="code" href="structstp__cached__curve__t.html#o0">curve</a>, 1 &lt;&lt; size);          \
01343   user = <a class="code" href="curve-cache_8c.html#a7">stp_curve_cache_get_ushort_data</a>(&amp;(lut-&gt;<a class="code" href="structlut__t.html#o12">user_color_correction</a>));    \
01344                                                                             \
01345   memset(nz, 0, <span class="keyword">sizeof</span>(nz));                                                \
01346                                                                             \
01347   <span class="keywordflow">for</span> (i = 0; i &lt; lut-&gt;<a class="code" href="structlut__t.html#o2">image_width</a>; i++, out += 4)                          \
01348     {                                                                       \
01349       <span class="keywordflow">for</span> (j = 0; j &lt; 4; j++)                                               \
01350         {                                                                   \
01351           <span class="keywordtype">int</span> inval = *s_in++;                                              \
01352           nz[j] |= inval;                                                   \
01353           out[j] = maps[j][user[inval]];                                    \
01354         }                                                                   \
01355     }                                                                       \
01356   <span class="keywordflow">for</span> (j = 0; j &lt; 4; j++)                                                   \
01357     <span class="keywordflow">if</span> (nz[j] == 0)                                                         \
01358       retval |= (1 &lt;&lt; j);                                                   \
01359   <span class="keywordflow">return</span> retval;                                                            \
01360 }
01361 
01362 <a class="code" href="color-conversions_8c.html#a20">KCMY_TO_KCMY_FUNC</a>(<span class="keywordtype">unsigned</span> <span class="keywordtype">char</span>, 8)
01363 <a class="code" href="color-conversions_8c.html#a20">KCMY_TO_KCMY_FUNC</a>(<span class="keywordtype">unsigned</span> <span class="keywordtype">short</span>, 16)
01364 <a class="code" href="color-conversions_8c.html#a5">GENERIC_COLOR_FUNC</a>(kcmy, kcmy)
01365 
01366 
<a name="l01367"></a><a class="code" href="color-conversions_8c.html#a21">01367</a> #define <a class="code" href="color-conversions_8c.html#a21">GRAY_TO_GRAY_FUNC</a>(T, bits)                                         \
01368 <span class="keyword">static</span> <span class="keywordtype">unsigned</span>                                                            \
01369 gray_##bits##_to_gray(<span class="keyword">const</span> <a class="code" href="structstp__vars.html">stp_vars_t</a> *vars,                              \
01370                       <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> *in,                             \
01371                       <span class="keywordtype">unsigned</span> <span class="keywordtype">short</span> *out)                                 \
01372 {                                                                          \
01373   <span class="keywordtype">int</span> i;                                                                   \
01374   <span class="keywordtype">int</span> i0 = -1;                                                             \
01375   <span class="keywordtype">int</span> o0 = 0;                                                              \
01376   <span class="keywordtype">int</span> nz = 0;                                                              \
01377   <span class="keyword">const</span> T *s_in = (<span class="keyword">const</span> T *) in;                                          \
01378   <a class="code" href="structlut__t.html">lut_t</a> *lut = (<a class="code" href="structlut__t.html">lut_t</a> *)(<a class="code" href="group__vars.html#ga20">stp_get_component_data</a>(vars, <span class="stringliteral">"Color"</span>));           \
01379   <span class="keywordtype">int</span> width = lut-&gt;<a class="code" href="structlut__t.html#o2">image_width</a>;                                            \
01380   <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">short</span> *composite;                                         \
01381   <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">short</span> *user;                                              \
01382                                                                            \
01383   <a class="code" href="group__curve.html#ga39">stp_curve_resample</a>                                                       \
01384     (<a class="code" href="curve-cache_8c.html#a2">stp_curve_cache_get_curve</a>(&amp;(lut-&gt;<a class="code" href="structlut__t.html#o13">channel_curves</a>[<a class="code" href="color-conversion_8h.html#a0">CHANNEL_K</a>])), 65536); \
01385   composite =                                                              \
01386     <a class="code" href="curve-cache_8c.html#a7">stp_curve_cache_get_ushort_data</a>(&amp;(lut-&gt;<a class="code" href="structlut__t.html#o13">channel_curves</a>[<a class="code" href="color-conversion_8h.html#a0">CHANNEL_K</a>]));    \
01387   <a class="code" href="group__curve.html#ga51">stp_curve_resample</a>(lut-&gt;<a class="code" href="structlut__t.html#o12">user_color_correction</a>.<a class="code" href="structstp__cached__curve__t.html#o0">curve</a>, 1 &lt;&lt; bits);         \
01388   user = <a class="code" href="curve-cache_8c.html#a7">stp_curve_cache_get_ushort_data</a>(&amp;(lut-&gt;<a class="code" href="structlut__t.html#o12">user_color_correction</a>));   \
01389                                                                            \
01390   memset(out, 0, width * <span class="keyword">sizeof</span>(<span class="keywordtype">unsigned</span> <span class="keywordtype">short</span>));                          \
01391                                                                            \
01392   <span class="keywordflow">for</span> (i = 0; i &lt; lut-&gt;<a class="code" href="structlut__t.html#o2">image_width</a>; i++)                                   \
01393     {                                                                      \
01394       <span class="keywordflow">if</span> (i0 != s_in[0])                                                   \
01395         {                                                                  \
01396           i0 = s_in[0];                                                    \
01397           o0 = composite[user[i0]];                                        \
01398           nz |= o0;                                                        \
01399         }                                                                  \
01400       out[0] = o0;                                                         \
01401       s_in ++;                                                             \
01402       out ++;                                                              \
01403     }                                                                      \
01404   <span class="keywordflow">return</span> nz == 0;                                                          \
01405 }
01406 
01407 <a class="code" href="color-conversions_8c.html#a21">GRAY_TO_GRAY_FUNC</a>(<span class="keywordtype">unsigned</span> <span class="keywordtype">char</span>, 8)
01408 <a class="code" href="color-conversions_8c.html#a21">GRAY_TO_GRAY_FUNC</a>(<span class="keywordtype">unsigned</span> <span class="keywordtype">short</span>, 16)
01409 <a class="code" href="color-conversions_8c.html#a5">GENERIC_COLOR_FUNC</a>(gray, gray)
01410 
<a name="l01411"></a><a class="code" href="color-conversions_8c.html#a22">01411</a> #define <a class="code" href="color-conversions_8c.html#a22">COLOR_TO_GRAY_FUNC</a>(T, bits)                                           \
01412 <span class="keyword">static</span> <span class="keywordtype">unsigned</span>                                                               \
01413 color_##bits##_to_gray(<span class="keyword">const</span> <a class="code" href="structstp__vars.html">stp_vars_t</a> *vars,                                \
01414                        <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> *in,                               \
01415                        <span class="keywordtype">unsigned</span> <span class="keywordtype">short</span> *out)                                   \
01416 {                                                                             \
01417   <span class="keywordtype">int</span> i;                                                                      \
01418   <span class="keywordtype">int</span> i0 = -1;                                                                \
01419   <span class="keywordtype">int</span> i1 = -1;                                                                \
01420   <span class="keywordtype">int</span> i2 = -1;                                                                \
01421   <span class="keywordtype">int</span> o0 = 0;                                                                 \
01422   <span class="keywordtype">int</span> nz = 0;                                                                 \
01423   <span class="keyword">const</span> T *s_in = (<span class="keyword">const</span> T *) in;                                             \
01424   <a class="code" href="structlut__t.html">lut_t</a> *lut = (<a class="code" href="structlut__t.html">lut_t</a> *)(<a class="code" href="group__vars.html#ga20">stp_get_component_data</a>(vars, <span class="stringliteral">"Color"</span>));              \
01425   <span class="keywordtype">int</span> l_red = <a class="code" href="color-conversions_8c.html#a0">LUM_RED</a>;                                                        \
01426   <span class="keywordtype">int</span> l_green = <a class="code" href="color-conversions_8c.html#a1">LUM_GREEN</a>;                                                    \
01427   <span class="keywordtype">int</span> l_blue = <a class="code" href="color-conversions_8c.html#a2">LUM_BLUE</a>;                                                      \
01428   <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">short</span> *composite;                                            \
01429   <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">short</span> *user;                                                 \
01430                                                                               \
01431   <a class="code" href="group__curve.html#ga39">stp_curve_resample</a>                                                          \
01432     (<a class="code" href="curve-cache_8c.html#a2">stp_curve_cache_get_curve</a>(&amp;(lut-&gt;<a class="code" href="structlut__t.html#o13">channel_curves</a>[<a class="code" href="color-conversion_8h.html#a0">CHANNEL_K</a>])), 65536);    \
01433   composite =                                                                 \
01434     <a class="code" href="curve-cache_8c.html#a7">stp_curve_cache_get_ushort_data</a>(&amp;(lut-&gt;<a class="code" href="structlut__t.html#o13">channel_curves</a>[<a class="code" href="color-conversion_8h.html#a0">CHANNEL_K</a>]));       \
01435   <a class="code" href="group__curve.html#ga51">stp_curve_resample</a>(lut-&gt;<a class="code" href="structlut__t.html#o12">user_color_correction</a>.<a class="code" href="structstp__cached__curve__t.html#o0">curve</a>, 1 &lt;&lt; bits);            \
01436   user = <a class="code" href="curve-cache_8c.html#a7">stp_curve_cache_get_ushort_data</a>(&amp;(lut-&gt;<a class="code" href="structlut__t.html#o12">user_color_correction</a>));      \
01437                                                                               \
01438   <span class="keywordflow">if</span> (lut-&gt;<a class="code" href="structlut__t.html#o7">input_color_description</a>-&gt;<a class="code" href="structcolor__description__t.html#o4">color_model</a> == <a class="code" href="color-conversion_8h.html#a52a36">COLOR_BLACK</a>)               \
01439     {                                                                         \
01440       l_red = (100 - l_red) / 2;                                              \
01441       l_green = (100 - l_green) / 2;                                          \
01442       l_blue = (100 - l_blue) / 2;                                            \
01443     }                                                                         \
01444                                                                               \
01445   <span class="keywordflow">for</span> (i = 0; i &lt; lut-&gt;<a class="code" href="structlut__t.html#o2">image_width</a>; i++)                                      \
01446     {                                                                         \
01447       <span class="keywordflow">if</span> (i0 != s_in[0] || i1 != s_in[1] || i2 != s_in[2])                    \
01448         {                                                                     \
01449           i0 = s_in[0];                                                       \
01450           i1 = s_in[1];                                                       \
01451           i2 = s_in[2];                                                       \
01452           o0 =                                                                \
01453             composite[user[(i0 * l_red + i1 * l_green + i2 * l_blue) / 100]]; \
01454           nz |= o0;                                                           \
01455         }                                                                     \
01456       out[0] = o0;                                                            \
01457       s_in += 3;                                                              \
01458       out ++;                                                                 \
01459     }                                                                         \
01460   <span class="keywordflow">return</span> nz == 0;                                                             \
01461 }
01462 
01463 <a class="code" href="color-conversions_8c.html#a22">COLOR_TO_GRAY_FUNC</a>(<span class="keywordtype">unsigned</span> <span class="keywordtype">char</span>, 8)
01464 <a class="code" href="color-conversions_8c.html#a22">COLOR_TO_GRAY_FUNC</a>(<span class="keywordtype">unsigned</span> <span class="keywordtype">short</span>, 16)
01465 <a class="code" href="color-conversions_8c.html#a5">GENERIC_COLOR_FUNC</a>(color, gray)
01466 
01467 
<a name="l01468"></a><a class="code" href="color-conversions_8c.html#a23">01468</a> #define <a class="code" href="color-conversions_8c.html#a23">CMYK_TO_GRAY_FUNC</a>(T, bits)                                          \
01469 <span class="keyword">static</span> <span class="keywordtype">unsigned</span>                                                             \
01470 cmyk_##bits##_to_gray(<span class="keyword">const</span> <a class="code" href="structstp__vars.html">stp_vars_t</a> *vars,                               \
01471                       <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> *in,                              \
01472                       <span class="keywordtype">unsigned</span> <span class="keywordtype">short</span> *out)                                  \
01473 {                                                                           \
01474   <span class="keywordtype">int</span> i;                                                                    \
01475   <span class="keywordtype">int</span> i0 = -1;                                                              \
01476   <span class="keywordtype">int</span> i1 = -1;                                                              \
01477   <span class="keywordtype">int</span> i2 = -1;                                                              \
01478   <span class="keywordtype">int</span> i3 = -4;                                                              \
01479   <span class="keywordtype">int</span> o0 = 0;                                                               \
01480   <span class="keywordtype">int</span> nz = 0;                                                               \
01481   <span class="keyword">const</span> T *s_in = (<span class="keyword">const</span> T *) in;                                           \
01482   <a class="code" href="structlut__t.html">lut_t</a> *lut = (<a class="code" href="structlut__t.html">lut_t</a> *)(<a class="code" href="group__vars.html#ga20">stp_get_component_data</a>(vars, <span class="stringliteral">"Color"</span>));            \
01483   <span class="keywordtype">int</span> l_red = <a class="code" href="color-conversions_8c.html#a0">LUM_RED</a>;                                                      \
01484   <span class="keywordtype">int</span> l_green = <a class="code" href="color-conversions_8c.html#a1">LUM_GREEN</a>;                                                  \
01485   <span class="keywordtype">int</span> l_blue = <a class="code" href="color-conversions_8c.html#a2">LUM_BLUE</a>;                                                    \
01486   <span class="keywordtype">int</span> l_white = 0;                                                          \
01487   <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">short</span> *composite;                                          \
01488   <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">short</span> *user;                                               \
01489                                                                             \
01490   <a class="code" href="group__curve.html#ga39">stp_curve_resample</a>                                                        \
01491     (<a class="code" href="curve-cache_8c.html#a2">stp_curve_cache_get_curve</a>(&amp;(lut-&gt;<a class="code" href="structlut__t.html#o13">channel_curves</a>[<a class="code" href="color-conversion_8h.html#a0">CHANNEL_K</a>])), 65536);  \
01492   composite =                                                               \
01493     <a class="code" href="curve-cache_8c.html#a7">stp_curve_cache_get_ushort_data</a>(&amp;(lut-&gt;<a class="code" href="structlut__t.html#o13">channel_curves</a>[<a class="code" href="color-conversion_8h.html#a0">CHANNEL_K</a>]));     \
01494   <a class="code" href="group__curve.html#ga51">stp_curve_resample</a>(lut-&gt;<a class="code" href="structlut__t.html#o12">user_color_correction</a>.<a class="code" href="structstp__cached__curve__t.html#o0">curve</a>, 1 &lt;&lt; bits);          \
01495   user = <a class="code" href="curve-cache_8c.html#a7">stp_curve_cache_get_ushort_data</a>(&amp;(lut-&gt;<a class="code" href="structlut__t.html#o12">user_color_correction</a>));    \
01496                                                                             \
01497   <span class="keywordflow">if</span> (lut-&gt;<a class="code" href="structlut__t.html#o7">input_color_description</a>-&gt;<a class="code" href="structcolor__description__t.html#o4">color_model</a> == <a class="code" href="color-conversion_8h.html#a52a36">COLOR_BLACK</a>)             \
01498     {                                                                       \
01499       l_red = (100 - l_red) / 3;                                            \
01500       l_green = (100 - l_green) / 3;                                        \
01501       l_blue = (100 - l_blue) / 3;                                          \
01502       l_white = (100 - l_white) / 3;                                        \
01503     }                                                                       \
01504                                                                             \
01505   <span class="keywordflow">for</span> (i = 0; i &lt; lut-&gt;<a class="code" href="structlut__t.html#o2">image_width</a>; i++)                                    \
01506     {                                                                       \
01507       <span class="keywordflow">if</span> (i0 != s_in[0] || i1 != s_in[1] || i2 != s_in[2] || i3 != s_in[3]) \
01508         {                                                                   \
01509           i0 = s_in[0];                                                     \
01510           i1 = s_in[1];                                                     \
01511           i2 = s_in[2];                                                     \
01512           i3 = s_in[3];                                                     \
01513           o0 = composite[user[(i0 * l_red + i1 * l_green +                  \
01514                           i2 * l_blue + i3 * l_white) / 100]];              \
01515           nz |= o0;                                                         \
01516         }                                                                   \
01517       out[0] = o0;                                                          \
01518       s_in += 4;                                                            \
01519       out ++;                                                               \
01520     }                                                                       \
01521   <span class="keywordflow">return</span> nz ? 0 : 1;                                                        \
01522 }
01523 
01524 <a class="code" href="color-conversions_8c.html#a23">CMYK_TO_GRAY_FUNC</a>(<span class="keywordtype">unsigned</span> <span class="keywordtype">char</span>, 8)
01525 <a class="code" href="color-conversions_8c.html#a23">CMYK_TO_GRAY_FUNC</a>(<span class="keywordtype">unsigned</span> <span class="keywordtype">short</span>, 16)
01526 <a class="code" href="color-conversions_8c.html#a5">GENERIC_COLOR_FUNC</a>(cmyk, gray)
01527 
<a name="l01528"></a><a class="code" href="color-conversions_8c.html#a24">01528</a> #define <a class="code" href="color-conversions_8c.html#a24">KCMY_TO_GRAY_FUNC</a>(T, bits)                                          \
01529 <span class="keyword">static</span> <span class="keywordtype">unsigned</span>                                                             \
01530 kcmy_##bits##_to_gray(<span class="keyword">const</span> <a class="code" href="structstp__vars.html">stp_vars_t</a> *vars,                               \
01531                       <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> *in,                              \
01532                       <span class="keywordtype">unsigned</span> <span class="keywordtype">short</span> *out)                                  \
01533 {                                                                           \
01534   <span class="keywordtype">int</span> i;                                                                    \
01535   <span class="keywordtype">int</span> i0 = -1;                                                              \
01536   <span class="keywordtype">int</span> i1 = -1;                                                              \
01537   <span class="keywordtype">int</span> i2 = -1;                                                              \
01538   <span class="keywordtype">int</span> i3 = -4;                                                              \
01539   <span class="keywordtype">int</span> o0 = 0;                                                               \
01540   <span class="keywordtype">int</span> nz = 0;                                                               \
01541   <span class="keyword">const</span> T *s_in = (<span class="keyword">const</span> T *) in;                                           \
01542   <a class="code" href="structlut__t.html">lut_t</a> *lut = (<a class="code" href="structlut__t.html">lut_t</a> *)(<a class="code" href="group__vars.html#ga20">stp_get_component_data</a>(vars, <span class="stringliteral">"Color"</span>));            \
01543   <span class="keywordtype">int</span> l_red = <a class="code" href="color-conversions_8c.html#a0">LUM_RED</a>;                                                      \
01544   <span class="keywordtype">int</span> l_green = <a class="code" href="color-conversions_8c.html#a1">LUM_GREEN</a>;                                                  \
01545   <span class="keywordtype">int</span> l_blue = <a class="code" href="color-conversions_8c.html#a2">LUM_BLUE</a>;                                                    \
01546   <span class="keywordtype">int</span> l_white = 0;                                                          \
01547   <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">short</span> *composite;                                          \
01548   <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">short</span> *user;                                               \
01549                                                                             \
01550   <a class="code" href="group__curve.html#ga39">stp_curve_resample</a>                                                        \
01551     (<a class="code" href="curve-cache_8c.html#a2">stp_curve_cache_get_curve</a>(&amp;(lut-&gt;<a class="code" href="structlut__t.html#o13">channel_curves</a>[<a class="code" href="color-conversion_8h.html#a0">CHANNEL_K</a>])), 65536);  \
01552   composite =                                                               \
01553     <a class="code" href="curve-cache_8c.html#a7">stp_curve_cache_get_ushort_data</a>(&amp;(lut-&gt;<a class="code" href="structlut__t.html#o13">channel_curves</a>[<a class="code" href="color-conversion_8h.html#a0">CHANNEL_K</a>]));     \
01554   <a class="code" href="group__curve.html#ga51">stp_curve_resample</a>(lut-&gt;<a class="code" href="structlut__t.html#o12">user_color_correction</a>.<a class="code" href="structstp__cached__curve__t.html#o0">curve</a>, 1 &lt;&lt; bits);          \
01555   user = <a class="code" href="curve-cache_8c.html#a7">stp_curve_cache_get_ushort_data</a>(&amp;(lut-&gt;<a class="code" href="structlut__t.html#o12">user_color_correction</a>));    \
01556                                                                             \
01557   <span class="keywordflow">if</span> (lut-&gt;<a class="code" href="structlut__t.html#o7">input_color_description</a>-&gt;<a class="code" href="structcolor__description__t.html#o4">color_model</a> == <a class="code" href="color-conversion_8h.html#a52a36">COLOR_BLACK</a>)             \
01558     {                                                                       \
01559       l_red = (100 - l_red) / 3;                                            \
01560       l_green = (100 - l_green) / 3;                                        \
01561       l_blue = (100 - l_blue) / 3;                                          \
01562       l_white = (100 - l_white) / 3;                                        \
01563     }                                                                       \
01564                                                                             \
01565   <span class="keywordflow">for</span> (i = 0; i &lt; lut-&gt;<a class="code" href="structlut__t.html#o2">image_width</a>; i++)                                    \
01566     {                                                                       \
01567       <span class="keywordflow">if</span> (i0 != s_in[0] || i1 != s_in[1] || i2 != s_in[2] || i3 != s_in[3]) \
01568         {                                                                   \
01569           i0 = s_in[0];                                                     \
01570           i1 = s_in[1];                                                     \
01571           i2 = s_in[2];                                                     \
01572           i3 = s_in[3];                                                     \
01573           o0 = composite[user[(i0 * l_red + i1 * l_green +                  \
01574                           i2 * l_blue + i3 * l_white) / 100]];              \
01575           nz |= o0;                                                         \
01576         }                                                                   \
01577       out[0] = o0;                                                          \
01578       s_in += 4;                                                            \
01579       out ++;                                                               \
01580     }                                                                       \
01581   <span class="keywordflow">return</span> nz ? 0 : 1;                                                        \
01582 }
01583 
01584 <a class="code" href="color-conversions_8c.html#a24">KCMY_TO_GRAY_FUNC</a>(<span class="keywordtype">unsigned</span> <span class="keywordtype">char</span>, 8)
01585 <a class="code" href="color-conversions_8c.html#a24">KCMY_TO_GRAY_FUNC</a>(<span class="keywordtype">unsigned</span> <span class="keywordtype">short</span>, 16)
01586 <a class="code" href="color-conversions_8c.html#a5">GENERIC_COLOR_FUNC</a>(kcmy, gray)
01587 
<a name="l01588"></a><a class="code" href="color-conversions_8c.html#a25">01588</a> #define <a class="code" href="color-conversions_8c.html#a25">GRAY_TO_GRAY_RAW_FUNC</a>(T, bits)                                  \
01589 <span class="keyword">static</span> <span class="keywordtype">unsigned</span>                                                         \
01590 gray_##bits##_to_gray_raw(<span class="keyword">const</span> <a class="code" href="structstp__vars.html">stp_vars_t</a> *vars,                       \
01591                           <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> *in,                      \
01592                           <span class="keywordtype">unsigned</span> <span class="keywordtype">short</span> *out)                          \
01593 {                                                                       \
01594   <span class="keywordtype">int</span> i;                                                                \
01595   <span class="keywordtype">int</span> nz = 0;                                                           \
01596   <span class="keyword">const</span> T *s_in = (<span class="keyword">const</span> T *) in;                                       \
01597   <a class="code" href="structlut__t.html">lut_t</a> *lut = (<a class="code" href="structlut__t.html">lut_t</a> *)(<a class="code" href="group__vars.html#ga20">stp_get_component_data</a>(vars, <span class="stringliteral">"Color"</span>));        \
01598   <span class="keywordtype">int</span> width = lut-&gt;<a class="code" href="structlut__t.html#o2">image_width</a>;                                         \
01599   <span class="keywordtype">unsigned</span> mask = 0;                                                    \
01600   <span class="keywordflow">if</span> (lut-&gt;<a class="code" href="structlut__t.html#o6">invert_output</a>)                                               \
01601     mask = 0xffff;                                                      \
01602                                                                         \
01603   memset(out, 0, width * <span class="keyword">sizeof</span>(<span class="keywordtype">unsigned</span> <span class="keywordtype">short</span>));                       \
01604                                                                         \
01605   <span class="keywordflow">for</span> (i = 0; i &lt; lut-&gt;<a class="code" href="structlut__t.html#o2">image_width</a>; i++)                                \
01606     {                                                                   \
01607       out[0] = (s_in[0] * (65535 / ((1 &lt;&lt; bits) - 1))) ^ mask;          \
01608       nz |= out[0];                                                     \
01609       s_in ++;                                                          \
01610       out ++;                                                           \
01611     }                                                                   \
01612   <span class="keywordflow">return</span> nz == 0;                                                       \
01613 }
01614 
01615 <a class="code" href="color-conversions_8c.html#a25">GRAY_TO_GRAY_RAW_FUNC</a>(<span class="keywordtype">unsigned</span> <span class="keywordtype">char</span>, 8)
01616 <a class="code" href="color-conversions_8c.html#a25">GRAY_TO_GRAY_RAW_FUNC</a>(<span class="keywordtype">unsigned</span> <span class="keywordtype">short</span>, 16)
01617 <a class="code" href="color-conversions_8c.html#a5">GENERIC_COLOR_FUNC</a>(gray, gray_raw)
01618 
<a name="l01619"></a><a class="code" href="color-conversions_8c.html#a26">01619</a> #define <a class="code" href="color-conversions_8c.html#a26">COLOR_TO_GRAY_RAW_FUNC</a>(T, bits, invertable, name2)              \
01620 <span class="keyword">static</span> <span class="keywordtype">unsigned</span>                                                         \
01621 color_##bits##_to_gray_##name2(<span class="keyword">const</span> <a class="code" href="structstp__vars.html">stp_vars_t</a> *vars,                  \
01622                                <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> *in,                 \
01623                                <span class="keywordtype">unsigned</span> <span class="keywordtype">short</span> *out)                     \
01624 {                                                                       \
01625   <span class="keywordtype">int</span> i;                                                                \
01626   <span class="keywordtype">int</span> i0 = -1;                                                          \
01627   <span class="keywordtype">int</span> i1 = -1;                                                          \
01628   <span class="keywordtype">int</span> i2 = -1;                                                          \
01629   <span class="keywordtype">int</span> o0 = 0;                                                           \
01630   <span class="keywordtype">int</span> nz = 0;                                                           \
01631   <span class="keyword">const</span> T *s_in = (<span class="keyword">const</span> T *) in;                                       \
01632   <a class="code" href="structlut__t.html">lut_t</a> *lut = (<a class="code" href="structlut__t.html">lut_t</a> *)(<a class="code" href="group__vars.html#ga20">stp_get_component_data</a>(vars, <span class="stringliteral">"Color"</span>));        \
01633   <span class="keywordtype">int</span> l_red = <a class="code" href="color-conversions_8c.html#a0">LUM_RED</a>;                                                  \
01634   <span class="keywordtype">int</span> l_green = <a class="code" href="color-conversions_8c.html#a1">LUM_GREEN</a>;                                              \
01635   <span class="keywordtype">int</span> l_blue = <a class="code" href="color-conversions_8c.html#a2">LUM_BLUE</a>;                                                \
01636   <span class="keywordtype">unsigned</span> mask = 0;                                                    \
01637   <span class="keywordflow">if</span> (lut-&gt;<a class="code" href="structlut__t.html#o6">invert_output</a> &amp;&amp; invertable)                                 \
01638     mask = 0xffff;                                                      \
01639                                                                         \
01640   <span class="keywordflow">if</span> (lut-&gt;<a class="code" href="structlut__t.html#o7">input_color_description</a>-&gt;<a class="code" href="structcolor__description__t.html#o4">color_model</a> == <a class="code" href="color-conversion_8h.html#a52a36">COLOR_BLACK</a>)         \
01641     {                                                                   \
01642       l_red = (100 - l_red) / 2;                                        \
01643       l_green = (100 - l_green) / 2;                                    \
01644       l_blue = (100 - l_blue) / 2;                                      \
01645     }                                                                   \
01646                                                                         \
01647   <span class="keywordflow">for</span> (i = 0; i &lt; lut-&gt;<a class="code" href="structlut__t.html#o2">image_width</a>; i++)                                \
01648     {                                                                   \
01649       <span class="keywordflow">if</span> (i0 != s_in[0] || i1 != s_in[1] || i2 != s_in[2])              \
01650         {                                                               \
01651           i0 = s_in[0];                                                 \
01652           i1 = s_in[1];                                                 \
01653           i2 = s_in[2];                                                 \
01654           o0 = (i0 * (65535 / ((1 &lt;&lt; bits) - 1)) * l_red +              \
01655                 i1 * (65535 / ((1 &lt;&lt; bits) - 1)) * l_green +            \
01656                 i2 * (65535 / ((1 &lt;&lt; bits) - 1)) * l_blue) / 100;       \
01657           o0 ^= mask;                                                   \
01658           nz |= o0;                                                     \
01659         }                                                               \
01660       out[0] = o0;                                                      \
01661       s_in += 3;                                                        \
01662       out ++;                                                           \
01663     }                                                                   \
01664   <span class="keywordflow">return</span> nz == 0;                                                       \
01665 }
01666 
01667 <a class="code" href="color-conversions_8c.html#a26">COLOR_TO_GRAY_RAW_FUNC</a>(<span class="keywordtype">unsigned</span> <span class="keywordtype">char</span>, 8, 1, <a class="code" href="structraw.html">raw</a>)
01668 <a class="code" href="color-conversions_8c.html#a26">COLOR_TO_GRAY_RAW_FUNC</a>(<span class="keywordtype">unsigned</span> <span class="keywordtype">short</span>, 16, 1, <a class="code" href="structraw.html">raw</a>)
01669 <a class="code" href="color-conversions_8c.html#a5">GENERIC_COLOR_FUNC</a>(color, gray_raw)
01670 <a class="code" href="color-conversions_8c.html#a26">COLOR_TO_GRAY_RAW_FUNC</a>(<span class="keywordtype">unsigned</span> <span class="keywordtype">char</span>, 8, 0, noninvert)
01671 <a class="code" href="color-conversions_8c.html#a26">COLOR_TO_GRAY_RAW_FUNC</a>(<span class="keywordtype">unsigned</span> <span class="keywordtype">short</span>, 16, 0, noninvert)
01672 
01673 
<a name="l01674"></a><a class="code" href="color-conversions_8c.html#a27">01674</a> #define <a class="code" href="color-conversions_8c.html#a27">CMYK_TO_GRAY_RAW_FUNC</a>(T, bits, invertable, name2)                   \
01675 <span class="keyword">static</span> <span class="keywordtype">unsigned</span>                                                             \
01676 cmyk_##bits##_to_gray_##name2(<span class="keyword">const</span> <a class="code" href="structstp__vars.html">stp_vars_t</a> *vars,                       \
01677                               <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> *in,                      \
01678                               <span class="keywordtype">unsigned</span> <span class="keywordtype">short</span> *out)                          \
01679 {                                                                           \
01680   <span class="keywordtype">int</span> i;                                                                    \
01681   <span class="keywordtype">int</span> i0 = -1;                                                              \
01682   <span class="keywordtype">int</span> i1 = -1;                                                              \
01683   <span class="keywordtype">int</span> i2 = -1;                                                              \
01684   <span class="keywordtype">int</span> i3 = -4;                                                              \
01685   <span class="keywordtype">int</span> o0 = 0;                                                               \
01686   <span class="keywordtype">int</span> nz = 0;                                                               \
01687   <span class="keyword">const</span> T *s_in = (<span class="keyword">const</span> T *) in;                                           \
01688   <a class="code" href="structlut__t.html">lut_t</a> *lut = (<a class="code" href="structlut__t.html">lut_t</a> *)(<a class="code" href="group__vars.html#ga20">stp_get_component_data</a>(vars, <span class="stringliteral">"Color"</span>));            \
01689   <span class="keywordtype">int</span> l_red = <a class="code" href="color-conversions_8c.html#a0">LUM_RED</a>;                                                      \
01690   <span class="keywordtype">int</span> l_green = <a class="code" href="color-conversions_8c.html#a1">LUM_GREEN</a>;                                                  \
01691   <span class="keywordtype">int</span> l_blue = <a class="code" href="color-conversions_8c.html#a2">LUM_BLUE</a>;                                                    \
01692   <span class="keywordtype">int</span> l_white = 0;                                                          \
01693   <span class="keywordtype">unsigned</span> mask = 0;                                                        \
01694   <span class="keywordflow">if</span> (lut-&gt;<a class="code" href="structlut__t.html#o6">invert_output</a> &amp;&amp; invertable)                                     \
01695     mask = 0xffff;                                                          \
01696                                                                             \
01697   <span class="keywordflow">if</span> (lut-&gt;<a class="code" href="structlut__t.html#o7">input_color_description</a>-&gt;<a class="code" href="structcolor__description__t.html#o4">color_model</a> == <a class="code" href="color-conversion_8h.html#a52a36">COLOR_BLACK</a>)             \
01698     {                                                                       \
01699       l_red = (100 - l_red) / 3;                                            \
01700       l_green = (100 - l_green) / 3;                                        \
01701       l_blue = (100 - l_blue) / 3;                                          \
01702       l_white = (100 - l_white) / 3;                                        \
01703     }                                                                       \
01704                                                                             \
01705   <span class="keywordflow">for</span> (i = 0; i &lt; lut-&gt;<a class="code" href="structlut__t.html#o2">image_width</a>; i++)                                    \
01706     {                                                                       \
01707       <span class="keywordflow">if</span> (i0 != s_in[0] || i1 != s_in[1] || i2 != s_in[2] || i3 != s_in[3]) \
01708         {                                                                   \
01709           i0 = s_in[0];                                                     \
01710           i1 = s_in[1];                                                     \
01711           i2 = s_in[2];                                                     \
01712           i3 = s_in[3];                                                     \
01713           o0 = (i0 * (65535 / ((1 &lt;&lt; bits) - 1)) * l_red +                  \
01714                 i1 * (65535 / ((1 &lt;&lt; bits) - 1)) * l_green +                \
01715                 i2 * (65535 / ((1 &lt;&lt; bits) - 1)) * l_blue +                 \
01716                 i3 * (65535 / ((1 &lt;&lt; bits) - 1)) * l_white) / 100;          \
01717           o0 ^= mask;                                                       \
01718           nz |= o0;                                                         \
01719         }                                                                   \
01720       out[0] = o0;                                                          \
01721       s_in += 4;                                                            \
01722       out ++;                                                               \
01723     }                                                                       \
01724   <span class="keywordflow">return</span> nz ? 0 : 1;                                                        \
01725 }
01726 
01727 <a class="code" href="color-conversions_8c.html#a27">CMYK_TO_GRAY_RAW_FUNC</a>(<span class="keywordtype">unsigned</span> <span class="keywordtype">char</span>, 8, 1, <a class="code" href="structraw.html">raw</a>)
01728 <a class="code" href="color-conversions_8c.html#a27">CMYK_TO_GRAY_RAW_FUNC</a>(<span class="keywordtype">unsigned</span> <span class="keywordtype">short</span>, 16, 1, <a class="code" href="structraw.html">raw</a>)
01729 <a class="code" href="color-conversions_8c.html#a5">GENERIC_COLOR_FUNC</a>(cmyk, gray_raw)
01730 <a class="code" href="color-conversions_8c.html#a27">CMYK_TO_GRAY_RAW_FUNC</a>(<span class="keywordtype">unsigned</span> <span class="keywordtype">char</span>, 8, 0, noninvert)
01731 <a class="code" href="color-conversions_8c.html#a27">CMYK_TO_GRAY_RAW_FUNC</a>(<span class="keywordtype">unsigned</span> <span class="keywordtype">short</span>, 16, 0, noninvert)
01732 
<a name="l01733"></a><a class="code" href="color-conversions_8c.html#a28">01733</a> #define <a class="code" href="color-conversions_8c.html#a28">KCMY_TO_GRAY_RAW_FUNC</a>(T, bits, invertable, name2)                   \
01734 <span class="keyword">static</span> <span class="keywordtype">unsigned</span>                                                             \
01735 kcmy_##bits##_to_gray_##name2(<span class="keyword">const</span> <a class="code" href="structstp__vars.html">stp_vars_t</a> *vars,                       \
01736                               <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> *in,                      \
01737                               <span class="keywordtype">unsigned</span> <span class="keywordtype">short</span> *out)                          \
01738 {                                                                           \
01739   <span class="keywordtype">int</span> i;                                                                    \
01740   <span class="keywordtype">int</span> i0 = -1;                                                              \
01741   <span class="keywordtype">int</span> i1 = -1;                                                              \
01742   <span class="keywordtype">int</span> i2 = -1;                                                              \
01743   <span class="keywordtype">int</span> i3 = -4;                                                              \
01744   <span class="keywordtype">int</span> o0 = 0;                                                               \
01745   <span class="keywordtype">int</span> nz = 0;                                                               \
01746   <span class="keyword">const</span> T *s_in = (<span class="keyword">const</span> T *) in;                                           \
01747   <a class="code" href="structlut__t.html">lut_t</a> *lut = (<a class="code" href="structlut__t.html">lut_t</a> *)(<a class="code" href="group__vars.html#ga20">stp_get_component_data</a>(vars, <span class="stringliteral">"Color"</span>));            \
01748   <span class="keywordtype">int</span> l_red = <a class="code" href="color-conversions_8c.html#a0">LUM_RED</a>;                                                      \
01749   <span class="keywordtype">int</span> l_green = <a class="code" href="color-conversions_8c.html#a1">LUM_GREEN</a>;                                                  \
01750   <span class="keywordtype">int</span> l_blue = <a class="code" href="color-conversions_8c.html#a2">LUM_BLUE</a>;                                                    \
01751   <span class="keywordtype">int</span> l_white = 0;                                                          \
01752   <span class="keywordtype">unsigned</span> mask = 0;                                                        \
01753   <span class="keywordflow">if</span> (lut-&gt;<a class="code" href="structlut__t.html#o6">invert_output</a> &amp;&amp; invertable)                                     \
01754     mask = 0xffff;                                                          \
01755                                                                             \
01756   <span class="keywordflow">if</span> (lut-&gt;<a class="code" href="structlut__t.html#o7">input_color_description</a>-&gt;<a class="code" href="structcolor__description__t.html#o4">color_model</a> == <a class="code" href="color-conversion_8h.html#a52a36">COLOR_BLACK</a>)             \
01757     {                                                                       \
01758       l_red = (100 - l_red) / 3;                                            \
01759       l_green = (100 - l_green) / 3;                                        \
01760       l_blue = (100 - l_blue) / 3;                                          \
01761       l_white = (100 - l_white) / 3;                                        \
01762     }                                                                       \
01763                                                                             \
01764   <span class="keywordflow">for</span> (i = 0; i &lt; lut-&gt;<a class="code" href="structlut__t.html#o2">image_width</a>; i++)                                    \
01765     {                                                                       \
01766       <span class="keywordflow">if</span> (i0 != s_in[0] || i1 != s_in[1] || i2 != s_in[2] || i3 != s_in[3]) \
01767         {                                                                   \
01768           i0 = s_in[0];                                                     \
01769           i1 = s_in[1];                                                     \
01770           i2 = s_in[2];                                                     \
01771           i3 = s_in[3];                                                     \
01772           o0 = (i0 * (65535 / ((1 &lt;&lt; bits) - 1)) * l_white +                \
01773                 i1 * (65535 / ((1 &lt;&lt; bits) - 1)) * l_red +                  \
01774                 i2 * (65535 / ((1 &lt;&lt; bits) - 1)) * l_green +                \
01775                 i3 * (65535 / ((1 &lt;&lt; bits) - 1)) * l_blue) / 100;           \
01776           o0 ^= mask;                                                       \
01777           nz |= o0;                                                         \
01778         }                                                                   \
01779       out[0] = o0;                                                          \
01780       s_in += 4;                                                            \
01781       out ++;                                                               \
01782     }                                                                       \
01783   <span class="keywordflow">return</span> nz ? 0 : 1;                                                        \
01784 }
01785 
01786 <a class="code" href="color-conversions_8c.html#a28">KCMY_TO_GRAY_RAW_FUNC</a>(<span class="keywordtype">unsigned</span> <span class="keywordtype">char</span>, 8, 1, <a class="code" href="structraw.html">raw</a>)
01787 <a class="code" href="color-conversions_8c.html#a28">KCMY_TO_GRAY_RAW_FUNC</a>(<span class="keywordtype">unsigned</span> <span class="keywordtype">short</span>, 16, 1, <a class="code" href="structraw.html">raw</a>)
01788 <a class="code" href="color-conversions_8c.html#a5">GENERIC_COLOR_FUNC</a>(kcmy, gray_raw)
01789 <a class="code" href="color-conversions_8c.html#a28">KCMY_TO_GRAY_RAW_FUNC</a>(<span class="keywordtype">unsigned</span> <span class="keywordtype">char</span>, 8, 0, noninvert)
01790 <a class="code" href="color-conversions_8c.html#a28">KCMY_TO_GRAY_RAW_FUNC</a>(<span class="keywordtype">unsigned</span> <span class="keywordtype">short</span>, 16, 0, noninvert)
01791 
<a name="l01792"></a><a class="code" href="color-conversions_8c.html#a29">01792</a> #define <a class="code" href="color-conversions_8c.html#a29">CMYK_TO_KCMY_RAW_FUNC</a>(T, bits)                                  \
01793 <span class="keyword">static</span> <span class="keywordtype">unsigned</span>                                                         \
01794 cmyk_##bits##_to_kcmy_raw(<span class="keyword">const</span> <a class="code" href="structstp__vars.html">stp_vars_t</a> *vars,                       \
01795                           <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> *in,                      \
01796                           <span class="keywordtype">unsigned</span> <span class="keywordtype">short</span> *out)                          \
01797 {                                                                       \
01798   <span class="keywordtype">int</span> i;                                                                \
01799   <span class="keywordtype">int</span> j;                                                                \
01800   <span class="keywordtype">int</span> nz[4];                                                            \
01801   <span class="keywordtype">unsigned</span> retval = 0;                                                  \
01802   <span class="keyword">const</span> T *s_in = (<span class="keyword">const</span> T *) in;                                       \
01803   <a class="code" href="structlut__t.html">lut_t</a> *lut = (<a class="code" href="structlut__t.html">lut_t</a> *)(<a class="code" href="group__vars.html#ga20">stp_get_component_data</a>(vars, <span class="stringliteral">"Color"</span>));        \
01804                                                                         \
01805   memset(nz, 0, <span class="keyword">sizeof</span>(nz));                                            \
01806   <span class="keywordflow">for</span> (i = 0; i &lt; lut-&gt;<a class="code" href="structlut__t.html#o2">image_width</a>; i++)                                \
01807     {                                                                   \
01808       out[0] = s_in[3] * (65535 / ((1 &lt;&lt; bits) - 1));                   \
01809       out[1] = s_in[0] * (65535 / ((1 &lt;&lt; bits) - 1));                   \
01810       out[2] = s_in[1] * (65535 / ((1 &lt;&lt; bits) - 1));                   \
01811       out[3] = s_in[2] * (65535 / ((1 &lt;&lt; bits) - 1));                   \
01812       <span class="keywordflow">for</span> (j = 0; j &lt; 4; j++)                                           \
01813         nz[j] |= out[j];                                                \
01814       s_in += 4;                                                        \
01815       out += 4;                                                         \
01816     }                                                                   \
01817   <span class="keywordflow">for</span> (j = 0; j &lt; 4; j++)                                               \
01818     <span class="keywordflow">if</span> (nz[j] == 0)                                                     \
01819       retval |= (1 &lt;&lt; j);                                               \
01820   <span class="keywordflow">return</span> retval;                                                        \
01821 }
01822 
01823 <a class="code" href="color-conversions_8c.html#a29">CMYK_TO_KCMY_RAW_FUNC</a>(<span class="keywordtype">unsigned</span> <span class="keywordtype">char</span>, 8)
01824 <a class="code" href="color-conversions_8c.html#a29">CMYK_TO_KCMY_RAW_FUNC</a>(<span class="keywordtype">unsigned</span> <span class="keywordtype">short</span>, 16)
01825 <a class="code" href="color-conversions_8c.html#a5">GENERIC_COLOR_FUNC</a>(cmyk, kcmy_raw)
01826 
<a name="l01827"></a><a class="code" href="color-conversions_8c.html#a30">01827</a> #define <a class="code" href="color-conversions_8c.html#a30">KCMY_TO_KCMY_RAW_FUNC</a>(T, bits)                                  \
01828 <span class="keyword">static</span> <span class="keywordtype">unsigned</span>                                                         \
01829 kcmy_##bits##_to_kcmy_raw(<span class="keyword">const</span> <a class="code" href="structstp__vars.html">stp_vars_t</a> *vars,                       \
01830                           <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> *in,                      \
01831                           <span class="keywordtype">unsigned</span> <span class="keywordtype">short</span> *out)                          \
01832 {                                                                       \
01833   <span class="keywordtype">int</span> i;                                                                \
01834   <span class="keywordtype">int</span> j;                                                                \
01835   <span class="keywordtype">int</span> nz[4];                                                            \
01836   <span class="keywordtype">unsigned</span> retval = 0;                                                  \
01837   <span class="keyword">const</span> T *s_in = (<span class="keyword">const</span> T *) in;                                       \
01838   <a class="code" href="structlut__t.html">lut_t</a> *lut = (<a class="code" href="structlut__t.html">lut_t</a> *)(<a class="code" href="group__vars.html#ga20">stp_get_component_data</a>(vars, <span class="stringliteral">"Color"</span>));        \
01839                                                                         \
01840   memset(nz, 0, <span class="keyword">sizeof</span>(nz));                                            \
01841   <span class="keywordflow">for</span> (i = 0; i &lt; lut-&gt;<a class="code" href="structlut__t.html#o2">image_width</a>; i++)                                \
01842     {                                                                   \
01843       <span class="keywordflow">for</span> (j = 0; j &lt; 4; j++)                                           \
01844         {                                                               \
01845           out[j] = s_in[j] * (65535 / ((1 &lt;&lt; bits) - 1));               \
01846           nz[j] |= out[j];                                              \
01847         }                                                               \
01848       s_in += 4;                                                        \
01849       out += 4;                                                         \
01850     }                                                                   \
01851   <span class="keywordflow">for</span> (j = 0; j &lt; 4; j++)                                               \
01852     <span class="keywordflow">if</span> (nz[j] == 0)                                                     \
01853       retval |= (1 &lt;&lt; j);                                               \
01854   <span class="keywordflow">return</span> retval;                                                        \
01855 }
01856 
01857 <a class="code" href="color-conversions_8c.html#a30">KCMY_TO_KCMY_RAW_FUNC</a>(<span class="keywordtype">unsigned</span> <span class="keywordtype">char</span>, 8)
01858 <a class="code" href="color-conversions_8c.html#a30">KCMY_TO_KCMY_RAW_FUNC</a>(<span class="keywordtype">unsigned</span> <span class="keywordtype">short</span>, 16)
01859 <a class="code" href="color-conversions_8c.html#a5">GENERIC_COLOR_FUNC</a>(kcmy, kcmy_raw)
01860 
01861 <span class="keyword">static</span> <span class="keywordtype">unsigned</span>
<a name="l01862"></a><a class="code" href="color-conversions_8c.html#a54">01862</a> <a class="code" href="color-conversions_8c.html#a54">generic_kcmy_to_cmykrb</a>(<span class="keyword">const</span> <a class="code" href="structstp__vars.html">stp_vars_t</a> *vars, <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">short</span> *in,
01863                        <span class="keywordtype">unsigned</span> <span class="keywordtype">short</span> *out)
01864 {
01865   <a class="code" href="structlut__t.html">lut_t</a> *lut = (<a class="code" href="structlut__t.html">lut_t</a> *)(<a class="code" href="group__vars.html#ga20">stp_get_component_data</a>(vars, <span class="stringliteral">"Color"</span>));
01866   <span class="keywordtype">unsigned</span> <span class="keywordtype">short</span> nz[6];
01867   <span class="keywordtype">int</span> width = lut-&gt;<a class="code" href="structlut__t.html#o2">image_width</a>;
01868   <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">short</span> *input_cache = NULL;
01869   <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">short</span> *output_cache = NULL;
01870   <span class="keywordtype">int</span> i, j;
01871   <span class="keywordtype">unsigned</span> retval = 0;
01872 
01873   memset(nz, 0, <span class="keyword">sizeof</span>(nz));
01874 
01875   <span class="keywordflow">for</span> (i = 0; i &lt; width; i++, out += 6, in += 4)
01876     {
01877       <span class="keywordflow">if</span> (input_cache &amp;&amp; <a class="code" href="color-conversions_8c.html#a50">short_eq</a>(input_cache, in, 4))
01878         <a class="code" href="color-conversions_8c.html#a51">short_copy</a>(out, output_cache, 6);
01879       <span class="keywordflow">else</span>
01880         {
01881           <span class="keywordtype">int</span> r = <a class="code" href="color-conversions_8c.html#a4">FMIN</a>(in[2], in[3]);
01882           <span class="keywordtype">int</span> b = <a class="code" href="color-conversions_8c.html#a4">FMIN</a>(in[1], in[2]);
01883           <span class="keywordtype">int</span> k = in[0];
01884           <span class="keywordtype">int</span> excess_r = r - (b + k);
01885           <span class="keywordtype">int</span> excess_b = b - (r + k);
01886           input_cache = in;
01887           <span class="keywordflow">for</span> (j = 0; j &lt; 4; j++)
01888             {
01889               out[j] = in[j];
01890               <span class="keywordflow">if</span> (in[j])
01891                 nz[j] = 1;
01892             }
01893           <span class="keywordflow">if</span> (excess_r &gt; 0)
01894             {
01895               out[2] -= excess_r;
01896               out[3] -= excess_r;
01897               out[4] = excess_r;
01898               out[5] = 0;
01899               nz[4] = 1;
01900             }
01901           <span class="keywordflow">else</span> <span class="keywordflow">if</span> (excess_b &gt; 0)
01902             {
01903               out[1] -= excess_b;
01904               out[2] -= excess_b;
01905               out[4] = 0;
01906               out[5] = excess_b;
01907               nz[5] = 1;
01908             }
01909           <span class="keywordflow">else</span>
01910             {
01911               out[4] = 0;
01912               out[5] = 0;
01913             }
01914           output_cache = out;
01915         }
01916     }
01917   <span class="keywordflow">for</span> (j = 0; j &lt; 6; j++)
01918     <span class="keywordflow">if</span> (nz[j] == 0)
01919       retval |= (1 &lt;&lt; j);
01920   <span class="keywordflow">return</span> retval;
01921 }
01922 
01923 <span class="keyword">static</span> <span class="keywordtype">unsigned</span>
<a name="l01924"></a><a class="code" href="color-conversions_8c.html#a55">01924</a> <a class="code" href="color-conversions_8c.html#a55">raw_kcmy_to_cmykrb</a>(<span class="keyword">const</span> <a class="code" href="structstp__vars.html">stp_vars_t</a> *vars, <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">short</span> *in,
01925                    <span class="keywordtype">unsigned</span> <span class="keywordtype">short</span> *out)
01926 {
01927   <a class="code" href="structlut__t.html">lut_t</a> *lut = (<a class="code" href="structlut__t.html">lut_t</a> *)(<a class="code" href="group__vars.html#ga20">stp_get_component_data</a>(vars, <span class="stringliteral">"Color"</span>));
01928   <span class="keywordtype">unsigned</span> <span class="keywordtype">short</span> nz[6];
01929   <span class="keywordtype">int</span> width = lut-&gt;<a class="code" href="structlut__t.html#o2">image_width</a>;
01930   <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">short</span> *input_cache = NULL;
01931   <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">short</span> *output_cache = NULL;
01932   <span class="keywordtype">int</span> i, j;
01933   <span class="keywordtype">unsigned</span> retval = 0;
01934 
01935   memset(nz, 0, <span class="keyword">sizeof</span>(nz));
01936 
01937   <span class="keywordflow">for</span> (i = 0; i &lt; width; i++, out += 6, in += 4)
01938     {
01939       <span class="keywordflow">if</span> (input_cache &amp;&amp; <a class="code" href="color-conversions_8c.html#a50">short_eq</a>(input_cache, in, 4))
01940         <a class="code" href="color-conversions_8c.html#a51">short_copy</a>(out, output_cache, 6);
01941       <span class="keywordflow">else</span>
01942         {
01943           <span class="keywordtype">int</span> r = <a class="code" href="color-conversions_8c.html#a4">FMIN</a>(in[2], in[3]);
01944           <span class="keywordtype">int</span> b = <a class="code" href="color-conversions_8c.html#a4">FMIN</a>(in[1], in[2]);
01945           <span class="keywordtype">int</span> k = in[0];
01946           <span class="keywordtype">int</span> excess_r = r - (b + k);
01947           <span class="keywordtype">int</span> excess_b = b - (r + k);
01948           input_cache = in;
01949           <span class="keywordflow">for</span> (j = 0; j &lt; 4; j++)
01950             {
01951               out[j] = in[j];
01952               <span class="keywordflow">if</span> (in[j])
01953                 nz[j] = 1;
01954             }
01955           <span class="keywordflow">if</span> (excess_r &gt; 0)
01956             {
01957               out[2] -= excess_r;
01958               out[3] -= excess_r;
01959               out[4] = excess_r;
01960               out[5] = 0;
01961               nz[4] = 1;
01962             }
01963           <span class="keywordflow">else</span> <span class="keywordflow">if</span> (excess_b &gt; 0)
01964             {
01965               out[1] -= excess_b;
01966               out[2] -= excess_b;
01967               out[4] = 0;
01968               out[5] = excess_b;
01969               nz[5] = 1;
01970             }
01971           <span class="keywordflow">else</span>
01972             {
01973               out[4] = 0;
01974               out[5] = 0;
01975             }
01976           output_cache = out;
01977         }
01978     }
01979   <span class="keywordflow">for</span> (j = 0; j &lt; 6; j++)
01980     <span class="keywordflow">if</span> (nz[j] == 0)
01981       retval |= (1 &lt;&lt; j);
01982   <span class="keywordflow">return</span> retval;
01983 }
01984 
<a name="l01985"></a><a class="code" href="color-conversions_8c.html#a31">01985</a> <span class="preprocessor">#define COLOR_TO_CMYKRB_FUNC(name, name2, name3, name4, bits)               \</span>
01986 <span class="preprocessor">static unsigned                                                             \</span>
01987 <span class="preprocessor">name##_##bits##_to_##name2(const stp_vars_t *vars, const unsigned char *in, \</span>
01988 <span class="preprocessor">                          unsigned short *out)                              \</span>
01989 <span class="preprocessor">{                                                                           \</span>
01990 <span class="preprocessor">  lut_t *lut = (lut_t *)(stp_get_component_data(vars, "Color"));            \</span>
01991 <span class="preprocessor">  size_t real_steps = lut-&gt;steps;                                           \</span>
01992 <span class="preprocessor">  unsigned status;                                                          \</span>
01993 <span class="preprocessor">  if (!lut-&gt;cmyk_tmp)                                                       \</span>
01994 <span class="preprocessor">    lut-&gt;cmyk_tmp = stp_malloc(4 * 2 * lut-&gt;image_width);                   \</span>
01995 <span class="preprocessor">  name##_##bits##_to_##name3(vars, in, lut-&gt;cmyk_tmp);                      \</span>
01996 <span class="preprocessor">  lut-&gt;steps = 65536;                                                       \</span>
01997 <span class="preprocessor">  status = name4##_kcmy_to_cmykrb(vars, lut-&gt;cmyk_tmp, out);                \</span>
01998 <span class="preprocessor">  lut-&gt;steps = real_steps;                                                  \</span>
01999 <span class="preprocessor">  return status;                                                            \</span>
02000 <span class="preprocessor">}</span>
02001 <span class="preprocessor"></span>
02002 <a class="code" href="color-conversions_8c.html#a31">COLOR_TO_CMYKRB_FUNC</a>(gray, cmykrb, kcmy, generic, 8)
02003 <a class="code" href="color-conversions_8c.html#a31">COLOR_TO_CMYKRB_FUNC</a>(gray, cmykrb, kcmy, generic, 16)
02004 <a class="code" href="color-conversions_8c.html#a5">GENERIC_COLOR_FUNC</a>(gray, cmykrb)
02005 <a class="code" href="color-conversions_8c.html#a31">COLOR_TO_CMYKRB_FUNC</a>(gray, cmykrb_threshold, kcmy_threshold, generic, 8)
02006 <a class="code" href="color-conversions_8c.html#a31">COLOR_TO_CMYKRB_FUNC</a>(gray, cmykrb_threshold, kcmy_threshold, generic, 16)
02007 <a class="code" href="color-conversions_8c.html#a5">GENERIC_COLOR_FUNC</a>(gray, cmykrb_threshold)
02008 <a class="code" href="color-conversions_8c.html#a31">COLOR_TO_CMYKRB_FUNC</a>(gray, cmykrb_raw, kcmy_raw, <a class="code" href="structraw.html">raw</a>, 8)
02009 <a class="code" href="color-conversions_8c.html#a31">COLOR_TO_CMYKRB_FUNC</a>(gray, cmykrb_raw, kcmy_raw, <a class="code" href="structraw.html">raw</a>, 16)
02010 <a class="code" href="color-conversions_8c.html#a5">GENERIC_COLOR_FUNC</a>(gray, cmykrb_raw)
02011 
02012 <a class="code" href="color-conversions_8c.html#a31">COLOR_TO_CMYKRB_FUNC</a>(color, cmykrb, kcmy, generic, 8)
02013 <a class="code" href="color-conversions_8c.html#a31">COLOR_TO_CMYKRB_FUNC</a>(color, cmykrb, kcmy, generic, 16)
02014 <a class="code" href="color-conversions_8c.html#a5">GENERIC_COLOR_FUNC</a>(color, cmykrb)
02015 <a class="code" href="color-conversions_8c.html#a31">COLOR_TO_CMYKRB_FUNC</a>(color, cmykrb_threshold, kcmy_threshold, generic, 8)
02016 <a class="code" href="color-conversions_8c.html#a31">COLOR_TO_CMYKRB_FUNC</a>(color, cmykrb_threshold, kcmy_threshold, generic, 16)
02017 <a class="code" href="color-conversions_8c.html#a5">GENERIC_COLOR_FUNC</a>(color, cmykrb_threshold)
02018 <a class="code" href="color-conversions_8c.html#a31">COLOR_TO_CMYKRB_FUNC</a>(color, cmykrb_fast, kcmy, generic, 8)
02019 <a class="code" href="color-conversions_8c.html#a31">COLOR_TO_CMYKRB_FUNC</a>(color, cmykrb_fast, kcmy, generic, 16)
02020 <a class="code" href="color-conversions_8c.html#a5">GENERIC_COLOR_FUNC</a>(color, cmykrb_fast)
02021 <a class="code" href="color-conversions_8c.html#a31">COLOR_TO_CMYKRB_FUNC</a>(color, cmykrb_raw, kcmy_raw, <a class="code" href="structraw.html">raw</a>, 8)
02022 <a class="code" href="color-conversions_8c.html#a31">COLOR_TO_CMYKRB_FUNC</a>(color, cmykrb_raw, kcmy_raw, <a class="code" href="structraw.html">raw</a>, 16)
02023 <a class="code" href="color-conversions_8c.html#a5">GENERIC_COLOR_FUNC</a>(color, cmykrb_raw)
02024 
02025 <a class="code" href="color-conversions_8c.html#a31">COLOR_TO_CMYKRB_FUNC</a>(cmyk, cmykrb, kcmy, generic, 8)
02026 <a class="code" href="color-conversions_8c.html#a31">COLOR_TO_CMYKRB_FUNC</a>(cmyk, cmykrb, kcmy, generic, 16)
02027 <a class="code" href="color-conversions_8c.html#a5">GENERIC_COLOR_FUNC</a>(cmyk, cmykrb)
02028 <a class="code" href="color-conversions_8c.html#a31">COLOR_TO_CMYKRB_FUNC</a>(cmyk, cmykrb_threshold, kcmy_threshold, generic, 8)
02029 <a class="code" href="color-conversions_8c.html#a31">COLOR_TO_CMYKRB_FUNC</a>(cmyk, cmykrb_threshold, kcmy_threshold, generic, 16)
02030 <a class="code" href="color-conversions_8c.html#a5">GENERIC_COLOR_FUNC</a>(cmyk, cmykrb_threshold)
02031 <a class="code" href="color-conversions_8c.html#a31">COLOR_TO_CMYKRB_FUNC</a>(cmyk, cmykrb_fast, kcmy, generic, 8)
02032 <a class="code" href="color-conversions_8c.html#a31">COLOR_TO_CMYKRB_FUNC</a>(cmyk, cmykrb_fast, kcmy, generic, 16)
02033 <a class="code" href="color-conversions_8c.html#a5">GENERIC_COLOR_FUNC</a>(cmyk, cmykrb_fast)
02034 <a class="code" href="color-conversions_8c.html#a31">COLOR_TO_CMYKRB_FUNC</a>(cmyk, cmykrb_raw, kcmy_raw, <a class="code" href="structraw.html">raw</a>, 8)
02035 <a class="code" href="color-conversions_8c.html#a31">COLOR_TO_CMYKRB_FUNC</a>(cmyk, cmykrb_raw, kcmy_raw, <a class="code" href="structraw.html">raw</a>, 16)
02036 <a class="code" href="color-conversions_8c.html#a5">GENERIC_COLOR_FUNC</a>(cmyk, cmykrb_raw)
02037 
02038 <a class="code" href="color-conversions_8c.html#a31">COLOR_TO_CMYKRB_FUNC</a>(kcmy, cmykrb, kcmy, generic, 8)
02039 <a class="code" href="color-conversions_8c.html#a31">COLOR_TO_CMYKRB_FUNC</a>(kcmy, cmykrb, kcmy, generic, 16)
02040 <a class="code" href="color-conversions_8c.html#a5">GENERIC_COLOR_FUNC</a>(kcmy, cmykrb)
02041 <a class="code" href="color-conversions_8c.html#a31">COLOR_TO_CMYKRB_FUNC</a>(kcmy, cmykrb_threshold, kcmy_threshold, generic, 8)
02042 <a class="code" href="color-conversions_8c.html#a31">COLOR_TO_CMYKRB_FUNC</a>(kcmy, cmykrb_threshold, kcmy_threshold, generic, 16)
02043 <a class="code" href="color-conversions_8c.html#a5">GENERIC_COLOR_FUNC</a>(kcmy, cmykrb_threshold)
02044 <a class="code" href="color-conversions_8c.html#a31">COLOR_TO_CMYKRB_FUNC</a>(kcmy, cmykrb_fast, kcmy, generic, 8)
02045 <a class="code" href="color-conversions_8c.html#a31">COLOR_TO_CMYKRB_FUNC</a>(kcmy, cmykrb_fast, kcmy, generic, 16)
02046 <a class="code" href="color-conversions_8c.html#a5">GENERIC_COLOR_FUNC</a>(kcmy, cmykrb_fast)
02047 <a class="code" href="color-conversions_8c.html#a31">COLOR_TO_CMYKRB_FUNC</a>(kcmy, cmykrb_raw, kcmy_raw, <a class="code" href="structraw.html">raw</a>, 8)
02048 <a class="code" href="color-conversions_8c.html#a31">COLOR_TO_CMYKRB_FUNC</a>(kcmy, cmykrb_raw, kcmy_raw, <a class="code" href="structraw.html">raw</a>, 16)
02049 <a class="code" href="color-conversions_8c.html#a5">GENERIC_COLOR_FUNC</a>(kcmy, cmykrb_raw)
02050 
<a name="l02051"></a><a class="code" href="color-conversions_8c.html#a32">02051</a> #define <a class="code" href="color-conversions_8c.html#a32">DESATURATED_FUNC</a>(name, name2, bits)                                \
02052 <span class="keyword">static</span> <span class="keywordtype">unsigned</span>                                                            \
02053 name##<a class="code" href="group__intl__internal.html#ga5">_</a>##bits##_to_##name2##_desaturated(<span class="keyword">const</span> <a class="code" href="structstp__vars.html">stp_vars_t</a> *vars,           \
02054                                          <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> *in,          \
02055                                          <span class="keywordtype">unsigned</span> <span class="keywordtype">short</span> *out)              \
02056 {                                                                          \
02057   <a class="code" href="structlut__t.html">lut_t</a> *lut = (<a class="code" href="structlut__t.html">lut_t</a> *)(<a class="code" href="group__vars.html#ga20">stp_get_component_data</a>(vars, <span class="stringliteral">"Color"</span>));           \
02058   size_t real_steps = lut-&gt;<a class="code" href="structlut__t.html#o0">steps</a>;                                          \
02059   <span class="keywordtype">unsigned</span> status;                                                         \
02060   <span class="keywordflow">if</span> (!lut-&gt;<a class="code" href="structlut__t.html#o26">gray_tmp</a>)                                                      \
02061     lut-&gt;<a class="code" href="structlut__t.html#o26">gray_tmp</a> = <a class="code" href="group__util.html#ga28">stp_malloc</a>(2 * lut-&gt;<a class="code" href="structlut__t.html#o2">image_width</a>);                      \
02062   name##<a class="code" href="group__intl__internal.html#ga5">_</a>##bits##_to_gray_noninvert(vars, in, lut-&gt;<a class="code" href="structlut__t.html#o26">gray_tmp</a>);              \
02063   lut-&gt;<a class="code" href="structlut__t.html#o0">steps</a> = 65536;                                                      \
02064   status = gray_16_to_##name2(vars, (<span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> *) lut-&gt;<a class="code" href="structlut__t.html#o26">gray_tmp</a>, out); \
02065   lut-&gt;<a class="code" href="structlut__t.html#o0">steps</a> = real_steps;                                                 \
02066   <span class="keywordflow">return</span> status;                                                           \
02067 }
02068 
02069 <a class="code" href="color-conversions_8c.html#a32">DESATURATED_FUNC</a>(color, color, 8)
02070 <a class="code" href="color-conversions_8c.html#a32">DESATURATED_FUNC</a>(color, color, 16)
02071 <a class="code" href="color-conversions_8c.html#a5">GENERIC_COLOR_FUNC</a>(color, color_desaturated)
02072 <a class="code" href="color-conversions_8c.html#a32">DESATURATED_FUNC</a>(color, kcmy, 8)
02073 <a class="code" href="color-conversions_8c.html#a32">DESATURATED_FUNC</a>(color, kcmy, 16)
02074 <a class="code" href="color-conversions_8c.html#a5">GENERIC_COLOR_FUNC</a>(color, kcmy_desaturated)
02075 <a class="code" href="color-conversions_8c.html#a32">DESATURATED_FUNC</a>(color, cmykrb, 8)
02076 <a class="code" href="color-conversions_8c.html#a32">DESATURATED_FUNC</a>(color, cmykrb, 16)
02077 <a class="code" href="color-conversions_8c.html#a5">GENERIC_COLOR_FUNC</a>(color, cmykrb_desaturated)
02078 
02079 <a class="code" href="color-conversions_8c.html#a32">DESATURATED_FUNC</a>(cmyk, color, 8)
02080 <a class="code" href="color-conversions_8c.html#a32">DESATURATED_FUNC</a>(cmyk, color, 16)
02081 <a class="code" href="color-conversions_8c.html#a5">GENERIC_COLOR_FUNC</a>(cmyk, color_desaturated)
02082 <a class="code" href="color-conversions_8c.html#a32">DESATURATED_FUNC</a>(cmyk, kcmy, 8)
02083 <a class="code" href="color-conversions_8c.html#a32">DESATURATED_FUNC</a>(cmyk, kcmy, 16)
02084 <a class="code" href="color-conversions_8c.html#a5">GENERIC_COLOR_FUNC</a>(cmyk, kcmy_desaturated)
02085 <a class="code" href="color-conversions_8c.html#a32">DESATURATED_FUNC</a>(cmyk, cmykrb, 8)
02086 <a class="code" href="color-conversions_8c.html#a32">DESATURATED_FUNC</a>(cmyk, cmykrb, 16)
02087 <a class="code" href="color-conversions_8c.html#a5">GENERIC_COLOR_FUNC</a>(cmyk, cmykrb_desaturated)
02088 
02089 <a class="code" href="color-conversions_8c.html#a32">DESATURATED_FUNC</a>(kcmy, color, 8)
02090 <a class="code" href="color-conversions_8c.html#a32">DESATURATED_FUNC</a>(kcmy, color, 16)
02091 <a class="code" href="color-conversions_8c.html#a5">GENERIC_COLOR_FUNC</a>(kcmy, color_desaturated)
02092 <a class="code" href="color-conversions_8c.html#a32">DESATURATED_FUNC</a>(kcmy, kcmy, 8)
02093 <a class="code" href="color-conversions_8c.html#a32">DESATURATED_FUNC</a>(kcmy, kcmy, 16)
02094 <a class="code" href="color-conversions_8c.html#a5">GENERIC_COLOR_FUNC</a>(kcmy, kcmy_desaturated)
02095 <a class="code" href="color-conversions_8c.html#a32">DESATURATED_FUNC</a>(kcmy, cmykrb, 8)
02096 <a class="code" href="color-conversions_8c.html#a32">DESATURATED_FUNC</a>(kcmy, cmykrb, 16)
02097 <a class="code" href="color-conversions_8c.html#a5">GENERIC_COLOR_FUNC</a>(kcmy, cmykrb_desaturated)
02098 
<a name="l02099"></a><a class="code" href="color-conversions_8c.html#a33">02099</a> #define <a class="code" href="color-conversions_8c.html#a33">CMYK_DISPATCH</a>(name)                                             \
02100 <span class="keyword">static</span> <span class="keywordtype">unsigned</span>                                                         \
02101 CMYK_to_##name(<span class="keyword">const</span> <a class="code" href="structstp__vars.html">stp_vars_t</a> *vars, <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> *in,         \
02102                <span class="keywordtype">unsigned</span> <span class="keywordtype">short</span> *out)                                     \
02103 {                                                                       \
02104   <a class="code" href="structlut__t.html">lut_t</a> *lut = (<a class="code" href="structlut__t.html">lut_t</a> *)(<a class="code" href="group__vars.html#ga20">stp_get_component_data</a>(vars, <span class="stringliteral">"Color"</span>));        \
02105   <span class="keywordflow">if</span> (lut-&gt;<a class="code" href="structlut__t.html#o7">input_color_description</a>-&gt;<a class="code" href="structcolor__description__t.html#o3">color_id</a> == <a class="code" href="color-conversion_8h.html#a53a42">COLOR_ID_CMYK</a>)          \
02106     <span class="keywordflow">return</span> cmyk_to_##name(vars, in, out);                               \
02107   <span class="keywordflow">else</span> <span class="keywordflow">if</span> (lut-&gt;<a class="code" href="structlut__t.html#o7">input_color_description</a>-&gt;<a class="code" href="structcolor__description__t.html#o3">color_id</a> == <a class="code" href="color-conversion_8h.html#a53a43">COLOR_ID_KCMY</a>)     \
02108     <span class="keywordflow">return</span> kcmy_to_##name(vars, in, out);                               \
02109   <span class="keywordflow">else</span>                                                                  \
02110     {                                                                   \
02111       <a class="code" href="print-util_8c.html#a18">stp_eprintf</a>(vars, <span class="stringliteral">"Bad dispatch to CMYK_to_%s: %d\n"</span>, #name,      \
02112                   lut-&gt;<a class="code" href="structlut__t.html#o7">input_color_description</a>-&gt;<a class="code" href="structcolor__description__t.html#o3">color_id</a>);              \
02113       <span class="keywordflow">return</span> 0;                                                         \
02114     }                                                                   \
02115 }
02116 
02117 <a class="code" href="color-conversions_8c.html#a33">CMYK_DISPATCH</a>(cmykrb)
02118 <a class="code" href="color-conversions_8c.html#a33">CMYK_DISPATCH</a>(cmykrb_raw)
02119 <a class="code" href="color-conversions_8c.html#a33">CMYK_DISPATCH</a>(cmykrb_fast)
02120 <a class="code" href="color-conversions_8c.html#a33">CMYK_DISPATCH</a>(cmykrb_threshold)
02121 <a class="code" href="color-conversions_8c.html#a33">CMYK_DISPATCH</a>(cmykrb_desaturated)
02122 <a class="code" href="color-conversions_8c.html#a33">CMYK_DISPATCH</a>(color)
02123 <a class="code" href="color-conversions_8c.html#a33">CMYK_DISPATCH</a>(color_raw)
02124 <a class="code" href="color-conversions_8c.html#a33">CMYK_DISPATCH</a>(color_fast)
02125 <a class="code" href="color-conversions_8c.html#a33">CMYK_DISPATCH</a>(color_threshold)
02126 <a class="code" href="color-conversions_8c.html#a33">CMYK_DISPATCH</a>(color_desaturated)
02127 <a class="code" href="color-conversions_8c.html#a33">CMYK_DISPATCH</a>(kcmy)
02128 <a class="code" href="color-conversions_8c.html#a33">CMYK_DISPATCH</a>(kcmy_raw)
02129 <a class="code" href="color-conversions_8c.html#a33">CMYK_DISPATCH</a>(kcmy_threshold)
02130 <a class="code" href="color-conversions_8c.html#a33">CMYK_DISPATCH</a>(kcmy_desaturated)
02131 <a class="code" href="color-conversions_8c.html#a33">CMYK_DISPATCH</a>(gray)
02132 <a class="code" href="color-conversions_8c.html#a33">CMYK_DISPATCH</a>(gray_raw)
02133 <a class="code" href="color-conversions_8c.html#a33">CMYK_DISPATCH</a>(gray_threshold)
02134 
<a name="l02135"></a><a class="code" href="color-conversions_8c.html#a34">02135</a> #define <a class="code" href="color-conversions_8c.html#a34">RAW_TO_RAW_THRESHOLD_FUNC</a>(T, name)                              \
02136 <span class="keyword">static</span> <span class="keywordtype">unsigned</span>                                                         \
02137 name##_to_raw_threshold(<span class="keyword">const</span> <a class="code" href="structstp__vars.html">stp_vars_t</a> *vars,                         \
02138                         <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> *in,                        \
02139                         <span class="keywordtype">unsigned</span> <span class="keywordtype">short</span> *out)                            \
02140 {                                                                       \
02141   <span class="keywordtype">int</span> i;                                                                \
02142   <span class="keywordtype">int</span> j;                                                                \
02143   <a class="code" href="structlut__t.html">lut_t</a> *lut = (<a class="code" href="structlut__t.html">lut_t</a> *)(<a class="code" href="group__vars.html#ga20">stp_get_component_data</a>(vars, <span class="stringliteral">"Color"</span>));        \
02144   <span class="keywordtype">unsigned</span> nz[<a class="code" href="group__image.html#ga8">STP_CHANNEL_LIMIT</a>];                                       \
02145   <span class="keywordtype">unsigned</span> z = (1 &lt;&lt; lut-&gt;<a class="code" href="structlut__t.html#o4">out_channels</a>) - 1;                            \
02146   <span class="keyword">const</span> T *s_in = (<span class="keyword">const</span> T *) in;                                       \
02147   <span class="keywordtype">unsigned</span> desired_high_bit = 0;                                        \
02148   <span class="keywordtype">unsigned</span> high_bit = 1 &lt;&lt; ((<span class="keyword">sizeof</span>(T) * 8) - 1);                       \
02149   <span class="keywordtype">int</span> width = lut-&gt;<a class="code" href="structlut__t.html#o2">image_width</a>;                                         \
02150   memset(out, 0, width * lut-&gt;<a class="code" href="structlut__t.html#o4">out_channels</a> * <span class="keyword">sizeof</span>(<span class="keywordtype">unsigned</span> <span class="keywordtype">short</span>));   \
02151   <span class="keywordflow">if</span> (!lut-&gt;<a class="code" href="structlut__t.html#o6">invert_output</a>)                                              \
02152     desired_high_bit = high_bit;                                        \
02153   <span class="keywordflow">for</span> (i = 0; i &lt; lut-&gt;<a class="code" href="structlut__t.html#o4">out_channels</a>; i++)                               \
02154     nz[i] = z &amp; ~(1 &lt;&lt; i);                                              \
02155                                                                         \
02156   <span class="keywordflow">for</span> (i = 0; i &lt; width; i++)                                           \
02157     {                                                                   \
02158       <span class="keywordflow">for</span> (j = 0; j &lt; lut-&gt;<a class="code" href="structlut__t.html#o4">out_channels</a>; j++)                           \
02159         {                                                               \
02160           <span class="keywordflow">if</span> ((*s_in++ &amp; high_bit) == desired_high_bit)                 \
02161             {                                                           \
02162               z &amp;= nz[j];                                               \
02163               *out = 65535;                                             \
02164             }                                                           \
02165           out++;                                                        \
02166         }                                                               \
02167     }                                                                   \
02168   <span class="keywordflow">return</span> z;                                                             \
02169 }
02170 
02171 <a class="code" href="color-conversions_8c.html#a34">RAW_TO_RAW_THRESHOLD_FUNC</a>(<span class="keywordtype">unsigned</span> <span class="keywordtype">char</span>, raw_8)
02172 <a class="code" href="color-conversions_8c.html#a34">RAW_TO_RAW_THRESHOLD_FUNC</a>(<span class="keywordtype">unsigned</span> <span class="keywordtype">short</span>, raw_16)
02173 <a class="code" href="color-conversions_8c.html#a5">GENERIC_COLOR_FUNC</a>(<a class="code" href="structraw.html">raw</a>, raw_threshold)
02174 
<a name="l02175"></a><a class="code" href="color-conversions_8c.html#a35">02175</a> #define <a class="code" href="color-conversions_8c.html#a35">RAW_TO_RAW_FUNC</a>(T, size)                                            \
02176 <span class="keyword">static</span> <span class="keywordtype">unsigned</span>                                                             \
02177 raw_##size##_to_raw(<span class="keyword">const</span> <a class="code" href="structstp__vars.html">stp_vars_t</a> *vars,                                 \
02178                     <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> *in,                                \
02179                     <span class="keywordtype">unsigned</span> <span class="keywordtype">short</span> *out)                                    \
02180 {                                                                           \
02181   <span class="keywordtype">int</span> i;                                                                    \
02182   <span class="keywordtype">unsigned</span> retval = 0;                                                      \
02183   <span class="keywordtype">int</span> j;                                                                    \
02184   <span class="keywordtype">int</span> nz[<a class="code" href="group__image.html#ga8">STP_CHANNEL_LIMIT</a>];                                                \
02185   <span class="keyword">const</span> T *s_in = (<span class="keyword">const</span> T *) in;                                           \
02186   <a class="code" href="structlut__t.html">lut_t</a> *lut = (<a class="code" href="structlut__t.html">lut_t</a> *)(<a class="code" href="group__vars.html#ga20">stp_get_component_data</a>(vars, <span class="stringliteral">"Color"</span>));            \
02187   <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">short</span> *maps[<a class="code" href="group__image.html#ga8">STP_CHANNEL_LIMIT</a>];                            \
02188   <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">short</span> *user;                                               \
02189                                                                             \
02190   <span class="keywordflow">for</span> (i = 0; i &lt; lut-&gt;<a class="code" href="structlut__t.html#o4">out_channels</a>; i++)                                   \
02191     {                                                                       \
02192       <a class="code" href="group__curve.html#ga51">stp_curve_resample</a>(lut-&gt;<a class="code" href="structlut__t.html#o13">channel_curves</a>[i].<a class="code" href="structstp__cached__curve__t.html#o0">curve</a>, 65536);              \
02193       maps[i] = <a class="code" href="curve-cache_8c.html#a7">stp_curve_cache_get_ushort_data</a>(&amp;(lut-&gt;<a class="code" href="structlut__t.html#o13">channel_curves</a>[i])); \
02194     }                                                                       \
02195   <a class="code" href="group__curve.html#ga51">stp_curve_resample</a>(lut-&gt;<a class="code" href="structlut__t.html#o12">user_color_correction</a>.<a class="code" href="structstp__cached__curve__t.html#o0">curve</a>, 1 &lt;&lt; size);          \
02196   user = <a class="code" href="curve-cache_8c.html#a7">stp_curve_cache_get_ushort_data</a>(&amp;(lut-&gt;<a class="code" href="structlut__t.html#o12">user_color_correction</a>));    \
02197                                                                             \
02198   memset(nz, 0, <span class="keyword">sizeof</span>(nz));                                                \
02199                                                                             \
02200   <span class="keywordflow">for</span> (i = 0; i &lt; lut-&gt;<a class="code" href="structlut__t.html#o2">image_width</a>; i++, out += lut-&gt;<a class="code" href="structlut__t.html#o4">out_channels</a>)          \
02201     {                                                                       \
02202       <span class="keywordflow">for</span> (j = 0; j &lt; lut-&gt;<a class="code" href="structlut__t.html#o4">out_channels</a>; j++)                               \
02203         {                                                                   \
02204           <span class="keywordtype">int</span> inval = *s_in++;                                              \
02205           nz[j] |= inval;                                                   \
02206           out[j] = maps[j][user[inval]];                                    \
02207         }                                                                   \
02208     }                                                                       \
02209   <span class="keywordflow">for</span> (j = 0; j &lt; lut-&gt;<a class="code" href="structlut__t.html#o4">out_channels</a>; j++)                                   \
02210     <span class="keywordflow">if</span> (nz[j] == 0)                                                         \
02211       retval |= (1 &lt;&lt; j);                                                   \
02212   <span class="keywordflow">return</span> retval;                                                            \
02213 }
02214 
02215 <a class="code" href="color-conversions_8c.html#a35">RAW_TO_RAW_FUNC</a>(<span class="keywordtype">unsigned</span> <span class="keywordtype">char</span>, 8)
02216 <a class="code" href="color-conversions_8c.html#a35">RAW_TO_RAW_FUNC</a>(<span class="keywordtype">unsigned</span> <span class="keywordtype">short</span>, 16)
02217 <a class="code" href="color-conversions_8c.html#a5">GENERIC_COLOR_FUNC</a>(<a class="code" href="structraw.html">raw</a>, <a class="code" href="structraw.html">raw</a>)
02218 
02219 
<a name="l02220"></a><a class="code" href="color-conversions_8c.html#a36">02220</a> #define <a class="code" href="color-conversions_8c.html#a36">RAW_TO_RAW_RAW_FUNC</a>(T, bits)                                    \
02221 <span class="keyword">static</span> <span class="keywordtype">unsigned</span>                                                         \
02222 raw_##bits##_to_raw_raw(<span class="keyword">const</span> <a class="code" href="structstp__vars.html">stp_vars_t</a> *vars,                         \
02223                         <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> *in,                        \
02224                         <span class="keywordtype">unsigned</span> <span class="keywordtype">short</span> *out)                            \
02225 {                                                                       \
02226   <span class="keywordtype">int</span> i;                                                                \
02227   <span class="keywordtype">int</span> j;                                                                \
02228   <span class="keywordtype">int</span> nz[<a class="code" href="group__image.html#ga8">STP_CHANNEL_LIMIT</a>];                                            \
02229   <span class="keywordtype">unsigned</span> retval = 0;                                                  \
02230   <span class="keyword">const</span> T *s_in = (<span class="keyword">const</span> T *) in;                                       \
02231   <a class="code" href="structlut__t.html">lut_t</a> *lut = (<a class="code" href="structlut__t.html">lut_t</a> *)(<a class="code" href="group__vars.html#ga20">stp_get_component_data</a>(vars, <span class="stringliteral">"Color"</span>));        \
02232   <span class="keywordtype">int</span> colors = lut-&gt;<a class="code" href="structlut__t.html#o3">in_channels</a>;                                        \
02233                                                                         \
02234   memset(nz, 0, <span class="keyword">sizeof</span>(nz));                                            \
02235   <span class="keywordflow">for</span> (i = 0; i &lt; lut-&gt;<a class="code" href="structlut__t.html#o2">image_width</a>; i++)                                \
02236     {                                                                   \
02237       <span class="keywordflow">for</span> (j = 0; j &lt; colors; j++)                                      \
02238         {                                                               \
02239           nz[j] |= s_in[j];                                             \
02240           out[j] = s_in[j] * (65535 / ((1 &lt;&lt; bits) - 1));               \
02241         }                                                               \
02242       s_in += colors;                                                   \
02243       out += colors;                                                    \
02244     }                                                                   \
02245   <span class="keywordflow">for</span> (j = 0; j &lt; colors; j++)                                          \
02246     <span class="keywordflow">if</span> (nz[j] == 0)                                                     \
02247       retval |= (1 &lt;&lt; j);                                               \
02248   <span class="keywordflow">return</span> retval;                                                        \
02249 }
02250 
02251 <a class="code" href="color-conversions_8c.html#a36">RAW_TO_RAW_RAW_FUNC</a>(<span class="keywordtype">unsigned</span> <span class="keywordtype">char</span>, 8)
02252 <a class="code" href="color-conversions_8c.html#a36">RAW_TO_RAW_RAW_FUNC</a>(<span class="keywordtype">unsigned</span> <span class="keywordtype">short</span>, 16)
02253 <a class="code" href="color-conversions_8c.html#a5">GENERIC_COLOR_FUNC</a>(<a class="code" href="structraw.html">raw</a>, raw_raw)
02254 
02255 
<a name="l02256"></a><a class="code" href="color-conversions_8c.html#a37">02256</a> #define <a class="code" href="color-conversions_8c.html#a37">CONVERSION_FUNCTION_WITH_FAST</a>(from, to, from2)          \
02257 <span class="keyword">static</span> <span class="keywordtype">unsigned</span>                                                 \
02258 generic_##from##_to_##to(<span class="keyword">const</span> <a class="code" href="structstp__vars.html">stp_vars_t</a> *v,                   \
02259                          <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> *in,               \
02260                          <span class="keywordtype">unsigned</span> <span class="keywordtype">short</span> *out)                   \
02261 {                                                               \
02262   <a class="code" href="structlut__t.html">lut_t</a> *lut = (<a class="code" href="structlut__t.html">lut_t</a> *)(<a class="code" href="group__vars.html#ga20">stp_get_component_data</a>(v, <span class="stringliteral">"Color"</span>));   \
02263   <span class="keywordflow">switch</span> (lut-&gt;<a class="code" href="structlut__t.html#o9">color_correction</a>-&gt;<a class="code" href="structcolor__correction__t.html#o2">correction</a>)                    \
02264     {                                                           \
02265     <span class="keywordflow">case</span> <a class="code" href="color-conversion_8h.html#a51a27">COLOR_CORRECTION_UNCORRECTED</a>:                          \
02266       <span class="keywordflow">return</span> from2##_to_##to##_fast(v, in, out);                \
02267     <span class="keywordflow">case</span> <a class="code" href="color-conversion_8h.html#a51a29">COLOR_CORRECTION_ACCURATE</a>:                             \
02268     <span class="keywordflow">case</span> <a class="code" href="color-conversion_8h.html#a51a28">COLOR_CORRECTION_BRIGHT</a>:                               \
02269       <span class="keywordflow">return</span> from2##_to_##to(v, in, out);                       \
02270     <span class="keywordflow">case</span> <a class="code" href="color-conversion_8h.html#a51a31">COLOR_CORRECTION_DESATURATED</a>:                          \
02271       <span class="keywordflow">return</span> from2##_to_##to##_desaturated(v, in, out);         \
02272     <span class="keywordflow">case</span> <a class="code" href="color-conversion_8h.html#a51a30">COLOR_CORRECTION_THRESHOLD</a>:                            \
02273     <span class="keywordflow">case</span> <a class="code" href="color-conversion_8h.html#a51a34">COLOR_CORRECTION_PREDITHERED</a>:                          \
02274       <span class="keywordflow">return</span> from2##_to_##to##_threshold(v, in, out);           \
02275     <span class="keywordflow">case</span> <a class="code" href="color-conversion_8h.html#a51a32">COLOR_CORRECTION_DENSITY</a>:                              \
02276     <span class="keywordflow">case</span> <a class="code" href="color-conversion_8h.html#a51a33">COLOR_CORRECTION_RAW</a>:                                  \
02277       <span class="keywordflow">return</span> from2##_to_##to##_raw(v, in, out);                 \
02278     <span class="keywordflow">default</span>:                                                    \
02279       <span class="keywordflow">return</span> (<span class="keywordtype">unsigned</span>) -1;                                     \
02280     }                                                           \
02281 }
02282 
<a name="l02283"></a><a class="code" href="color-conversions_8c.html#a38">02283</a> <span class="preprocessor">#define CONVERSION_FUNCTION_WITHOUT_FAST(from, to, from2)       \</span>
02284 <span class="preprocessor">static unsigned                                                 \</span>
02285 <span class="preprocessor">generic_##from##_to_##to(const stp_vars_t *v,                   \</span>
02286 <span class="preprocessor">                         const unsigned char *in,               \</span>
02287 <span class="preprocessor">                         unsigned short *out)                   \</span>
02288 <span class="preprocessor">{                                                               \</span>
02289 <span class="preprocessor">  lut_t *lut = (lut_t *)(stp_get_component_data(v, "Color"));   \</span>
02290 <span class="preprocessor">  switch (lut-&gt;color_correction-&gt;correction)                    \</span>
02291 <span class="preprocessor">    {                                                           \</span>
02292 <span class="preprocessor">    case COLOR_CORRECTION_UNCORRECTED:                          \</span>
02293 <span class="preprocessor">    case COLOR_CORRECTION_ACCURATE:                             \</span>
02294 <span class="preprocessor">    case COLOR_CORRECTION_BRIGHT:                               \</span>
02295 <span class="preprocessor">      return from2##_to_##to(v, in, out);                       \</span>
02296 <span class="preprocessor">    case COLOR_CORRECTION_DESATURATED:                          \</span>
02297 <span class="preprocessor">      return from2##_to_##to##_desaturated(v, in, out);         \</span>
02298 <span class="preprocessor">    case COLOR_CORRECTION_THRESHOLD:                            \</span>
02299 <span class="preprocessor">    case COLOR_CORRECTION_PREDITHERED:                          \</span>
02300 <span class="preprocessor">      return from2##_to_##to##_threshold(v, in, out);           \</span>
02301 <span class="preprocessor">    case COLOR_CORRECTION_DENSITY:                              \</span>
02302 <span class="preprocessor">    case COLOR_CORRECTION_RAW:                                  \</span>
02303 <span class="preprocessor">      return from2##_to_##to##_raw(v, in, out);                 \</span>
02304 <span class="preprocessor">    default:                                                    \</span>
02305 <span class="preprocessor">      return (unsigned) -1;                                     \</span>
02306 <span class="preprocessor">    }                                                           \</span>
02307 <span class="preprocessor">}</span>
02308 <span class="preprocessor"></span>
<a name="l02309"></a><a class="code" href="color-conversions_8c.html#a39">02309</a> <span class="preprocessor">#define CONVERSION_FUNCTION_WITHOUT_DESATURATED(from, to, from2)        \</span>
02310 <span class="preprocessor">static unsigned                                                         \</span>
02311 <span class="preprocessor">generic_##from##_to_##to(const stp_vars_t *v,                           \</span>
02312 <span class="preprocessor">                         const unsigned char *in,                       \</span>
02313 <span class="preprocessor">                         unsigned short *out)                           \</span>
02314 <span class="preprocessor">{                                                                       \</span>
02315 <span class="preprocessor">  lut_t *lut = (lut_t *)(stp_get_component_data(v, "Color"));           \</span>
02316 <span class="preprocessor">  switch (lut-&gt;color_correction-&gt;correction)                            \</span>
02317 <span class="preprocessor">    {                                                                   \</span>
02318 <span class="preprocessor">    case COLOR_CORRECTION_UNCORRECTED:                                  \</span>
02319 <span class="preprocessor">    case COLOR_CORRECTION_ACCURATE:                                     \</span>
02320 <span class="preprocessor">    case COLOR_CORRECTION_BRIGHT:                                       \</span>
02321 <span class="preprocessor">    case COLOR_CORRECTION_DESATURATED:                                  \</span>
02322 <span class="preprocessor">      return from2##_to_##to(v, in, out);                               \</span>
02323 <span class="preprocessor">    case COLOR_CORRECTION_THRESHOLD:                                    \</span>
02324 <span class="preprocessor">    case COLOR_CORRECTION_PREDITHERED:                                  \</span>
02325 <span class="preprocessor">      return from2##_to_##to##_threshold(v, in, out);                   \</span>
02326 <span class="preprocessor">    case COLOR_CORRECTION_DENSITY:                                      \</span>
02327 <span class="preprocessor">    case COLOR_CORRECTION_RAW:                                          \</span>
02328 <span class="preprocessor">      return from2##_to_##to##_raw(v, in, out);                         \</span>
02329 <span class="preprocessor">    default:                                                            \</span>
02330 <span class="preprocessor">      return (unsigned) -1;                                             \</span>
02331 <span class="preprocessor">    }                                                                   \</span>
02332 <span class="preprocessor">}</span>
02333 <span class="preprocessor"></span>
02334 <a class="code" href="color-conversions_8c.html#a37">CONVERSION_FUNCTION_WITH_FAST</a>(cmyk, color, CMYK)
02335 <a class="code" href="color-conversions_8c.html#a37">CONVERSION_FUNCTION_WITH_FAST</a>(cmyk, cmykrb, CMYK)
02336 <a class="code" href="color-conversions_8c.html#a37">CONVERSION_FUNCTION_WITH_FAST</a>(color, color, color)
02337 <a class="code" href="color-conversions_8c.html#a37">CONVERSION_FUNCTION_WITH_FAST</a>(color, cmykrb, color)
02338 <a class="code" href="color-conversions_8c.html#a37">CONVERSION_FUNCTION_WITH_FAST</a>(color, kcmy, color)
02339 <a class="code" href="color-conversions_8c.html#a38">CONVERSION_FUNCTION_WITHOUT_FAST</a>(cmyk, kcmy, CMYK)
02340 <a class="code" href="color-conversions_8c.html#a39">CONVERSION_FUNCTION_WITHOUT_DESATURATED</a>(cmyk, gray, CMYK)
02341 <a class="code" href="color-conversions_8c.html#a39">CONVERSION_FUNCTION_WITHOUT_DESATURATED</a>(color, gray, color)
02342 <a class="code" href="color-conversions_8c.html#a39">CONVERSION_FUNCTION_WITHOUT_DESATURATED</a>(gray, gray, gray)
02343 <a class="code" href="color-conversions_8c.html#a39">CONVERSION_FUNCTION_WITHOUT_DESATURATED</a>(gray, color, gray)
02344 <a class="code" href="color-conversions_8c.html#a39">CONVERSION_FUNCTION_WITHOUT_DESATURATED</a>(gray, kcmy, gray)
02345 <a class="code" href="color-conversions_8c.html#a39">CONVERSION_FUNCTION_WITHOUT_DESATURATED</a>(gray, cmykrb, gray)
02346 
02347 <span class="keywordtype">unsigned</span>
<a name="l02348"></a><a class="code" href="color-conversions_8c.html#a56">02348</a> <a class="code" href="color-conversions_8c.html#a56">stpi_color_convert_to_gray</a>(<span class="keyword">const</span> <a class="code" href="structstp__vars.html">stp_vars_t</a> *v,
02349                            <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> *in,
02350                            <span class="keywordtype">unsigned</span> <span class="keywordtype">short</span> *out)
02351 {
02352   <a class="code" href="structlut__t.html">lut_t</a> *lut = (<a class="code" href="structlut__t.html">lut_t</a> *)(<a class="code" href="group__vars.html#ga20">stp_get_component_data</a>(v, <span class="stringliteral">"Color"</span>));
02353   <span class="keywordflow">switch</span> (lut-&gt;<a class="code" href="structlut__t.html#o7">input_color_description</a>-&gt;<a class="code" href="structcolor__description__t.html#o3">color_id</a>)
02354     {
02355     <span class="keywordflow">case</span> <a class="code" href="color-conversion_8h.html#a53a38">COLOR_ID_GRAY</a>:
02356     <span class="keywordflow">case</span> <a class="code" href="color-conversion_8h.html#a53a39">COLOR_ID_WHITE</a>:
02357       <span class="keywordflow">return</span> generic_gray_to_gray(v, in, out);
02358     <span class="keywordflow">case</span> <a class="code" href="color-conversion_8h.html#a53a40">COLOR_ID_RGB</a>:
02359     <span class="keywordflow">case</span> <a class="code" href="color-conversion_8h.html#a53a41">COLOR_ID_CMY</a>:
02360       <span class="keywordflow">return</span> generic_color_to_gray(v, in, out);
02361     <span class="keywordflow">case</span> <a class="code" href="color-conversion_8h.html#a53a42">COLOR_ID_CMYK</a>:
02362     <span class="keywordflow">case</span> <a class="code" href="color-conversion_8h.html#a53a43">COLOR_ID_KCMY</a>:
02363       <span class="keywordflow">return</span> generic_cmyk_to_gray(v, in, out);
02364     <span class="keywordflow">default</span>:
02365       <span class="keywordflow">return</span> (<span class="keywordtype">unsigned</span>) -1;
02366     }
02367 }
02368 
02369 <span class="keywordtype">unsigned</span>
<a name="l02370"></a><a class="code" href="color-conversions_8c.html#a57">02370</a> <a class="code" href="color-conversions_8c.html#a57">stpi_color_convert_to_color</a>(<span class="keyword">const</span> <a class="code" href="structstp__vars.html">stp_vars_t</a> *v,
02371                             <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> *in,
02372                             <span class="keywordtype">unsigned</span> <span class="keywordtype">short</span> *out)
02373 {
02374   <a class="code" href="structlut__t.html">lut_t</a> *lut = (<a class="code" href="structlut__t.html">lut_t</a> *)(<a class="code" href="group__vars.html#ga20">stp_get_component_data</a>(v, <span class="stringliteral">"Color"</span>));
02375   <span class="keywordflow">switch</span> (lut-&gt;<a class="code" href="structlut__t.html#o7">input_color_description</a>-&gt;<a class="code" href="structcolor__description__t.html#o3">color_id</a>)
02376     {
02377     <span class="keywordflow">case</span> <a class="code" href="color-conversion_8h.html#a53a38">COLOR_ID_GRAY</a>:
02378     <span class="keywordflow">case</span> <a class="code" href="color-conversion_8h.html#a53a39">COLOR_ID_WHITE</a>:
02379       <span class="keywordflow">return</span> generic_gray_to_color(v, in, out);
02380     <span class="keywordflow">case</span> <a class="code" href="color-conversion_8h.html#a53a40">COLOR_ID_RGB</a>:
02381     <span class="keywordflow">case</span> <a class="code" href="color-conversion_8h.html#a53a41">COLOR_ID_CMY</a>:
02382       <span class="keywordflow">return</span> generic_color_to_color(v, in, out);
02383     <span class="keywordflow">case</span> <a class="code" href="color-conversion_8h.html#a53a42">COLOR_ID_CMYK</a>:
02384     <span class="keywordflow">case</span> <a class="code" href="color-conversion_8h.html#a53a43">COLOR_ID_KCMY</a>:
02385       <span class="keywordflow">return</span> generic_cmyk_to_color(v, in, out);
02386     <span class="keywordflow">default</span>:
02387       <span class="keywordflow">return</span> (<span class="keywordtype">unsigned</span>) -1;
02388     }
02389 }
02390 
02391 <span class="keywordtype">unsigned</span>
<a name="l02392"></a><a class="code" href="color-conversions_8c.html#a58">02392</a> <a class="code" href="color-conversions_8c.html#a58">stpi_color_convert_to_kcmy</a>(<span class="keyword">const</span> <a class="code" href="structstp__vars.html">stp_vars_t</a> *v,
02393                            <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> *in,
02394                            <span class="keywordtype">unsigned</span> <span class="keywordtype">short</span> *out)
02395 {
02396   <a class="code" href="structlut__t.html">lut_t</a> *lut = (<a class="code" href="structlut__t.html">lut_t</a> *)(<a class="code" href="group__vars.html#ga20">stp_get_component_data</a>(v, <span class="stringliteral">"Color"</span>));
02397   <span class="keywordflow">switch</span> (lut-&gt;<a class="code" href="structlut__t.html#o7">input_color_description</a>-&gt;<a class="code" href="structcolor__description__t.html#o3">color_id</a>)
02398     {
02399     <span class="keywordflow">case</span> <a class="code" href="color-conversion_8h.html#a53a38">COLOR_ID_GRAY</a>:
02400     <span class="keywordflow">case</span> <a class="code" href="color-conversion_8h.html#a53a39">COLOR_ID_WHITE</a>:
02401       <span class="keywordflow">return</span> generic_gray_to_kcmy(v, in, out);
02402     <span class="keywordflow">case</span> <a class="code" href="color-conversion_8h.html#a53a40">COLOR_ID_RGB</a>:
02403     <span class="keywordflow">case</span> <a class="code" href="color-conversion_8h.html#a53a41">COLOR_ID_CMY</a>:
02404       <span class="keywordflow">return</span> generic_color_to_kcmy(v, in, out);
02405     <span class="keywordflow">case</span> <a class="code" href="color-conversion_8h.html#a53a42">COLOR_ID_CMYK</a>:
02406     <span class="keywordflow">case</span> <a class="code" href="color-conversion_8h.html#a53a43">COLOR_ID_KCMY</a>:
02407       <span class="keywordflow">return</span> generic_cmyk_to_kcmy(v, in, out);
02408     <span class="keywordflow">default</span>:
02409       <span class="keywordflow">return</span> (<span class="keywordtype">unsigned</span>) -1;
02410     }
02411 }
02412 
02413 <span class="keywordtype">unsigned</span>
<a name="l02414"></a><a class="code" href="color-conversions_8c.html#a59">02414</a> <a class="code" href="color-conversions_8c.html#a59">stpi_color_convert_to_cmykrb</a>(<span class="keyword">const</span> <a class="code" href="structstp__vars.html">stp_vars_t</a> *v,
02415                              <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> *in,
02416                              <span class="keywordtype">unsigned</span> <span class="keywordtype">short</span> *out)
02417 {
02418   <a class="code" href="structlut__t.html">lut_t</a> *lut = (<a class="code" href="structlut__t.html">lut_t</a> *)(<a class="code" href="group__vars.html#ga20">stp_get_component_data</a>(v, <span class="stringliteral">"Color"</span>));
02419   <span class="keywordflow">switch</span> (lut-&gt;<a class="code" href="structlut__t.html#o7">input_color_description</a>-&gt;<a class="code" href="structcolor__description__t.html#o3">color_id</a>)
02420     {
02421     <span class="keywordflow">case</span> <a class="code" href="color-conversion_8h.html#a53a38">COLOR_ID_GRAY</a>:
02422     <span class="keywordflow">case</span> <a class="code" href="color-conversion_8h.html#a53a39">COLOR_ID_WHITE</a>:
02423       <span class="keywordflow">return</span> generic_gray_to_cmykrb(v, in, out);
02424     <span class="keywordflow">case</span> <a class="code" href="color-conversion_8h.html#a53a40">COLOR_ID_RGB</a>:
02425     <span class="keywordflow">case</span> <a class="code" href="color-conversion_8h.html#a53a41">COLOR_ID_CMY</a>:
02426       <span class="keywordflow">return</span> generic_color_to_cmykrb(v, in, out);
02427     <span class="keywordflow">case</span> <a class="code" href="color-conversion_8h.html#a53a42">COLOR_ID_CMYK</a>:
02428     <span class="keywordflow">case</span> <a class="code" href="color-conversion_8h.html#a53a43">COLOR_ID_KCMY</a>:
02429       <span class="keywordflow">return</span> generic_cmyk_to_cmykrb(v, in, out);
02430     <span class="keywordflow">default</span>:
02431       <span class="keywordflow">return</span> (<span class="keywordtype">unsigned</span>) -1;
02432     }
02433 }
02434 
02435 <span class="keywordtype">unsigned</span>
<a name="l02436"></a><a class="code" href="color-conversions_8c.html#a60">02436</a> <a class="code" href="color-conversions_8c.html#a60">stpi_color_convert_raw</a>(<span class="keyword">const</span> <a class="code" href="structstp__vars.html">stp_vars_t</a> *v,
02437                        <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> *in,
02438                        <span class="keywordtype">unsigned</span> <span class="keywordtype">short</span> *out)
02439 {
02440   <a class="code" href="structlut__t.html">lut_t</a> *lut = (<a class="code" href="structlut__t.html">lut_t</a> *)(<a class="code" href="group__vars.html#ga20">stp_get_component_data</a>(v, <span class="stringliteral">"Color"</span>));
02441   <span class="keywordflow">switch</span> (lut-&gt;<a class="code" href="structlut__t.html#o9">color_correction</a>-&gt;<a class="code" href="structcolor__correction__t.html#o2">correction</a>)
02442     {
02443     <span class="keywordflow">case</span> <a class="code" href="color-conversion_8h.html#a51a30">COLOR_CORRECTION_THRESHOLD</a>:
02444     <span class="keywordflow">case</span> <a class="code" href="color-conversion_8h.html#a51a34">COLOR_CORRECTION_PREDITHERED</a>:
02445       <span class="keywordflow">return</span> raw_to_raw_threshold(v, in, out);
02446     <span class="keywordflow">case</span> <a class="code" href="color-conversion_8h.html#a51a27">COLOR_CORRECTION_UNCORRECTED</a>:
02447     <span class="keywordflow">case</span> <a class="code" href="color-conversion_8h.html#a51a28">COLOR_CORRECTION_BRIGHT</a>:
02448     <span class="keywordflow">case</span> <a class="code" href="color-conversion_8h.html#a51a29">COLOR_CORRECTION_ACCURATE</a>:
02449     <span class="keywordflow">case</span> <a class="code" href="color-conversion_8h.html#a51a31">COLOR_CORRECTION_DESATURATED</a>:
02450       <span class="keywordflow">return</span> raw_to_raw(v, in, out);
02451     <span class="keywordflow">case</span> <a class="code" href="color-conversion_8h.html#a51a33">COLOR_CORRECTION_RAW</a>:
02452     <span class="keywordflow">case</span> <a class="code" href="color-conversion_8h.html#a51a26">COLOR_CORRECTION_DEFAULT</a>:
02453     <span class="keywordflow">case</span> <a class="code" href="color-conversion_8h.html#a51a32">COLOR_CORRECTION_DENSITY</a>:
02454       <span class="keywordflow">return</span> raw_to_raw_raw(v, in, out);
02455     <span class="keywordflow">default</span>:
02456       <span class="keywordflow">return</span> (<span class="keywordtype">unsigned</span>) -1;
02457     }
02458 }
</pre></div><hr size="1"><address style="align: right;"><small>Generated on Wed Aug 25 07:56:13 2004 for libgimpprint API Reference by
<a href="http://www.doxygen.org/index.html">
<img src="doxygen.png" alt="doxygen" align="middle" border=0 > </a>1.3.6 </small></address>
</body>
</html>
