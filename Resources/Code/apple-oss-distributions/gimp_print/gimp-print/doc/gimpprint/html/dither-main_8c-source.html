<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>libgimpprint API Reference: src/main/dither-main.c Source File</title>
<link href="doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.6 -->
<div class="qindex"><a class="qindex" href="index.html">Main&nbsp;Page</a> | <a class="qindex" href="modules.html">Modules</a> | <a class="qindex" href="classes.html">Alphabetical&nbsp;List</a> | <a class="qindex" href="annotated.html">Data&nbsp;Structures</a> | <a class="qindex" href="files.html">File&nbsp;List</a> | <a class="qindex" href="functions.html">Data&nbsp;Fields</a> | <a class="qindex" href="globals.html">Globals</a> | <a class="qindex" href="pages.html">Related&nbsp;Pages</a></div>
<h1>src/main/dither-main.c</h1><a href="dither-main_8c.html">Go to the documentation of this file.</a><div class="fragment"><pre>00001 <span class="comment">/*</span>
00002 <span class="comment"> * "$Id: dither-main_8c-source.html,v 1.1.1.2 2004/12/22 23:48:58 jlovell Exp $"</span>
00003 <span class="comment"> *</span>
00004 <span class="comment"> *   Dither routine entrypoints</span>
00005 <span class="comment"> *</span>
00006 <span class="comment"> *   Copyright 1997-2003 Michael Sweet (mike@easysw.com) and</span>
00007 <span class="comment"> *      Robert Krawitz (rlk@alum.mit.edu)</span>
00008 <span class="comment"> *</span>
00009 <span class="comment"> *   This program is free software; you can redistribute it and/or modify it</span>
00010 <span class="comment"> *   under the terms of the GNU General Public License as published by the Free</span>
00011 <span class="comment"> *   Software Foundation; either version 2 of the License, or (at your option)</span>
00012 <span class="comment"> *   any later version.</span>
00013 <span class="comment"> *</span>
00014 <span class="comment"> *   This program is distributed in the hope that it will be useful, but</span>
00015 <span class="comment"> *   WITHOUT ANY WARRANTY; without even the implied warranty of MERCHANTABILITY</span>
00016 <span class="comment"> *   or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License</span>
00017 <span class="comment"> *   for more details.</span>
00018 <span class="comment"> *</span>
00019 <span class="comment"> *   You should have received a copy of the GNU General Public License</span>
00020 <span class="comment"> *   along with this program; if not, write to the Free Software</span>
00021 <span class="comment"> *   Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA 02111-1307, USA.</span>
00022 <span class="comment"> *</span>
00023 <span class="comment"> * Revision History:</span>
00024 <span class="comment"> *</span>
00025 <span class="comment"> *   See ChangeLog</span>
00026 <span class="comment"> */</span>
00027 
00028 <span class="preprocessor">#ifdef HAVE_CONFIG_H</span>
00029 <span class="preprocessor"></span><span class="preprocessor">#include &lt;config.h&gt;</span>
00030 <span class="preprocessor">#endif</span>
00031 <span class="preprocessor"></span><span class="preprocessor">#include &lt;<a class="code" href="gimp-print_8h.html">gimp-print/gimp-print.h</a>&gt;</span>
00032 <span class="preprocessor">#include "<a class="code" href="gimp-print-internal_8h.html">gimp-print-internal.h</a>"</span>
00033 <span class="preprocessor">#include &lt;<a class="code" href="gimp-print-intl-internal_8h.html">gimp-print/gimp-print-intl-internal.h</a>&gt;</span>
00034 <span class="preprocessor">#ifdef HAVE_LIMITS_H</span>
00035 <span class="preprocessor"></span><span class="preprocessor">#include &lt;limits.h&gt;</span>
00036 <span class="preprocessor">#endif</span>
00037 <span class="preprocessor"></span><span class="preprocessor">#include &lt;math.h&gt;</span>
00038 <span class="preprocessor">#include &lt;string.h&gt;</span>
00039 <span class="preprocessor">#include "<a class="code" href="dither-impl_8h.html">dither-impl.h</a>"</span>
00040 <span class="preprocessor">#include "<a class="code" href="generic-options_8h.html">generic-options.h</a>"</span>
00041 
<a name="l00042"></a><a class="code" href="dither-main_8c.html#a1">00042</a> <span class="keyword">static</span> <span class="keyword">const</span> <a class="code" href="structstpi__dither__algorithm__t.html">stpi_dither_algorithm_t</a> <a class="code" href="dither-main_8c.html#a1">dither_algos</a>[] =
00043 {
00044   <span class="comment">/* Note to translators: "EvenTone" is the proper name, rather than a */</span>
00045   <span class="comment">/* descriptive name, of this algorithm. */</span>
00046   { <span class="stringliteral">"None"</span>,           <a class="code" href="group__intl__internal.html#ga6">N_</a> (<span class="stringliteral">"Default"</span>),                -1 },
00047   { <span class="stringliteral">"EvenTone"</span>,       <a class="code" href="group__intl__internal.html#ga6">N_</a> (<span class="stringliteral">"EvenTone"</span>),               <a class="code" href="dither-impl_8h.html#a8">D_EVENTONE</a> },
00048   { <span class="stringliteral">"HybridEvenTone"</span>, <a class="code" href="group__intl__internal.html#ga6">N_</a> (<span class="stringliteral">"Hybrid EvenTone"</span>),        <a class="code" href="dither-impl_8h.html#a10">D_HYBRID_EVENTONE</a> },
00049   { <span class="stringliteral">"UniTone"</span>,        <a class="code" href="group__intl__internal.html#ga6">N_</a> (<span class="stringliteral">"UniTone"</span>),                <a class="code" href="dither-impl_8h.html#a9">D_UNITONE</a> },
00050   { <span class="stringliteral">"HybridUniTone"</span>,  <a class="code" href="group__intl__internal.html#ga6">N_</a> (<span class="stringliteral">"Hybrid UniTone"</span>),         <a class="code" href="dither-impl_8h.html#a11">D_HYBRID_UNITONE</a> },
00051   { <span class="stringliteral">"Adaptive"</span>,       <a class="code" href="group__intl__internal.html#ga6">N_</a> (<span class="stringliteral">"Adaptive Hybrid"</span>),        <a class="code" href="dither-impl_8h.html#a2">D_ADAPTIVE_HYBRID</a> },
00052   { <span class="stringliteral">"Ordered"</span>,        <a class="code" href="group__intl__internal.html#ga6">N_</a> (<span class="stringliteral">"Ordered"</span>),                <a class="code" href="dither-impl_8h.html#a4">D_ORDERED</a> },
00053   { <span class="stringliteral">"Fast"</span>,           <a class="code" href="group__intl__internal.html#ga6">N_</a> (<span class="stringliteral">"Fast"</span>),                   <a class="code" href="dither-impl_8h.html#a6">D_FAST</a> },
00054   { <span class="stringliteral">"VeryFast"</span>,       <a class="code" href="group__intl__internal.html#ga6">N_</a> (<span class="stringliteral">"Very Fast"</span>),              <a class="code" href="dither-impl_8h.html#a7">D_VERY_FAST</a> },
00055   { <span class="stringliteral">"Floyd"</span>,          <a class="code" href="group__intl__internal.html#ga6">N_</a> (<span class="stringliteral">"Hybrid Floyd-Steinberg"</span>), <a class="code" href="dither-impl_8h.html#a0">D_FLOYD_HYBRID</a> },
00056   { <span class="stringliteral">"Predithered"</span>,    <a class="code" href="group__intl__internal.html#ga6">N_</a> (<span class="stringliteral">"Predithered Input"</span>),      <a class="code" href="dither-impl_8h.html#a12">D_PREDITHERED</a> }
00057 };
00058 
<a name="l00059"></a><a class="code" href="dither-main_8c.html#a2">00059</a> <span class="keyword">static</span> <span class="keyword">const</span> <span class="keywordtype">int</span> <a class="code" href="dither-main_8c.html#a2">num_dither_algos</a> = <span class="keyword">sizeof</span>(<a class="code" href="dither-main_8c.html#a1">dither_algos</a>)/<span class="keyword">sizeof</span>(<a class="code" href="structstpi__dither__algorithm__t.html">stpi_dither_algorithm_t</a>);
00060 
00061 
00062 <span class="comment">/*</span>
00063 <span class="comment"> * Bayer's dither matrix using Judice, Jarvis, and Ninke recurrence relation</span>
00064 <span class="comment"> * http://www.cs.rit.edu/~sxc7922/Project/CRT.htm</span>
00065 <span class="comment"> */</span>
00066 
<a name="l00067"></a><a class="code" href="dither-main_8c.html#a3">00067</a> <span class="keyword">static</span> <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <a class="code" href="dither-main_8c.html#a3">sq2</a>[] =
00068 {
00069   0, 2,
00070   3, 1
00071 };
00072 
<a name="l00073"></a><a class="code" href="dither-main_8c.html#a4">00073</a> <span class="keyword">static</span> <span class="keyword">const</span> <a class="code" href="structstp__parameter__t.html">stp_parameter_t</a> <a class="code" href="dither-main_8c.html#a4">dither_parameters</a>[] =
00074 {
00075   {
00076     <span class="stringliteral">"Density"</span>, <a class="code" href="group__intl__internal.html#ga6">N_</a>(<span class="stringliteral">"Density"</span>), <a class="code" href="group__intl__internal.html#ga6">N_</a>(<span class="stringliteral">"Output Level Adjustment"</span>),
00077     <a class="code" href="group__intl__internal.html#ga6">N_</a>(<span class="stringliteral">"Adjust the density (amount of ink) of the print. "</span>
00078        <span class="stringliteral">"Reduce the density if the ink bleeds through the "</span>
00079        <span class="stringliteral">"paper or smears; increase the density if black "</span>
00080        <span class="stringliteral">"regions are not solid."</span>),
00081     <a class="code" href="group__vars.html#gga132a10">STP_PARAMETER_TYPE_DOUBLE</a>, <a class="code" href="group__vars.html#gga133a18">STP_PARAMETER_CLASS_OUTPUT</a>,
00082     <a class="code" href="group__vars.html#gga134a22">STP_PARAMETER_LEVEL_ADVANCED</a>, 0, 1, -1, 1, 0
00083   },
00084   {
00085     <span class="stringliteral">"DitherAlgorithm"</span>, <a class="code" href="group__intl__internal.html#ga6">N_</a>(<span class="stringliteral">"Dither Algorithm"</span>), <a class="code" href="group__intl__internal.html#ga6">N_</a>(<span class="stringliteral">"Screening Adjustment"</span>),
00086     <a class="code" href="group__intl__internal.html#ga6">N_</a>(<span class="stringliteral">"Choose the dither algorithm to be used.\n"</span>
00087        <span class="stringliteral">"Adaptive Hybrid usually produces the best all-around quality.\n"</span>
00088        <span class="stringliteral">"EvenTone is a new, experimental algorithm that often produces excellent results.\n"</span>
00089        <span class="stringliteral">"Ordered is faster and produces almost as good quality on photographs.\n"</span>
00090        <span class="stringliteral">"Fast and Very Fast are considerably faster, and work well for text and line art.\n"</span>
00091        <span class="stringliteral">"Hybrid Floyd-Steinberg generally produces inferior output."</span>),
00092     <a class="code" href="group__vars.html#gga132a7">STP_PARAMETER_TYPE_STRING_LIST</a>, <a class="code" href="group__vars.html#gga133a18">STP_PARAMETER_CLASS_OUTPUT</a>,
00093     <a class="code" href="group__vars.html#gga134a22">STP_PARAMETER_LEVEL_ADVANCED</a>, 1, 1, -1, 1, 0
00094   },
00095 };
00096 
<a name="l00097"></a><a class="code" href="dither-main_8c.html#a5">00097</a> <span class="keyword">static</span> <span class="keyword">const</span> <span class="keywordtype">int</span> <a class="code" href="dither-main_8c.html#a5">dither_parameter_count</a> =
00098 <span class="keyword">sizeof</span>(<a class="code" href="dither-main_8c.html#a4">dither_parameters</a>) / <span class="keyword">sizeof</span>(<span class="keyword">const</span> <a class="code" href="structstp__parameter__t.html">stp_parameter_t</a>);
00099 
00100 <a class="code" href="group__vars.html#ga1">stp_parameter_list_t</a>
<a name="l00101"></a><a class="code" href="dither-main_8c.html#a6">00101</a> <a class="code" href="dither-main_8c.html#a6">stp_dither_list_parameters</a>(<span class="keyword">const</span> <a class="code" href="structstp__vars.html">stp_vars_t</a> *v)
00102 {
00103   <a class="code" href="group__vars.html#ga1">stp_parameter_list_t</a> *ret = <a class="code" href="group__vars.html#ga43">stp_parameter_list_create</a>();
00104   <span class="keywordtype">int</span> i;
00105   <span class="keywordflow">for</span> (i = 0; i &lt; <a class="code" href="dither-main_8c.html#a5">dither_parameter_count</a>; i++)
00106     <a class="code" href="group__vars.html#ga82">stp_parameter_list_add_param</a>(ret, &amp;(<a class="code" href="dither-main_8c.html#a4">dither_parameters</a>[i]));
00107   <span class="keywordflow">return</span> ret;
00108 }
00109 
00110 <span class="keywordtype">void</span>
<a name="l00111"></a><a class="code" href="dither-main_8c.html#a7">00111</a> <a class="code" href="dither-main_8c.html#a7">stp_dither_describe_parameter</a>(<span class="keyword">const</span> <a class="code" href="structstp__vars.html">stp_vars_t</a> *v, <span class="keyword">const</span> <span class="keywordtype">char</span> *name,
00112                               <a class="code" href="structstp__parameter__t.html">stp_parameter_t</a> *description)
00113 {
00114   <span class="keywordtype">int</span> i;
00115   description-&gt;<a class="code" href="structstp__parameter__t.html#o4">p_type</a> = <a class="code" href="group__vars.html#gga132a16">STP_PARAMETER_TYPE_INVALID</a>;
00116   <span class="keywordflow">if</span> (name == NULL)
00117     <span class="keywordflow">return</span>;
00118   description-&gt;<a class="code" href="structstp__parameter__t.html#o26">deflt</a>.str = NULL;
00119   <span class="keywordflow">if</span> (strcmp(name, <span class="stringliteral">"Density"</span>) == 0)
00120     {
00121       <a class="code" href="group__vars.html#ga75">stp_fill_parameter_settings</a>(description, &amp;(<a class="code" href="dither-main_8c.html#a4">dither_parameters</a>[0]));
00122       description-&gt;<a class="code" href="structstp__parameter__t.html#o18">bounds</a>.dbl.upper = 8.0;
00123       description-&gt;<a class="code" href="structstp__parameter__t.html#o18">bounds</a>.dbl.lower = 0.1;
00124       description-&gt;<a class="code" href="structstp__parameter__t.html#o26">deflt</a>.dbl = 1.0;
00125     }
00126   <span class="keywordflow">else</span> <span class="keywordflow">if</span> (strcmp(name, <span class="stringliteral">"DitherAlgorithm"</span>) == 0)
00127     {
00128       <a class="code" href="group__vars.html#ga75">stp_fill_parameter_settings</a>(description, &amp;(<a class="code" href="dither-main_8c.html#a4">dither_parameters</a>[1]));
00129       <span class="keywordflow">if</span> (<a class="code" href="group__vars.html#ga100">stp_check_string_parameter</a>(v, <span class="stringliteral">"Quality"</span>, <a class="code" href="group__vars.html#gga135a32">STP_PARAMETER_ACTIVE</a>) &amp;&amp;
00130           <a class="code" href="generic-options_8h.html#a2">stpi_get_quality_by_name</a>(<a class="code" href="group__vars.html#ga36">stp_get_string_parameter</a>(v, <span class="stringliteral">"Quality"</span>)))
00131         description-&gt;<a class="code" href="structstp__parameter__t.html#o8">is_active</a> = 0;
00132       <span class="keywordflow">else</span>
00133         {
00134           description-&gt;<a class="code" href="structstp__parameter__t.html#o18">bounds</a>.str = <a class="code" href="string-list_8h.html#a1">stp_string_list_create</a>();
00135           <span class="keywordflow">for</span> (i = 0; i &lt; <a class="code" href="dither-main_8c.html#a2">num_dither_algos</a>; i++)
00136             {
00137               <span class="keyword">const</span> <a class="code" href="structstpi__dither__algorithm__t.html">stpi_dither_algorithm_t</a> *dt = &amp;<a class="code" href="dither-main_8c.html#a1">dither_algos</a>[i];
00138               <a class="code" href="string-list_8c.html#a11">stp_string_list_add_string</a>(description-&gt;<a class="code" href="structstp__parameter__t.html#o18">bounds</a>.str,
00139                                          dt-&gt;<a class="code" href="structstpi__dither__algorithm__t.html#o0">name</a>, dt-&gt;<a class="code" href="structstpi__dither__algorithm__t.html#o1">text</a>);
00140             }
00141           description-&gt;<a class="code" href="structstp__parameter__t.html#o26">deflt</a>.str =
00142             <a class="code" href="string-list_8c.html#a6">stp_string_list_param</a>(description-&gt;<a class="code" href="structstp__parameter__t.html#o18">bounds</a>.str, 0)-&gt;<a class="code" href="structstp__param__string__t.html#o0">name</a>;
00143         }
00144     }
00145   <span class="keywordflow">else</span>
00146     <span class="keywordflow">return</span>;
00147   <span class="keywordflow">if</span> (<a class="code" href="group__vars.html#ga100">stp_check_string_parameter</a>(v, <span class="stringliteral">"Quality"</span>, <a class="code" href="group__vars.html#gga135a32">STP_PARAMETER_ACTIVE</a>) &amp;&amp;
00148       <a class="code" href="generic-options_8h.html#a2">stpi_get_quality_by_name</a>(<a class="code" href="group__vars.html#ga36">stp_get_string_parameter</a>(v, <span class="stringliteral">"Quality"</span>)))
00149     description-&gt;<a class="code" href="structstp__parameter__t.html#o8">is_active</a> = 0;
00150   <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<a class="code" href="group__vars.html#ga100">stp_check_string_parameter</a>(v, <span class="stringliteral">"ImageType"</span>, <a class="code" href="group__vars.html#gga135a32">STP_PARAMETER_ACTIVE</a>) &amp;&amp;
00151            strcmp(<a class="code" href="group__vars.html#ga36">stp_get_string_parameter</a>(v, <span class="stringliteral">"ImageType"</span>), <span class="stringliteral">"None"</span>) != 0 &amp;&amp;
00152            description-&gt;<a class="code" href="structstp__parameter__t.html#o6">p_level</a> &gt; <a class="code" href="group__vars.html#gga134a21">STP_PARAMETER_LEVEL_BASIC</a>)
00153     description-&gt;<a class="code" href="structstp__parameter__t.html#o8">is_active</a> = 0;
00154 }
00155 
<a name="l00156"></a><a class="code" href="dither-main_8c.html#a0">00156</a> <span class="preprocessor">#define RETURN_DITHERFUNC(func, v)                                      \</span>
00157 <span class="preprocessor">do                                                                      \</span>
00158 <span class="preprocessor">{                                                                       \</span>
00159 <span class="preprocessor">  stp_dprintf(STP_DBG_COLORFUNC, v, "ditherfunc %s\n", #func);  \</span>
00160 <span class="preprocessor">  return (func);                                                        \</span>
00161 <span class="preprocessor">} while (0)</span>
00162 <span class="preprocessor"></span>
00163 <span class="keyword">static</span> <a class="code" href="dither-impl_8h.html#a22">stpi_ditherfunc_t</a> *
<a name="l00164"></a><a class="code" href="dither-main_8c.html#a8">00164</a> <a class="code" href="dither-main_8c.html#a8">stpi_set_dither_function</a>(<a class="code" href="structstp__vars.html">stp_vars_t</a> *v)
00165 {
00166   <span class="keyword">const</span> <a class="code" href="structstpi__quality__t.html">stpi_quality_t</a> *quality = NULL;
00167   <span class="keyword">const</span> <span class="keywordtype">char</span> *image_type = <a class="code" href="group__vars.html#ga36">stp_get_string_parameter</a>(v, <span class="stringliteral">"ImageType"</span>);
00168   <span class="keyword">const</span> <span class="keywordtype">char</span> *color_correction = <a class="code" href="group__vars.html#ga36">stp_get_string_parameter</a>(v,<span class="stringliteral">"ColorCorrection"</span>);
00169   <a class="code" href="structdither.html">stpi_dither_t</a> *d = (<a class="code" href="structdither.html">stpi_dither_t</a> *) <a class="code" href="group__vars.html#ga20">stp_get_component_data</a>(v, <span class="stringliteral">"Dither"</span>);
00170   <span class="keywordtype">int</span> i;
00171   <span class="keyword">const</span> <span class="keywordtype">char</span> *algorithm = <a class="code" href="group__vars.html#ga36">stp_get_string_parameter</a>(v, <span class="stringliteral">"DitherAlgorithm"</span>);
00172   d-&gt;<a class="code" href="structdither.html#o4">stpi_dither_type</a> = -1;
00173   <span class="keywordflow">if</span> (<a class="code" href="group__vars.html#ga100">stp_check_string_parameter</a>(v, <span class="stringliteral">"Quality"</span>, <a class="code" href="group__vars.html#gga135a32">STP_PARAMETER_ACTIVE</a>))
00174     quality = <a class="code" href="generic-options_8h.html#a2">stpi_get_quality_by_name</a>(<a class="code" href="group__vars.html#ga36">stp_get_string_parameter</a>(v, <span class="stringliteral">"Quality"</span>));
00175 
00176   <span class="keywordflow">if</span> (color_correction)
00177     {
00178       <span class="keywordflow">if</span> (strcmp(color_correction, <span class="stringliteral">"Predithered"</span>) == 0)
00179         d-&gt;<a class="code" href="structdither.html#o4">stpi_dither_type</a> = <a class="code" href="dither-impl_8h.html#a12">D_PREDITHERED</a>;
00180     }
00181   <span class="keywordflow">if</span> (image_type &amp;&amp; d-&gt;<a class="code" href="structdither.html#o4">stpi_dither_type</a> == -1)
00182     {
00183       <span class="keywordflow">if</span> (strcmp(image_type, <span class="stringliteral">"Text"</span>) == 0)
00184         d-&gt;<a class="code" href="structdither.html#o4">stpi_dither_type</a> = <a class="code" href="dither-impl_8h.html#a7">D_VERY_FAST</a>;
00185     }
00186   <span class="keywordflow">if</span> (quality &amp;&amp; d-&gt;<a class="code" href="structdither.html#o4">stpi_dither_type</a> == -1)
00187     {
00188       <span class="keywordflow">switch</span> (quality-&gt;<a class="code" href="structstpi__quality__t.html#o2">quality_level</a>)
00189         {
00190         <span class="keywordflow">case</span> 0:
00191         <span class="keywordflow">case</span> 1:
00192           d-&gt;<a class="code" href="structdither.html#o4">stpi_dither_type</a> = <a class="code" href="dither-impl_8h.html#a7">D_VERY_FAST</a>;
00193           <span class="keywordflow">break</span>;
00194         <span class="keywordflow">case</span> 2:
00195         <span class="keywordflow">case</span> 3:
00196           <span class="keywordflow">if</span> (image_type &amp;&amp; strcmp(image_type, <span class="stringliteral">"LineArt"</span>) == 0)
00197             d-&gt;<a class="code" href="structdither.html#o4">stpi_dither_type</a> = <a class="code" href="dither-impl_8h.html#a7">D_VERY_FAST</a>;
00198           <span class="keywordflow">else</span>
00199             d-&gt;<a class="code" href="structdither.html#o4">stpi_dither_type</a> = <a class="code" href="dither-impl_8h.html#a6">D_FAST</a>;
00200           <span class="keywordflow">break</span>;
00201         <span class="keywordflow">case</span> 4:
00202           <span class="keywordflow">if</span> (image_type &amp;&amp;
00203               (strcmp(image_type, <span class="stringliteral">"LineArt"</span>) == 0 ||
00204                strcmp(image_type, <span class="stringliteral">"TextGraphics"</span>) == 0))
00205             d-&gt;<a class="code" href="structdither.html#o4">stpi_dither_type</a> = <a class="code" href="dither-impl_8h.html#a2">D_ADAPTIVE_HYBRID</a>;
00206           <span class="keywordflow">else</span>
00207             d-&gt;<a class="code" href="structdither.html#o4">stpi_dither_type</a> = <a class="code" href="dither-impl_8h.html#a4">D_ORDERED</a>;
00208           <span class="keywordflow">break</span>;
00209         <span class="keywordflow">case</span> 5:
00210           <span class="keywordflow">if</span> (image_type &amp;&amp;
00211               (strcmp(image_type, <span class="stringliteral">"LineArt"</span>) == 0 ||
00212                strcmp(image_type, <span class="stringliteral">"TextGraphics"</span>) == 0))
00213             d-&gt;<a class="code" href="structdither.html#o4">stpi_dither_type</a> = <a class="code" href="dither-impl_8h.html#a10">D_HYBRID_EVENTONE</a>;
00214           <span class="keywordflow">else</span> <span class="keywordflow">if</span> (image_type &amp;&amp; (strcmp(image_type, <span class="stringliteral">"Photo"</span>) == 0))
00215             d-&gt;<a class="code" href="structdither.html#o4">stpi_dither_type</a> = <a class="code" href="dither-impl_8h.html#a8">D_EVENTONE</a>;
00216           <span class="keywordflow">else</span>
00217             d-&gt;<a class="code" href="structdither.html#o4">stpi_dither_type</a> = <a class="code" href="dither-impl_8h.html#a4">D_ORDERED</a>;
00218           <span class="keywordflow">break</span>;
00219         <span class="keywordflow">case</span> 6:
00220         <span class="keywordflow">case</span> 7:
00221         <span class="keywordflow">case</span> 8:
00222         <span class="keywordflow">case</span> 9:
00223         <span class="keywordflow">case</span> 10:
00224         <span class="keywordflow">default</span>:
00225           <span class="keywordflow">if</span> (image_type &amp;&amp;
00226               (strcmp(image_type, <span class="stringliteral">"LineArt"</span>) == 0 ||
00227                strcmp(image_type, <span class="stringliteral">"TextGraphics"</span>) == 0))
00228             d-&gt;<a class="code" href="structdither.html#o4">stpi_dither_type</a> = <a class="code" href="dither-impl_8h.html#a10">D_HYBRID_EVENTONE</a>;
00229           <span class="keywordflow">else</span>
00230             d-&gt;<a class="code" href="structdither.html#o4">stpi_dither_type</a> = <a class="code" href="dither-impl_8h.html#a8">D_EVENTONE</a>;
00231           <span class="keywordflow">break</span>;
00232         }
00233       <span class="comment">/* EvenTone performs poorly if the aspect ratio is greater than 2 */</span>
00234       <span class="keywordflow">if</span> ((d-&gt;<a class="code" href="structdither.html#o4">stpi_dither_type</a> &amp; (<a class="code" href="dither-impl_8h.html#a8">D_EVENTONE</a> | <a class="code" href="dither-impl_8h.html#a9">D_UNITONE</a>)) &amp;&amp;
00235           (d-&gt;<a class="code" href="structdither.html#o6">x_aspect</a> &gt; 2 || d-&gt;<a class="code" href="structdither.html#o7">y_aspect</a> &gt; 2))
00236         d-&gt;<a class="code" href="structdither.html#o4">stpi_dither_type</a> = <a class="code" href="dither-impl_8h.html#a2">D_ADAPTIVE_HYBRID</a>;
00237     }
00238   <span class="keywordflow">else</span> <span class="keywordflow">if</span> (algorithm)
00239     {
00240       <span class="keywordflow">for</span> (i = 0; i &lt; <a class="code" href="dither-main_8c.html#a2">num_dither_algos</a>; i++)
00241         {
00242           <span class="keywordflow">if</span> (!strcmp(algorithm, <a class="code" href="group__intl__internal.html#ga5">_</a>(<a class="code" href="dither-main_8c.html#a1">dither_algos</a>[i].name)))
00243             {
00244               d-&gt;<a class="code" href="structdither.html#o4">stpi_dither_type</a> = <a class="code" href="dither-main_8c.html#a1">dither_algos</a>[i].<a class="code" href="structstpi__dither__algorithm__t.html#o2">id</a>;
00245               <span class="keywordflow">break</span>;
00246             }
00247         }
00248       <span class="keywordflow">if</span> (d-&gt;<a class="code" href="structdither.html#o4">stpi_dither_type</a> == -1)
00249         {
00250           d-&gt;<a class="code" href="structdither.html#o4">stpi_dither_type</a> = <a class="code" href="dither-impl_8h.html#a8">D_EVENTONE</a>;
00251           <span class="comment">/* EvenTone performs poorly if the aspect ratio is greater than 2 */</span>
00252           <span class="keywordflow">if</span> ((d-&gt;<a class="code" href="structdither.html#o4">stpi_dither_type</a> &amp; (<a class="code" href="dither-impl_8h.html#a8">D_EVENTONE</a> | <a class="code" href="dither-impl_8h.html#a9">D_UNITONE</a>)) &amp;&amp;
00253               (d-&gt;<a class="code" href="structdither.html#o6">x_aspect</a> &gt; 2 || d-&gt;<a class="code" href="structdither.html#o7">y_aspect</a> &gt; 2))
00254             d-&gt;<a class="code" href="structdither.html#o4">stpi_dither_type</a> = <a class="code" href="dither-impl_8h.html#a2">D_ADAPTIVE_HYBRID</a>;
00255         }       
00256     }
00257   <span class="keywordflow">switch</span> (d-&gt;<a class="code" href="structdither.html#o4">stpi_dither_type</a>)
00258     {
00259     <span class="keywordflow">case</span> <a class="code" href="dither-impl_8h.html#a12">D_PREDITHERED</a>:
00260       <a class="code" href="dither-main_8c.html#a0">RETURN_DITHERFUNC</a>(<a class="code" href="dither-impl_8h.html#a27">stpi_dither_predithered</a>, v);
00261     <span class="keywordflow">case</span> <a class="code" href="dither-impl_8h.html#a7">D_VERY_FAST</a>:
00262       <a class="code" href="dither-main_8c.html#a0">RETURN_DITHERFUNC</a>(<a class="code" href="dither-impl_8h.html#a28">stpi_dither_very_fast</a>, v);
00263     <span class="keywordflow">case</span> <a class="code" href="dither-impl_8h.html#a4">D_ORDERED</a>:
00264     <span class="keywordflow">case</span> <a class="code" href="dither-impl_8h.html#a6">D_FAST</a>:
00265       <a class="code" href="dither-main_8c.html#a0">RETURN_DITHERFUNC</a>(<a class="code" href="dither-impl_8h.html#a29">stpi_dither_ordered</a>, v);
00266     <span class="keywordflow">case</span> <a class="code" href="dither-impl_8h.html#a10">D_HYBRID_EVENTONE</a>:
00267     <span class="keywordflow">case</span> <a class="code" href="dither-impl_8h.html#a8">D_EVENTONE</a>:
00268       <a class="code" href="dither-main_8c.html#a0">RETURN_DITHERFUNC</a>(<a class="code" href="dither-impl_8h.html#a31">stpi_dither_et</a>, v);
00269     <span class="keywordflow">case</span> <a class="code" href="dither-impl_8h.html#a11">D_HYBRID_UNITONE</a>:
00270     <span class="keywordflow">case</span> <a class="code" href="dither-impl_8h.html#a9">D_UNITONE</a>:
00271       <a class="code" href="dither-main_8c.html#a0">RETURN_DITHERFUNC</a>(<a class="code" href="dither-impl_8h.html#a32">stpi_dither_ut</a>, v);
00272     <span class="keywordflow">default</span>:
00273       <a class="code" href="dither-main_8c.html#a0">RETURN_DITHERFUNC</a>(<a class="code" href="dither-impl_8h.html#a30">stpi_dither_ed</a>, v);
00274     }
00275 }
00276 
00277 <span class="keywordtype">void</span>
<a name="l00278"></a><a class="code" href="dither-main_8c.html#a9">00278</a> <a class="code" href="dither-main_8c.html#a9">stp_dither_set_adaptive_limit</a>(<a class="code" href="structstp__vars.html">stp_vars_t</a> *v, <span class="keywordtype">double</span> limit)
00279 {
00280   <a class="code" href="structdither.html">stpi_dither_t</a> *d = (<a class="code" href="structdither.html">stpi_dither_t</a> *) <a class="code" href="group__vars.html#ga20">stp_get_component_data</a>(v, <span class="stringliteral">"Dither"</span>);
00281   d-&gt;<a class="code" href="structdither.html#o5">adaptive_limit</a> = limit;
00282 }
00283 
00284 <span class="keywordtype">void</span>
<a name="l00285"></a><a class="code" href="dither-main_8c.html#a10">00285</a> <a class="code" href="dither-main_8c.html#a10">stp_dither_set_ink_spread</a>(<a class="code" href="structstp__vars.html">stp_vars_t</a> *v, <span class="keywordtype">int</span> spread)
00286 {
00287   <a class="code" href="structdither.html">stpi_dither_t</a> *d = (<a class="code" href="structdither.html">stpi_dither_t</a> *) <a class="code" href="group__vars.html#ga20">stp_get_component_data</a>(v, <span class="stringliteral">"Dither"</span>);
00288   <a class="code" href="group__util.html#ga52">STP_SAFE_FREE</a>(d-&gt;<a class="code" href="structdither.html#o9">offset0_table</a>);
00289   <a class="code" href="group__util.html#ga52">STP_SAFE_FREE</a>(d-&gt;<a class="code" href="structdither.html#o10">offset1_table</a>);
00290   <span class="keywordflow">if</span> (spread &gt;= 16)
00291     {
00292       d-&gt;<a class="code" href="structdither.html#o2">spread</a> = 16;
00293     }
00294   <span class="keywordflow">else</span>
00295     {
00296       <span class="keywordtype">int</span> max_offset;
00297       <span class="keywordtype">int</span> i;
00298       d-&gt;<a class="code" href="structdither.html#o2">spread</a> = spread;
00299       max_offset = (1 &lt;&lt; (16 - spread)) + 1;
00300       d-&gt;<a class="code" href="structdither.html#o9">offset0_table</a> = <a class="code" href="group__util.html#ga28">stp_malloc</a>(<span class="keyword">sizeof</span>(<span class="keywordtype">int</span>) * max_offset);
00301       d-&gt;<a class="code" href="structdither.html#o10">offset1_table</a> = <a class="code" href="group__util.html#ga28">stp_malloc</a>(<span class="keyword">sizeof</span>(<span class="keywordtype">int</span>) * max_offset);
00302       <span class="keywordflow">for</span> (i = 0; i &lt; max_offset; i++)
00303         {
00304           d-&gt;<a class="code" href="structdither.html#o9">offset0_table</a>[i] = (i + 1) * (i + 1);
00305           d-&gt;<a class="code" href="structdither.html#o10">offset1_table</a>[i] = ((i + 1) * i) / 2;
00306         }
00307     }
00308   d-&gt;<a class="code" href="structdither.html#o3">spread_mask</a> = (1 &lt;&lt; d-&gt;<a class="code" href="structdither.html#o2">spread</a>) - 1;
00309 }
00310 
00311 <span class="keywordtype">void</span>
<a name="l00312"></a><a class="code" href="dither-main_8c.html#a11">00312</a> <a class="code" href="dither-main_8c.html#a11">stp_dither_set_randomizer</a>(<a class="code" href="structstp__vars.html">stp_vars_t</a> *v, <span class="keywordtype">int</span> i, <span class="keywordtype">double</span> val)
00313 {
00314   <a class="code" href="structdither.html">stpi_dither_t</a> *d = (<a class="code" href="structdither.html">stpi_dither_t</a> *) <a class="code" href="group__vars.html#ga20">stp_get_component_data</a>(v, <span class="stringliteral">"Dither"</span>);
00315   <span class="keywordflow">if</span> (i &lt; 0 || i &gt;= <a class="code" href="dither-impl_8h.html#a17">CHANNEL_COUNT</a>(d))
00316     <span class="keywordflow">return</span>;
00317   <a class="code" href="dither-impl_8h.html#a16">CHANNEL</a>(d, i).randomizer = val * 65535;
00318 }
00319 
00320 <span class="keyword">static</span> <span class="keywordtype">void</span>
<a name="l00321"></a><a class="code" href="dither-main_8c.html#a12">00321</a> <a class="code" href="dither-main_8c.html#a12">stpi_dither_free</a>(<span class="keywordtype">void</span> *vd)
00322 {
00323   <a class="code" href="structdither.html">stpi_dither_t</a> *d = (<a class="code" href="structdither.html">stpi_dither_t</a> *) vd;
00324   <span class="keywordtype">int</span> j;
00325   <span class="keywordflow">if</span> (d-&gt;<a class="code" href="structdither.html#o25">aux_freefunc</a>)
00326     (d-&gt;<a class="code" href="structdither.html#o25">aux_freefunc</a>)(d);
00327   <span class="keywordflow">for</span> (j = 0; j &lt; <a class="code" href="dither-impl_8h.html#a17">CHANNEL_COUNT</a>(d); j++)
00328     <a class="code" href="dither-inks_8c.html#a3">stpi_dither_channel_destroy</a>(&amp;(<a class="code" href="dither-impl_8h.html#a16">CHANNEL</a>(d, j)));
00329   <a class="code" href="group__util.html#ga52">STP_SAFE_FREE</a>(d-&gt;<a class="code" href="structdither.html#o9">offset0_table</a>);
00330   <a class="code" href="group__util.html#ga52">STP_SAFE_FREE</a>(d-&gt;<a class="code" href="structdither.html#o10">offset1_table</a>);
00331   <a class="code" href="print-dither-matrices_8c.html#a11">stp_dither_matrix_destroy</a>(&amp;(d-&gt;<a class="code" href="structdither.html#o16">dither_matrix</a>));
00332   <a class="code" href="print-dither-matrices_8c.html#a11">stp_dither_matrix_destroy</a>(&amp;(d-&gt;<a class="code" href="structdither.html#o17">transition_matrix</a>));
00333   <a class="code" href="group__util.html#ga31">stp_free</a>(d-&gt;<a class="code" href="structdither.html#o18">channel</a>);
00334   <a class="code" href="group__util.html#ga31">stp_free</a>(d-&gt;<a class="code" href="structdither.html#o21">channel_index</a>);
00335   <a class="code" href="group__util.html#ga31">stp_free</a>(d-&gt;<a class="code" href="structdither.html#o22">subchannel_count</a>);
00336   <a class="code" href="group__util.html#ga31">stp_free</a>(d);
00337 }
00338 
00339 <span class="keywordtype">void</span>
<a name="l00340"></a><a class="code" href="dither-main_8c.html#a13">00340</a> <a class="code" href="dither-main_8c.html#a13">stp_dither_init</a>(<a class="code" href="structstp__vars.html">stp_vars_t</a> *v, <a class="code" href="structstp__image.html">stp_image_t</a> *image, <span class="keywordtype">int</span> out_width,
00341                 <span class="keywordtype">int</span> xdpi, <span class="keywordtype">int</span> ydpi)
00342 {
00343   <span class="keywordtype">int</span> in_width = <a class="code" href="group__image.html#ga2">stp_image_width</a>(image);
00344   <a class="code" href="structdither.html">stpi_dither_t</a> *d = <a class="code" href="group__util.html#ga29">stp_zalloc</a>(<span class="keyword">sizeof</span>(<a class="code" href="structdither.html">stpi_dither_t</a>));
00345 
00346   <a class="code" href="group__vars.html#ga18">stp_allocate_component_data</a>(v, <span class="stringliteral">"Dither"</span>, NULL, <a class="code" href="dither-main_8c.html#a12">stpi_dither_free</a>, d);
00347 
00348   d-&gt;<a class="code" href="structdither.html#o15">finalized</a> = 0;
00349   d-&gt;<a class="code" href="structdither.html#o14">error_rows</a> = <a class="code" href="dither-impl_8h.html#a14">ERROR_ROWS</a>;
00350   d-&gt;<a class="code" href="structdither.html#o11">d_cutoff</a> = 4096;
00351 
00352   d-&gt;<a class="code" href="structdither.html#o9">offset0_table</a> = NULL;
00353   d-&gt;<a class="code" href="structdither.html#o10">offset1_table</a> = NULL;
00354   <span class="keywordflow">if</span> (xdpi &gt; ydpi)
00355     {
00356       d-&gt;<a class="code" href="structdither.html#o6">x_aspect</a> = 1;
00357       d-&gt;<a class="code" href="structdither.html#o7">y_aspect</a> = xdpi / ydpi;
00358     }
00359   <span class="keywordflow">else</span>
00360     {
00361       d-&gt;<a class="code" href="structdither.html#o6">x_aspect</a> = ydpi / xdpi;
00362       d-&gt;<a class="code" href="structdither.html#o7">y_aspect</a> = 1;
00363     }
00364   d-&gt;<a class="code" href="structdither.html#o23">ditherfunc</a> = <a class="code" href="dither-main_8c.html#a8">stpi_set_dither_function</a>(v);
00365   d-&gt;<a class="code" href="structdither.html#o8">transition</a> = 1.0;
00366   d-&gt;<a class="code" href="structdither.html#o5">adaptive_limit</a> = .75 * 65535;
00367 
00368   <span class="comment">/*</span>
00369 <span class="comment">   * For hybrid EvenTone we want to use the good matrix.  For regular</span>
00370 <span class="comment">   * EvenTone, we don't need to pay the cost.</span>
00371 <span class="comment">   */</span>
00372   
00373   <span class="keywordflow">if</span> (d-&gt;<a class="code" href="structdither.html#o4">stpi_dither_type</a> == <a class="code" href="dither-impl_8h.html#a7">D_VERY_FAST</a> || d-&gt;<a class="code" href="structdither.html#o4">stpi_dither_type</a> ==<a class="code" href="dither-impl_8h.html#a8">D_EVENTONE</a> ||
00374       d-&gt;<a class="code" href="structdither.html#o4">stpi_dither_type</a> == <a class="code" href="dither-impl_8h.html#a6">D_FAST</a> || d-&gt;<a class="code" href="structdither.html#o4">stpi_dither_type</a> == <a class="code" href="dither-impl_8h.html#a12">D_PREDITHERED</a>)
00375     {
00376       <span class="keywordflow">if</span> (<a class="code" href="group__vars.html#ga103">stp_check_int_parameter</a>(v, <span class="stringliteral">"DitherVeryFastSteps"</span>,
00377                                   <a class="code" href="group__vars.html#gga135a32">STP_PARAMETER_ACTIVE</a>))
00378         <a class="code" href="dither_8h.html#a26">stp_dither_set_iterated_matrix</a>
00379           (v, 2, <a class="code" href="group__vars.html#ga58">stp_get_int_parameter</a>(v, <span class="stringliteral">"DitherVeryFastSteps"</span>), <a class="code" href="dither-main_8c.html#a3">sq2</a>, 0, 2,4);
00380       <span class="keywordflow">else</span>
00381         <a class="code" href="print-dither-matrices_8c.html#a18">stp_dither_set_iterated_matrix</a>(v, 2, <a class="code" href="dither-impl_8h.html#a13">DITHER_FAST_STEPS</a>, <a class="code" href="dither-main_8c.html#a3">sq2</a>, 0, 2, 4);
00382     }
00383   <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<a class="code" href="group__vars.html#ga107">stp_check_array_parameter</a>(v, <span class="stringliteral">"DitherMatrix"</span>,
00384                                      <a class="code" href="group__vars.html#gga135a32">STP_PARAMETER_ACTIVE</a>) &amp;&amp;
00385            (<a class="code" href="dither_8h.html#a15">stp_dither_matrix_validate_array</a>
00386             (<a class="code" href="group__vars.html#ga54">stp_get_array_parameter</a>(v, <span class="stringliteral">"DitherMatrix"</span>))))
00387     {
00388       <a class="code" href="dither_8h.html#a28">stp_dither_set_matrix_from_dither_array</a>
00389         (v, <a class="code" href="group__vars.html#ga54">stp_get_array_parameter</a>(v, <span class="stringliteral">"DitherMatrix"</span>), 0);
00390     }
00391   <span class="keywordflow">else</span>
00392     {
00393       <a class="code" href="structstp__array.html">stp_array_t</a> *array;
00394       <span class="keywordtype">int</span> transposed;
00395         array = <a class="code" href="print-dither-matrices_8c.html#a30">stp_find_standard_dither_array</a>(d-&gt;<a class="code" href="structdither.html#o7">y_aspect</a>, d-&gt;<a class="code" href="structdither.html#o6">x_aspect</a>);
00396       transposed = d-&gt;<a class="code" href="structdither.html#o7">y_aspect</a> &lt; d-&gt;<a class="code" href="structdither.html#o6">x_aspect</a> ? 1 : 0;
00397       <span class="keywordflow">if</span> (array)
00398         {
00399           <a class="code" href="print-dither-matrices_8c.html#a20">stp_dither_set_matrix_from_dither_array</a>(v, array, transposed);
00400           <a class="code" href="group__array.html#ga4">stp_array_destroy</a>(array);
00401         }
00402       <span class="keywordflow">else</span>
00403         {
00404           <a class="code" href="print-util_8c.html#a18">stp_eprintf</a>(v, <span class="stringliteral">"Cannot find dither matrix file!  Aborting.\n"</span>);
00405           <a class="code" href="group__util.html#ga3">stp_abort</a>();
00406         }
00407     }
00408   <a class="code" href="print-dither-matrices_8c.html#a21">stp_dither_set_transition</a>(v, 0.7);
00409 
00410   d-&gt;<a class="code" href="structdither.html#o0">src_width</a> = in_width;
00411   d-&gt;<a class="code" href="structdither.html#o1">dst_width</a> = out_width;
00412 
00413   <a class="code" href="dither-main_8c.html#a10">stp_dither_set_ink_spread</a>(v, 13);
00414   d-&gt;<a class="code" href="structdither.html#o19">channel_count</a> = 0;
00415 }
00416 
00417 <span class="keywordtype">void</span>
<a name="l00418"></a><a class="code" href="dither-main_8c.html#a14">00418</a> <a class="code" href="dither-main_8c.html#a14">stpi_dither_reverse_row_ends</a>(<a class="code" href="structdither.html">stpi_dither_t</a> *d)
00419 {
00420   <span class="keywordtype">int</span> i;
00421   <span class="keywordflow">for</span> (i = 0; i &lt; <a class="code" href="dither-impl_8h.html#a17">CHANNEL_COUNT</a>(d); i++)
00422     {
00423       <span class="keywordtype">int</span> tmp = <a class="code" href="dither-impl_8h.html#a16">CHANNEL</a>(d, i).row_ends[0];
00424       <a class="code" href="dither-impl_8h.html#a16">CHANNEL</a>(d, i).row_ends[0] =
00425         <a class="code" href="dither-impl_8h.html#a16">CHANNEL</a>(d, i).row_ends[1];
00426       <a class="code" href="dither-impl_8h.html#a16">CHANNEL</a>(d, i).row_ends[1] = tmp;
00427     }
00428 }
00429 
00430 <span class="keywordtype">int</span>
<a name="l00431"></a><a class="code" href="dither-main_8c.html#a15">00431</a> <a class="code" href="dither-main_8c.html#a15">stp_dither_get_first_position</a>(<a class="code" href="structstp__vars.html">stp_vars_t</a> *v, <span class="keywordtype">int</span> color, <span class="keywordtype">int</span> subchannel)
00432 {
00433   <a class="code" href="structdither.html">stpi_dither_t</a> *d = (<a class="code" href="structdither.html">stpi_dither_t</a> *) <a class="code" href="group__vars.html#ga20">stp_get_component_data</a>(v, <span class="stringliteral">"Dither"</span>);
00434   <span class="keywordtype">int</span> channel = <a class="code" href="dither-inks_8c.html#a0">stpi_dither_translate_channel</a>(v, color, subchannel);
00435   <span class="keywordflow">if</span> (channel &lt; 0)
00436     <span class="keywordflow">return</span> -1;
00437   <span class="keywordflow">return</span> <a class="code" href="dither-impl_8h.html#a16">CHANNEL</a>(d, channel).row_ends[0];
00438 }
00439 
00440 <span class="keywordtype">int</span>
<a name="l00441"></a><a class="code" href="dither-main_8c.html#a16">00441</a> <a class="code" href="dither-main_8c.html#a16">stp_dither_get_last_position</a>(<a class="code" href="structstp__vars.html">stp_vars_t</a> *v, <span class="keywordtype">int</span> color, <span class="keywordtype">int</span> subchannel)
00442 {
00443   <a class="code" href="structdither.html">stpi_dither_t</a> *d = (<a class="code" href="structdither.html">stpi_dither_t</a> *) <a class="code" href="group__vars.html#ga20">stp_get_component_data</a>(v, <span class="stringliteral">"Dither"</span>);
00444   <span class="keywordtype">int</span> channel = <a class="code" href="dither-inks_8c.html#a0">stpi_dither_translate_channel</a>(v, color, subchannel);
00445   <span class="keywordflow">if</span> (channel &lt; 0)
00446     <span class="keywordflow">return</span> -1;
00447   <span class="keywordflow">return</span> <a class="code" href="dither-impl_8h.html#a16">CHANNEL</a>(d, channel).row_ends[1];
00448 }
00449 
00450 <span class="keywordtype">int</span> *
<a name="l00451"></a><a class="code" href="dither-main_8c.html#a17">00451</a> <a class="code" href="dither-main_8c.html#a17">stpi_dither_get_errline</a>(<a class="code" href="structdither.html">stpi_dither_t</a> *d, <span class="keywordtype">int</span> row, <span class="keywordtype">int</span> color)
00452 {
00453   <a class="code" href="structdither__channel.html">stpi_dither_channel_t</a> *dc;
00454   <span class="keywordflow">if</span> (row &lt; 0 || color &lt; 0 || color &gt;= <a class="code" href="dither-impl_8h.html#a17">CHANNEL_COUNT</a>(d))
00455     <span class="keywordflow">return</span> NULL;
00456   dc = &amp;(<a class="code" href="dither-impl_8h.html#a16">CHANNEL</a>(d, color));
00457   <span class="keywordflow">if</span> (!dc-&gt;<a class="code" href="structdither__channel.html#o13">errs</a>)
00458     dc-&gt;<a class="code" href="structdither__channel.html#o13">errs</a> = <a class="code" href="group__util.html#ga29">stp_zalloc</a>(d-&gt;<a class="code" href="structdither.html#o14">error_rows</a> * <span class="keyword">sizeof</span>(<span class="keywordtype">int</span> *));
00459   <span class="keywordflow">if</span> (!dc-&gt;<a class="code" href="structdither__channel.html#o13">errs</a>[row % dc-&gt;<a class="code" href="structdither__channel.html#o12">error_rows</a>])
00460     {
00461       <span class="keywordtype">int</span> size = 2 * <a class="code" href="dither-impl_8h.html#a15">MAX_SPREAD</a> + (16 * ((d-&gt;<a class="code" href="structdither.html#o1">dst_width</a> + 7) / 8));
00462       dc-&gt;<a class="code" href="structdither__channel.html#o13">errs</a>[row % dc-&gt;<a class="code" href="structdither__channel.html#o12">error_rows</a>] = <a class="code" href="group__util.html#ga29">stp_zalloc</a>(size * <span class="keyword">sizeof</span>(<span class="keywordtype">int</span>));
00463     }
00464   <span class="keywordflow">return</span> dc-&gt;<a class="code" href="structdither__channel.html#o13">errs</a>[row % dc-&gt;<a class="code" href="structdither__channel.html#o12">error_rows</a>] + <a class="code" href="dither-impl_8h.html#a15">MAX_SPREAD</a>;
00465 }
00466 
00467 <span class="keywordtype">void</span>
<a name="l00468"></a><a class="code" href="dither-main_8c.html#a18">00468</a> <a class="code" href="dither-main_8c.html#a18">stp_dither_internal</a>(<a class="code" href="structstp__vars.html">stp_vars_t</a> *v, <span class="keywordtype">int</span> row, <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">short</span> *input,
00469                     <span class="keywordtype">int</span> duplicate_line, <span class="keywordtype">int</span> zero_mask,
00470                     <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> *mask)
00471 {
00472   <span class="keywordtype">int</span> i;
00473   <a class="code" href="structdither.html">stpi_dither_t</a> *d = (<a class="code" href="structdither.html">stpi_dither_t</a> *) <a class="code" href="group__vars.html#ga20">stp_get_component_data</a>(v, <span class="stringliteral">"Dither"</span>);
00474   <a class="code" href="dither-inks_8c.html#a6">stpi_dither_finalize</a>(v);
00475   <a class="code" href="print-dither-matrices_8c.html#a15">stp_dither_matrix_set_row</a>(&amp;(d-&gt;<a class="code" href="structdither.html#o16">dither_matrix</a>), row);
00476   <a class="code" href="print-dither-matrices_8c.html#a15">stp_dither_matrix_set_row</a>(&amp;(d-&gt;<a class="code" href="structdither.html#o17">transition_matrix</a>), row);
00477   <span class="keywordflow">for</span> (i = 0; i &lt; <a class="code" href="dither-impl_8h.html#a17">CHANNEL_COUNT</a>(d); i++)
00478     {
00479       <a class="code" href="dither-impl_8h.html#a16">CHANNEL</a>(d, i).ptr = <a class="code" href="dither-impl_8h.html#a16">CHANNEL</a>(d, i).ptr;
00480       <span class="keywordflow">if</span> (<a class="code" href="dither-impl_8h.html#a16">CHANNEL</a>(d, i).ptr)
00481           memset(<a class="code" href="dither-impl_8h.html#a16">CHANNEL</a>(d, i).ptr, 0,
00482                  (d-&gt;<a class="code" href="structdither.html#o1">dst_width</a> + 7) / 8 * <a class="code" href="dither-impl_8h.html#a16">CHANNEL</a>(d, i).signif_bits);
00483       <a class="code" href="dither-impl_8h.html#a16">CHANNEL</a>(d, i).row_ends[0] = -1;
00484       <a class="code" href="dither-impl_8h.html#a16">CHANNEL</a>(d, i).row_ends[1] = -1;
00485 
00486       <a class="code" href="print-dither-matrices_8c.html#a15">stp_dither_matrix_set_row</a>(&amp;(<a class="code" href="dither-impl_8h.html#a16">CHANNEL</a>(d, i).dithermat), row);
00487       <a class="code" href="print-dither-matrices_8c.html#a15">stp_dither_matrix_set_row</a>(&amp;(<a class="code" href="dither-impl_8h.html#a16">CHANNEL</a>(d, i).pick), row);
00488     }
00489   d-&gt;<a class="code" href="structdither.html#o13">ptr_offset</a> = 0;
00490   (d-&gt;<a class="code" href="structdither.html#o23">ditherfunc</a>)(v, row, input, duplicate_line, zero_mask, mask);
00491 }
00492 
00493 <span class="keywordtype">void</span>
<a name="l00494"></a><a class="code" href="dither-main_8c.html#a19">00494</a> <a class="code" href="dither-main_8c.html#a19">stp_dither</a>(<a class="code" href="structstp__vars.html">stp_vars_t</a> *v, <span class="keywordtype">int</span> row, <span class="keywordtype">int</span> duplicate_line, <span class="keywordtype">int</span> zero_mask,
00495            <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> *mask)
00496 {
00497   <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">short</span> *input = <a class="code" href="channel_8c.html#a21">stp_channel_get_output</a>(v);
00498   <a class="code" href="dither-main_8c.html#a18">stp_dither_internal</a>(v, row, input, duplicate_line, zero_mask, mask);
00499 }
</pre></div><hr size="1"><address style="align: right;"><small>Generated on Wed Aug 25 07:56:13 2004 for libgimpprint API Reference by
<a href="http://www.doxygen.org/index.html">
<img src="doxygen.png" alt="doxygen" align="middle" border=0 > </a>1.3.6 </small></address>
</body>
</html>
