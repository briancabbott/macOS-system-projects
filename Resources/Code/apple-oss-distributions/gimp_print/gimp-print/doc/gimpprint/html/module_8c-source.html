<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>libgimpprint API Reference: src/main/module.c Source File</title>
<link href="doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.6 -->
<div class="qindex"><a class="qindex" href="index.html">Main&nbsp;Page</a> | <a class="qindex" href="modules.html">Modules</a> | <a class="qindex" href="classes.html">Alphabetical&nbsp;List</a> | <a class="qindex" href="annotated.html">Data&nbsp;Structures</a> | <a class="qindex" href="files.html">File&nbsp;List</a> | <a class="qindex" href="functions.html">Data&nbsp;Fields</a> | <a class="qindex" href="globals.html">Globals</a> | <a class="qindex" href="pages.html">Related&nbsp;Pages</a></div>
<h1>src/main/module.c</h1><a href="module_8c.html">Go to the documentation of this file.</a><div class="fragment"><pre>00001 <span class="comment">/*</span>
00002 <span class="comment"> * "$Id: module_8c-source.html,v 1.1.1.2 2004/12/22 23:49:05 jlovell Exp $"</span>
00003 <span class="comment"> *</span>
00004 <span class="comment"> *   libgimpprint module loader - load modules with libltdl/libdl.</span>
00005 <span class="comment"> *</span>
00006 <span class="comment"> *   Copyright 2002 Roger Leigh (rleigh@debian.org)</span>
00007 <span class="comment"> *</span>
00008 <span class="comment"> *   This program is free software; you can redistribute it and/or modify it</span>
00009 <span class="comment"> *   under the terms of the GNU General Public License as published by the Free</span>
00010 <span class="comment"> *   Software Foundation; either version 2 of the License, or (at your option)</span>
00011 <span class="comment"> *   any later version.</span>
00012 <span class="comment"> *</span>
00013 <span class="comment"> *   This program is distributed in the hope that it will be useful, but</span>
00014 <span class="comment"> *   WITHOUT ANY WARRANTY; without even the implied warranty of MERCHANTABILITY</span>
00015 <span class="comment"> *   or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License</span>
00016 <span class="comment"> *   for more details.</span>
00017 <span class="comment"> *</span>
00018 <span class="comment"> *   You should have received a copy of the GNU General Public License</span>
00019 <span class="comment"> *   along with this program; if not, write to the Free Software</span>
00020 <span class="comment"> *   Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA 02111-1307, USA.</span>
00021 <span class="comment"> */</span>
00022 
00023 <span class="preprocessor">#ifdef HAVE_CONFIG_H</span>
00024 <span class="preprocessor"></span><span class="preprocessor">#include &lt;config.h&gt;</span>
00025 <span class="preprocessor">#endif</span>
00026 <span class="preprocessor"></span><span class="preprocessor">#include &lt;<a class="code" href="gimp-print_8h.html">gimp-print/gimp-print.h</a>&gt;</span>
00027 <span class="preprocessor">#include "<a class="code" href="gimp-print-internal_8h.html">gimp-print-internal.h</a>"</span>
00028 <span class="preprocessor">#include &lt;<a class="code" href="gimp-print-intl-internal_8h.html">gimp-print/gimp-print-intl-internal.h</a>&gt;</span>
00029 <span class="preprocessor">#include &lt;stdio.h&gt;</span>
00030 <span class="preprocessor">#include &lt;stdlib.h&gt;</span>
00031 <span class="preprocessor">#include &lt;string.h&gt;</span>
00032 <span class="preprocessor">#include &lt;libgen.h&gt;</span>
00033 <span class="preprocessor">#include &lt;errno.h&gt;</span>
00034 <span class="preprocessor">#include &lt;unistd.h&gt;</span>
00035 
00036 
<a name="l00037"></a><a class="code" href="structstpi__internal__module__class.html">00037</a> <span class="keyword">typedef</span> <span class="keyword">struct </span><a class="code" href="structstpi__internal__module__class.html">stpi_internal_module_class</a>
00038 {
<a name="l00039"></a><a class="code" href="structstpi__internal__module__class.html#o0">00039</a>   <a class="code" href="module_8h.html#a13">stp_module_class_t</a> <span class="keyword">class</span>;
<a name="l00040"></a><a class="code" href="structstpi__internal__module__class.html#o1">00040</a>   <span class="keyword">const</span> <span class="keywordtype">char</span> *<a class="code" href="structstpi__internal__module__class.html#o1">description</a>;
00041 } <a class="code" href="structstpi__internal__module__class.html">stpi_internal_module_class_t</a>;
00042 
00043 
00044 <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="module_8c.html#a12">module_list_freefunc</a>(<span class="keywordtype">void</span> *item);
00045 <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="module_8c.html#a13">stp_module_register</a>(<a class="code" href="structstp__module.html">stp_module_t</a> *module);
00046 <span class="preprocessor">#ifdef USE_DLOPEN</span>
00047 <span class="preprocessor"></span><span class="keyword">static</span> <span class="keywordtype">void</span> *stp_dlsym(<span class="keywordtype">void</span> *handle, <span class="keyword">const</span> <span class="keywordtype">char</span> *symbol, <span class="keyword">const</span> <span class="keywordtype">char</span> *modulename);
00048 <span class="preprocessor">#endif</span>
00049 <span class="preprocessor"></span>
<a name="l00050"></a><a class="code" href="module_8c.html#a1">00050</a> <span class="keyword">static</span> <span class="keyword">const</span> <a class="code" href="structstpi__internal__module__class.html">stpi_internal_module_class_t</a> <a class="code" href="module_8c.html#a1">module_classes</a>[] =
00051   {
00052     {<a class="code" href="module_8h.html#a13a3">STP_MODULE_CLASS_MISC</a>, <a class="code" href="group__intl__internal.html#ga6">N_</a>(<span class="stringliteral">"Miscellaneous (unclassified)"</span>)},
00053     {<a class="code" href="module_8h.html#a13a4">STP_MODULE_CLASS_FAMILY</a>, <a class="code" href="group__intl__internal.html#ga6">N_</a>(<span class="stringliteral">"Family driver"</span>)},
00054     {<a class="code" href="module_8h.html#a13a5">STP_MODULE_CLASS_COLOR</a>, <a class="code" href="group__intl__internal.html#ga6">N_</a>(<span class="stringliteral">"Color conversion module"</span>)},
00055     {<a class="code" href="module_8h.html#a13a6">STP_MODULE_CLASS_DITHER</a>, <a class="code" href="group__intl__internal.html#ga6">N_</a>(<span class="stringliteral">"Dither algorithm"</span>)},
00056     {<a class="code" href="module_8h.html#a13a2">STP_MODULE_CLASS_INVALID</a>, NULL} <span class="comment">/* Must be last */</span>
00057   };
00058 
00059 <span class="preprocessor">#if !defined(USE_LTDL) &amp;&amp; !defined(USE_DLOPEN)</span>
<a name="l00060"></a><a class="code" href="module_8c.html#a2">00060</a> <span class="preprocessor"></span><span class="keyword">extern</span> <a class="code" href="structstp__module.html">stp_module_t</a> <a class="code" href="module_8c.html#a2">print_canon_LTX_stp_module_data</a>;
<a name="l00061"></a><a class="code" href="module_8c.html#a3">00061</a> <span class="keyword">extern</span> <a class="code" href="structstp__module.html">stp_module_t</a> <a class="code" href="module_8c.html#a3">print_escp2_LTX_stp_module_data</a>;
<a name="l00062"></a><a class="code" href="module_8c.html#a4">00062</a> <span class="keyword">extern</span> <a class="code" href="structstp__module.html">stp_module_t</a> <a class="code" href="module_8c.html#a4">print_lexmark_LTX_stp_module_data</a>;
<a name="l00063"></a><a class="code" href="module_8c.html#a5">00063</a> <span class="keyword">extern</span> <a class="code" href="structstp__module.html">stp_module_t</a> <a class="code" href="module_8c.html#a5">print_pcl_LTX_stp_module_data</a>;
<a name="l00064"></a><a class="code" href="module_8c.html#a6">00064</a> <span class="keyword">extern</span> <a class="code" href="structstp__module.html">stp_module_t</a> <a class="code" href="module_8c.html#a6">print_ps_LTX_stp_module_data</a>;
<a name="l00065"></a><a class="code" href="module_8c.html#a7">00065</a> <span class="keyword">extern</span> <a class="code" href="structstp__module.html">stp_module_t</a> <a class="code" href="module_8c.html#a7">print_olympus_LTX_stp_module_data</a>;
<a name="l00066"></a><a class="code" href="module_8c.html#a8">00066</a> <span class="keyword">extern</span> <a class="code" href="structstp__module.html">stp_module_t</a> <a class="code" href="module_8c.html#a8">print_raw_LTX_stp_module_data</a>;
<a name="l00067"></a><a class="code" href="module_8c.html#a9">00067</a> <span class="keyword">extern</span> <a class="code" href="structstp__module.html">stp_module_t</a> <a class="code" href="module_8c.html#a9">color_traditional_LTX_stp_module_data</a>;
00068 
00069 <span class="comment">/*</span>
00070 <span class="comment"> * A list of modules, for use when the modules are linked statically.</span>
00071 <span class="comment"> */</span>
<a name="l00072"></a><a class="code" href="module_8c.html#a10">00072</a> <span class="keyword">static</span> <a class="code" href="structstp__module.html">stp_module_t</a> *<a class="code" href="module_8c.html#a10">static_modules</a>[] =
00073   {
00074     &amp;<a class="code" href="module_8c.html#a6">print_ps_LTX_stp_module_data</a>,
00075     &amp;<a class="code" href="module_8c.html#a2">print_canon_LTX_stp_module_data</a>,
00076     &amp;<a class="code" href="module_8c.html#a3">print_escp2_LTX_stp_module_data</a>,
00077     &amp;<a class="code" href="module_8c.html#a5">print_pcl_LTX_stp_module_data</a>,
00078     &amp;<a class="code" href="module_8c.html#a4">print_lexmark_LTX_stp_module_data</a>,
00079     &amp;<a class="code" href="module_8c.html#a7">print_olympus_LTX_stp_module_data</a>,
00080     &amp;<a class="code" href="module_8c.html#a8">print_raw_LTX_stp_module_data</a>,
00081     &amp;<a class="code" href="module_8c.html#a9">color_traditional_LTX_stp_module_data</a>,
00082     NULL
00083   };
00084 <span class="preprocessor">#endif</span>
00085 <span class="preprocessor"></span>
<a name="l00086"></a><a class="code" href="module_8c.html#a11">00086</a> <span class="keyword">static</span> <a class="code" href="structstp__list.html">stp_list_t</a> *<a class="code" href="module_8c.html#a11">module_list</a> = NULL;
00087 
00088 
00089 <span class="comment">/*</span>
00090 <span class="comment"> * Callback for removing a module from stp_module_list.</span>
00091 <span class="comment"> */</span>
00092 <span class="keyword">static</span> <span class="keywordtype">void</span>
<a name="l00093"></a><a class="code" href="module_8c.html#a12">00093</a> <a class="code" href="module_8c.html#a12">module_list_freefunc</a>(<span class="keywordtype">void</span> *item <span class="comment">/* module to remove */</span>)
00094 {
00095   <a class="code" href="structstp__module.html">stp_module_t</a> *module = (<a class="code" href="structstp__module.html">stp_module_t</a> *) item;
00096   <span class="keywordflow">if</span> (module &amp;&amp; module-&gt;<a class="code" href="structstp__module.html#o6">fini</a>) <span class="comment">/* Call the module exit function */</span>
00097     module-&gt;<a class="code" href="structstp__module.html#o6">fini</a>();
00098 <span class="preprocessor">#if defined(USE_LTDL) || defined(USE_DLOPEN)</span>
00099 <span class="preprocessor"></span>  DLCLOSE(module-&gt;<a class="code" href="structstp__module.html#o4">handle</a>); <span class="comment">/* Close the module if it's not static */</span>
00100 <span class="preprocessor">#endif</span>
00101 <span class="preprocessor"></span>}
00102 
00103 
00104 <span class="comment">/*</span>
00105 <span class="comment"> * Load all available modules.  Return nonzero on failure.</span>
00106 <span class="comment"> */</span>
<a name="l00107"></a><a class="code" href="module_8c.html#a14">00107</a> <span class="keywordtype">int</span> <a class="code" href="module_8h.html#a7">stp_module_load</a>(<span class="keywordtype">void</span>)
00108 {
00109   <span class="comment">/* initialise libltdl */</span>
00110 <span class="preprocessor">#ifdef USE_LTDL</span>
00111 <span class="preprocessor"></span>  <span class="keyword">static</span> <span class="keywordtype">int</span> ltdl_is_initialised = 0;        <span class="comment">/* Is libltdl initialised? */</span>
00112 <span class="preprocessor">#endif</span>
00113 <span class="preprocessor"></span>  <span class="keyword">static</span> <span class="keywordtype">int</span> module_list_is_initialised = 0; <span class="comment">/* Is the module list initialised? */</span>
00114 <span class="preprocessor">#if defined(USE_LTDL) || defined(USE_DLOPEN)</span>
00115 <span class="preprocessor"></span>  <a class="code" href="structstp__list.html">stp_list_t</a> *dir_list;                      <span class="comment">/* List of directories to scan */</span>
00116   <a class="code" href="structstp__list.html">stp_list_t</a> *file_list;                     <span class="comment">/* List of modules to open */</span>
00117   <a class="code" href="structstp__list__item.html">stp_list_item_t</a> *file;                     <span class="comment">/* Pointer to current module */</span>
00118 <span class="preprocessor">#endif</span>
00119 <span class="preprocessor"></span>
00120 <span class="preprocessor">#ifdef USE_LTDL</span>
00121 <span class="preprocessor"></span>  <span class="keywordflow">if</span> (!ltdl_is_initialised)
00122     {
00123       <span class="keywordflow">if</span> (lt_dlinit())
00124         {
00125           <a class="code" href="print-util_8c.html#a20">stp_erprintf</a>(<span class="stringliteral">"Error initialising libltdl: %s\n"</span>, DLERROR());
00126           <span class="keywordflow">return</span> 1;
00127         }
00128       ltdl_is_initialised = 1;
00129     }
00130   <span class="comment">/* set default search paths */</span>
00131   lt_dladdsearchdir(PKGMODULEDIR);
00132 <span class="preprocessor">#endif</span>
00133 <span class="preprocessor"></span>
00134   <span class="comment">/* initialise module_list */</span>
00135   <span class="keywordflow">if</span> (!module_list_is_initialised)
00136     {
00137       <span class="keywordflow">if</span> (!(<a class="code" href="module_8c.html#a11">module_list</a> = <a class="code" href="list_8h.html#a7">stp_list_create</a>()))
00138         <span class="keywordflow">return</span> 1;
00139       <a class="code" href="print-list_8c.html#a19">stp_list_set_freefunc</a>(<a class="code" href="module_8c.html#a11">module_list</a>, <a class="code" href="module_8c.html#a12">module_list_freefunc</a>);
00140       module_list_is_initialised = 1;
00141     }
00142 
00143   <span class="comment">/* search for available modules */</span>
00144 <span class="preprocessor">#if defined (USE_LTDL) || defined (USE_DLOPEN)</span>
00145 <span class="preprocessor"></span>  <span class="keywordflow">if</span> (!(dir_list = <a class="code" href="list_8h.html#a7">stp_list_create</a>()))
00146     <span class="keywordflow">return</span> 1;
00147   <a class="code" href="print-list_8c.html#a19">stp_list_set_freefunc</a>(dir_list, <a class="code" href="list_8h.html#a6">stp_list_node_free_data</a>);
00148   <span class="keywordflow">if</span> (getenv(<span class="stringliteral">"STP_MODULE_PATH"</span>))
00149     {
00150       <a class="code" href="path_8c.html#a9">stp_path_split</a>(dir_list, getenv(<span class="stringliteral">"STP_MODULE_PATH"</span>));
00151     }
00152   <span class="keywordflow">else</span>
00153     {
00154 <span class="preprocessor">#ifdef USE_LTDL</span>
00155 <span class="preprocessor"></span>      <a class="code" href="path_8c.html#a9">stp_path_split</a>(dir_list, getenv(<span class="stringliteral">"LTDL_LIBRARY_PATH"</span>));
00156       <a class="code" href="path_8c.html#a9">stp_path_split</a>(dir_list, lt_dlgetsearchpath());
00157 <span class="preprocessor">#else</span>
00158 <span class="preprocessor"></span>      <a class="code" href="path_8c.html#a9">stp_path_split</a>(dir_list, PKGMODULEDIR);
00159 <span class="preprocessor">#endif</span>
00160 <span class="preprocessor"></span>    }
00161 <span class="preprocessor">#ifdef USE_LTDL</span>
00162 <span class="preprocessor"></span>  file_list = <a class="code" href="path_8c.html#a8">stp_path_search</a>(dir_list, <span class="stringliteral">".la"</span>);
00163 <span class="preprocessor">#else</span>
00164 <span class="preprocessor"></span>  file_list = <a class="code" href="path_8c.html#a8">stp_path_search</a>(dir_list, <span class="stringliteral">".so"</span>);
00165 <span class="preprocessor">#endif</span>
00166 <span class="preprocessor"></span>  <a class="code" href="print-list_8c.html#a10">stp_list_destroy</a>(dir_list);
00167 
00168   <span class="comment">/* load modules */</span>
00169   file = <a class="code" href="print-list_8c.html#a12">stp_list_get_start</a>(file_list);
00170   <span class="keywordflow">while</span> (file)
00171     {
00172       <a class="code" href="module_8c.html#a17">stp_module_open</a>((<span class="keyword">const</span> <span class="keywordtype">char</span> *) <a class="code" href="print-list_8c.html#a33">stp_list_item_get_data</a>(file));
00173       file = <a class="code" href="print-list_8c.html#a32">stp_list_item_next</a>(file);
00174     }
00175 
00176   <a class="code" href="print-list_8c.html#a10">stp_list_destroy</a>(file_list);
00177 <span class="preprocessor">#else </span><span class="comment">/* use a static module list */</span>
00178   {
00179     <span class="keywordtype">int</span> i=0;
00180     <span class="keywordflow">while</span> (<a class="code" href="module_8c.html#a10">static_modules</a>[i])
00181       {
00182         <a class="code" href="module_8c.html#a13">stp_module_register</a>(<a class="code" href="module_8c.html#a10">static_modules</a>[i]);
00183         i++;
00184       }
00185   }
00186 <span class="preprocessor">#endif</span>
00187 <span class="preprocessor"></span>  <span class="keywordflow">return</span> 0;
00188   }
00189 
00190 
00191 <span class="comment">/*</span>
00192 <span class="comment"> * Unload all modules and clean up.</span>
00193 <span class="comment"> */</span>
00194 <span class="keywordtype">int</span>
<a name="l00195"></a><a class="code" href="module_8c.html#a15">00195</a> <a class="code" href="module_8h.html#a8">stp_module_exit</a>(<span class="keywordtype">void</span>)
00196 {
00197   <span class="comment">/* destroy the module list (modules unloaded by callback) */</span>
00198   <span class="keywordflow">if</span> (<a class="code" href="module_8c.html#a11">module_list</a>)
00199     <a class="code" href="print-list_8c.html#a10">stp_list_destroy</a>(<a class="code" href="module_8c.html#a11">module_list</a>);
00200   <span class="comment">/* shut down libltdl (forces close of any unclosed modules) */</span>
00201 <span class="preprocessor">#ifdef USE_LTDL</span>
00202 <span class="preprocessor"></span>  <span class="keywordflow">return</span> lt_dlexit();
00203 <span class="preprocessor">#else</span>
00204 <span class="preprocessor"></span>  <span class="keywordflow">return</span> 0;
00205 <span class="preprocessor">#endif</span>
00206 <span class="preprocessor"></span>}
00207 
00208 
00209 <span class="comment">/*</span>
00210 <span class="comment"> * Find all modules in a given class.</span>
00211 <span class="comment"> */</span>
00212 <a class="code" href="structstp__list.html">stp_list_t</a> *
<a name="l00213"></a><a class="code" href="module_8c.html#a16">00213</a> <a class="code" href="module_8c.html#a16">stp_module_get_class</a>(stp_module_class_t <span class="keyword">class</span> <span class="comment">/* Module class */</span>)
00214 {
00215   <a class="code" href="structstp__list.html">stp_list_t</a> *list;                           <span class="comment">/* List to return */</span>
00216   <a class="code" href="structstp__list__item.html">stp_list_item_t</a> *ln;                        <span class="comment">/* Module to check*/</span>
00217 
00218   list = <a class="code" href="list_8h.html#a7">stp_list_create</a>(); <span class="comment">/* No freefunc, so it can be destroyed</span>
00219 <span class="comment">                               without unloading any modules! */</span>
00220   <span class="keywordflow">if</span> (!list)
00221     <span class="keywordflow">return</span> NULL;
00222 
00223   ln = <a class="code" href="print-list_8c.html#a12">stp_list_get_start</a>(<a class="code" href="module_8c.html#a11">module_list</a>);
00224   <span class="keywordflow">while</span> (ln)
00225     {
00226       <span class="comment">/* Add modules of the same class to our list */</span>
00227       <span class="keywordflow">if</span> (((<a class="code" href="structstp__module.html">stp_module_t</a> *) <a class="code" href="print-list_8c.html#a33">stp_list_item_get_data</a>(ln))-&gt;class == <span class="keyword">class</span>)
00228         <a class="code" href="print-list_8c.html#a29">stp_list_item_create</a>(list, NULL, <a class="code" href="print-list_8c.html#a33">stp_list_item_get_data</a>(ln));
00229       ln = <a class="code" href="print-list_8c.html#a32">stp_list_item_next</a>(ln);
00230     }
00231   <span class="keywordflow">return</span> list;
00232 }
00233 
00234 
00235 <span class="comment">/*</span>
00236 <span class="comment"> * Open a module.</span>
00237 <span class="comment"> */</span>
00238 <span class="keywordtype">int</span>
<a name="l00239"></a><a class="code" href="module_8c.html#a17">00239</a> <a class="code" href="module_8c.html#a17">stp_module_open</a>(<span class="keyword">const</span> <span class="keywordtype">char</span> *modulename <span class="comment">/* Module filename */</span>)
00240 {
00241 <span class="preprocessor">#if defined(USE_LTDL) || defined(USE_DLOPEN)</span>
00242 <span class="preprocessor"></span><span class="preprocessor">#ifdef USE_LTDL</span>
00243 <span class="preprocessor"></span>  lt_dlhandle module;                  <span class="comment">/* Handle for module */</span>
00244 <span class="preprocessor">#else</span>
00245 <span class="preprocessor"></span>  <span class="keywordtype">void</span> *module;                        <span class="comment">/* Handle for module */</span>
00246 <span class="preprocessor">#endif</span>
00247 <span class="preprocessor"></span>  <a class="code" href="structstp__module__version.html">stp_module_version_t</a> *version;       <span class="comment">/* Module version */</span>
00248   <a class="code" href="structstp__module.html">stp_module_t</a> *data;                  <span class="comment">/* Module data */</span>
00249   <a class="code" href="structstp__list__item.html">stp_list_item_t</a> *reg_module;         <span class="comment">/* Pointer to module list nodes */</span>
00250   <span class="keywordtype">int</span> error = 0;                       <span class="comment">/* Error status */</span>
00251 
00252   <a class="code" href="print-util_8c.html#a24">stp_deprintf</a>(<a class="code" href="group__util.html#ga43">STP_DBG_MODULE</a>, <span class="stringliteral">"stp-module: open: %s\n"</span>, modulename);
00253   <span class="keywordflow">while</span>(1)
00254     {
00255       module = DLOPEN(modulename);
00256       <span class="keywordflow">if</span> (!module)
00257         <span class="keywordflow">break</span>;
00258 
00259       <span class="comment">/* check version is valid */</span>
00260       version = (<a class="code" href="structstp__module__version.html">stp_module_version_t</a> *) DLSYM(module, <span class="stringliteral">"stp_module_version"</span>);
00261       <span class="keywordflow">if</span> (!version)
00262         <span class="keywordflow">break</span>;
00263       <span class="keywordflow">if</span> (version-&gt;<a class="code" href="structstp__module__version.html#o0">major</a> != 1 &amp;&amp; version-&gt;<a class="code" href="structstp__module__version.html#o1">minor</a> &lt; 0)
00264         <span class="keywordflow">break</span>;
00265 
00266       data = (<span class="keywordtype">void</span> *) DLSYM(module, <span class="stringliteral">"stp_module_data"</span>);
00267       <span class="keywordflow">if</span> (!data)
00268         <span class="keywordflow">break</span>;
00269       data-&gt;<a class="code" href="structstp__module.html#o4">handle</a> = module; <span class="comment">/* store module handle */</span>
00270 
00271       <span class="comment">/* check same module isn't already loaded */</span>
00272       reg_module = <a class="code" href="print-list_8c.html#a12">stp_list_get_start</a>(<a class="code" href="module_8c.html#a11">module_list</a>);
00273       <span class="keywordflow">while</span> (reg_module)
00274         {
00275           <span class="keywordflow">if</span> (!strcmp(data-&gt;<a class="code" href="structstp__module.html#o0">name</a>, ((<a class="code" href="structstp__module.html">stp_module_t</a> *)
00276                                    <a class="code" href="list_8h.html#a30">stp_list_item_get_data</a>(reg_module))-&gt;name) &amp;&amp;
00277               data-&gt;<a class="code" href="structstp__module.html#o3">class</a> == ((<a class="code" href="structstp__module.html">stp_module_t</a> *)
00278                               <a class="code" href="print-list_8c.html#a33">stp_list_item_get_data</a>(reg_module))-&gt;class)
00279             {
00280               <a class="code" href="print-util_8c.html#a24">stp_deprintf</a>(<a class="code" href="group__util.html#ga43">STP_DBG_MODULE</a>,
00281                             <span class="stringliteral">"stp-module: reject duplicate: %s\n"</span>,
00282                             data-&gt;<a class="code" href="structstp__module.html#o0">name</a>);
00283               error = 1;
00284               <span class="keywordflow">break</span>;
00285             }
00286           reg_module = <a class="code" href="print-list_8c.html#a32">stp_list_item_next</a>(reg_module);
00287         }
00288       <span class="keywordflow">if</span> (error)
00289         <span class="keywordflow">break</span>;
00290 
00291       <span class="comment">/* Register the module */</span>
00292       <span class="keywordflow">if</span> (<a class="code" href="module_8c.html#a13">stp_module_register</a>(data))
00293         <span class="keywordflow">break</span>;
00294 
00295       <span class="keywordflow">return</span> 0;
00296     }
00297 
00298   <span class="keywordflow">if</span> (module)
00299     DLCLOSE(module);
00300 <span class="preprocessor">#endif</span>
00301 <span class="preprocessor"></span>  <span class="keywordflow">return</span> 1;
00302 }
00303 
00304 
00305 <span class="comment">/*</span>
00306 <span class="comment"> * Register a loaded module.</span>
00307 <span class="comment"> */</span>
<a name="l00308"></a><a class="code" href="module_8c.html#a13">00308</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="module_8c.html#a13">stp_module_register</a>(<a class="code" href="structstp__module.html">stp_module_t</a> *module <span class="comment">/* Module to register */</span>)
00309 {
00310   <span class="comment">/* Add to the module list */</span>
00311   <span class="keywordflow">if</span> (<a class="code" href="print-list_8c.html#a29">stp_list_item_create</a>(<a class="code" href="module_8c.html#a11">module_list</a>, NULL, module))
00312     <span class="keywordflow">return</span> 1;
00313 
00314   <a class="code" href="print-util_8c.html#a24">stp_deprintf</a>(<a class="code" href="group__util.html#ga43">STP_DBG_MODULE</a>, <span class="stringliteral">"stp-module: register: %s\n"</span>, module-&gt;<a class="code" href="structstp__module.html#o0">name</a>);
00315   <span class="keywordflow">return</span> 0;
00316 }
00317 
00318 
00319 <span class="comment">/*</span>
00320 <span class="comment"> * Initialise all loaded modules</span>
00321 <span class="comment"> */</span>
<a name="l00322"></a><a class="code" href="module_8c.html#a18">00322</a> <span class="keywordtype">int</span> <a class="code" href="module_8h.html#a10">stp_module_init</a>(<span class="keywordtype">void</span>)
00323 {
00324   <a class="code" href="structstp__list__item.html">stp_list_item_t</a> *module_item; <span class="comment">/* Module list pointer */</span>
00325   <a class="code" href="structstp__module.html">stp_module_t</a> *module;         <span class="comment">/* Module to initialise */</span>
00326 
00327   module_item = <a class="code" href="print-list_8c.html#a12">stp_list_get_start</a>(<a class="code" href="module_8c.html#a11">module_list</a>);
00328   <span class="keywordflow">while</span> (module_item)
00329     {
00330       module = (<a class="code" href="structstp__module.html">stp_module_t</a> *) <a class="code" href="print-list_8c.html#a33">stp_list_item_get_data</a>(module_item);
00331       <span class="keywordflow">if</span> (module)
00332         {
00333           <a class="code" href="print-util_8c.html#a24">stp_deprintf</a>(<a class="code" href="group__util.html#ga43">STP_DBG_MODULE</a>, <span class="stringliteral">"stp-module-init: %s\n"</span>, module-&gt;<a class="code" href="structstp__module.html#o0">name</a>);
00334           <span class="comment">/* Initialise module */</span>
00335           <span class="keywordflow">if</span> (module-&gt;<a class="code" href="structstp__module.html#o5">init</a> &amp;&amp; module-&gt;<a class="code" href="structstp__module.html#o5">init</a>())
00336             {
00337               <a class="code" href="print-util_8c.html#a24">stp_deprintf</a>(<a class="code" href="group__util.html#ga43">STP_DBG_MODULE</a>,
00338                            <span class="stringliteral">"stp-module-init: %s: Module init failed\n"</span>,
00339                            module-&gt;<a class="code" href="structstp__module.html#o0">name</a>);
00340             }
00341         }
00342       module_item = <a class="code" href="print-list_8c.html#a32">stp_list_item_next</a>(module_item);
00343     }
00344   <span class="keywordflow">return</span> 0;
00345 }
00346 
00347 
00348 
00349 <span class="comment">/*</span>
00350 <span class="comment"> * Close a module.</span>
00351 <span class="comment"> */</span>
00352 <span class="keywordtype">int</span>
<a name="l00353"></a><a class="code" href="module_8c.html#a19">00353</a> <a class="code" href="module_8c.html#a19">stp_module_close</a>(<a class="code" href="structstp__list__item.html">stp_list_item_t</a> *module <span class="comment">/* Module to close */</span>)
00354 {
00355   <span class="keywordflow">return</span> <a class="code" href="print-list_8c.html#a30">stp_list_item_destroy</a>(<a class="code" href="module_8c.html#a11">module_list</a>, module);
00356 }
00357 
00358 
00359 <span class="comment">/*</span>
00360 <span class="comment"> * If using dlopen, add modulename_LTX_ to symbol name</span>
00361 <span class="comment"> */</span>
00362 <span class="preprocessor">#ifdef USE_DLOPEN</span>
00363 <span class="preprocessor"></span><span class="keyword">static</span> <span class="keywordtype">void</span> *stp_dlsym(<span class="keywordtype">void</span> *handle,           <span class="comment">/* Module */</span>
00364                        <span class="keyword">const</span> <span class="keywordtype">char</span> *symbol,     <span class="comment">/* Symbol name */</span>
00365                        <span class="keyword">const</span> <span class="keywordtype">char</span> *modulename) <span class="comment">/* Module name */</span>
00366 {
00367   <span class="keywordtype">int</span> len;                                     <span class="comment">/* Length of string */</span>
00368   <span class="keyword">static</span> <span class="keywordtype">char</span> *full_symbol = NULL;             <span class="comment">/* Symbol to return */</span>
00369   <span class="keywordtype">char</span> *module;                                <span class="comment">/* Real module name */</span>
00370   <span class="keywordtype">char</span> *tmp = <a class="code" href="group__util.html#ga35">stp_strdup</a>(modulename);          <span class="comment">/* Temporary string */</span>
00371 
00372   module = basename(tmp);
00373 
00374   <span class="keywordflow">if</span> (full_symbol)
00375     {
00376       <a class="code" href="group__util.html#ga31">stp_free</a> (full_symbol);
00377       full_symbol = NULL;
00378     }
00379 
00380   full_symbol = (<span class="keywordtype">char</span> *) <a class="code" href="group__util.html#ga28">stp_malloc</a>(<span class="keyword">sizeof</span>(<span class="keywordtype">char</span>) * (strlen(module) - 2));
00381 
00382   <span class="comment">/* "_LTX_" + '\0' - ".so" */</span>
00383   len = strlen(symbol) + strlen(module) + 3;
00384   full_symbol = (<span class="keywordtype">char</span> *) <a class="code" href="group__util.html#ga28">stp_malloc</a>(<span class="keyword">sizeof</span>(<span class="keywordtype">char</span>) * len);
00385 
00386   len = 0;
00387   strncpy (full_symbol, module, strlen(module) - 3);
00388   len = strlen(module) - 3;
00389   strcpy (full_symbol+len, <span class="stringliteral">"_LTX_"</span>);
00390   len += 5;
00391   strcpy (full_symbol+len, symbol);
00392   len += strlen(symbol);
00393   full_symbol[len] = <span class="charliteral">'\0'</span>;
00394 
00395 <span class="preprocessor">#if defined(__OpenBSD__)</span>
00396 <span class="preprocessor"></span><span class="comment">/* OpenBSD needs a prepended underscore to match symbols */</span>
00397  {
00398    <span class="keywordtype">char</span> *prefix_symbol = <a class="code" href="group__util.html#ga28">stp_malloc</a>(<span class="keyword">sizeof</span>(<span class="keywordtype">char</span>) * (strlen(full_symbol) + 2));
00399    prefix_symbol[0] = <span class="charliteral">'_'</span>;
00400    strcpy(prefix_symbol+1, full_symbol);
00401    <a class="code" href="group__util.html#ga31">stp_free</a>(full_symbol);
00402    full_symbol = prefix_symbol;
00403  }
00404 <span class="preprocessor">#endif</span>
00405 <span class="preprocessor"></span>
00406  <span class="comment">/* Change any hyphens to underscores */</span>
00407  <span class="keywordflow">for</span> (len = 0; full_symbol[len] != <span class="charliteral">'\0'</span>; len++)
00408    <span class="keywordflow">if</span> (full_symbol[len] == <span class="charliteral">'-'</span>)
00409      full_symbol[len] = <span class="charliteral">'_'</span>;
00410 
00411  <a class="code" href="print-util_8c.html#a24">stp_deprintf</a>(STP_DBG_MODULE, <span class="stringliteral">"SYMBOL: %s\n"</span>, full_symbol);
00412 
00413   <span class="keywordflow">return</span> dlsym(handle, full_symbol);
00414 }
00415 <span class="preprocessor">#endif</span>
</pre></div><hr size="1"><address style="align: right;"><small>Generated on Wed Aug 25 07:56:14 2004 for libgimpprint API Reference by
<a href="http://www.doxygen.org/index.html">
<img src="doxygen.png" alt="doxygen" align="middle" border=0 > </a>1.3.6 </small></address>
</body>
</html>
