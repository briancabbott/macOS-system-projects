<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>libgimpprint API Reference: src/main/dither-eventone.c Source File</title>
<link href="doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.6 -->
<div class="qindex"><a class="qindex" href="index.html">Main&nbsp;Page</a> | <a class="qindex" href="modules.html">Modules</a> | <a class="qindex" href="classes.html">Alphabetical&nbsp;List</a> | <a class="qindex" href="annotated.html">Data&nbsp;Structures</a> | <a class="qindex" href="files.html">File&nbsp;List</a> | <a class="qindex" href="functions.html">Data&nbsp;Fields</a> | <a class="qindex" href="globals.html">Globals</a> | <a class="qindex" href="pages.html">Related&nbsp;Pages</a></div>
<h1>src/main/dither-eventone.c</h1><a href="dither-eventone_8c.html">Go to the documentation of this file.</a><div class="fragment"><pre>00001 <span class="comment">/*</span>
00002 <span class="comment"> * "$Id: dither-eventone_8c-source.html,v 1.1.1.2 2004/12/22 23:48:58 jlovell Exp $"</span>
00003 <span class="comment"> *</span>
00004 <span class="comment"> *   EvenTone dither implementation for Gimp-Print</span>
00005 <span class="comment"> *</span>
00006 <span class="comment"> *   Copyright 2002-2003 Mark Tomlinson (mark@southern.co.nz)</span>
00007 <span class="comment"> *</span>
00008 <span class="comment"> *   This program is free software; you can redistribute it and/or modify it</span>
00009 <span class="comment"> *   under the terms of the GNU General Public License as published by the Free</span>
00010 <span class="comment"> *   Software Foundation; either version 2 of the License, or (at your option)</span>
00011 <span class="comment"> *   any later version.</span>
00012 <span class="comment"> *</span>
00013 <span class="comment"> *   This program is distributed in the hope that it will be useful, but</span>
00014 <span class="comment"> *   WITHOUT ANY WARRANTY; without even the implied warranty of MERCHANTABILITY</span>
00015 <span class="comment"> *   or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License</span>
00016 <span class="comment"> *   for more details.</span>
00017 <span class="comment"> *</span>
00018 <span class="comment"> *   You should have received a copy of the GNU General Public License</span>
00019 <span class="comment"> *   along with this program; if not, write to the Free Software</span>
00020 <span class="comment"> *   Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA 02111-1307, USA.</span>
00021 <span class="comment"> *</span>
00022 <span class="comment"> *   This code uses the Eventone dither algorithm. This is described</span>
00023 <span class="comment"> *   at the website http://www.artofcode.com/eventone/</span>
00024 <span class="comment"> *   This algorithm is covered by US Patents 5,055,942 and 5,917,614</span>
00025 <span class="comment"> *   and was invented by Raph Levien &lt;raph@acm.org&gt;</span>
00026 <span class="comment"> *   It was made available to be used free of charge in GPL-licensed</span>
00027 <span class="comment"> */</span>
00028 
00029 <span class="preprocessor">#ifdef HAVE_CONFIG_H</span>
00030 <span class="preprocessor"></span><span class="preprocessor">#include &lt;config.h&gt;</span>
00031 <span class="preprocessor">#endif</span>
00032 <span class="preprocessor"></span><span class="preprocessor">#include &lt;<a class="code" href="gimp-print_8h.html">gimp-print/gimp-print.h</a>&gt;</span>
00033 <span class="preprocessor">#include "<a class="code" href="gimp-print-internal_8h.html">gimp-print-internal.h</a>"</span>
00034 <span class="preprocessor">#include &lt;<a class="code" href="gimp-print-intl-internal_8h.html">gimp-print/gimp-print-intl-internal.h</a>&gt;</span>
00035 <span class="preprocessor">#include &lt;string.h&gt;</span>
00036 <span class="preprocessor">#include &lt;math.h&gt;</span>
00037 <span class="preprocessor">#include &lt;limits.h&gt;</span>
00038 <span class="preprocessor">#include "<a class="code" href="dither-impl_8h.html">dither-impl.h</a>"</span>
00039 <span class="preprocessor">#include "<a class="code" href="dither-inlined-functions_8h.html">dither-inlined-functions.h</a>"</span>
00040 
<a name="l00041"></a><a class="code" href="structdistance__t.html">00041</a> <span class="keyword">typedef</span> <span class="keyword">struct</span>
00042 <span class="keyword"></span>{
<a name="l00043"></a><a class="code" href="structdistance__t.html#o0">00043</a>   <span class="keywordtype">int</span> dx;
<a name="l00044"></a><a class="code" href="structdistance__t.html#o1">00044</a>   <span class="keywordtype">int</span> dy;
<a name="l00045"></a><a class="code" href="structdistance__t.html#o2">00045</a>   <span class="keywordtype">int</span> r_sq;
00046 } <a class="code" href="structdistance__t.html">distance_t</a>;
00047 
<a name="l00048"></a><a class="code" href="structeventone__t.html">00048</a> <span class="keyword">typedef</span> <span class="keyword">struct</span>
00049 <span class="keyword"></span>{
<a name="l00050"></a><a class="code" href="structeventone__t.html#o0">00050</a>   <span class="keywordtype">int</span>   d2x;
<a name="l00051"></a><a class="code" href="structeventone__t.html#o1">00051</a>   <span class="keywordtype">int</span>   d2y;
<a name="l00052"></a><a class="code" href="structeventone__t.html#o2">00052</a>   <a class="code" href="structdistance__t.html">distance_t</a>    d_sq;
<a name="l00053"></a><a class="code" href="structeventone__t.html#o3">00053</a>   <span class="keywordtype">int</span>   aspect;
<a name="l00054"></a><a class="code" href="structeventone__t.html#o4">00054</a>   <span class="keywordtype">int</span>   unitone_aspect;
<a name="l00055"></a><a class="code" href="structeventone__t.html#o5">00055</a>   <span class="keywordtype">int</span>   physical_aspect;
<a name="l00056"></a><a class="code" href="structeventone__t.html#o6">00056</a>   <span class="keywordtype">int</span>   diff_factor;
<a name="l00057"></a><a class="code" href="structeventone__t.html#o7">00057</a>   <a class="code" href="structdither__channel.html">stpi_dither_channel_t</a> *dummy_channel;
00058 } <a class="code" href="structeventone__t.html">eventone_t</a>;
00059 
<a name="l00060"></a><a class="code" href="structshade__segment.html">00060</a> <span class="keyword">typedef</span> <span class="keyword">struct </span><a class="code" href="structshade__segment.html">shade_segment</a>
00061 {
<a name="l00062"></a><a class="code" href="structshade__segment.html#o0">00062</a>   <a class="code" href="structdistance__t.html">distance_t</a> <a class="code" href="structshade__segment.html#o0">dis</a>;
<a name="l00063"></a><a class="code" href="structshade__segment.html#o1">00063</a>   <a class="code" href="structdistance__t.html">distance_t</a> *<a class="code" href="structshade__segment.html#o1">et_dis</a>;
<a name="l00064"></a><a class="code" href="structshade__segment.html#o2">00064</a>   <a class="code" href="structink__defn.html">stpi_ink_defn_t</a> lower;
<a name="l00065"></a><a class="code" href="structshade__segment.html#o3">00065</a>   <a class="code" href="structink__defn.html">stpi_ink_defn_t</a> upper;
<a name="l00066"></a><a class="code" href="structshade__segment.html#o4">00066</a>   <span class="keywordtype">int</span> <a class="code" href="structshade__segment.html#o4">share_this_channel</a>;
00067 } <a class="code" href="structshade__segment.html">shade_distance_t</a>;
00068 
00069 
<a name="l00070"></a><a class="code" href="dither-eventone_8c.html#a0">00070</a> <span class="preprocessor">#define EVEN_C1 256</span>
<a name="l00071"></a><a class="code" href="dither-eventone_8c.html#a1">00071</a> <span class="preprocessor"></span><span class="preprocessor">#define EVEN_C2 (EVEN_C1 * sqrt(3.0) / 2.0)</span>
<a name="l00072"></a><a class="code" href="dither-eventone_8c.html#a2">00072</a> <span class="preprocessor"></span><span class="preprocessor">#define UNITONE_C1 16384</span>
<a name="l00073"></a><a class="code" href="dither-eventone_8c.html#a3">00073</a> <span class="preprocessor"></span><span class="preprocessor">#define UNITONE_C2 (UNITONE_C1 * sqrt(3.0) / 2.0)</span>
00074 <span class="preprocessor"></span>
00075 <span class="keyword">static</span> <span class="keywordtype">void</span>
<a name="l00076"></a><a class="code" href="dither-eventone_8c.html#a5">00076</a> <a class="code" href="dither-eventone_8c.html#a5">free_eventone_data</a>(<a class="code" href="structdither.html">stpi_dither_t</a> *d)
00077 {
00078   <span class="keywordtype">int</span> i;
00079   <a class="code" href="structeventone__t.html">eventone_t</a> *et = (<a class="code" href="structeventone__t.html">eventone_t</a> *) (d-&gt;<a class="code" href="structdither.html#o24">aux_data</a>);
00080   <span class="keywordflow">for</span> (i = 0; i &lt; <a class="code" href="dither-impl_8h.html#a17">CHANNEL_COUNT</a>(d); i++)
00081     {
00082       <span class="keywordflow">if</span> (<a class="code" href="dither-impl_8h.html#a16">CHANNEL</a>(d, i).aux_data)
00083         {
00084           <a class="code" href="structshade__segment.html">shade_distance_t</a> *shade = (<a class="code" href="structshade__segment.html">shade_distance_t</a> *) <a class="code" href="dither-impl_8h.html#a16">CHANNEL</a>(d,i).aux_data;
00085           <a class="code" href="group__util.html#ga52">STP_SAFE_FREE</a>(shade-&gt;<a class="code" href="structshade__segment.html#o1">et_dis</a>);
00086           <a class="code" href="group__util.html#ga52">STP_SAFE_FREE</a>(<a class="code" href="dither-impl_8h.html#a16">CHANNEL</a>(d, i).aux_data);
00087         }
00088     }
00089   <span class="keywordflow">if</span> (et-&gt;<a class="code" href="structeventone__t.html#o7">dummy_channel</a>) {
00090     <a class="code" href="structdither__channel.html">stpi_dither_channel_t</a> *dc = et-&gt;<a class="code" href="structeventone__t.html#o7">dummy_channel</a>;
00091     <a class="code" href="structshade__segment.html">shade_distance_t</a> *shade = (<a class="code" href="structshade__segment.html">shade_distance_t</a> *) dc-&gt;<a class="code" href="structdither__channel.html#o18">aux_data</a>;
00092     <a class="code" href="group__util.html#ga52">STP_SAFE_FREE</a>(shade-&gt;<a class="code" href="structshade__segment.html#o1">et_dis</a>);
00093     <a class="code" href="group__util.html#ga52">STP_SAFE_FREE</a>(dc-&gt;<a class="code" href="structdither__channel.html#o18">aux_data</a>);
00094     <a class="code" href="dither-inks_8c.html#a3">stpi_dither_channel_destroy</a>(dc);
00095     <a class="code" href="group__util.html#ga52">STP_SAFE_FREE</a>(et-&gt;<a class="code" href="structeventone__t.html#o7">dummy_channel</a>);
00096   }
00097   <a class="code" href="group__util.html#ga52">STP_SAFE_FREE</a>(et);
00098 }
00099 
00100 <span class="keyword">static</span> <span class="keywordtype">void</span>
<a name="l00101"></a><a class="code" href="dither-eventone_8c.html#a6">00101</a> <a class="code" href="dither-eventone_8c.html#a6">et_setup</a>(<a class="code" href="structdither.html">stpi_dither_t</a> *d)
00102 {
00103   <span class="keywordtype">int</span> size = 2 * <a class="code" href="dither-impl_8h.html#a15">MAX_SPREAD</a> + ((d-&gt;<a class="code" href="structdither.html#o1">dst_width</a> + 7) &amp; ~7);
00104   <span class="keyword">static</span> <span class="keyword">const</span> <span class="keywordtype">int</span> diff_factors[] = {1, 10, 16, 23, 32};
00105   <a class="code" href="structeventone__t.html">eventone_t</a> *et = <a class="code" href="group__util.html#ga29">stp_zalloc</a>(<span class="keyword">sizeof</span>(<a class="code" href="structeventone__t.html">eventone_t</a>));
00106   <span class="keywordtype">int</span> xa, ya;
00107   <span class="keywordtype">int</span> i;
00108   <span class="keywordflow">for</span> (i = 0; i &lt; <a class="code" href="dither-impl_8h.html#a17">CHANNEL_COUNT</a>(d); i++) {
00109     <a class="code" href="dither-impl_8h.html#a16">CHANNEL</a>(d, i).error_rows = 1;
00110     <a class="code" href="dither-impl_8h.html#a16">CHANNEL</a>(d, i).errs = <a class="code" href="group__util.html#ga29">stp_zalloc</a>(1 * <span class="keyword">sizeof</span>(<span class="keywordtype">int</span> *));
00111     <a class="code" href="dither-impl_8h.html#a16">CHANNEL</a>(d, i).errs[0] = <a class="code" href="group__util.html#ga29">stp_zalloc</a>(size * <span class="keyword">sizeof</span>(<span class="keywordtype">int</span>));
00112   }
00113   <span class="keywordflow">if</span> (d-&gt;<a class="code" href="structdither.html#o4">stpi_dither_type</a> &amp; <a class="code" href="dither-impl_8h.html#a9">D_UNITONE</a>) {
00114     <a class="code" href="structdither__channel.html">stpi_dither_channel_t</a> *dc = <a class="code" href="group__util.html#ga29">stp_zalloc</a>(<span class="keyword">sizeof</span>(<a class="code" href="structdither__channel.html">stpi_dither_channel_t</a>));
00115     <a class="code" href="print-dither-matrices_8c.html#a12">stp_dither_matrix_clone</a>(&amp;(d-&gt;<a class="code" href="structdither.html#o16">dither_matrix</a>), &amp;(dc-&gt;<a class="code" href="structdither__channel.html#o15">dithermat</a>), 0, 0);
00116     <a class="code" href="print-dither-matrices_8c.html#a12">stp_dither_matrix_clone</a>(&amp;(d-&gt;<a class="code" href="structdither.html#o17">transition_matrix</a>), &amp;(dc-&gt;<a class="code" href="structdither__channel.html#o14">pick</a>), 0, 0);
00117     dc-&gt;<a class="code" href="structdither__channel.html#o12">error_rows</a> = 1;
00118     dc-&gt;<a class="code" href="structdither__channel.html#o13">errs</a> = <a class="code" href="group__util.html#ga29">stp_zalloc</a>(1 * <span class="keyword">sizeof</span>(<span class="keywordtype">int</span> *));
00119     dc-&gt;<a class="code" href="structdither__channel.html#o13">errs</a>[0] = <a class="code" href="group__util.html#ga29">stp_zalloc</a>(size * <span class="keyword">sizeof</span>(<span class="keywordtype">int</span>));
00120     et-&gt;<a class="code" href="structeventone__t.html#o7">dummy_channel</a> = dc;
00121   }
00122 
00123   xa = d-&gt;<a class="code" href="structdither.html#o6">x_aspect</a> / d-&gt;<a class="code" href="structdither.html#o7">y_aspect</a>;
00124   <span class="keywordflow">if</span> (xa == 0)
00125     xa = 1;
00126   et-&gt;<a class="code" href="structeventone__t.html#o2">d_sq</a>.<a class="code" href="structdistance__t.html#o0">dx</a> = xa * xa;
00127   et-&gt;<a class="code" href="structeventone__t.html#o0">d2x</a> = 2 * et-&gt;<a class="code" href="structeventone__t.html#o2">d_sq</a>.<a class="code" href="structdistance__t.html#o0">dx</a>;
00128 
00129   ya = d-&gt;<a class="code" href="structdither.html#o7">y_aspect</a> / d-&gt;<a class="code" href="structdither.html#o6">x_aspect</a>;
00130   <span class="keywordflow">if</span> (ya == 0)
00131     ya = 1;
00132   et-&gt;<a class="code" href="structeventone__t.html#o2">d_sq</a>.<a class="code" href="structdistance__t.html#o1">dy</a> = ya * ya;
00133   et-&gt;<a class="code" href="structeventone__t.html#o1">d2y</a> = 2 * et-&gt;<a class="code" href="structeventone__t.html#o2">d_sq</a>.<a class="code" href="structdistance__t.html#o1">dy</a>;
00134 
00135   et-&gt;<a class="code" href="structeventone__t.html#o3">aspect</a> = <a class="code" href="dither-eventone_8c.html#a1">EVEN_C2</a> / (xa * ya);
00136   et-&gt;<a class="code" href="structeventone__t.html#o4">unitone_aspect</a> = <a class="code" href="dither-eventone_8c.html#a3">UNITONE_C2</a> / (xa * ya);
00137   et-&gt;<a class="code" href="structeventone__t.html#o2">d_sq</a>.<a class="code" href="structdistance__t.html#o2">r_sq</a> = 0;
00138 
00139   <span class="keywordflow">for</span> (i = 0; i &lt; <a class="code" href="dither-impl_8h.html#a17">CHANNEL_COUNT</a>(d); i++) {
00140     <span class="keywordtype">int</span> x;
00141     <a class="code" href="structshade__segment.html">shade_distance_t</a> *shade = <a class="code" href="group__util.html#ga29">stp_zalloc</a>(<span class="keyword">sizeof</span>(<a class="code" href="structshade__segment.html">shade_distance_t</a>));
00142     shade-&gt;<a class="code" href="structshade__segment.html#o0">dis</a> = et-&gt;<a class="code" href="structeventone__t.html#o2">d_sq</a>;
00143     shade-&gt;<a class="code" href="structshade__segment.html#o1">et_dis</a> = <a class="code" href="group__util.html#ga28">stp_malloc</a>(<span class="keyword">sizeof</span>(<a class="code" href="structdistance__t.html">distance_t</a>) * d-&gt;<a class="code" href="structdither.html#o1">dst_width</a>);
00144     <span class="keywordflow">if</span> (<a class="code" href="dither-impl_8h.html#a16">CHANNEL</a>(d, i).darkness &gt; .1)
00145       shade-&gt;<a class="code" href="structshade__segment.html#o4">share_this_channel</a> = 1;
00146     <span class="keywordflow">else</span>
00147       shade-&gt;<a class="code" href="structshade__segment.html#o4">share_this_channel</a> = 0;
00148     <span class="keywordflow">for</span> (x = 0; x &lt; d-&gt;<a class="code" href="structdither.html#o1">dst_width</a>; x++) {
00149       shade-&gt;<a class="code" href="structshade__segment.html#o1">et_dis</a>[x] = et-&gt;<a class="code" href="structeventone__t.html#o2">d_sq</a>;
00150     }
00151     <a class="code" href="dither-impl_8h.html#a16">CHANNEL</a>(d, i).aux_data = shade;
00152   }
00153   <span class="keywordflow">if</span> (et-&gt;<a class="code" href="structeventone__t.html#o7">dummy_channel</a>) {
00154     <span class="keywordtype">int</span> x;
00155     <a class="code" href="structshade__segment.html">shade_distance_t</a> *shade = <a class="code" href="group__util.html#ga29">stp_zalloc</a>(<span class="keyword">sizeof</span>(<a class="code" href="structshade__segment.html">shade_distance_t</a>));
00156     shade-&gt;<a class="code" href="structshade__segment.html#o0">dis</a> = et-&gt;<a class="code" href="structeventone__t.html#o2">d_sq</a>;
00157     shade-&gt;<a class="code" href="structshade__segment.html#o1">et_dis</a> = <a class="code" href="group__util.html#ga28">stp_malloc</a>(<span class="keyword">sizeof</span>(<a class="code" href="structdistance__t.html">distance_t</a>) * d-&gt;<a class="code" href="structdither.html#o1">dst_width</a>);
00158     <span class="keywordflow">for</span> (x = 0; x &lt; d-&gt;<a class="code" href="structdither.html#o1">dst_width</a>; x++) {
00159       shade-&gt;<a class="code" href="structshade__segment.html#o1">et_dis</a>[x] = et-&gt;<a class="code" href="structeventone__t.html#o2">d_sq</a>;
00160     }
00161     et-&gt;<a class="code" href="structeventone__t.html#o7">dummy_channel</a>-&gt;<a class="code" href="structdither__channel.html#o18">aux_data</a> = shade;
00162   }
00163 
00164   et-&gt;<a class="code" href="structeventone__t.html#o5">physical_aspect</a> = d-&gt;<a class="code" href="structdither.html#o7">y_aspect</a> / d-&gt;<a class="code" href="structdither.html#o6">x_aspect</a>;
00165   <span class="keywordflow">if</span> (et-&gt;<a class="code" href="structeventone__t.html#o5">physical_aspect</a> &gt;= 4)
00166     et-&gt;<a class="code" href="structeventone__t.html#o5">physical_aspect</a> = 4;
00167   <span class="keywordflow">else</span> <span class="keywordflow">if</span> (et-&gt;<a class="code" href="structeventone__t.html#o5">physical_aspect</a> &gt;= 2)
00168     et-&gt;<a class="code" href="structeventone__t.html#o5">physical_aspect</a> = 2;
00169   <span class="keywordflow">else</span> et-&gt;<a class="code" href="structeventone__t.html#o5">physical_aspect</a> = 1;
00170 
00171   et-&gt;<a class="code" href="structeventone__t.html#o6">diff_factor</a> = diff_factors[et-&gt;<a class="code" href="structeventone__t.html#o5">physical_aspect</a>];
00172 
00173   d-&gt;<a class="code" href="structdither.html#o24">aux_data</a> = et;
00174   d-&gt;<a class="code" href="structdither.html#o25">aux_freefunc</a> = <a class="code" href="dither-eventone_8c.html#a5">free_eventone_data</a>;
00175 }
00176 
00177 <span class="keyword">static</span> <span class="keywordtype">int</span>
<a name="l00178"></a><a class="code" href="dither-eventone_8c.html#a7">00178</a> <a class="code" href="dither-eventone_8c.html#a7">et_initializer</a>(<a class="code" href="structdither.html">stpi_dither_t</a> *d, <span class="keywordtype">int</span> duplicate_line, <span class="keywordtype">int</span> zero_mask)
00179 {
00180   <span class="keywordtype">int</span> i;
00181   <a class="code" href="structeventone__t.html">eventone_t</a> *et;
00182   <span class="keywordflow">if</span> (!d-&gt;<a class="code" href="structdither.html#o24">aux_data</a>)
00183     <a class="code" href="dither-eventone_8c.html#a6">et_setup</a>(d);
00184 
00185   et = (<a class="code" href="structeventone__t.html">eventone_t</a> *) (d-&gt;<a class="code" href="structdither.html#o24">aux_data</a>);
00186   <span class="keywordflow">if</span> (!duplicate_line) {
00187     <span class="keywordflow">if</span> ((zero_mask &amp; ((1 &lt;&lt; <a class="code" href="dither-impl_8h.html#a17">CHANNEL_COUNT</a>(d)) - 1)) !=
00188         ((1 &lt;&lt; <a class="code" href="dither-impl_8h.html#a17">CHANNEL_COUNT</a>(d)) - 1)) {
00189       d-&gt;<a class="code" href="structdither.html#o12">last_line_was_empty</a> = 0;
00190     } <span class="keywordflow">else</span> {
00191       d-&gt;<a class="code" href="structdither.html#o12">last_line_was_empty</a>++;
00192     }
00193   } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (d-&gt;<a class="code" href="structdither.html#o12">last_line_was_empty</a>) {
00194     d-&gt;<a class="code" href="structdither.html#o12">last_line_was_empty</a>++;
00195   }
00196 
00197   <span class="keywordflow">if</span> (d-&gt;<a class="code" href="structdither.html#o12">last_line_was_empty</a> &gt;= 5) {
00198     <span class="keywordflow">return</span> 0;
00199   } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (d-&gt;<a class="code" href="structdither.html#o12">last_line_was_empty</a> == 4) {
00200     <span class="keywordflow">if</span> (et-&gt;<a class="code" href="structeventone__t.html#o7">dummy_channel</a>) {
00201       memset(et-&gt;<a class="code" href="structeventone__t.html#o7">dummy_channel</a>-&gt;<a class="code" href="structdither__channel.html#o13">errs</a>[0], 0, d-&gt;<a class="code" href="structdither.html#o1">dst_width</a> * <span class="keyword">sizeof</span>(<span class="keywordtype">int</span>));
00202     }
00203     <span class="keywordflow">for</span> (i = 0; i &lt; <a class="code" href="dither-impl_8h.html#a17">CHANNEL_COUNT</a>(d); i++)
00204       memset(<a class="code" href="dither-impl_8h.html#a16">CHANNEL</a>(d, i).errs[0], 0, d-&gt;<a class="code" href="structdither.html#o1">dst_width</a> * <span class="keyword">sizeof</span>(<span class="keywordtype">int</span>));
00205     <span class="keywordflow">return</span> 0;
00206   }
00207   <span class="keywordflow">for</span> (i = 0; i &lt; <a class="code" href="dither-impl_8h.html#a17">CHANNEL_COUNT</a>(d); i++)
00208     <a class="code" href="dither-impl_8h.html#a16">CHANNEL</a>(d, i).v = 0;
00209   <span class="keywordflow">if</span> (et-&gt;<a class="code" href="structeventone__t.html#o7">dummy_channel</a>)
00210     et-&gt;<a class="code" href="structeventone__t.html#o7">dummy_channel</a>-&gt;<a class="code" href="structdither__channel.html#o5">v</a> = 0;
00211   <span class="keywordflow">return</span> 1;
00212 }
00213 
00214 <span class="keyword">static</span> <span class="keyword">inline</span> <span class="keywordtype">void</span>
<a name="l00215"></a><a class="code" href="dither-eventone_8c.html#a8">00215</a> <a class="code" href="dither-eventone_8c.html#a8">advance_eventone_pre</a>(<a class="code" href="structshade__segment.html">shade_distance_t</a> *sp, <a class="code" href="structeventone__t.html">eventone_t</a> *et, <span class="keywordtype">int</span> x)
00216 {
00217   <a class="code" href="structdistance__t.html">distance_t</a> *etd = &amp;sp-&gt;<a class="code" href="structshade__segment.html#o1">et_dis</a>[x];
00218   <span class="keywordtype">int</span> t = sp-&gt;<a class="code" href="structshade__segment.html#o0">dis</a>.<a class="code" href="structdistance__t.html#o2">r_sq</a> + sp-&gt;<a class="code" href="structshade__segment.html#o0">dis</a>.<a class="code" href="structdistance__t.html#o0">dx</a>;
00219   <span class="keywordflow">if</span> (t &lt;= etd-&gt;<a class="code" href="structdistance__t.html#o2">r_sq</a>) {         <span class="comment">/* Do eventone calculations */</span>
00220     sp-&gt;<a class="code" href="structshade__segment.html#o0">dis</a>.<a class="code" href="structdistance__t.html#o2">r_sq</a> = t;           <span class="comment">/* Nearest pixel same as last one */</span>
00221     sp-&gt;<a class="code" href="structshade__segment.html#o0">dis</a>.<a class="code" href="structdistance__t.html#o0">dx</a> += et-&gt;<a class="code" href="structeventone__t.html#o0">d2x</a>;
00222   } <span class="keywordflow">else</span> {
00223     sp-&gt;<a class="code" href="structshade__segment.html#o0">dis</a> = *etd;             <span class="comment">/* Nearest pixel is from a previous line */</span>
00224   }
00225 }
00226 
00227 <span class="keyword">static</span> <span class="keyword">inline</span> <span class="keywordtype">void</span>
<a name="l00228"></a><a class="code" href="dither-eventone_8c.html#a9">00228</a> <a class="code" href="dither-eventone_8c.html#a9">eventone_update</a>(<a class="code" href="structdither__channel.html">stpi_dither_channel_t</a> *dc, <a class="code" href="structeventone__t.html">eventone_t</a> *et,
00229                 <span class="keywordtype">int</span> x, <span class="keywordtype">int</span> direction)
00230 {
00231   <a class="code" href="structshade__segment.html">shade_distance_t</a> *sp = (<a class="code" href="structshade__segment.html">shade_distance_t</a> *) dc-&gt;<a class="code" href="structdither__channel.html#o18">aux_data</a>;
00232   <a class="code" href="structdistance__t.html">distance_t</a> *etd = &amp;sp-&gt;<a class="code" href="structshade__segment.html#o1">et_dis</a>[x];
00233   <span class="keywordtype">int</span> t = etd-&gt;<a class="code" href="structdistance__t.html#o2">r_sq</a> + etd-&gt;<a class="code" href="structdistance__t.html#o1">dy</a>;          <span class="comment">/* r^2 from dot above */</span>
00234   <span class="keywordtype">int</span> u = sp-&gt;<a class="code" href="structshade__segment.html#o0">dis</a>.<a class="code" href="structdistance__t.html#o2">r_sq</a> + sp-&gt;<a class="code" href="structshade__segment.html#o0">dis</a>.<a class="code" href="structdistance__t.html#o1">dy</a>;    <span class="comment">/* r^2 from dot on this line */</span>
00235   <span class="keywordflow">if</span> (u &lt; t) {                          <span class="comment">/* If dot from this line is close */</span>
00236     t = u;                              <span class="comment">/* Use it instead */</span>
00237     etd-&gt;<a class="code" href="structdistance__t.html#o0">dx</a> = sp-&gt;<a class="code" href="structshade__segment.html#o0">dis</a>.<a class="code" href="structdistance__t.html#o0">dx</a>;
00238     etd-&gt;<a class="code" href="structdistance__t.html#o1">dy</a> = sp-&gt;<a class="code" href="structshade__segment.html#o0">dis</a>.<a class="code" href="structdistance__t.html#o1">dy</a>;
00239   }
00240   etd-&gt;<a class="code" href="structdistance__t.html#o1">dy</a> += et-&gt;<a class="code" href="structeventone__t.html#o1">d2y</a>;
00241 
00242   <span class="keywordflow">if</span> (t &gt; 65535) {                      <span class="comment">/* Do some hard limiting */</span>
00243     t = 65535;
00244   }
00245   etd-&gt;<a class="code" href="structdistance__t.html#o2">r_sq</a> = t;
00246 }
00247 
00248 <span class="keyword">static</span> <span class="keyword">inline</span> <span class="keywordtype">void</span>
<a name="l00249"></a><a class="code" href="dither-eventone_8c.html#a10">00249</a> <a class="code" href="dither-eventone_8c.html#a10">diffuse_error</a>(<a class="code" href="structdither__channel.html">stpi_dither_channel_t</a> *dc, <a class="code" href="structeventone__t.html">eventone_t</a> *et, <span class="keywordtype">int</span> x, <span class="keywordtype">int</span> direction)
00250 {
00251   <span class="comment">/*</span>
00252 <span class="comment">   * Tests to date show that the second diffusion pattern works better</span>
00253 <span class="comment">   * than the first in most cases.  The previous code is being left here</span>
00254 <span class="comment">   * in case it is later determined that the original code works better.</span>
00255 <span class="comment">   * -- rlk 20031101</span>
00256 <span class="comment">   */</span>
00257 <span class="preprocessor">#if 0</span>
00258 <span class="preprocessor"></span><span class="comment">/*  int fraction = (dc-&gt;v + (et-&gt;diff_factor&gt;&gt;1)) / et-&gt;diff_factor; */</span>
00259   <span class="keywordtype">int</span> frac_2 = dc-&gt;<a class="code" href="structdither__channel.html#o5">v</a> + dc-&gt;<a class="code" href="structdither__channel.html#o5">v</a>;
00260   <span class="keywordtype">int</span> frac_3 = frac_2 + dc-&gt;<a class="code" href="structdither__channel.html#o5">v</a>;
00261   dc-&gt;<a class="code" href="structdither__channel.html#o13">errs</a>[0][x + <a class="code" href="dither-impl_8h.html#a15">MAX_SPREAD</a>] = frac_3;
00262   dc-&gt;<a class="code" href="structdither__channel.html#o13">errs</a>[0][x + <a class="code" href="dither-impl_8h.html#a15">MAX_SPREAD</a> - direction] += frac_2;
00263   dc-&gt;<a class="code" href="structdither__channel.html#o5">v</a> -= (frac_2 + frac_3) / 16;
00264 <span class="preprocessor">#else</span>
00265 <span class="preprocessor"></span>  dc-&gt;<a class="code" href="structdither__channel.html#o13">errs</a>[0][x + <a class="code" href="dither-impl_8h.html#a15">MAX_SPREAD</a>] = dc-&gt;<a class="code" href="structdither__channel.html#o5">v</a> * 3;
00266   dc-&gt;<a class="code" href="structdither__channel.html#o13">errs</a>[0][x + <a class="code" href="dither-impl_8h.html#a15">MAX_SPREAD</a> - direction] += dc-&gt;<a class="code" href="structdither__channel.html#o5">v</a> * 5;
00267   dc-&gt;<a class="code" href="structdither__channel.html#o13">errs</a>[0][x + <a class="code" href="dither-impl_8h.html#a15">MAX_SPREAD</a> - (direction * 2)] += dc-&gt;<a class="code" href="structdither__channel.html#o5">v</a> * 1;
00268   dc-&gt;<a class="code" href="structdither__channel.html#o5">v</a> -= dc-&gt;<a class="code" href="structdither__channel.html#o5">v</a> * 9 / 16;
00269 <span class="preprocessor">#endif</span>
00270 <span class="preprocessor"></span>}
00271 
00272 <span class="keyword">static</span> <span class="keyword">inline</span> <span class="keywordtype">int</span>
<a name="l00273"></a><a class="code" href="dither-eventone_8c.html#a11">00273</a> <a class="code" href="dither-eventone_8c.html#a11">eventone_adjust</a>(<a class="code" href="structdither__channel.html">stpi_dither_channel_t</a> *dc, <a class="code" href="structeventone__t.html">eventone_t</a> *et, <span class="keywordtype">int</span> dither_point,
00274                 <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> desired)
00275 {
00276   <span class="keywordflow">if</span> (dither_point &lt;= 0)
00277     <span class="keywordflow">return</span> 0;
00278   <span class="keywordflow">else</span> <span class="keywordflow">if</span> (dither_point &gt;= 65535)
00279     <span class="keywordflow">return</span> 65535;
00280   <span class="keywordflow">if</span> (desired == 0) {
00281     dither_point = 0;
00282   } <span class="keywordflow">else</span> {
00283     <a class="code" href="structshade__segment.html">shade_distance_t</a> *shade = (<a class="code" href="structshade__segment.html">shade_distance_t</a> *) dc-&gt;<a class="code" href="structdither__channel.html#o18">aux_data</a>;
00284     dither_point += shade-&gt;<a class="code" href="structshade__segment.html#o0">dis</a>.<a class="code" href="structdistance__t.html#o2">r_sq</a> * et-&gt;<a class="code" href="structeventone__t.html#o3">aspect</a> - (<a class="code" href="dither-eventone_8c.html#a0">EVEN_C1</a> * 65535) / desired;
00285     <span class="keywordflow">if</span> (dither_point &gt; 65535)
00286       dither_point = 65535;
00287     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (dither_point &lt; 0)
00288       dither_point = 0;
00289   }
00290   <span class="keywordflow">return</span> dither_point;
00291 }
00292 
00293 <span class="keyword">static</span> <span class="keyword">inline</span> <span class="keywordtype">int</span>
<a name="l00294"></a><a class="code" href="dither-eventone_8c.html#a12">00294</a> <a class="code" href="dither-eventone_8c.html#a12">unitone_adjust</a>(<a class="code" href="structdither__channel.html">stpi_dither_channel_t</a> *dc, <a class="code" href="structeventone__t.html">eventone_t</a> *et,
00295                <span class="keywordtype">int</span> dither_point, <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> desired)
00296 {
00297   <span class="keywordflow">if</span> (dither_point &lt;= 0)
00298     <span class="keywordflow">return</span> INT_MIN;
00299   <span class="keywordflow">else</span> <span class="keywordflow">if</span> (dither_point &gt;= 65535)
00300     <span class="keywordflow">return</span> dither_point;
00301   <span class="keywordflow">if</span> (desired == 0) {
00302     dither_point = INT_MIN;
00303   } <span class="keywordflow">else</span> {
00304     <a class="code" href="structshade__segment.html">shade_distance_t</a> *shade = (<a class="code" href="structshade__segment.html">shade_distance_t</a> *) dc-&gt;<a class="code" href="structdither__channel.html#o18">aux_data</a>;
00305     dither_point += shade-&gt;<a class="code" href="structshade__segment.html#o0">dis</a>.<a class="code" href="structdistance__t.html#o2">r_sq</a> * et-&gt;<a class="code" href="structeventone__t.html#o4">unitone_aspect</a> -
00306       (<a class="code" href="dither-eventone_8c.html#a2">UNITONE_C1</a> * 65535u) / desired;
00307   }
00308   <span class="keywordflow">return</span> dither_point;
00309 }
00310 
00311 
00312 <span class="keyword">static</span> <span class="keyword">inline</span> <span class="keywordtype">void</span>
<a name="l00313"></a><a class="code" href="dither-eventone_8c.html#a13">00313</a> <a class="code" href="dither-eventone_8c.html#a13">find_segment</a>(<a class="code" href="structdither__channel.html">stpi_dither_channel_t</a> *dc, <span class="keywordtype">unsigned</span> inkval,
00314              <a class="code" href="structink__defn.html">stpi_ink_defn_t</a> *lower, <a class="code" href="structink__defn.html">stpi_ink_defn_t</a> *upper)
00315 {
00316   lower-&gt;<a class="code" href="structink__defn.html#o0">range</a> = 0;
00317   lower-&gt;<a class="code" href="structink__defn.html#o2">bits</a> = 0;
00318 
00319   <span class="keywordflow">if</span> (dc-&gt;<a class="code" href="structdither__channel.html#o10">nlevels</a> == 1)
00320     {
00321       upper-&gt;<a class="code" href="structink__defn.html#o2">bits</a> = dc-&gt;<a class="code" href="structdither__channel.html#o9">ink_list</a>[1].<a class="code" href="structink__defn.html#o2">bits</a>;
00322       upper-&gt;<a class="code" href="structink__defn.html#o0">range</a> = dc-&gt;<a class="code" href="structdither__channel.html#o9">ink_list</a>[1].<a class="code" href="structink__defn.html#o1">value</a>;
00323     }
00324   <span class="keywordflow">else</span>
00325     {
00326       <span class="keywordtype">int</span> i;
00327       <a class="code" href="structink__defn.html">stpi_ink_defn_t</a> *ip;
00328 
00329       <span class="keywordflow">for</span> (i=0, ip = dc-&gt;<a class="code" href="structdither__channel.html#o9">ink_list</a>; i &lt; dc-&gt;<a class="code" href="structdither__channel.html#o10">nlevels</a> - 1; i++, ip++) {
00330         <span class="keywordflow">if</span> (ip-&gt;value &gt; inkval)
00331           <span class="keywordflow">break</span>;
00332         lower-&gt;<a class="code" href="structink__defn.html#o2">bits</a> = ip-&gt;bits;
00333         lower-&gt;<a class="code" href="structink__defn.html#o0">range</a> = ip-&gt;value;
00334       }
00335 
00336       upper-&gt;<a class="code" href="structink__defn.html#o2">bits</a> = ip-&gt;bits;
00337       upper-&gt;<a class="code" href="structink__defn.html#o0">range</a> = ip-&gt;value;
00338     }
00339 }
00340 
00341 <span class="keyword">static</span> <span class="keyword">inline</span> <span class="keywordtype">int</span>
<a name="l00342"></a><a class="code" href="dither-eventone_8c.html#a14">00342</a> <a class="code" href="dither-eventone_8c.html#a14">find_segment_and_ditherpoint</a>(<a class="code" href="structdither__channel.html">stpi_dither_channel_t</a> *dc, <span class="keywordtype">unsigned</span> inkval,
00343                              <a class="code" href="structink__defn.html">stpi_ink_defn_t</a> *lower, <a class="code" href="structink__defn.html">stpi_ink_defn_t</a> *upper)
00344 {
00345   <a class="code" href="dither-eventone_8c.html#a13">find_segment</a>(dc, inkval, lower, upper);
00346   <span class="keywordflow">if</span> (inkval &lt;= lower-&gt;<a class="code" href="structink__defn.html#o0">range</a>)
00347     <span class="keywordflow">return</span> 0;
00348   <span class="keywordflow">else</span> <span class="keywordflow">if</span> (inkval &gt;= upper-&gt;<a class="code" href="structink__defn.html#o0">range</a>)
00349     <span class="keywordflow">return</span> 65535;
00350   <span class="keywordflow">else</span>
00351     <span class="keywordflow">return</span> (65535u * (inkval - lower-&gt;<a class="code" href="structink__defn.html#o0">range</a>)) / (upper-&gt;<a class="code" href="structink__defn.html#o0">range</a> - lower-&gt;<a class="code" href="structink__defn.html#o0">range</a>);
00352 }
00353 
00354 <span class="keyword">static</span> <span class="keyword">inline</span> <span class="keywordtype">void</span>
<a name="l00355"></a><a class="code" href="dither-eventone_8c.html#a15">00355</a> <a class="code" href="dither-eventone_8c.html#a15">print_ink</a>(<a class="code" href="structdither.html">stpi_dither_t</a> *d, <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> *tptr, <span class="keyword">const</span> <a class="code" href="structink__defn.html">stpi_ink_defn_t</a> *ink,
00356           <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> bit, <span class="keywordtype">int</span> length)
00357 {
00358   <span class="keywordtype">int</span> j;
00359 
00360   <span class="keywordflow">if</span> (tptr != 0)
00361     {
00362       tptr += d-&gt;<a class="code" href="structdither.html#o13">ptr_offset</a>;
00363       <span class="keywordflow">switch</span>(ink-&gt;<a class="code" href="structink__defn.html#o2">bits</a>)
00364         {
00365         <span class="keywordflow">case</span> 1:
00366           tptr[0] |= bit;
00367           <span class="keywordflow">return</span>;
00368         <span class="keywordflow">case</span> 2:
00369           tptr[length] |= bit;
00370           <span class="keywordflow">return</span>;
00371         <span class="keywordflow">case</span> 3:
00372           tptr[0] |= bit;
00373           tptr[length] |= bit;
00374           <span class="keywordflow">return</span>;
00375         <span class="keywordflow">default</span>:
00376           <span class="keywordflow">for</span> (j=1; j &lt;= ink-&gt;<a class="code" href="structink__defn.html#o2">bits</a>; j+=j, tptr += length) {
00377             <span class="keywordflow">if</span> (j &amp; ink-&gt;<a class="code" href="structink__defn.html#o2">bits</a>)
00378               *tptr |= bit;
00379           }
00380           <span class="keywordflow">return</span>;
00381         }
00382     }
00383 }
00384 
00385 <span class="keywordtype">void</span>
<a name="l00386"></a><a class="code" href="dither-eventone_8c.html#a16">00386</a> <a class="code" href="dither-eventone_8c.html#a16">stpi_dither_et</a>(<a class="code" href="structstp__vars.html">stp_vars_t</a> *v,
00387                <span class="keywordtype">int</span> row,
00388                <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">short</span> *<a class="code" href="structraw.html">raw</a>,
00389                <span class="keywordtype">int</span> duplicate_line,
00390                <span class="keywordtype">int</span> zero_mask,
00391                <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> *mask)
00392 {
00393   <a class="code" href="structdither.html">stpi_dither_t</a> *d = (<a class="code" href="structdither.html">stpi_dither_t</a> *) <a class="code" href="group__vars.html#ga20">stp_get_component_data</a>(v, <span class="stringliteral">"Dither"</span>);
00394   <a class="code" href="structeventone__t.html">eventone_t</a> *et;
00395 
00396   <span class="keywordtype">int</span>           x,
00397                 length;
00398   <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> bit;
00399   <span class="keywordtype">int</span>           i;
00400 
00401   <span class="keywordtype">int</span>           terminate;
00402   <span class="keywordtype">int</span>           direction;
00403   <span class="keywordtype">int</span>           xerror, xstep, xmod;
00404   <span class="keywordtype">int</span>           channel_count = <a class="code" href="dither-impl_8h.html#a17">CHANNEL_COUNT</a>(d);
00405 
00406   <span class="keywordflow">if</span> (!<a class="code" href="dither-eventone_8c.html#a7">et_initializer</a>(d, duplicate_line, zero_mask))
00407     <span class="keywordflow">return</span>;
00408 
00409   et = (<a class="code" href="structeventone__t.html">eventone_t</a> *) d-&gt;<a class="code" href="structdither.html#o24">aux_data</a>;
00410 
00411   length = (d-&gt;<a class="code" href="structdither.html#o1">dst_width</a> + 7) / 8;
00412 
00413   <span class="keywordflow">if</span> (row &amp; 1) {
00414     direction = 1;
00415     x = 0;
00416     terminate = d-&gt;<a class="code" href="structdither.html#o1">dst_width</a>;
00417     d-&gt;<a class="code" href="structdither.html#o13">ptr_offset</a> = 0;
00418   } <span class="keywordflow">else</span> {
00419     direction = -1;
00420     x = d-&gt;<a class="code" href="structdither.html#o1">dst_width</a> - 1;
00421     terminate = -1;
00422     d-&gt;<a class="code" href="structdither.html#o13">ptr_offset</a> = length - 1;
00423     raw += channel_count * (d-&gt;<a class="code" href="structdither.html#o0">src_width</a> - 1);
00424   }
00425   bit = 1 &lt;&lt; (7 - (x &amp; 7));
00426   xstep  = channel_count * (d-&gt;<a class="code" href="structdither.html#o0">src_width</a> / d-&gt;<a class="code" href="structdither.html#o1">dst_width</a>);
00427   xmod   = d-&gt;<a class="code" href="structdither.html#o0">src_width</a> % d-&gt;<a class="code" href="structdither.html#o1">dst_width</a>;
00428   xerror = (xmod * x) % d-&gt;<a class="code" href="structdither.html#o1">dst_width</a>;
00429 
00430   <span class="keywordflow">for</span> (; x != terminate; x += direction) {
00431 
00432     <span class="keywordtype">int</span> point_error = 0;
00433     <span class="keywordtype">int</span> comparison = 32768;
00434 
00435     <span class="keywordflow">if</span> (d-&gt;<a class="code" href="structdither.html#o4">stpi_dither_type</a> &amp; <a class="code" href="dither-impl_8h.html#a3">D_ORDERED_BASE</a>)
00436       comparison += (<a class="code" href="dither-inlined-functions_8h.html#a0">ditherpoint</a>(d, &amp;(d-&gt;<a class="code" href="structdither.html#o16">dither_matrix</a>), x) / 16) - 2048;
00437 
00438     <span class="keywordflow">for</span> (i=0; i &lt; channel_count; i++) {
00439       <span class="keywordflow">if</span> (<a class="code" href="dither-impl_8h.html#a16">CHANNEL</a>(d, i).ptr)
00440         {
00441           <span class="keywordtype">int</span> inkspot;
00442           <span class="keywordtype">int</span> range_point;
00443           <a class="code" href="structdither__channel.html">stpi_dither_channel_t</a> *dc = &amp;<a class="code" href="dither-impl_8h.html#a16">CHANNEL</a>(d, i);
00444           <a class="code" href="structshade__segment.html">shade_distance_t</a> *sp = (<a class="code" href="structshade__segment.html">shade_distance_t</a> *) dc-&gt;<a class="code" href="structdither__channel.html#o18">aux_data</a>;
00445           <a class="code" href="structink__defn.html">stpi_ink_defn_t</a> *inkp;
00446           <a class="code" href="structink__defn.html">stpi_ink_defn_t</a> lower, upper;
00447 
00448           <a class="code" href="dither-eventone_8c.html#a8">advance_eventone_pre</a>(sp, et, x);
00449 
00450           <span class="comment">/*</span>
00451 <span class="comment">           * Find which are the two candidate dot sizes.</span>
00452 <span class="comment">           * Rather than use the absolute value of the point to compute</span>
00453 <span class="comment">           * the error, we will use the relative value of the point within</span>
00454 <span class="comment">           * the range to find the two candidate dot sizes.</span>
00455 <span class="comment">           */</span>
00456           range_point =
00457             <a class="code" href="dither-eventone_8c.html#a14">find_segment_and_ditherpoint</a>(dc, raw[i], &amp;lower, &amp;upper);
00458 
00459           <span class="comment">/* Incorporate error data from previous line */</span>
00460           dc-&gt;<a class="code" href="structdither__channel.html#o5">v</a> += 2 * range_point + (dc-&gt;<a class="code" href="structdither__channel.html#o13">errs</a>[0][x + <a class="code" href="dither-impl_8h.html#a15">MAX_SPREAD</a>] + 8) / 16;
00461           inkspot = dc-&gt;<a class="code" href="structdither__channel.html#o5">v</a> - range_point;
00462 
00463           point_error += <a class="code" href="dither-eventone_8c.html#a11">eventone_adjust</a>(dc, et, inkspot, range_point);
00464 
00465           <span class="comment">/* Determine whether to print the larger or smaller dot */</span>
00466           inkp = &amp;lower;
00467           <span class="keywordflow">if</span> (point_error &gt;= comparison) {
00468             point_error -= 65535;
00469             inkp = &amp;upper;
00470             dc-&gt;<a class="code" href="structdither__channel.html#o5">v</a> -= 131070;
00471             sp-&gt;<a class="code" href="structshade__segment.html#o0">dis</a> = et-&gt;<a class="code" href="structeventone__t.html#o2">d_sq</a>;
00472           }
00473 
00474           <span class="comment">/* Adjust the error to reflect the dot choice */</span>
00475           <span class="keywordflow">if</span> (inkp-&gt;<a class="code" href="structink__defn.html#o2">bits</a>) {
00476             <span class="keywordflow">if</span> (!mask || (*(mask + d-&gt;<a class="code" href="structdither.html#o13">ptr_offset</a>) &amp; bit)) {
00477               <a class="code" href="dither-inlined-functions_8h.html#a1">set_row_ends</a>(dc, x);
00478 
00479               <span class="comment">/* Do the printing */</span>
00480               <a class="code" href="dither-eventone_8c.html#a15">print_ink</a>(d, dc-&gt;<a class="code" href="structdither__channel.html#o17">ptr</a>, inkp, bit, length);
00481             }
00482           }
00483 
00484           <span class="comment">/* Spread the error around to the adjacent dots */</span>
00485           <a class="code" href="dither-eventone_8c.html#a9">eventone_update</a>(dc, et, x, direction);
00486           <a class="code" href="dither-eventone_8c.html#a10">diffuse_error</a>(dc, et, x, direction);
00487         }
00488     }
00489     <span class="keywordflow">if</span> (direction == 1)
00490       <a class="code" href="dither-impl_8h.html#a19">ADVANCE_UNIDIRECTIONAL</a>(d, bit, raw, channel_count, xerror, xstep, xmod);
00491     <span class="keywordflow">else</span>
00492       <a class="code" href="dither-impl_8h.html#a20">ADVANCE_REVERSE</a>(d, bit, raw, channel_count, xerror, xstep, xmod);
00493   }
00494   <span class="keywordflow">if</span> (direction == -1)
00495     <a class="code" href="dither-main_8c.html#a14">stpi_dither_reverse_row_ends</a>(d);
00496 }
00497 
00498 <span class="keywordtype">void</span>
<a name="l00499"></a><a class="code" href="dither-eventone_8c.html#a17">00499</a> <a class="code" href="dither-eventone_8c.html#a17">stpi_dither_ut</a>(<a class="code" href="structstp__vars.html">stp_vars_t</a> *v,
00500                <span class="keywordtype">int</span> row,
00501                <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">short</span> *<a class="code" href="structraw.html">raw</a>,
00502                <span class="keywordtype">int</span> duplicate_line,
00503                <span class="keywordtype">int</span> zero_mask,
00504                <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> *mask)
00505 {
00506   <a class="code" href="structdither.html">stpi_dither_t</a> *d = (<a class="code" href="structdither.html">stpi_dither_t</a> *) <a class="code" href="group__vars.html#ga20">stp_get_component_data</a>(v, <span class="stringliteral">"Dither"</span>);
00507   <a class="code" href="structeventone__t.html">eventone_t</a> *et;
00508 
00509   <span class="keywordtype">int</span>           x,
00510                 length;
00511   <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> bit;
00512   <span class="keywordtype">int</span>           i;
00513 
00514   <span class="keywordtype">int</span>           terminate;
00515   <span class="keywordtype">int</span>           direction;
00516   <span class="keywordtype">int</span>           xerror, xstep, xmod;
00517   <span class="keywordtype">int</span>           channel_count = <a class="code" href="dither-impl_8h.html#a17">CHANNEL_COUNT</a>(d);
00518   <a class="code" href="structdither__channel.html">stpi_dither_channel_t</a> *ddc;
00519 
00520   <span class="keywordflow">if</span> (channel_count == 1) {
00521     <a class="code" href="dither-eventone_8c.html#a16">stpi_dither_et</a>(v, row, raw, duplicate_line, zero_mask, mask);
00522     <span class="keywordflow">return</span>;
00523   }
00524 
00525   <span class="keywordflow">if</span> (!<a class="code" href="dither-eventone_8c.html#a7">et_initializer</a>(d, duplicate_line, zero_mask))
00526     <span class="keywordflow">return</span>;
00527 
00528   et = (<a class="code" href="structeventone__t.html">eventone_t</a> *) d-&gt;<a class="code" href="structdither.html#o24">aux_data</a>;
00529   ddc = et-&gt;<a class="code" href="structeventone__t.html#o7">dummy_channel</a>;
00530 
00531   length = (d-&gt;<a class="code" href="structdither.html#o1">dst_width</a> + 7) / 8;
00532 
00533   <span class="keywordflow">if</span> (row &amp; 1) {
00534     direction = 1;
00535     x = 0;
00536     terminate = d-&gt;<a class="code" href="structdither.html#o1">dst_width</a>;
00537     d-&gt;<a class="code" href="structdither.html#o13">ptr_offset</a> = 0;
00538   } <span class="keywordflow">else</span> {
00539     direction = -1;
00540     x = d-&gt;<a class="code" href="structdither.html#o1">dst_width</a> - 1;
00541     terminate = -1;
00542     d-&gt;<a class="code" href="structdither.html#o13">ptr_offset</a> = length - 1;
00543     raw += channel_count * (d-&gt;<a class="code" href="structdither.html#o0">src_width</a> - 1);
00544   }
00545   bit = 1 &lt;&lt; (7 - (x &amp; 7));
00546   xstep  = channel_count * (d-&gt;<a class="code" href="structdither.html#o0">src_width</a> / d-&gt;<a class="code" href="structdither.html#o1">dst_width</a>);
00547   xmod   = d-&gt;<a class="code" href="structdither.html#o0">src_width</a> % d-&gt;<a class="code" href="structdither.html#o1">dst_width</a>;
00548   xerror = (xmod * x) % d-&gt;<a class="code" href="structdither.html#o1">dst_width</a>;
00549 
00550   <span class="keywordflow">for</span> (; x != terminate; x += direction) {
00551 
00552     <a class="code" href="structshade__segment.html">shade_distance_t</a> *ssp = (<a class="code" href="structshade__segment.html">shade_distance_t</a> *) ddc-&gt;<a class="code" href="structdither__channel.html#o18">aux_data</a>;
00553     <span class="keywordtype">int</span> point_error = 0;
00554     <span class="keywordtype">int</span> total_error = 0;
00555     <span class="keywordtype">int</span> channels_to_print = 0;
00556     <span class="keywordtype">int</span> print_all_channels = 0;
00557     <span class="keywordtype">int</span> maximum_value = 0;
00558     <span class="keywordtype">int</span> comparison = 32768;
00559     <a class="code" href="structdither__channel.html">stpi_dither_channel_t</a> *best_channel = NULL;
00560     <a class="code" href="structdither__channel.html">stpi_dither_channel_t</a> *second_best_channel = NULL;
00561     <span class="keywordtype">int</span> best_channel_value = INT_MIN;
00562     <span class="keywordtype">int</span> second_best_channel_value = INT_MIN;
00563     <span class="keywordtype">int</span> random_value = <a class="code" href="dither-inlined-functions_8h.html#a0">ditherpoint</a>(d, &amp;(d-&gt;<a class="code" href="structdither.html#o16">dither_matrix</a>), x);
00564 
00565     <span class="keywordflow">if</span> (d-&gt;<a class="code" href="structdither.html#o4">stpi_dither_type</a> &amp; <a class="code" href="dither-impl_8h.html#a3">D_ORDERED_BASE</a>)
00566       comparison += (random_value / 16) - 2048;
00567 
00568 
00569     ddc-&gt;<a class="code" href="structdither__channel.html#o7">b</a> = 0;
00570     <a class="code" href="dither-eventone_8c.html#a8">advance_eventone_pre</a>(ssp, et, x);
00571 
00572     <span class="keywordflow">for</span> (i=0; i &lt; channel_count; i++) {
00573       <a class="code" href="structdither__channel.html">stpi_dither_channel_t</a> *dc = &amp;<a class="code" href="dither-impl_8h.html#a16">CHANNEL</a>(d, i);
00574       <span class="keywordflow">if</span> (dc-&gt;<a class="code" href="structdither__channel.html#o17">ptr</a>) {
00575         <a class="code" href="structshade__segment.html">shade_distance_t</a> *sp = (<a class="code" href="structshade__segment.html">shade_distance_t</a> *) dc-&gt;<a class="code" href="structdither__channel.html#o18">aux_data</a>;
00576 
00577         <a class="code" href="dither-eventone_8c.html#a8">advance_eventone_pre</a>(sp, et, x);
00578 
00579         <span class="comment">/*</span>
00580 <span class="comment">         * Find which are the two candidate dot sizes.</span>
00581 <span class="comment">         * Rather than use the absolute value of the point to compute</span>
00582 <span class="comment">         * the error, we will use the relative value of the point within</span>
00583 <span class="comment">         * the range to find the two candidate dot sizes.</span>
00584 <span class="comment">         */</span>
00585         dc-&gt;<a class="code" href="structdither__channel.html#o7">b</a> = <a class="code" href="dither-eventone_8c.html#a14">find_segment_and_ditherpoint</a>(dc, raw[i],
00586                                              &amp;(sp-&gt;<a class="code" href="structshade__segment.html#o2">lower</a>), &amp;(sp-&gt;<a class="code" href="structshade__segment.html#o3">upper</a>));
00587         <span class="keywordflow">if</span> (sp-&gt;<a class="code" href="structshade__segment.html#o4">share_this_channel</a>) {
00588           <span class="keywordflow">if</span> (dc-&gt;<a class="code" href="structdither__channel.html#o7">b</a> &gt; maximum_value)
00589             maximum_value = dc-&gt;<a class="code" href="structdither__channel.html#o7">b</a>;
00590           ddc-&gt;<a class="code" href="structdither__channel.html#o7">b</a> += dc-&gt;<a class="code" href="structdither__channel.html#o7">b</a>;
00591         }
00592         <span class="comment">/* Incorporate error data from previous line */</span>
00593         dc-&gt;<a class="code" href="structdither__channel.html#o5">v</a> += 2 * dc-&gt;<a class="code" href="structdither__channel.html#o7">b</a> + (dc-&gt;<a class="code" href="structdither__channel.html#o13">errs</a>[0][x + <a class="code" href="dither-impl_8h.html#a15">MAX_SPREAD</a>] + 8) / 16;
00594         dc-&gt;<a class="code" href="structdither__channel.html#o6">o</a> = <a class="code" href="dither-eventone_8c.html#a12">unitone_adjust</a>(dc, et, dc-&gt;<a class="code" href="structdither__channel.html#o5">v</a> - dc-&gt;<a class="code" href="structdither__channel.html#o7">b</a>, dc-&gt;<a class="code" href="structdither__channel.html#o7">b</a>);
00595       }
00596     }
00597 
00598 <span class="preprocessor">#if 0</span>
00599 <span class="preprocessor"></span>    <span class="keywordflow">if</span> ((2 * (ddc-&gt;<a class="code" href="structdither__channel.html#o7">b</a> - maximum_value)) &lt; (3 * maximum_value))
00600       print_all_channels = 1;
00601 <span class="preprocessor">#endif</span>
00602 <span class="preprocessor"></span>
00603     <span class="keywordflow">if</span> (ddc-&gt;<a class="code" href="structdither__channel.html#o7">b</a> &gt; 131070)
00604       print_all_channels = 1;
00605     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (ddc-&gt;<a class="code" href="structdither__channel.html#o7">b</a> &gt; 65535) {
00606       ddc-&gt;<a class="code" href="structdither__channel.html#o7">b</a> -= 65535;
00607       channels_to_print = 1;
00608     }
00609 
00610     <span class="keywordflow">if</span> (ddc-&gt;<a class="code" href="structdither__channel.html#o7">b</a> &gt; 65535) {
00611       ddc-&gt;<a class="code" href="structdither__channel.html#o7">b</a> = 65535;
00612     }
00613     
00614     ddc-&gt;<a class="code" href="structdither__channel.html#o5">v</a> += 2 * ddc-&gt;<a class="code" href="structdither__channel.html#o7">b</a> + (ddc-&gt;<a class="code" href="structdither__channel.html#o13">errs</a>[0][x + <a class="code" href="dither-impl_8h.html#a15">MAX_SPREAD</a>] + 8) / 16;
00615     total_error += <a class="code" href="dither-eventone_8c.html#a11">eventone_adjust</a>(ddc, et, ddc-&gt;<a class="code" href="structdither__channel.html#o5">v</a> - ddc-&gt;<a class="code" href="structdither__channel.html#o7">b</a>, ddc-&gt;<a class="code" href="structdither__channel.html#o7">b</a>);
00616     <span class="keywordflow">if</span> (total_error &gt;= comparison) {
00617       channels_to_print += 1;
00618     }
00619 
00620     <span class="keywordflow">if</span> (!print_all_channels) {
00621       <span class="keywordflow">for</span> (i=0; i &lt; channel_count; i++) {
00622         <a class="code" href="structdither__channel.html">stpi_dither_channel_t</a> *dc = &amp;<a class="code" href="dither-impl_8h.html#a16">CHANNEL</a>(d, i);
00623         <a class="code" href="structshade__segment.html">shade_distance_t</a> *sp = (<a class="code" href="structshade__segment.html">shade_distance_t</a> *) dc-&gt;<a class="code" href="structdither__channel.html#o18">aux_data</a>;
00624       
00625         <span class="keywordflow">if</span> (dc-&gt;<a class="code" href="structdither__channel.html#o17">ptr</a>) {
00626 
00627           <span class="keywordflow">if</span> (sp-&gt;<a class="code" href="structshade__segment.html#o4">share_this_channel</a>) {
00628             <span class="keywordflow">if</span> (dc-&gt;<a class="code" href="structdither__channel.html#o6">o</a> &gt; best_channel_value) {
00629               second_best_channel = best_channel;
00630               best_channel = dc;
00631               second_best_channel_value = best_channel_value;
00632               <span class="keywordflow">if</span> (dc-&gt;o &gt;= 32768)
00633                 best_channel_value = INT_MAX;
00634               <span class="keywordflow">else</span>
00635                 best_channel_value = dc-&gt;<a class="code" href="structdither__channel.html#o6">o</a>;
00636             } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (dc-&gt;<a class="code" href="structdither__channel.html#o6">o</a> &gt; second_best_channel_value) {
00637               second_best_channel = dc;
00638               <span class="keywordflow">if</span> (dc-&gt;o &gt;= 32768)
00639                 second_best_channel_value = INT_MAX;
00640               <span class="keywordflow">else</span>
00641                 second_best_channel_value = dc-&gt;<a class="code" href="structdither__channel.html#o6">o</a>;
00642             }
00643           }
00644         }
00645       }
00646     }
00647     
00648     <span class="keywordflow">for</span> (i=0; i &lt; channel_count; i++) {
00649       <a class="code" href="structdither__channel.html">stpi_dither_channel_t</a> *dc = &amp;<a class="code" href="dither-impl_8h.html#a16">CHANNEL</a>(d, i);
00650       <span class="keywordflow">if</span> (dc-&gt;<a class="code" href="structdither__channel.html#o17">ptr</a>) {
00651 
00652         <span class="comment">/* Determine whether to print the larger or smaller dot */</span>
00653         <a class="code" href="structshade__segment.html">shade_distance_t</a> *sp = (<a class="code" href="structshade__segment.html">shade_distance_t</a> *) dc-&gt;<a class="code" href="structdither__channel.html#o18">aux_data</a>;
00654         <a class="code" href="structink__defn.html">stpi_ink_defn_t</a> *inkp = &amp;(sp-&gt;<a class="code" href="structshade__segment.html#o2">lower</a>);
00655 
00656         <span class="keywordflow">if</span> (dc-&gt;<a class="code" href="structdither__channel.html#o6">o</a> &lt; 0)
00657           dc-&gt;<a class="code" href="structdither__channel.html#o6">o</a> = 0;
00658         <span class="keywordflow">else</span> <span class="keywordflow">if</span> (dc-&gt;<a class="code" href="structdither__channel.html#o6">o</a> &gt; 65535)
00659           dc-&gt;<a class="code" href="structdither__channel.html#o6">o</a> = 65535;
00660         <span class="keywordflow">if</span> (print_all_channels || !sp-&gt;<a class="code" href="structshade__segment.html#o4">share_this_channel</a>) {
00661           point_error += dc-&gt;<a class="code" href="structdither__channel.html#o6">o</a>;
00662           <span class="keywordflow">if</span> (point_error &gt;= comparison) {
00663             point_error -= 65535;
00664             inkp = &amp;(sp-&gt;<a class="code" href="structshade__segment.html#o3">upper</a>);
00665             dc-&gt;<a class="code" href="structdither__channel.html#o5">v</a> -= 131070;
00666             sp-&gt;<a class="code" href="structshade__segment.html#o0">dis</a> = et-&gt;<a class="code" href="structeventone__t.html#o2">d_sq</a>;
00667           }
00668         } <span class="keywordflow">else</span> <span class="keywordflow">if</span> ((channels_to_print &gt;= 1 &amp;&amp; best_channel == dc) ||
00669                    (channels_to_print &gt;= 2 &amp;&amp; second_best_channel == dc)) {
00670           inkp = &amp;(sp-&gt;<a class="code" href="structshade__segment.html#o3">upper</a>);
00671           dc-&gt;<a class="code" href="structdither__channel.html#o5">v</a> -= 131070;
00672           sp-&gt;<a class="code" href="structshade__segment.html#o0">dis</a> = et-&gt;<a class="code" href="structeventone__t.html#o2">d_sq</a>;
00673         }         
00674         <span class="keywordflow">if</span> (inkp-&gt;<a class="code" href="structink__defn.html#o2">bits</a>) {
00675           <span class="keywordflow">if</span> (!mask || (*(mask + d-&gt;<a class="code" href="structdither.html#o13">ptr_offset</a>) &amp; bit)) {
00676             <a class="code" href="dither-inlined-functions_8h.html#a1">set_row_ends</a>(dc, x);
00677 
00678             <span class="comment">/* Do the printing */</span>
00679             <a class="code" href="dither-eventone_8c.html#a15">print_ink</a>(d, dc-&gt;<a class="code" href="structdither__channel.html#o17">ptr</a>, inkp, bit, length);
00680           }
00681         }
00682       }
00683     }
00684     <span class="keywordflow">if</span> (total_error &gt;= comparison) {
00685       ddc-&gt;<a class="code" href="structdither__channel.html#o5">v</a> -= 131070;
00686       total_error -= 65535;
00687       ssp-&gt;<a class="code" href="structshade__segment.html#o0">dis</a> = et-&gt;<a class="code" href="structeventone__t.html#o2">d_sq</a>;
00688     }
00689 
00690     <a class="code" href="dither-eventone_8c.html#a9">eventone_update</a>(ddc, et, x, direction);
00691     <a class="code" href="dither-eventone_8c.html#a10">diffuse_error</a>(ddc, et, x, direction);
00692     <span class="keywordflow">for</span> (i=0; i &lt; channel_count; i++) {
00693       <a class="code" href="structdither__channel.html">stpi_dither_channel_t</a> *dc = &amp;<a class="code" href="dither-impl_8h.html#a16">CHANNEL</a>(d, i);
00694       <span class="keywordflow">if</span> (dc-&gt;<a class="code" href="structdither__channel.html#o17">ptr</a>) {
00695 
00696         <span class="comment">/* Spread the error around to the adjacent dots */</span>
00697         <a class="code" href="dither-eventone_8c.html#a9">eventone_update</a>(dc, et, x, direction);
00698         <a class="code" href="dither-eventone_8c.html#a10">diffuse_error</a>(dc, et, x, direction);
00699       }
00700     }
00701 
00702 
00703     <span class="keywordflow">if</span> (direction == 1)
00704       <a class="code" href="dither-impl_8h.html#a19">ADVANCE_UNIDIRECTIONAL</a>(d, bit, raw, channel_count, xerror, xstep, xmod);
00705     <span class="keywordflow">else</span>
00706       <a class="code" href="dither-impl_8h.html#a20">ADVANCE_REVERSE</a>(d, bit, raw, channel_count, xerror, xstep, xmod);
00707   }
00708   <span class="keywordflow">if</span> (direction == -1)
00709     <a class="code" href="dither-main_8c.html#a14">stpi_dither_reverse_row_ends</a>(d);
00710 }
</pre></div><hr size="1"><address style="align: right;"><small>Generated on Wed Aug 25 07:56:13 2004 for libgimpprint API Reference by
<a href="http://www.doxygen.org/index.html">
<img src="doxygen.png" alt="doxygen" align="middle" border=0 > </a>1.3.6 </small></address>
</body>
</html>
