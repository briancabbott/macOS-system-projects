<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>libgimpprint API Reference: src/main/channel.c Source File</title>
<link href="doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.6 -->
<div class="qindex"><a class="qindex" href="index.html">Main&nbsp;Page</a> | <a class="qindex" href="modules.html">Modules</a> | <a class="qindex" href="classes.html">Alphabetical&nbsp;List</a> | <a class="qindex" href="annotated.html">Data&nbsp;Structures</a> | <a class="qindex" href="files.html">File&nbsp;List</a> | <a class="qindex" href="functions.html">Data&nbsp;Fields</a> | <a class="qindex" href="globals.html">Globals</a> | <a class="qindex" href="pages.html">Related&nbsp;Pages</a></div>
<h1>src/main/channel.c</h1><a href="channel_8c.html">Go to the documentation of this file.</a><div class="fragment"><pre>00001 <span class="comment">/*</span>
00002 <span class="comment"> * "$Id: channel_8c-source.html,v 1.1.1.2 2004/12/22 23:48:56 jlovell Exp $"</span>
00003 <span class="comment"> *</span>
00004 <span class="comment"> *   Dither routine entrypoints</span>
00005 <span class="comment"> *</span>
00006 <span class="comment"> *   Copyright 2003 Robert Krawitz (rlk@alum.mit.edu)</span>
00007 <span class="comment"> *</span>
00008 <span class="comment"> *   This program is free software; you can redistribute it and/or modify it</span>
00009 <span class="comment"> *   under the terms of the GNU General Public License as published by the Free</span>
00010 <span class="comment"> *   Software Foundation; either version 2 of the License, or (at your option)</span>
00011 <span class="comment"> *   any later version.</span>
00012 <span class="comment"> *</span>
00013 <span class="comment"> *   This program is distributed in the hope that it will be useful, but</span>
00014 <span class="comment"> *   WITHOUT ANY WARRANTY; without even the implied warranty of MERCHANTABILITY</span>
00015 <span class="comment"> *   or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License</span>
00016 <span class="comment"> *   for more details.</span>
00017 <span class="comment"> *</span>
00018 <span class="comment"> *   You should have received a copy of the GNU General Public License</span>
00019 <span class="comment"> *   along with this program; if not, write to the Free Software</span>
00020 <span class="comment"> *   Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA 02111-1307, USA.</span>
00021 <span class="comment"> *</span>
00022 <span class="comment"> * Revision History:</span>
00023 <span class="comment"> *</span>
00024 <span class="comment"> *   See ChangeLog</span>
00025 <span class="comment"> */</span>
00026 
00027 <span class="preprocessor">#ifdef HAVE_CONFIG_H</span>
00028 <span class="preprocessor"></span><span class="preprocessor">#include &lt;config.h&gt;</span>
00029 <span class="preprocessor">#endif</span>
00030 <span class="preprocessor"></span><span class="preprocessor">#include &lt;<a class="code" href="gimp-print_8h.html">gimp-print/gimp-print.h</a>&gt;</span>
00031 <span class="preprocessor">#include "<a class="code" href="gimp-print-internal_8h.html">gimp-print-internal.h</a>"</span>
00032 <span class="preprocessor">#include &lt;<a class="code" href="gimp-print-intl-internal_8h.html">gimp-print/gimp-print-intl-internal.h</a>&gt;</span>
00033 <span class="preprocessor">#ifdef HAVE_LIMITS_H</span>
00034 <span class="preprocessor"></span><span class="preprocessor">#include &lt;limits.h&gt;</span>
00035 <span class="preprocessor">#endif</span>
00036 <span class="preprocessor"></span><span class="preprocessor">#include &lt;math.h&gt;</span>
00037 <span class="preprocessor">#include &lt;string.h&gt;</span>
00038 
00039 <span class="preprocessor">#ifdef __GNUC__</span>
00040 <span class="preprocessor"></span><span class="preprocessor">#define inline __inline__</span>
00041 <span class="preprocessor"></span><span class="preprocessor">#endif</span>
00042 <span class="preprocessor"></span>
<a name="l00043"></a><a class="code" href="structstpi__subchannel__t.html">00043</a> <span class="keyword">typedef</span> <span class="keyword">struct</span>
00044 <span class="keyword"></span>{
<a name="l00045"></a><a class="code" href="structstpi__subchannel__t.html#o0">00045</a>   <span class="keywordtype">double</span> value;
<a name="l00046"></a><a class="code" href="structstpi__subchannel__t.html#o1">00046</a>   <span class="keywordtype">double</span> lower;
<a name="l00047"></a><a class="code" href="structstpi__subchannel__t.html#o2">00047</a>   <span class="keywordtype">double</span> upper;
<a name="l00048"></a><a class="code" href="structstpi__subchannel__t.html#o3">00048</a>   <span class="keywordtype">double</span> cutoff;
<a name="l00049"></a><a class="code" href="structstpi__subchannel__t.html#o4">00049</a>   <span class="keywordtype">unsigned</span> <span class="keywordtype">short</span> s_density;
00050 } <a class="code" href="structstpi__subchannel__t.html">stpi_subchannel_t</a>;
00051 
<a name="l00052"></a><a class="code" href="structstpi__channel__t.html">00052</a> <span class="keyword">typedef</span> <span class="keyword">struct</span>
00053 <span class="keyword"></span>{
<a name="l00054"></a><a class="code" href="structstpi__channel__t.html#o0">00054</a>   <span class="keywordtype">unsigned</span> subchannel_count;
<a name="l00055"></a><a class="code" href="structstpi__channel__t.html#o1">00055</a>   <a class="code" href="structstpi__subchannel__t.html">stpi_subchannel_t</a> *sc;
<a name="l00056"></a><a class="code" href="structstpi__channel__t.html#o2">00056</a>   <span class="keywordtype">unsigned</span> <span class="keywordtype">short</span> *lut;
00057 } <a class="code" href="structstpi__channel__t.html">stpi_channel_t</a>;
00058 
<a name="l00059"></a><a class="code" href="structstpi__channel__group__t.html">00059</a> <span class="keyword">typedef</span> <span class="keyword">struct</span>
00060 <span class="keyword"></span>{
<a name="l00061"></a><a class="code" href="structstpi__channel__group__t.html#o0">00061</a>   <span class="keywordtype">unsigned</span> channel_count;
<a name="l00062"></a><a class="code" href="structstpi__channel__group__t.html#o1">00062</a>   <span class="keywordtype">unsigned</span> total_channels;
<a name="l00063"></a><a class="code" href="structstpi__channel__group__t.html#o2">00063</a>   <span class="keywordtype">unsigned</span> input_channels;
<a name="l00064"></a><a class="code" href="structstpi__channel__group__t.html#o3">00064</a>   size_t width;
<a name="l00065"></a><a class="code" href="structstpi__channel__group__t.html#o4">00065</a>   <span class="keywordtype">int</span> initialized;
<a name="l00066"></a><a class="code" href="structstpi__channel__group__t.html#o5">00066</a>   <span class="keywordtype">unsigned</span> ink_limit;
<a name="l00067"></a><a class="code" href="structstpi__channel__group__t.html#o6">00067</a>   <span class="keywordtype">unsigned</span> max_density;
<a name="l00068"></a><a class="code" href="structstpi__channel__group__t.html#o7">00068</a>   <a class="code" href="structstpi__channel__t.html">stpi_channel_t</a> *c;
<a name="l00069"></a><a class="code" href="structstpi__channel__group__t.html#o8">00069</a>   <span class="keywordtype">unsigned</span> <span class="keywordtype">short</span> *input_data;
<a name="l00070"></a><a class="code" href="structstpi__channel__group__t.html#o9">00070</a>   <span class="keywordtype">unsigned</span> <span class="keywordtype">short</span> *data;
<a name="l00071"></a><a class="code" href="structstpi__channel__group__t.html#o10">00071</a>   <span class="keywordtype">int</span> black_channel;
00072 } <a class="code" href="structstpi__channel__group__t.html">stpi_channel_group_t</a>;
00073 
00074 
00075 <span class="keyword">static</span> <span class="keywordtype">void</span>
<a name="l00076"></a><a class="code" href="channel_8c.html#a0">00076</a> <a class="code" href="channel_8c.html#a0">clear_a_channel</a>(<a class="code" href="structstpi__channel__group__t.html">stpi_channel_group_t</a> *cg, <span class="keywordtype">int</span> channel)
00077 {
00078   <span class="keywordflow">if</span> (channel &lt; cg-&gt;<a class="code" href="structstpi__channel__group__t.html#o0">channel_count</a>)
00079     {
00080       <a class="code" href="group__util.html#ga52">STP_SAFE_FREE</a>(cg-&gt;<a class="code" href="structstpi__channel__group__t.html#o7">c</a>[channel].<a class="code" href="structstpi__channel__t.html#o1">sc</a>);
00081       <a class="code" href="group__util.html#ga52">STP_SAFE_FREE</a>(cg-&gt;<a class="code" href="structstpi__channel__group__t.html#o7">c</a>[channel].<a class="code" href="structstpi__channel__t.html#o2">lut</a>);
00082       cg-&gt;<a class="code" href="structstpi__channel__group__t.html#o7">c</a>[channel].<a class="code" href="structstpi__channel__t.html#o0">subchannel_count</a> = 0;
00083     }
00084 }
00085 
00086 <span class="keyword">static</span> <span class="keywordtype">void</span>
<a name="l00087"></a><a class="code" href="channel_8c.html#a1">00087</a> <a class="code" href="channel_8c.html#a1">stpi_channel_clear</a>(<span class="keywordtype">void</span> *vc)
00088 {
00089   <a class="code" href="structstpi__channel__group__t.html">stpi_channel_group_t</a> *cg = (<a class="code" href="structstpi__channel__group__t.html">stpi_channel_group_t</a> *) vc;
00090   <span class="keywordtype">int</span> i;
00091   <span class="keywordflow">if</span> (cg-&gt;<a class="code" href="structstpi__channel__group__t.html#o0">channel_count</a> &gt; 0)
00092     <span class="keywordflow">for</span> (i = 0; i &lt; cg-&gt;<a class="code" href="structstpi__channel__group__t.html#o0">channel_count</a>; i++)
00093       <a class="code" href="channel_8c.html#a0">clear_a_channel</a>(cg, i);
00094   <span class="keywordflow">if</span> (cg-&gt;<a class="code" href="structstpi__channel__group__t.html#o9">data</a> != cg-&gt;<a class="code" href="structstpi__channel__group__t.html#o8">input_data</a>)
00095     <a class="code" href="group__util.html#ga52">STP_SAFE_FREE</a>(cg-&gt;<a class="code" href="structstpi__channel__group__t.html#o9">data</a>);
00096   <a class="code" href="group__util.html#ga52">STP_SAFE_FREE</a>(cg-&gt;<a class="code" href="structstpi__channel__group__t.html#o8">input_data</a>);
00097   <a class="code" href="group__util.html#ga52">STP_SAFE_FREE</a>(cg-&gt;<a class="code" href="structstpi__channel__group__t.html#o7">c</a>);
00098   cg-&gt;<a class="code" href="structstpi__channel__group__t.html#o0">channel_count</a> = 0;
00099   cg-&gt;<a class="code" href="structstpi__channel__group__t.html#o1">total_channels</a> = 0;
00100   cg-&gt;<a class="code" href="structstpi__channel__group__t.html#o2">input_channels</a> = 0;
00101   cg-&gt;<a class="code" href="structstpi__channel__group__t.html#o4">initialized</a> = 0;
00102 }
00103 
00104 <span class="keywordtype">void</span>
<a name="l00105"></a><a class="code" href="channel_8c.html#a2">00105</a> <a class="code" href="channel_8c.html#a2">stp_channel_reset</a>(<a class="code" href="structstp__vars.html">stp_vars_t</a> *v)
00106 {
00107   <a class="code" href="structstpi__channel__group__t.html">stpi_channel_group_t</a> *cg =
00108     ((<a class="code" href="structstpi__channel__group__t.html">stpi_channel_group_t</a> *) <a class="code" href="group__vars.html#ga20">stp_get_component_data</a>(v, <span class="stringliteral">"Channel"</span>));
00109   <span class="keywordflow">if</span> (cg)
00110     <a class="code" href="channel_8c.html#a1">stpi_channel_clear</a>(cg);
00111 }
00112 
00113 <span class="keywordtype">void</span>
<a name="l00114"></a><a class="code" href="channel_8c.html#a3">00114</a> <a class="code" href="channel_8c.html#a3">stp_channel_reset_channel</a>(<a class="code" href="structstp__vars.html">stp_vars_t</a> *v, <span class="keywordtype">int</span> channel)
00115 {
00116   <a class="code" href="structstpi__channel__group__t.html">stpi_channel_group_t</a> *cg =
00117     ((<a class="code" href="structstpi__channel__group__t.html">stpi_channel_group_t</a> *) <a class="code" href="group__vars.html#ga20">stp_get_component_data</a>(v, <span class="stringliteral">"Channel"</span>));
00118   <span class="keywordflow">if</span> (cg)
00119     <a class="code" href="channel_8c.html#a0">clear_a_channel</a>(cg, channel);
00120 }
00121 
00122 <span class="keyword">static</span> <span class="keywordtype">void</span>
<a name="l00123"></a><a class="code" href="channel_8c.html#a4">00123</a> <a class="code" href="channel_8c.html#a4">stpi_channel_free</a>(<span class="keywordtype">void</span> *vc)
00124 {
00125   <a class="code" href="channel_8c.html#a1">stpi_channel_clear</a>(vc);
00126   <a class="code" href="group__util.html#ga31">stp_free</a>(vc);
00127 }
00128 
00129 <span class="keyword">static</span> <a class="code" href="structstpi__subchannel__t.html">stpi_subchannel_t</a> *
<a name="l00130"></a><a class="code" href="channel_8c.html#a5">00130</a> <a class="code" href="channel_8c.html#a5">get_channel</a>(<a class="code" href="structstp__vars.html">stp_vars_t</a> *v, <span class="keywordtype">unsigned</span> channel, <span class="keywordtype">unsigned</span> subchannel)
00131 {
00132   <a class="code" href="structstpi__channel__group__t.html">stpi_channel_group_t</a> *cg =
00133     ((<a class="code" href="structstpi__channel__group__t.html">stpi_channel_group_t</a> *) <a class="code" href="group__vars.html#ga20">stp_get_component_data</a>(v, <span class="stringliteral">"Channel"</span>));
00134   <span class="keywordflow">if</span> (!cg)
00135     <span class="keywordflow">return</span> NULL;
00136   <span class="keywordflow">if</span> (channel &gt;= cg-&gt;<a class="code" href="structstpi__channel__group__t.html#o0">channel_count</a>)
00137     <span class="keywordflow">return</span> NULL;
00138   <span class="keywordflow">if</span> (subchannel &gt;= cg-&gt;<a class="code" href="structstpi__channel__group__t.html#o7">c</a>[channel].<a class="code" href="structstpi__channel__t.html#o0">subchannel_count</a>)
00139     <span class="keywordflow">return</span> NULL;
00140   <span class="keywordflow">return</span> &amp;(cg-&gt;<a class="code" href="structstpi__channel__group__t.html#o7">c</a>[channel].<a class="code" href="structstpi__channel__t.html#o1">sc</a>[subchannel]);
00141 }
00142 
00143 <span class="keywordtype">void</span>
<a name="l00144"></a><a class="code" href="channel_8c.html#a6">00144</a> <a class="code" href="channel_8c.html#a6">stp_channel_add</a>(<a class="code" href="structstp__vars.html">stp_vars_t</a> *v, <span class="keywordtype">unsigned</span> channel, <span class="keywordtype">unsigned</span> subchannel,
00145                 <span class="keywordtype">double</span> value)
00146 {
00147   <a class="code" href="structstpi__channel__group__t.html">stpi_channel_group_t</a> *cg =
00148     ((<a class="code" href="structstpi__channel__group__t.html">stpi_channel_group_t</a> *) <a class="code" href="group__vars.html#ga20">stp_get_component_data</a>(v, <span class="stringliteral">"Channel"</span>));
00149   <a class="code" href="structstpi__channel__t.html">stpi_channel_t</a> *chan;
00150   <span class="keywordflow">if</span> (!cg)
00151     {
00152       cg = <a class="code" href="group__util.html#ga29">stp_zalloc</a>(<span class="keyword">sizeof</span>(<a class="code" href="structstpi__channel__group__t.html">stpi_channel_group_t</a>));
00153       cg-&gt;<a class="code" href="structstpi__channel__group__t.html#o10">black_channel</a> = -1;
00154       <a class="code" href="group__vars.html#ga18">stp_allocate_component_data</a>(v, <span class="stringliteral">"Channel"</span>, NULL, <a class="code" href="channel_8c.html#a4">stpi_channel_free</a>, cg);
00155     }
00156   <span class="keywordflow">if</span> (channel &gt;= cg-&gt;<a class="code" href="structstpi__channel__group__t.html#o0">channel_count</a>)
00157     {
00158       <span class="keywordtype">unsigned</span> oc = cg-&gt;<a class="code" href="structstpi__channel__group__t.html#o0">channel_count</a>;
00159       cg-&gt;<a class="code" href="structstpi__channel__group__t.html#o7">c</a> = <a class="code" href="group__util.html#ga30">stp_realloc</a>(cg-&gt;<a class="code" href="structstpi__channel__group__t.html#o7">c</a>, <span class="keyword">sizeof</span>(<a class="code" href="structstpi__channel__t.html">stpi_channel_t</a>) * (channel + 1));
00160       memset(cg-&gt;<a class="code" href="structstpi__channel__group__t.html#o7">c</a> + oc, 0, <span class="keyword">sizeof</span>(stpi_channel_t) * (channel + 1 - oc));
00161       <span class="keywordflow">if</span> (channel &gt;= cg-&gt;<a class="code" href="structstpi__channel__group__t.html#o0">channel_count</a>)
00162         cg-&gt;<a class="code" href="structstpi__channel__group__t.html#o0">channel_count</a> = channel + 1;
00163     }
00164   chan = cg-&gt;<a class="code" href="structstpi__channel__group__t.html#o7">c</a> + channel;
00165   <span class="keywordflow">if</span> (subchannel &gt;= chan-&gt;<a class="code" href="structstpi__channel__t.html#o0">subchannel_count</a>)
00166     {
00167       <span class="keywordtype">unsigned</span> oc = chan-&gt;<a class="code" href="structstpi__channel__t.html#o0">subchannel_count</a>;
00168       chan-&gt;<a class="code" href="structstpi__channel__t.html#o1">sc</a> =
00169         <a class="code" href="group__util.html#ga30">stp_realloc</a>(chan-&gt;<a class="code" href="structstpi__channel__t.html#o1">sc</a>, <span class="keyword">sizeof</span>(<a class="code" href="structstpi__subchannel__t.html">stpi_subchannel_t</a>) * (subchannel + 1));
00170       (<span class="keywordtype">void</span>) memset
00171         (chan-&gt;<a class="code" href="structstpi__channel__t.html#o1">sc</a> + oc, 0, <span class="keyword">sizeof</span>(stpi_subchannel_t) * (subchannel + 1 - oc));
00172       chan-&gt;<a class="code" href="structstpi__channel__t.html#o1">sc</a>[subchannel].<a class="code" href="structstpi__subchannel__t.html#o0">value</a> = value;
00173       <span class="keywordflow">if</span> (subchannel &gt;= chan-&gt;<a class="code" href="structstpi__channel__t.html#o0">subchannel_count</a>)
00174         chan-&gt;<a class="code" href="structstpi__channel__t.html#o0">subchannel_count</a> = subchannel + 1;
00175     }
00176   chan-&gt;<a class="code" href="structstpi__channel__t.html#o1">sc</a>[subchannel].<a class="code" href="structstpi__subchannel__t.html#o0">value</a> = value;
00177   chan-&gt;<a class="code" href="structstpi__channel__t.html#o1">sc</a>[subchannel].<a class="code" href="structstpi__subchannel__t.html#o4">s_density</a> = 65535;
00178   chan-&gt;<a class="code" href="structstpi__channel__t.html#o1">sc</a>[subchannel].<a class="code" href="structstpi__subchannel__t.html#o3">cutoff</a> = 0.75;
00179 }
00180 
00181 <span class="keywordtype">void</span>
<a name="l00182"></a><a class="code" href="channel_8c.html#a7">00182</a> <a class="code" href="channel_8c.html#a7">stp_channel_set_density_adjustment</a>(<a class="code" href="structstp__vars.html">stp_vars_t</a> *v, <span class="keywordtype">int</span> color, <span class="keywordtype">int</span> subchannel,
00183                                    <span class="keywordtype">double</span> adjustment)
00184 {
00185   <a class="code" href="structstpi__subchannel__t.html">stpi_subchannel_t</a> *sch = <a class="code" href="channel_8c.html#a5">get_channel</a>(v, color, subchannel);
00186   <span class="keywordflow">if</span> ((strcmp(<a class="code" href="group__vars.html#ga36">stp_get_string_parameter</a>(v, <span class="stringliteral">"STPIOutputType"</span>), <span class="stringliteral">"Raw"</span>) == 0 &amp;&amp;
00187        strcmp(<a class="code" href="group__vars.html#ga36">stp_get_string_parameter</a>(v, <span class="stringliteral">"ColorCorrection"</span>), <span class="stringliteral">"None"</span>) == 0) ||
00188       strcmp(<a class="code" href="group__vars.html#ga36">stp_get_string_parameter</a>(v, <span class="stringliteral">"ColorCorrection"</span>), <span class="stringliteral">"Raw"</span>) == 0 ||
00189       strcmp(<a class="code" href="group__vars.html#ga36">stp_get_string_parameter</a>(v, <span class="stringliteral">"ColorCorrection"</span>), <span class="stringliteral">"Predithered"</span>) == 0)
00190     {
00191       <a class="code" href="print-util_8c.html#a23">stp_dprintf</a>(<a class="code" href="group__util.html#ga33">STP_DBG_INK</a>, v,
00192                   <span class="stringliteral">"Ignoring channel_density channel %d subchannel %d adjustment %f\n"</span>,
00193                   color, subchannel, adjustment);
00194     }
00195   <span class="keywordflow">else</span>
00196     {
00197       <a class="code" href="print-util_8c.html#a23">stp_dprintf</a>(<a class="code" href="group__util.html#ga33">STP_DBG_INK</a>, v,
00198                   <span class="stringliteral">"channel_density channel %d subchannel %d adjustment %f\n"</span>,
00199                   color, subchannel, adjustment);
00200       <span class="keywordflow">if</span> (sch &amp;&amp; adjustment &gt;= 0 &amp;&amp; adjustment &lt;= 1)
00201         sch-&gt;<a class="code" href="structstpi__subchannel__t.html#o4">s_density</a> = adjustment * 65535;
00202     }
00203 }
00204 
00205 <span class="keywordtype">void</span>
<a name="l00206"></a><a class="code" href="channel_8c.html#a8">00206</a> <a class="code" href="channel_8c.html#a8">stp_channel_set_ink_limit</a>(<a class="code" href="structstp__vars.html">stp_vars_t</a> *v, <span class="keywordtype">double</span> limit)
00207 {
00208   <a class="code" href="structstpi__channel__group__t.html">stpi_channel_group_t</a> *cg =
00209     ((<a class="code" href="structstpi__channel__group__t.html">stpi_channel_group_t</a> *) <a class="code" href="group__vars.html#ga20">stp_get_component_data</a>(v, <span class="stringliteral">"Channel"</span>));
00210   <a class="code" href="print-util_8c.html#a23">stp_dprintf</a>(<a class="code" href="group__util.html#ga33">STP_DBG_INK</a>, v, <span class="stringliteral">"ink_limit %f\n"</span>, limit);
00211   <span class="keywordflow">if</span> (limit &gt; 0)
00212     cg-&gt;<a class="code" href="structstpi__channel__group__t.html#o5">ink_limit</a> = 65535 * limit;
00213 }
00214 
00215 <span class="keywordtype">void</span>
<a name="l00216"></a><a class="code" href="channel_8c.html#a9">00216</a> <a class="code" href="channel_8c.html#a9">stp_channel_set_black_channel</a>(<a class="code" href="structstp__vars.html">stp_vars_t</a> *v, <span class="keywordtype">int</span> channel)
00217 {
00218   <a class="code" href="structstpi__channel__group__t.html">stpi_channel_group_t</a> *cg =
00219     ((<a class="code" href="structstpi__channel__group__t.html">stpi_channel_group_t</a> *) <a class="code" href="group__vars.html#ga20">stp_get_component_data</a>(v, <span class="stringliteral">"Channel"</span>));
00220   <a class="code" href="print-util_8c.html#a23">stp_dprintf</a>(<a class="code" href="group__util.html#ga33">STP_DBG_INK</a>, v, <span class="stringliteral">"black_channel %d\n"</span>, channel);
00221   cg-&gt;<a class="code" href="structstpi__channel__group__t.html#o10">black_channel</a> = channel;
00222 }
00223 
00224 <span class="keywordtype">void</span>
<a name="l00225"></a><a class="code" href="channel_8c.html#a10">00225</a> <a class="code" href="channel_8c.html#a10">stp_channel_set_cutoff_adjustment</a>(<a class="code" href="structstp__vars.html">stp_vars_t</a> *v, <span class="keywordtype">int</span> color, <span class="keywordtype">int</span> subchannel,
00226                                   <span class="keywordtype">double</span> adjustment)
00227 {
00228   <a class="code" href="structstpi__subchannel__t.html">stpi_subchannel_t</a> *sch = <a class="code" href="channel_8c.html#a5">get_channel</a>(v, color, subchannel);
00229   <a class="code" href="print-util_8c.html#a23">stp_dprintf</a>(<a class="code" href="group__util.html#ga33">STP_DBG_INK</a>, v,
00230               <span class="stringliteral">"channel_cutoff channel %d subchannel %d adjustment %f\n"</span>,
00231               color, subchannel, adjustment);
00232   <span class="keywordflow">if</span> (sch &amp;&amp; adjustment &gt;= 0)
00233     sch-&gt;<a class="code" href="structstpi__subchannel__t.html#o3">cutoff</a> = adjustment;
00234 }
00235 
00236 <span class="keyword">static</span> <span class="keywordtype">int</span>
<a name="l00237"></a><a class="code" href="channel_8c.html#a11">00237</a> <a class="code" href="channel_8c.html#a11">input_needs_splitting</a>(<span class="keyword">const</span> <a class="code" href="structstp__vars.html">stp_vars_t</a> *v)
00238 {
00239   <span class="keyword">const</span> <a class="code" href="structstpi__channel__group__t.html">stpi_channel_group_t</a> *cg =
00240     ((<span class="keyword">const</span> <a class="code" href="structstpi__channel__group__t.html">stpi_channel_group_t</a> *) <a class="code" href="group__vars.html#ga20">stp_get_component_data</a>(v, <span class="stringliteral">"Channel"</span>));
00241 <span class="preprocessor">#if 1</span>
00242 <span class="preprocessor"></span>  <span class="keywordflow">return</span> cg-&gt;<a class="code" href="structstpi__channel__group__t.html#o1">total_channels</a> != cg-&gt;<a class="code" href="structstpi__channel__group__t.html#o2">input_channels</a>;
00243 <span class="preprocessor">#else</span>
00244 <span class="preprocessor"></span>  <span class="keywordtype">int</span> i;
00245   <span class="keywordflow">if</span> (!cg || cg-&gt;<a class="code" href="structstpi__channel__group__t.html#o0">channel_count</a> &lt;= 0)
00246     <span class="keywordflow">return</span> 0;
00247   <span class="keywordflow">for</span> (i = 0; i &lt; cg-&gt;<a class="code" href="structstpi__channel__group__t.html#o0">channel_count</a>; i++)
00248     {
00249       <span class="keywordflow">if</span> (cg-&gt;<a class="code" href="structstpi__channel__group__t.html#o7">c</a>[i].<a class="code" href="structstpi__channel__t.html#o0">subchannel_count</a> &gt; 1)
00250         <span class="keywordflow">return</span> 1;
00251     }
00252   <span class="keywordflow">return</span> 0;
00253 <span class="preprocessor">#endif</span>
00254 <span class="preprocessor"></span>}
00255 
00256 <span class="keywordtype">void</span>
<a name="l00257"></a><a class="code" href="channel_8c.html#a12">00257</a> <a class="code" href="channel_8c.html#a12">stp_channel_initialize</a>(<a class="code" href="structstp__vars.html">stp_vars_t</a> *v, <a class="code" href="structstp__image.html">stp_image_t</a> *image,
00258                        <span class="keywordtype">int</span> input_channel_count)
00259 {
00260   <a class="code" href="structstpi__channel__group__t.html">stpi_channel_group_t</a> *cg =
00261     ((<a class="code" href="structstpi__channel__group__t.html">stpi_channel_group_t</a> *) <a class="code" href="group__vars.html#ga20">stp_get_component_data</a>(v, <span class="stringliteral">"Channel"</span>));
00262   <span class="keywordtype">int</span> width = <a class="code" href="group__image.html#ga2">stp_image_width</a>(image);
00263   <span class="keywordtype">int</span> i, j, k;
00264   <span class="keywordflow">if</span> (!cg)
00265     {
00266       cg = <a class="code" href="group__util.html#ga29">stp_zalloc</a>(<span class="keyword">sizeof</span>(<a class="code" href="structstpi__channel__group__t.html">stpi_channel_group_t</a>));
00267       cg-&gt;<a class="code" href="structstpi__channel__group__t.html#o10">black_channel</a> = -1;
00268       <a class="code" href="group__vars.html#ga18">stp_allocate_component_data</a>(v, <span class="stringliteral">"Channel"</span>, NULL, <a class="code" href="channel_8c.html#a4">stpi_channel_free</a>, cg);
00269     }
00270   <span class="keywordflow">if</span> (cg-&gt;<a class="code" href="structstpi__channel__group__t.html#o4">initialized</a>)
00271     <span class="keywordflow">return</span>;
00272   cg-&gt;<a class="code" href="structstpi__channel__group__t.html#o4">initialized</a> = 1;
00273   cg-&gt;<a class="code" href="structstpi__channel__group__t.html#o6">max_density</a> = 0;
00274   <span class="keywordflow">if</span> (cg-&gt;<a class="code" href="structstpi__channel__group__t.html#o10">black_channel</a> &lt; -1 || cg-&gt;<a class="code" href="structstpi__channel__group__t.html#o10">black_channel</a> &gt;= cg-&gt;<a class="code" href="structstpi__channel__group__t.html#o0">channel_count</a>)
00275     cg-&gt;<a class="code" href="structstpi__channel__group__t.html#o10">black_channel</a> = -1;
00276   <span class="keywordflow">for</span> (i = 0; i &lt; cg-&gt;<a class="code" href="structstpi__channel__group__t.html#o0">channel_count</a>; i++)
00277     {
00278       <a class="code" href="structstpi__channel__t.html">stpi_channel_t</a> *c = &amp;(cg-&gt;<a class="code" href="structstpi__channel__group__t.html#o7">c</a>[i]);
00279       <span class="keywordtype">int</span> sc = c-&gt;<a class="code" href="structstpi__channel__t.html#o0">subchannel_count</a>;
00280       <span class="keywordflow">if</span> (sc &gt; 1)
00281         {
00282           <span class="keywordtype">int</span> val = 0;
00283           <span class="keywordtype">int</span> next_breakpoint;
00284           c-&gt;<a class="code" href="structstpi__channel__t.html#o2">lut</a> = <a class="code" href="group__util.html#ga29">stp_zalloc</a>(<span class="keyword">sizeof</span>(<span class="keywordtype">unsigned</span> <span class="keywordtype">short</span>) * sc * 65536);
00285           next_breakpoint = c-&gt;<a class="code" href="structstpi__channel__t.html#o1">sc</a>[0].<a class="code" href="structstpi__subchannel__t.html#o0">value</a> * 65535 * c-&gt;<a class="code" href="structstpi__channel__t.html#o1">sc</a>[0].<a class="code" href="structstpi__subchannel__t.html#o3">cutoff</a>;
00286           <span class="keywordflow">if</span> (next_breakpoint &gt; 65535)
00287             next_breakpoint = 65535;
00288           <span class="keywordflow">while</span> (val &lt;= next_breakpoint)
00289             {
00290               <span class="keywordtype">int</span> value = (<span class="keywordtype">int</span>) ((<span class="keywordtype">double</span>) val / c-&gt;<a class="code" href="structstpi__channel__t.html#o1">sc</a>[0].<a class="code" href="structstpi__subchannel__t.html#o0">value</a>);
00291               c-&gt;<a class="code" href="structstpi__channel__t.html#o2">lut</a>[val * sc + sc - 1] = value;
00292               val++;
00293             }
00294 
00295           <span class="keywordflow">for</span> (k = 0; k &lt; sc - 1; k++)
00296             {
00297               <span class="keywordtype">double</span> this_val = c-&gt;<a class="code" href="structstpi__channel__t.html#o1">sc</a>[k].<a class="code" href="structstpi__subchannel__t.html#o0">value</a>;
00298               <span class="keywordtype">double</span> next_val = c-&gt;<a class="code" href="structstpi__channel__t.html#o1">sc</a>[k + 1].<a class="code" href="structstpi__subchannel__t.html#o0">value</a>;
00299               <span class="keywordtype">double</span> this_cutoff = c-&gt;<a class="code" href="structstpi__channel__t.html#o1">sc</a>[k].<a class="code" href="structstpi__subchannel__t.html#o3">cutoff</a>;
00300               <span class="keywordtype">double</span> next_cutoff = c-&gt;<a class="code" href="structstpi__channel__t.html#o1">sc</a>[k + 1].<a class="code" href="structstpi__subchannel__t.html#o3">cutoff</a>;
00301               <span class="keywordtype">int</span> range;
00302               <span class="keywordtype">int</span> base = val;
00303               <span class="keywordtype">double</span> cutoff = sqrt(this_cutoff * next_cutoff);
00304               next_breakpoint = next_val * 65535 * cutoff;
00305               <span class="keywordflow">if</span> (next_breakpoint &gt; 65535)
00306                 next_breakpoint = 65535;
00307               range = next_breakpoint - val;
00308               <span class="keywordflow">while</span> (val &lt;= next_breakpoint)
00309                 {
00310                   <span class="keywordtype">double</span> where = ((<span class="keywordtype">double</span>) val - base) / (<span class="keywordtype">double</span>) range;
00311                   <span class="keywordtype">double</span> lower_val = base * (1.0 - where);
00312                   <span class="keywordtype">double</span> lower_amount = lower_val / this_val;
00313                   <span class="keywordtype">double</span> upper_amount = (val - lower_val) / next_val;
00314                   c-&gt;<a class="code" href="structstpi__channel__t.html#o2">lut</a>[val * sc + sc - k - 2] = upper_amount;
00315                   c-&gt;<a class="code" href="structstpi__channel__t.html#o2">lut</a>[val * sc + sc - k - 1] = lower_amount;
00316                   val++;
00317                 }
00318             }
00319           <span class="keywordflow">while</span> (val &lt;= 65535)
00320             {
00321               c-&gt;<a class="code" href="structstpi__channel__t.html#o2">lut</a>[val * sc] = val / c-&gt;<a class="code" href="structstpi__channel__t.html#o1">sc</a>[sc - 1].<a class="code" href="structstpi__subchannel__t.html#o0">value</a>;
00322               val++;
00323             }
00324         }
00325       cg-&gt;<a class="code" href="structstpi__channel__group__t.html#o1">total_channels</a> += c-&gt;<a class="code" href="structstpi__channel__t.html#o0">subchannel_count</a>;
00326       <span class="keywordflow">for</span> (j = 0; j &lt; c-&gt;<a class="code" href="structstpi__channel__t.html#o0">subchannel_count</a>; j++)
00327         cg-&gt;<a class="code" href="structstpi__channel__group__t.html#o6">max_density</a> += c-&gt;<a class="code" href="structstpi__channel__t.html#o1">sc</a>[j].<a class="code" href="structstpi__subchannel__t.html#o4">s_density</a>;
00328     }
00329   cg-&gt;<a class="code" href="structstpi__channel__group__t.html#o2">input_channels</a> = input_channel_count;
00330   cg-&gt;<a class="code" href="structstpi__channel__group__t.html#o3">width</a> = width;
00331   cg-&gt;<a class="code" href="structstpi__channel__group__t.html#o9">data</a> = <a class="code" href="group__util.html#ga28">stp_malloc</a>(<span class="keyword">sizeof</span>(<span class="keywordtype">unsigned</span> <span class="keywordtype">short</span>) * cg-&gt;<a class="code" href="structstpi__channel__group__t.html#o1">total_channels</a> * width);
00332   <span class="keywordflow">if</span> (!<a class="code" href="channel_8c.html#a11">input_needs_splitting</a>(v))
00333     {
00334       cg-&gt;<a class="code" href="structstpi__channel__group__t.html#o8">input_data</a> = cg-&gt;<a class="code" href="structstpi__channel__group__t.html#o9">data</a>;
00335       <span class="keywordflow">return</span>;
00336     }
00337   cg-&gt;<a class="code" href="structstpi__channel__group__t.html#o8">input_data</a> =
00338     <a class="code" href="group__util.html#ga28">stp_malloc</a>(<span class="keyword">sizeof</span>(<span class="keywordtype">unsigned</span> <span class="keywordtype">short</span>) * cg-&gt;<a class="code" href="structstpi__channel__group__t.html#o2">input_channels</a> * width);
00339 }
00340 
00341 <span class="keyword">static</span> <span class="keywordtype">void</span>
<a name="l00342"></a><a class="code" href="channel_8c.html#a13">00342</a> <a class="code" href="channel_8c.html#a13">clear_channel</a>(<span class="keywordtype">unsigned</span> <span class="keywordtype">short</span> *data, <span class="keywordtype">unsigned</span> width, <span class="keywordtype">unsigned</span> depth)
00343 {
00344   <span class="keywordtype">int</span> i;
00345   width *= depth;
00346   <span class="keywordflow">for</span> (i = 0; i &lt; width; i += depth)
00347     data[i] = 0;
00348 }
00349 
00350 <span class="keyword">static</span> <span class="keywordtype">int</span>
<a name="l00351"></a><a class="code" href="channel_8c.html#a14">00351</a> <a class="code" href="channel_8c.html#a14">scale_channel</a>(<span class="keywordtype">unsigned</span> <span class="keywordtype">short</span> *data, <span class="keywordtype">unsigned</span> width, <span class="keywordtype">unsigned</span> depth,
00352               <span class="keywordtype">unsigned</span> <span class="keywordtype">short</span> density)
00353 {
00354   <span class="keywordtype">int</span> i;
00355   <span class="keywordtype">int</span> retval = 0;
00356   <span class="keywordtype">unsigned</span> <span class="keywordtype">short</span> previous_data = 0;
00357   <span class="keywordtype">unsigned</span> <span class="keywordtype">short</span> previous_value = 0;
00358   <span class="keywordflow">if</span> (density &gt; 65535)
00359     density = 65535;
00360   width *= depth;
00361   <span class="keywordflow">for</span> (i = 0; i &lt; width; i += depth)
00362     {
00363       <span class="keywordflow">if</span> (data[i] == previous_data)
00364         data[i] = previous_value;
00365       <span class="keywordflow">else</span> <span class="keywordflow">if</span> (data[i] == (<span class="keywordtype">unsigned</span> <span class="keywordtype">short</span>) 65535)
00366         {
00367           data[i] = density;
00368           retval = 1;
00369         }
00370       <span class="keywordflow">else</span> <span class="keywordflow">if</span> (data[i] &gt; 0)
00371         {
00372           <span class="keywordtype">unsigned</span> <span class="keywordtype">short</span> tval = (32767u + data[i] * density) / 65535u;
00373           previous_data = data[i];
00374           <span class="keywordflow">if</span> (tval)
00375             retval = 1;
00376           previous_value = (<span class="keywordtype">unsigned</span> <span class="keywordtype">short</span>) tval;
00377           data[i] = (<span class="keywordtype">unsigned</span> <span class="keywordtype">short</span>) tval;
00378         }
00379     }
00380   <span class="keywordflow">return</span> retval;
00381 }
00382 
00383 <span class="keyword">static</span> <span class="keywordtype">int</span>
<a name="l00384"></a><a class="code" href="channel_8c.html#a15">00384</a> <a class="code" href="channel_8c.html#a15">scan_channel</a>(<span class="keywordtype">unsigned</span> <span class="keywordtype">short</span> *data, <span class="keywordtype">unsigned</span> width, <span class="keywordtype">unsigned</span> depth)
00385 {
00386   <span class="keywordtype">int</span> i;
00387   width *= depth;
00388   <span class="keywordflow">for</span> (i = 0; i &lt; width; i += depth)
00389     {
00390       <span class="keywordflow">if</span> (data[i])
00391         <span class="keywordflow">return</span> 1;
00392     }
00393   <span class="keywordflow">return</span> 0;
00394 }
00395 
00396 <span class="keyword">static</span> <span class="keyword">inline</span> <span class="keywordtype">unsigned</span>
<a name="l00397"></a><a class="code" href="channel_8c.html#a16">00397</a> <a class="code" href="channel_8c.html#a16">ink_sum</a>(<span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">short</span> *data, <span class="keywordtype">int</span> total_channels)
00398 {
00399   <span class="keywordtype">int</span> j;
00400   <span class="keywordtype">unsigned</span> total_ink = 0;
00401   <span class="keywordflow">for</span> (j = 0; j &lt; total_channels; j++)
00402     total_ink += data[j];
00403   <span class="keywordflow">return</span> total_ink;
00404 }
00405 
00406 <span class="keyword">static</span> <span class="keywordtype">int</span>
<a name="l00407"></a><a class="code" href="channel_8c.html#a17">00407</a> <a class="code" href="channel_8c.html#a17">limit_ink</a>(<span class="keyword">const</span> <a class="code" href="structstp__vars.html">stp_vars_t</a> *v)
00408 {
00409   <span class="keywordtype">int</span> i;
00410   <span class="keywordtype">int</span> retval = 0;
00411   <a class="code" href="structstpi__channel__group__t.html">stpi_channel_group_t</a> *cg =
00412     ((<a class="code" href="structstpi__channel__group__t.html">stpi_channel_group_t</a> *) <a class="code" href="group__vars.html#ga20">stp_get_component_data</a>(v, <span class="stringliteral">"Channel"</span>));
00413   <span class="keywordtype">unsigned</span> <span class="keywordtype">short</span> *ptr = cg-&gt;<a class="code" href="structstpi__channel__group__t.html#o9">data</a>;
00414   <span class="keywordflow">if</span> (cg-&gt;<a class="code" href="structstpi__channel__group__t.html#o5">ink_limit</a> == 0 || cg-&gt;<a class="code" href="structstpi__channel__group__t.html#o5">ink_limit</a> &gt;= cg-&gt;<a class="code" href="structstpi__channel__group__t.html#o6">max_density</a>)
00415     <span class="keywordflow">return</span> 0;
00416   <span class="keywordflow">for</span> (i = 0; i &lt; cg-&gt;<a class="code" href="structstpi__channel__group__t.html#o3">width</a>; i++)
00417     {
00418       <span class="keywordtype">int</span> total_ink = <a class="code" href="channel_8c.html#a16">ink_sum</a>(ptr, cg-&gt;<a class="code" href="structstpi__channel__group__t.html#o1">total_channels</a>);
00419       <span class="keywordflow">if</span> (total_ink &gt; cg-&gt;<a class="code" href="structstpi__channel__group__t.html#o5">ink_limit</a>) <span class="comment">/* Need to limit ink? */</span>
00420         {
00421           <span class="keywordtype">int</span> j;
00422           <span class="comment">/*</span>
00423 <span class="comment">           * FIXME we probably should first try to convert light ink to dark</span>
00424 <span class="comment">           */</span>
00425           <span class="keywordtype">double</span> ratio = (<span class="keywordtype">double</span>) cg-&gt;<a class="code" href="structstpi__channel__group__t.html#o5">ink_limit</a> / (<span class="keywordtype">double</span>) total_ink;
00426           <span class="keywordflow">for</span> (j = 0; j &lt; cg-&gt;<a class="code" href="structstpi__channel__group__t.html#o1">total_channels</a>; j++)
00427             ptr[j] *= ratio;
00428           retval = 1;
00429         }
00430       ptr += cg-&gt;<a class="code" href="structstpi__channel__group__t.html#o1">total_channels</a>;
00431    }
00432   <span class="keywordflow">return</span> retval;
00433 }
00434 
00435 <span class="keyword">static</span> <span class="keyword">inline</span> <span class="keywordtype">int</span>
<a name="l00436"></a><a class="code" href="channel_8c.html#a18">00436</a> <a class="code" href="channel_8c.html#a18">mem_eq</a>(<span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">short</span> *i1, <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">short</span> *i2, <span class="keywordtype">int</span> count)
00437 {
00438   <span class="keywordtype">int</span> i;
00439   <span class="keywordflow">for</span> (i = 0; i &lt; count; i++)
00440     <span class="keywordflow">if</span> (i1[i] != i2[i])
00441       <span class="keywordflow">return</span> 0;
00442   <span class="keywordflow">return</span> 1;
00443 }
00444 
00445 <span class="keywordtype">void</span>
<a name="l00446"></a><a class="code" href="channel_8c.html#a19">00446</a> <a class="code" href="channel_8c.html#a19">stp_channel_convert</a>(<span class="keyword">const</span> <a class="code" href="structstp__vars.html">stp_vars_t</a> *v, <span class="keywordtype">unsigned</span> *zero_mask)
00447 {
00448   <a class="code" href="structstpi__channel__group__t.html">stpi_channel_group_t</a> *cg =
00449     ((<a class="code" href="structstpi__channel__group__t.html">stpi_channel_group_t</a> *) <a class="code" href="group__vars.html#ga20">stp_get_component_data</a>(v, <span class="stringliteral">"Channel"</span>));
00450   <span class="keywordtype">int</span> i, j, k;
00451   <span class="keywordtype">int</span> nz[<a class="code" href="group__image.html#ga8">STP_CHANNEL_LIMIT</a>];
00452   <span class="keywordtype">int</span> outbytes = cg-&gt;<a class="code" href="structstpi__channel__group__t.html#o1">total_channels</a> * <span class="keyword">sizeof</span>(<span class="keywordtype">unsigned</span> <span class="keywordtype">short</span>);
00453   <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">short</span> *input_cache = NULL;
00454   <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">short</span> *output_cache = NULL;
00455   <span class="keywordtype">unsigned</span> black_value = 0;
00456   <span class="keywordtype">unsigned</span> l_val = 0;
00457   <span class="keywordtype">unsigned</span> i_val = 0;
00458   <span class="keywordtype">unsigned</span> o_val = 0;
00459   <span class="keywordtype">unsigned</span> offset = 0;
00460   <span class="keywordtype">unsigned</span> virtual_black = 0;
00461   memset(nz, 0, <span class="keyword">sizeof</span>(nz));
00462   <span class="keywordflow">if</span> (<a class="code" href="channel_8c.html#a11">input_needs_splitting</a>(v))
00463     {
00464       <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">short</span> *input = cg-&gt;<a class="code" href="structstpi__channel__group__t.html#o8">input_data</a>;
00465       <span class="keywordtype">unsigned</span> <span class="keywordtype">short</span> *output = cg-&gt;<a class="code" href="structstpi__channel__group__t.html#o9">data</a>;
00466       <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">short</span> *o_output;
00467       <span class="keywordflow">for</span> (i = 0; i &lt; cg-&gt;<a class="code" href="structstpi__channel__group__t.html#o3">width</a>; i++)
00468         {
00469           <span class="keywordtype">int</span> zero_ptr = 0;
00470           <span class="keywordflow">if</span> (input_cache &amp;&amp; <a class="code" href="channel_8c.html#a18">mem_eq</a>(input_cache, input, cg-&gt;<a class="code" href="structstpi__channel__group__t.html#o2">input_channels</a>))
00471             {
00472               memcpy(output, output_cache, outbytes);
00473               input += cg-&gt;<a class="code" href="structstpi__channel__group__t.html#o2">input_channels</a>;
00474               output += cg-&gt;<a class="code" href="structstpi__channel__group__t.html#o1">total_channels</a>;
00475             }
00476           <span class="keywordflow">else</span>
00477             {
00478               input_cache = input;
00479               black_value = 0;
00480               o_output = output;
00481               <span class="keywordflow">if</span> (cg-&gt;<a class="code" href="structstpi__channel__group__t.html#o10">black_channel</a> &gt;= 0)
00482                 black_value = input[cg-&gt;<a class="code" href="structstpi__channel__group__t.html#o10">black_channel</a>];
00483               virtual_black = 65535;
00484               <span class="keywordflow">for</span> (j = 0; j &lt; cg-&gt;<a class="code" href="structstpi__channel__group__t.html#o0">channel_count</a>; j++)
00485                 {
00486                   <span class="keywordflow">if</span> (input[j] &lt; virtual_black &amp;&amp; j != cg-&gt;<a class="code" href="structstpi__channel__group__t.html#o10">black_channel</a>)
00487                     virtual_black = input[j];
00488                 }
00489               black_value += virtual_black / 4;
00490               <span class="keywordflow">for</span> (j = 0; j &lt; cg-&gt;<a class="code" href="structstpi__channel__group__t.html#o0">channel_count</a>; j++)
00491                 {
00492                   <a class="code" href="structstpi__channel__t.html">stpi_channel_t</a> *c = &amp;(cg-&gt;<a class="code" href="structstpi__channel__group__t.html#o7">c</a>[j]);
00493                   <span class="keywordtype">int</span> s_count = c-&gt;<a class="code" href="structstpi__channel__t.html#o0">subchannel_count</a>;
00494                   <span class="keywordflow">if</span> (s_count &gt;= 1)
00495                     {
00496                       i_val = *input++;
00497                       <span class="keywordflow">if</span> (i_val == 0)
00498                         {
00499                           <span class="keywordflow">for</span> (k = 0; k &lt; s_count; k++)
00500                             *(output++) = 0;
00501                         }
00502                       <span class="keywordflow">else</span> <span class="keywordflow">if</span> (s_count == 1)
00503                         {
00504                           <span class="keywordflow">if</span> (c-&gt;<a class="code" href="structstpi__channel__t.html#o1">sc</a>[0].<a class="code" href="structstpi__subchannel__t.html#o4">s_density</a> &lt; 65535)
00505                             i_val = i_val * c-&gt;<a class="code" href="structstpi__channel__t.html#o1">sc</a>[0].<a class="code" href="structstpi__subchannel__t.html#o4">s_density</a> / 65535;
00506                           nz[zero_ptr++] |= *(output++) = i_val;
00507                         }
00508                       <span class="keywordflow">else</span>
00509                         {
00510                           l_val = i_val;
00511                           <span class="keywordflow">if</span> (i_val &gt; 0 &amp;&amp; black_value &amp;&amp;
00512                               j != cg-&gt;<a class="code" href="structstpi__channel__group__t.html#o10">black_channel</a>)
00513                             {
00514                               l_val += black_value;
00515                               <span class="keywordflow">if</span> (l_val &gt; 65535)
00516                                 l_val = 65535;
00517                             }
00518                           offset = l_val * s_count;
00519                           <span class="keywordflow">for</span> (k = 0; k &lt; s_count; k++)
00520                             {
00521                               <span class="keywordflow">if</span> (c-&gt;<a class="code" href="structstpi__channel__t.html#o1">sc</a>[k].<a class="code" href="structstpi__subchannel__t.html#o4">s_density</a> &gt; 0)
00522                                 {
00523                                   o_val = c-&gt;<a class="code" href="structstpi__channel__t.html#o2">lut</a>[offset + k];
00524                                   <span class="keywordflow">if</span> (i_val != l_val)
00525                                     o_val = o_val * i_val / l_val;
00526                                   <span class="keywordflow">if</span> (c-&gt;<a class="code" href="structstpi__channel__t.html#o1">sc</a>[k].<a class="code" href="structstpi__subchannel__t.html#o4">s_density</a> &lt; 65535)
00527                                     o_val = o_val * c-&gt;<a class="code" href="structstpi__channel__t.html#o1">sc</a>[k].<a class="code" href="structstpi__subchannel__t.html#o4">s_density</a> / 65535;
00528                                 }
00529                               <span class="keywordflow">else</span>
00530                                 o_val = 0;
00531                               *output++ = o_val;
00532                               nz[zero_ptr++] |= o_val;
00533                             }
00534                         }
00535                     }
00536                 }
00537               output_cache = o_output;
00538             }
00539         }
00540       <span class="keywordflow">if</span> (zero_mask)
00541         {
00542           *zero_mask = 0;
00543           <span class="keywordflow">for</span> (i = 0; i &lt; cg-&gt;<a class="code" href="structstpi__channel__group__t.html#o1">total_channels</a>; i++)
00544             <span class="keywordflow">if</span> (!nz[i])
00545               *zero_mask |= 1 &lt;&lt; i;
00546         }
00547     }
00548   <span class="keywordflow">else</span>
00549     {
00550       <span class="keywordtype">int</span> physical_channel = 0;
00551       <span class="keywordflow">if</span> (zero_mask)
00552         *zero_mask = 0;
00553       <span class="keywordflow">for</span> (i = 0; i &lt; cg-&gt;<a class="code" href="structstpi__channel__group__t.html#o0">channel_count</a>; i++)
00554         {
00555           <a class="code" href="structstpi__channel__t.html">stpi_channel_t</a> *ch = &amp;(cg-&gt;<a class="code" href="structstpi__channel__group__t.html#o7">c</a>[i]);
00556           <span class="keywordflow">if</span> (ch-&gt;<a class="code" href="structstpi__channel__t.html#o0">subchannel_count</a> &gt; 0)
00557             <span class="keywordflow">for</span> (j = 0; j &lt; ch-&gt;<a class="code" href="structstpi__channel__t.html#o0">subchannel_count</a>; j++)
00558               {
00559                 <a class="code" href="structstpi__subchannel__t.html">stpi_subchannel_t</a> *sch = &amp;(ch-&gt;<a class="code" href="structstpi__channel__t.html#o1">sc</a>[j]);
00560                 <span class="keywordtype">unsigned</span> density = sch-&gt;<a class="code" href="structstpi__subchannel__t.html#o4">s_density</a>;
00561                 <span class="keywordtype">unsigned</span> <span class="keywordtype">short</span> *output = cg-&gt;<a class="code" href="structstpi__channel__group__t.html#o9">data</a> + physical_channel;
00562                 <span class="keywordflow">if</span> (density == 0)
00563                   {
00564                     <a class="code" href="channel_8c.html#a13">clear_channel</a>(output, cg-&gt;<a class="code" href="structstpi__channel__group__t.html#o3">width</a>, cg-&gt;<a class="code" href="structstpi__channel__group__t.html#o1">total_channels</a>);
00565                     <span class="keywordflow">if</span> (zero_mask)
00566                       *zero_mask |= 1 &lt;&lt; physical_channel;
00567                   }
00568                 <span class="keywordflow">else</span> <span class="keywordflow">if</span> (density != 65535)
00569                   {
00570                     <span class="keywordflow">if</span> (<a class="code" href="channel_8c.html#a14">scale_channel</a>(output, cg-&gt;<a class="code" href="structstpi__channel__group__t.html#o3">width</a>, cg-&gt;<a class="code" href="structstpi__channel__group__t.html#o1">total_channels</a>,
00571                                       density) == 0)
00572                       <span class="keywordflow">if</span> (zero_mask)
00573                         *zero_mask |= 1 &lt;&lt; physical_channel;
00574                   }
00575                 <span class="keywordflow">else</span> <span class="keywordflow">if</span> (zero_mask)
00576                   {
00577                     <span class="keywordflow">if</span> (<a class="code" href="channel_8c.html#a15">scan_channel</a>(output, cg-&gt;<a class="code" href="structstpi__channel__group__t.html#o3">width</a>, cg-&gt;<a class="code" href="structstpi__channel__group__t.html#o1">total_channels</a>) == 0)
00578                       *zero_mask |= 1 &lt;&lt; physical_channel;
00579                   }
00580                 physical_channel++;
00581               }
00582         }
00583     }
00584   (<span class="keywordtype">void</span>) <a class="code" href="channel_8c.html#a17">limit_ink</a>(v);
00585 }
00586 
00587 <span class="keywordtype">unsigned</span> <span class="keywordtype">short</span> *
<a name="l00588"></a><a class="code" href="channel_8c.html#a20">00588</a> <a class="code" href="channel_8c.html#a20">stp_channel_get_input</a>(<span class="keyword">const</span> <a class="code" href="structstp__vars.html">stp_vars_t</a> *v)
00589 {
00590   <a class="code" href="structstpi__channel__group__t.html">stpi_channel_group_t</a> *cg =
00591     ((<a class="code" href="structstpi__channel__group__t.html">stpi_channel_group_t</a> *) <a class="code" href="group__vars.html#ga20">stp_get_component_data</a>(v, <span class="stringliteral">"Channel"</span>));
00592   <span class="keywordflow">return</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">short</span> *) cg-&gt;<a class="code" href="structstpi__channel__group__t.html#o8">input_data</a>;
00593 }
00594 
00595 <span class="keywordtype">unsigned</span> <span class="keywordtype">short</span> *
<a name="l00596"></a><a class="code" href="channel_8c.html#a21">00596</a> <a class="code" href="channel_8c.html#a21">stp_channel_get_output</a>(<span class="keyword">const</span> <a class="code" href="structstp__vars.html">stp_vars_t</a> *v)
00597 {
00598   <a class="code" href="structstpi__channel__group__t.html">stpi_channel_group_t</a> *cg =
00599     ((<a class="code" href="structstpi__channel__group__t.html">stpi_channel_group_t</a> *) <a class="code" href="group__vars.html#ga20">stp_get_component_data</a>(v, <span class="stringliteral">"Channel"</span>));
00600   <span class="keywordflow">return</span> cg-&gt;<a class="code" href="structstpi__channel__group__t.html#o9">data</a>;
00601 }
</pre></div><hr size="1"><address style="align: right;"><small>Generated on Wed Aug 25 07:56:13 2004 for libgimpprint API Reference by
<a href="http://www.doxygen.org/index.html">
<img src="doxygen.png" alt="doxygen" align="middle" border=0 > </a>1.3.6 </small></address>
</body>
</html>
