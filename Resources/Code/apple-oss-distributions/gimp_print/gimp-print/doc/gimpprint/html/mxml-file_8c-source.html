<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>libgimpprint API Reference: src/main/mxml-file.c Source File</title>
<link href="doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.6 -->
<div class="qindex"><a class="qindex" href="index.html">Main&nbsp;Page</a> | <a class="qindex" href="modules.html">Modules</a> | <a class="qindex" href="classes.html">Alphabetical&nbsp;List</a> | <a class="qindex" href="annotated.html">Data&nbsp;Structures</a> | <a class="qindex" href="files.html">File&nbsp;List</a> | <a class="qindex" href="functions.html">Data&nbsp;Fields</a> | <a class="qindex" href="globals.html">Globals</a> | <a class="qindex" href="pages.html">Related&nbsp;Pages</a></div>
<h1>src/main/mxml-file.c</h1><a href="mxml-file_8c.html">Go to the documentation of this file.</a><div class="fragment"><pre>00001 <span class="comment">/*</span>
00002 <span class="comment"> * "$Id: mxml-file_8c-source.html,v 1.1.1.2 2004/12/22 23:49:05 jlovell Exp $"</span>
00003 <span class="comment"> *</span>
00004 <span class="comment"> * File loading code for mini-XML, a small XML-like file parsing library.</span>
00005 <span class="comment"> *</span>
00006 <span class="comment"> * Copyright 2003 by Michael Sweet.</span>
00007 <span class="comment"> *</span>
00008 <span class="comment"> * This program is free software; you can redistribute it and/or</span>
00009 <span class="comment"> * modify it under the terms of the GNU Library General Public</span>
00010 <span class="comment"> * License as published by the Free Software Foundation; either</span>
00011 <span class="comment"> * version 2, or (at your option) any later version.</span>
00012 <span class="comment"> *</span>
00013 <span class="comment"> * This program is distributed in the hope that it will be useful,</span>
00014 <span class="comment"> * but WITHOUT ANY WARRANTY; without even the implied warranty of</span>
00015 <span class="comment"> * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the</span>
00016 <span class="comment"> * GNU General Public License for more details.</span>
00017 <span class="comment"> *</span>
00018 <span class="comment"> * Contents:</span>
00019 <span class="comment"> *</span>
00020 <span class="comment"> *   stp_mxmlLoadFile()        - Load a file into an XML node tree.</span>
00021 <span class="comment"> *   stp_mxmlLoadString()      - Load a string into an XML node tree.</span>
00022 <span class="comment"> *   stp_mxmlSaveAllocString() - Save an XML node tree to an allocated string.</span>
00023 <span class="comment"> *   stp_mxmlSaveFile()        - Save an XML tree to a file.</span>
00024 <span class="comment"> *   stp_mxmlSaveString()      - Save an XML node tree to a string.</span>
00025 <span class="comment"> *   mxml_add_char()       - Add a character to a buffer, expanding as needed.</span>
00026 <span class="comment"> *   mxml_file_getc()      - Get a character from a file.</span>
00027 <span class="comment"> *   mxml_load_data()      - Load data into an XML node tree.</span>
00028 <span class="comment"> *   mxml_parse_element()  - Parse an element for any attributes...</span>
00029 <span class="comment"> *   mxml_string_getc()    - Get a character from a string.</span>
00030 <span class="comment"> *   mxml_write_node()     - Save an XML node to a file.</span>
00031 <span class="comment"> *   mxml_write_string()   - Write a string, escaping &amp; and &lt; as needed.</span>
00032 <span class="comment"> *   mxml_write_ws()       - Do whitespace callback...</span>
00033 <span class="comment"> */</span>
00034 
00035 <span class="comment">/*</span>
00036 <span class="comment"> * Include necessary headers...</span>
00037 <span class="comment"> */</span>
00038 
00039 <span class="preprocessor">#include &lt;<a class="code" href="mxml_8h.html">gimp-print/mxml.h</a>&gt;</span>
00040 <span class="preprocessor">#include "config.h"</span>
00041 
00042 
00043 <span class="comment">/*</span>
00044 <span class="comment"> * Local functions...</span>
00045 <span class="comment"> */</span>
00046 
00047 <span class="keyword">static</span> <span class="keywordtype">int</span>              <a class="code" href="mxml-file_8c.html#a0">mxml_add_char</a>(<span class="keywordtype">int</span> ch, <span class="keywordtype">char</span> **ptr, <span class="keywordtype">char</span> **buffer,
00048                                       <span class="keywordtype">int</span> *bufsize);
00049 <span class="keyword">static</span> <span class="keywordtype">int</span>              <a class="code" href="mxml-file_8c.html#a1">mxml_file_getc</a>(<span class="keywordtype">void</span> *p);
00050 <span class="keyword">static</span> <span class="keywordtype">int</span>              <a class="code" href="mxml-file_8c.html#a2">mxml_file_putc</a>(<span class="keywordtype">int</span> ch, <span class="keywordtype">void</span> *p);
00051 <span class="keyword">static</span> <a class="code" href="structstp__mxml__node__s.html">stp_mxml_node_t</a>  *<a class="code" href="mxml-file_8c.html#a3">mxml_load_data</a>(<a class="code" href="structstp__mxml__node__s.html">stp_mxml_node_t</a> *top, <span class="keywordtype">void</span> *p,
00052                                         <a class="code" href="mxml_8h.html#a14">stp_mxml_type_t</a> (*cb)(<a class="code" href="structstp__mxml__node__s.html">stp_mxml_node_t</a> *),
00053                                         <span class="keywordtype">int</span> (*getc_cb)(<span class="keywordtype">void</span> *));
00054 <span class="keyword">static</span> <span class="keywordtype">int</span>              <a class="code" href="mxml-file_8c.html#a4">mxml_parse_element</a>(stp_mxml_node_t *node, <span class="keywordtype">void</span> *p,
00055                                            <span class="keywordtype">int</span> (*getc_cb)(<span class="keywordtype">void</span> *));
00056 <span class="keyword">static</span> <span class="keywordtype">int</span>              <a class="code" href="mxml-file_8c.html#a5">mxml_string_getc</a>(<span class="keywordtype">void</span> *p);
00057 <span class="keyword">static</span> <span class="keywordtype">int</span>              <a class="code" href="mxml-file_8c.html#a6">mxml_string_putc</a>(<span class="keywordtype">int</span> ch, <span class="keywordtype">void</span> *p);
00058 <span class="keyword">static</span> <span class="keywordtype">int</span>              <a class="code" href="mxml-file_8c.html#a7">mxml_write_node</a>(stp_mxml_node_t *node, <span class="keywordtype">void</span> *p,
00059                                         <span class="keywordtype">int</span> (*cb)(stp_mxml_node_t *, <span class="keywordtype">int</span>),
00060                                         <span class="keywordtype">int</span> col,
00061                                         <span class="keywordtype">int</span> (*putc_cb)(<span class="keywordtype">int</span>, <span class="keywordtype">void</span> *));
00062 <span class="keyword">static</span> <span class="keywordtype">int</span>              <a class="code" href="mxml-file_8c.html#a8">mxml_write_string</a>(<span class="keyword">const</span> <span class="keywordtype">char</span> *s, <span class="keywordtype">void</span> *p,
00063                                           <span class="keywordtype">int</span> (*putc_cb)(<span class="keywordtype">int</span>, <span class="keywordtype">void</span> *));
00064 <span class="keyword">static</span> <span class="keywordtype">int</span>              <a class="code" href="mxml-file_8c.html#a9">mxml_write_ws</a>(stp_mxml_node_t *node, <span class="keywordtype">void</span> *p, 
00065                                       <span class="keywordtype">int</span> (*cb)(stp_mxml_node_t *, <span class="keywordtype">int</span>), <span class="keywordtype">int</span> ws,
00066                                       <span class="keywordtype">int</span> col, <span class="keywordtype">int</span> (*putc_cb)(<span class="keywordtype">int</span>, <span class="keywordtype">void</span> *));
00067 
00068 
00069 <span class="comment">/*</span>
00070 <span class="comment"> * 'stp_mxmlLoadFile()' - Load a file into an XML node tree.</span>
00071 <span class="comment"> *</span>
00072 <span class="comment"> * The nodes in the specified file are added to the specified top node.</span>
00073 <span class="comment"> * If no top node is provided, the XML file MUST be well-formed with a</span>
00074 <span class="comment"> * single parent node like &lt;?xml&gt; for the entire file. The callback</span>
00075 <span class="comment"> * function returns the value type that should be used for child nodes.</span>
00076 <span class="comment"> * If STP_MXML_NO_CALLBACK is specified then all child nodes will be either</span>
00077 <span class="comment"> * STP_MXML_ELEMENT or STP_MXML_TEXT nodes.</span>
00078 <span class="comment"> */</span>
00079 
00080 <a class="code" href="mxml_8h.html#a19">stp_mxml_node_t</a> *                               <span class="comment">/* O - First node or NULL if the file could not be read. */</span>
<a name="l00081"></a><a class="code" href="mxml-file_8c.html#a10">00081</a> <a class="code" href="mxml-file_8c.html#a10">stp_mxmlLoadFile</a>(stp_mxml_node_t *top,          <span class="comment">/* I - Top node */</span>
00082              FILE        *fp,           <span class="comment">/* I - File to read from */</span>
00083              <a class="code" href="mxml_8h.html#a14">stp_mxml_type_t</a> (*cb)(stp_mxml_node_t *))
00084                                         <span class="comment">/* I - Callback function or STP_MXML_NO_CALLBACK */</span>
00085 {
00086   <span class="keywordflow">return</span> (<a class="code" href="mxml-file_8c.html#a3">mxml_load_data</a>(top, fp, cb, <a class="code" href="mxml-file_8c.html#a1">mxml_file_getc</a>));
00087 }
00088 
00089 
00090 <span class="comment">/*</span>
00091 <span class="comment"> * 'stp_mxmlLoadString()' - Load a string into an XML node tree.</span>
00092 <span class="comment"> *</span>
00093 <span class="comment"> * The nodes in the specified string are added to the specified top node.</span>
00094 <span class="comment"> * If no top node is provided, the XML string MUST be well-formed with a</span>
00095 <span class="comment"> * single parent node like &lt;?xml&gt; for the entire string. The callback</span>
00096 <span class="comment"> * function returns the value type that should be used for child nodes.</span>
00097 <span class="comment"> * If STP_MXML_NO_CALLBACK is specified then all child nodes will be either</span>
00098 <span class="comment"> * STP_MXML_ELEMENT or STP_MXML_TEXT nodes.</span>
00099 <span class="comment"> */</span>
00100 
00101 <a class="code" href="mxml_8h.html#a19">stp_mxml_node_t</a> *                               <span class="comment">/* O - First node or NULL if the string has errors. */</span>
<a name="l00102"></a><a class="code" href="mxml-file_8c.html#a11">00102</a> <a class="code" href="mxml-file_8c.html#a11">stp_mxmlLoadString</a>(stp_mxml_node_t *top,        <span class="comment">/* I - Top node */</span>
00103                <span class="keyword">const</span> <span class="keywordtype">char</span>  *s,          <span class="comment">/* I - String to load */</span>
00104                <a class="code" href="mxml_8h.html#a14">stp_mxml_type_t</a> (*cb)(stp_mxml_node_t *))
00105                                         <span class="comment">/* I - Callback function or STP_MXML_NO_CALLBACK */</span>
00106 {
00107   <span class="keywordflow">return</span> (<a class="code" href="mxml-file_8c.html#a3">mxml_load_data</a>(top, &amp;s, cb, <a class="code" href="mxml-file_8c.html#a5">mxml_string_getc</a>));
00108 }
00109 
00110 
00111 <span class="comment">/*</span>
00112 <span class="comment"> * 'stp_mxmlSaveAllocString()' - Save an XML node tree to an allocated string.</span>
00113 <span class="comment"> *</span>
00114 <span class="comment"> * This function returns a pointer to a string containing the textual</span>
00115 <span class="comment"> * representation of the XML node tree.  The string should be freed</span>
00116 <span class="comment"> * using the free() function when you are done with it.  NULL is returned</span>
00117 <span class="comment"> * if the node would produce an empty string or if the string cannot be</span>
00118 <span class="comment"> * allocated.</span>
00119 <span class="comment"> */</span>
00120 
00121 <span class="keywordtype">char</span> *                                  <span class="comment">/* O - Allocated string or NULL */</span>
<a name="l00122"></a><a class="code" href="mxml-file_8c.html#a12">00122</a> <a class="code" href="mxml-file_8c.html#a12">stp_mxmlSaveAllocString</a>(stp_mxml_node_t *node,  <span class="comment">/* I - Node to write */</span>
00123                     <span class="keywordtype">int</span>         (*cb)(stp_mxml_node_t *, <span class="keywordtype">int</span>))
00124                                         <span class="comment">/* I - Whitespace callback or STP_MXML_NO_CALLBACK */</span>
00125 {
00126   <span class="keywordtype">int</span>   bytes;                          <span class="comment">/* Required bytes */</span>
00127   <span class="keywordtype">char</span>  buffer[8192];                   <span class="comment">/* Temporary buffer */</span>
00128   <span class="keywordtype">char</span>  *s;                             <span class="comment">/* Allocated string */</span>
00129 
00130 
00131  <span class="comment">/*</span>
00132 <span class="comment">  * Write the node to the temporary buffer...</span>
00133 <span class="comment">  */</span>
00134 
00135   bytes = <a class="code" href="mxml-file_8c.html#a14">stp_mxmlSaveString</a>(node, buffer, <span class="keyword">sizeof</span>(buffer), cb);
00136 
00137   <span class="keywordflow">if</span> (bytes &lt;= 0)
00138     <span class="keywordflow">return</span> (NULL);
00139 
00140   <span class="keywordflow">if</span> (bytes &lt; (<span class="keywordtype">int</span>)(<span class="keyword">sizeof</span>(buffer) - 1))
00141   {
00142    <span class="comment">/*</span>
00143 <span class="comment">    * Node fit inside the buffer, so just duplicate that string and</span>
00144 <span class="comment">    * return...</span>
00145 <span class="comment">    */</span>
00146 
00147     <span class="keywordflow">return</span> (strdup(buffer));
00148   }
00149 
00150  <span class="comment">/*</span>
00151 <span class="comment">  * Allocate a buffer of the required size and save the node to the</span>
00152 <span class="comment">  * new buffer...</span>
00153 <span class="comment">  */</span>
00154 
00155   <span class="keywordflow">if</span> ((s = malloc(bytes + 1)) == NULL)
00156     <span class="keywordflow">return</span> (NULL);
00157 
00158   <a class="code" href="mxml-file_8c.html#a14">stp_mxmlSaveString</a>(node, s, bytes + 1, cb);
00159 
00160  <span class="comment">/*</span>
00161 <span class="comment">  * Return the allocated string...</span>
00162 <span class="comment">  */</span>
00163 
00164   <span class="keywordflow">return</span> (s);
00165 }
00166 
00167 
00168 <span class="comment">/*</span>
00169 <span class="comment"> * 'stp_mxmlSaveFile()' - Save an XML tree to a file.</span>
00170 <span class="comment"> *</span>
00171 <span class="comment"> * The callback argument specifies a function that returns a whitespace</span>
00172 <span class="comment"> * character or nul (0) before and after each element. If STP_MXML_NO_CALLBACK</span>
00173 <span class="comment"> * is specified, whitespace will only be added before STP_MXML_TEXT nodes</span>
00174 <span class="comment"> * with leading whitespace and before attribute names inside opening</span>
00175 <span class="comment"> * element tags.</span>
00176 <span class="comment"> */</span>
00177 
00178 <span class="keywordtype">int</span>                                     <span class="comment">/* O - 0 on success, -1 on error. */</span>
<a name="l00179"></a><a class="code" href="mxml-file_8c.html#a13">00179</a> <a class="code" href="mxml-file_8c.html#a13">stp_mxmlSaveFile</a>(stp_mxml_node_t *node,         <span class="comment">/* I - Node to write */</span>
00180              FILE        *fp,           <span class="comment">/* I - File to write to */</span>
00181              <span class="keywordtype">int</span>         (*cb)(stp_mxml_node_t *, <span class="keywordtype">int</span>))
00182                                         <span class="comment">/* I - Whitespace callback or STP_MXML_NO_CALLBACK */</span>
00183 {
00184   <span class="keywordtype">int</span>   col;                            <span class="comment">/* Final column */</span>
00185 
00186 
00187  <span class="comment">/*</span>
00188 <span class="comment">  * Write the node...</span>
00189 <span class="comment">  */</span>
00190 
00191   <span class="keywordflow">if</span> ((col = <a class="code" href="mxml-file_8c.html#a7">mxml_write_node</a>(node, fp, cb, 0, <a class="code" href="mxml-file_8c.html#a2">mxml_file_putc</a>)) &lt; 0)
00192     <span class="keywordflow">return</span> (-1);
00193 
00194   <span class="keywordflow">if</span> (col &gt; 0)
00195     <span class="keywordflow">if</span> (putc(<span class="charliteral">'\n'</span>, fp) &lt; 0)
00196       <span class="keywordflow">return</span> (-1);
00197 
00198  <span class="comment">/*</span>
00199 <span class="comment">  * Return 0 (success)...</span>
00200 <span class="comment">  */</span>
00201 
00202   <span class="keywordflow">return</span> (0);
00203 }
00204 
00205 
00206 <span class="comment">/*</span>
00207 <span class="comment"> * 'stp_mxmlSaveString()' - Save an XML node tree to a string.</span>
00208 <span class="comment"> *</span>
00209 <span class="comment"> * This function returns the total number of bytes that would be</span>
00210 <span class="comment"> * required for the string but only copies (bufsize - 1) characters</span>
00211 <span class="comment"> * into the specified buffer.</span>
00212 <span class="comment"> */</span>
00213 
00214 <span class="keywordtype">int</span>                                     <span class="comment">/* O - Size of string */</span>
<a name="l00215"></a><a class="code" href="mxml-file_8c.html#a14">00215</a> <a class="code" href="mxml-file_8c.html#a14">stp_mxmlSaveString</a>(stp_mxml_node_t *node,       <span class="comment">/* I - Node to write */</span>
00216                <span class="keywordtype">char</span>        *buffer,     <span class="comment">/* I - String buffer */</span>
00217                <span class="keywordtype">int</span>         bufsize,     <span class="comment">/* I - Size of string buffer */</span>
00218                <span class="keywordtype">int</span>         (*cb)(stp_mxml_node_t *, <span class="keywordtype">int</span>))
00219                                         <span class="comment">/* I - Whitespace callback or STP_MXML_NO_CALLBACK */</span>
00220 {
00221   <span class="keywordtype">int</span>   col;                            <span class="comment">/* Final column */</span>
00222   <span class="keywordtype">char</span>  *ptr[2];                        <span class="comment">/* Pointers for putc_cb */</span>
00223 
00224 
00225  <span class="comment">/*</span>
00226 <span class="comment">  * Write the node...</span>
00227 <span class="comment">  */</span>
00228 
00229   ptr[0] = buffer;
00230   ptr[1] = buffer + bufsize;
00231 
00232   <span class="keywordflow">if</span> ((col = <a class="code" href="mxml-file_8c.html#a7">mxml_write_node</a>(node, ptr, cb, 0, <a class="code" href="mxml-file_8c.html#a6">mxml_string_putc</a>)) &lt; 0)
00233     <span class="keywordflow">return</span> (-1);
00234 
00235   <span class="keywordflow">if</span> (col &gt; 0)
00236     <a class="code" href="mxml-file_8c.html#a6">mxml_string_putc</a>(<span class="charliteral">'\n'</span>, ptr);
00237 
00238  <span class="comment">/*</span>
00239 <span class="comment">  * Nul-terminate the buffer...</span>
00240 <span class="comment">  */</span>
00241 
00242   <span class="keywordflow">if</span> (ptr[0] &gt;= ptr[1])
00243     buffer[bufsize - 1] = <span class="charliteral">'\0'</span>;
00244   <span class="keywordflow">else</span>
00245     ptr[0][0] = <span class="charliteral">'\0'</span>;
00246 
00247  <span class="comment">/*</span>
00248 <span class="comment">  * Return the number of characters...</span>
00249 <span class="comment">  */</span>
00250 
00251   <span class="keywordflow">return</span> (ptr[0] - buffer);
00252 }
00253 
00254 
00255 <span class="comment">/*</span>
00256 <span class="comment"> * 'mxml_add_char()' - Add a character to a buffer, expanding as needed.</span>
00257 <span class="comment"> */</span>
00258 
00259 <span class="keyword">static</span> <span class="keywordtype">int</span>                              <span class="comment">/* O  - 0 on success, -1 on error */</span>
<a name="l00260"></a><a class="code" href="mxml-file_8c.html#a0">00260</a> <a class="code" href="mxml-file_8c.html#a0">mxml_add_char</a>(<span class="keywordtype">int</span>  ch,                  <span class="comment">/* I  - Character to add */</span>
00261               <span class="keywordtype">char</span> **bufptr,            <span class="comment">/* IO - Current position in buffer */</span>
00262               <span class="keywordtype">char</span> **buffer,            <span class="comment">/* IO - Current buffer */</span>
00263               <span class="keywordtype">int</span>  *bufsize)            <span class="comment">/* IO - Current buffer size */</span>
00264 {
00265   <span class="keywordtype">char</span>  *newbuffer;                     <span class="comment">/* New buffer value */</span>
00266 
00267 
00268   <span class="keywordflow">if</span> (*bufptr &gt;= (*buffer + *bufsize - 1))
00269   {
00270    <span class="comment">/*</span>
00271 <span class="comment">    * Increase the size of the buffer...</span>
00272 <span class="comment">    */</span>
00273 
00274     <span class="keywordflow">if</span> (*bufsize &lt; 1024)
00275       (*bufsize) *= 2;
00276     <span class="keywordflow">else</span>
00277       (*bufsize) += 1024;
00278 
00279     <span class="keywordflow">if</span> ((newbuffer = realloc(*buffer, *bufsize)) == NULL)
00280     {
00281       free(*buffer);
00282 
00283       fprintf(stderr, <span class="stringliteral">"Unable to expand string buffer to %d bytes!\n"</span>,
00284               *bufsize);
00285 
00286       <span class="keywordflow">return</span> (-1);
00287     }
00288 
00289     *bufptr = newbuffer + (*bufptr - *buffer);
00290     *buffer = newbuffer;
00291   }
00292 
00293   *(*bufptr)++ = ch;
00294 
00295   <span class="keywordflow">return</span> (0);
00296 }
00297 
00298 
00299 <span class="comment">/*</span>
00300 <span class="comment"> * 'mxml_file_getc()' - Get a character from a file.</span>
00301 <span class="comment"> */</span>
00302 
00303 <span class="keyword">static</span> <span class="keywordtype">int</span>                              <span class="comment">/* O - Character or EOF */</span>
<a name="l00304"></a><a class="code" href="mxml-file_8c.html#a1">00304</a> <a class="code" href="mxml-file_8c.html#a1">mxml_file_getc</a>(<span class="keywordtype">void</span> *p)                 <span class="comment">/* I - Pointer to file */</span>
00305 {
00306   <span class="keywordflow">return</span> (getc((FILE *)p));
00307 }
00308 
00309 
00310 <span class="comment">/*</span>
00311 <span class="comment"> * 'mxml_file_putc()' - Write a character to a file.</span>
00312 <span class="comment"> */</span>
00313 
00314 <span class="keyword">static</span> <span class="keywordtype">int</span>                              <span class="comment">/* O - 0 on success, -1 on failure */</span>
<a name="l00315"></a><a class="code" href="mxml-file_8c.html#a2">00315</a> <a class="code" href="mxml-file_8c.html#a2">mxml_file_putc</a>(<span class="keywordtype">int</span>  ch,                 <span class="comment">/* I - Character to write */</span>
00316                <span class="keywordtype">void</span> *p)                 <span class="comment">/* I - Pointer to file */</span>
00317 {
00318   <span class="keywordflow">return</span> (putc(ch, (FILE *)p));
00319 }
00320 
00321 
00322 <span class="comment">/*</span>
00323 <span class="comment"> * 'mxml_load_data()' - Load data into an XML node tree.</span>
00324 <span class="comment"> */</span>
00325 
00326 <span class="keyword">static</span> <a class="code" href="mxml_8h.html#a19">stp_mxml_node_t</a> *                        <span class="comment">/* O - First node or NULL if the file could not be read. */</span>
<a name="l00327"></a><a class="code" href="mxml-file_8c.html#a3">00327</a> <a class="code" href="mxml-file_8c.html#a3">mxml_load_data</a>(stp_mxml_node_t *top,    <span class="comment">/* I - Top node */</span>
00328                <span class="keywordtype">void</span>        *p,          <span class="comment">/* I - Pointer to data */</span>
00329                <a class="code" href="mxml_8h.html#a14">stp_mxml_type_t</a> (*cb)(stp_mxml_node_t *),
00330                                         <span class="comment">/* I - Callback function or STP_MXML_NO_CALLBACK */</span>
00331                <span class="keywordtype">int</span>         (*getc_cb)(<span class="keywordtype">void</span> *))
00332                                         <span class="comment">/* I - Read function */</span>
00333 {
00334   <a class="code" href="mxml_8h.html#a19">stp_mxml_node_t</a>       *node,                  <span class="comment">/* Current node */</span>
00335                 *parent;                <span class="comment">/* Current parent node */</span>
00336   <span class="keywordtype">int</span>           ch,                     <span class="comment">/* Character from file */</span>
00337                 whitespace;             <span class="comment">/* Non-zero if whitespace seen */</span>
00338   <span class="keywordtype">char</span>          *buffer,                <span class="comment">/* String buffer */</span>
00339                 *bufptr;                <span class="comment">/* Pointer into buffer */</span>
00340   <span class="keywordtype">int</span>           bufsize;                <span class="comment">/* Size of buffer */</span>
00341   <a class="code" href="mxml_8h.html#a14">stp_mxml_type_t</a>       type;                   <span class="comment">/* Current node type */</span>
00342 
00343 
00344  <span class="comment">/*</span>
00345 <span class="comment">  * Read elements and other nodes from the file...</span>
00346 <span class="comment">  */</span>
00347 
00348   <span class="keywordflow">if</span> ((buffer = malloc(64)) == NULL)
00349   {
00350     fputs(<span class="stringliteral">"Unable to allocate string buffer!\n"</span>, stderr);
00351     <span class="keywordflow">return</span> (NULL);
00352   }
00353 
00354   bufsize    = 64;
00355   bufptr     = buffer;
00356   parent     = top;
00357   whitespace = 0;
00358 
00359   <span class="keywordflow">if</span> (cb &amp;&amp; parent)
00360     type = (*cb)(parent);
00361   <span class="keywordflow">else</span>
00362     type = <a class="code" href="mxml_8h.html#a43a24">STP_MXML_TEXT</a>;
00363 
00364   <span class="keywordflow">while</span> ((ch = (*getc_cb)(p)) != EOF)
00365   {
00366     <span class="keywordflow">if</span> ((ch == <span class="charliteral">'&lt;'</span> || (isspace(ch) &amp;&amp; type != <a class="code" href="mxml_8h.html#a43a22">STP_MXML_OPAQUE</a>)) &amp;&amp; bufptr &gt; buffer)
00367     {
00368      <span class="comment">/*</span>
00369 <span class="comment">      * Add a new value node...</span>
00370 <span class="comment">      */</span>
00371 
00372       *bufptr = <span class="charliteral">'\0'</span>;
00373 
00374       <span class="keywordflow">switch</span> (type)
00375       {
00376         <span class="keywordflow">case</span> <a class="code" href="mxml_8h.html#a43a21">STP_MXML_INTEGER</a> :
00377             node = <a class="code" href="mxml-node_8c.html#a4">stp_mxmlNewInteger</a>(parent, strtol(buffer, &amp;bufptr, 0));
00378             <span class="keywordflow">break</span>;
00379 
00380         <span class="keywordflow">case</span> <a class="code" href="mxml_8h.html#a43a22">STP_MXML_OPAQUE</a> :
00381             node = <a class="code" href="mxml-node_8c.html#a5">stp_mxmlNewOpaque</a>(parent, buffer);
00382             <span class="keywordflow">break</span>;
00383 
00384         <span class="keywordflow">case</span> <a class="code" href="mxml_8h.html#a43a23">STP_MXML_REAL</a> :
00385             node = <a class="code" href="mxml-node_8c.html#a6">stp_mxmlNewReal</a>(parent, strtod(buffer, &amp;bufptr));
00386             <span class="keywordflow">break</span>;
00387 
00388         <span class="keywordflow">case</span> <a class="code" href="mxml_8h.html#a43a24">STP_MXML_TEXT</a> :
00389             node = <a class="code" href="mxml-node_8c.html#a7">stp_mxmlNewText</a>(parent, whitespace, buffer);
00390             <span class="keywordflow">break</span>;
00391 
00392         <span class="keywordflow">default</span> : <span class="comment">/* Should never happen... */</span>
00393             node = NULL;
00394             <span class="keywordflow">break</span>;
00395       }   
00396 
00397       <span class="keywordflow">if</span> (*bufptr)
00398       {
00399        <span class="comment">/*</span>
00400 <span class="comment">        * Bad integer/real number value...</span>
00401 <span class="comment">        */</span>
00402 
00403         fprintf(stderr, <span class="stringliteral">"Bad %s value '%s' in parent &lt;%s&gt;!\n"</span>,
00404                 type == <a class="code" href="mxml_8h.html#a43a21">STP_MXML_INTEGER</a> ? <span class="stringliteral">"integer"</span> : <span class="stringliteral">"real"</span>, buffer,
00405                 parent ? parent-&gt;<a class="code" href="structstp__mxml__node__s.html#o6">value</a>.<a class="code" href="unionstp__mxml__value__u.html#o0">element</a>.<a class="code" href="structstp__mxml__value__s.html#o0">name</a> : <span class="stringliteral">"null"</span>);
00406         <span class="keywordflow">break</span>;
00407       }
00408 
00409       bufptr     = buffer;
00410       whitespace = isspace(ch) &amp;&amp; type == <a class="code" href="mxml_8h.html#a43a24">STP_MXML_TEXT</a>;
00411 
00412       <span class="keywordflow">if</span> (!node)
00413       {
00414        <span class="comment">/*</span>
00415 <span class="comment">        * Just print error for now...</span>
00416 <span class="comment">        */</span>
00417 
00418         fprintf(stderr, <span class="stringliteral">"Unable to add value node of type %d to parent &lt;%s&gt;!\n"</span>,
00419                 type, parent ? parent-&gt;<a class="code" href="structstp__mxml__node__s.html#o6">value</a>.<a class="code" href="unionstp__mxml__value__u.html#o0">element</a>.<a class="code" href="structstp__mxml__value__s.html#o0">name</a> : <span class="stringliteral">"null"</span>);
00420         <span class="keywordflow">break</span>;
00421       }
00422     }
00423     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (isspace(ch) &amp;&amp; type == <a class="code" href="mxml_8h.html#a43a24">STP_MXML_TEXT</a>)
00424       whitespace = 1;
00425 
00426    <span class="comment">/*</span>
00427 <span class="comment">    * Add lone whitespace node if we have an element and existing</span>
00428 <span class="comment">    * whitespace...</span>
00429 <span class="comment">    */</span>
00430 
00431     <span class="keywordflow">if</span> (ch == <span class="charliteral">'&lt;'</span> &amp;&amp; whitespace &amp;&amp; type == <a class="code" href="mxml_8h.html#a43a24">STP_MXML_TEXT</a>)
00432     {
00433       <a class="code" href="mxml-node_8c.html#a7">stp_mxmlNewText</a>(parent, whitespace, <span class="stringliteral">""</span>);
00434       whitespace = 0;
00435     }
00436 
00437     <span class="keywordflow">if</span> (ch == <span class="charliteral">'&lt;'</span>)
00438     {
00439      <span class="comment">/*</span>
00440 <span class="comment">      * Start of open/close tag...</span>
00441 <span class="comment">      */</span>
00442 
00443       bufptr = buffer;
00444 
00445       <span class="keywordflow">while</span> ((ch = (*getc_cb)(p)) != EOF)
00446         <span class="keywordflow">if</span> (isspace(ch) || ch == <span class="charliteral">'&gt;'</span> || (ch == <span class="charliteral">'/'</span> &amp;&amp; bufptr &gt; buffer))
00447           <span class="keywordflow">break</span>;
00448         <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<a class="code" href="mxml-file_8c.html#a0">mxml_add_char</a>(ch, &amp;bufptr, &amp;buffer, &amp;bufsize))
00449         {
00450           free(buffer);
00451           <span class="keywordflow">return</span> (NULL);
00452         }
00453         <span class="keywordflow">else</span> <span class="keywordflow">if</span> ((bufptr - buffer) == 3 &amp;&amp; !strncmp(buffer, <span class="stringliteral">"!--"</span>, 3))
00454           <span class="keywordflow">break</span>;
00455 
00456       *bufptr = <span class="charliteral">'\0'</span>;
00457 
00458       <span class="keywordflow">if</span> (!strcmp(buffer, <span class="stringliteral">"!--"</span>))
00459       {
00460        <span class="comment">/*</span>
00461 <span class="comment">        * Gather rest of comment...</span>
00462 <span class="comment">        */</span>
00463 
00464         <span class="keywordflow">while</span> ((ch = (*getc_cb)(p)) != EOF)
00465         {
00466           <span class="keywordflow">if</span> (ch == <span class="charliteral">'&gt;'</span> &amp;&amp; bufptr &gt; (buffer + 4) &amp;&amp;
00467               !strncmp(bufptr - 2, <span class="stringliteral">"--"</span>, 2))
00468             <span class="keywordflow">break</span>;
00469           <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<a class="code" href="mxml-file_8c.html#a0">mxml_add_char</a>(ch, &amp;bufptr, &amp;buffer, &amp;bufsize))
00470           {
00471             free(buffer);
00472             <span class="keywordflow">return</span> (NULL);
00473           }
00474         }
00475 
00476        <span class="comment">/*</span>
00477 <span class="comment">        * Error out if we didn't get the whole comment...</span>
00478 <span class="comment">        */</span>
00479 
00480         <span class="keywordflow">if</span> (ch != <span class="charliteral">'&gt;'</span>)
00481           <span class="keywordflow">break</span>;
00482 
00483        <span class="comment">/*</span>
00484 <span class="comment">        * Otherwise add this as an element under the current parent...</span>
00485 <span class="comment">        */</span>
00486 
00487         *bufptr = <span class="charliteral">'\0'</span>;
00488 
00489         <span class="keywordflow">if</span> (!<a class="code" href="mxml-node_8c.html#a3">stp_mxmlNewElement</a>(parent, buffer))
00490         {
00491          <span class="comment">/*</span>
00492 <span class="comment">          * Just print error for now...</span>
00493 <span class="comment">          */</span>
00494 
00495           fprintf(stderr, <span class="stringliteral">"Unable to add comment node to parent &lt;%s&gt;!\n"</span>,
00496                   parent ? parent-&gt;<a class="code" href="structstp__mxml__node__s.html#o6">value</a>.<a class="code" href="unionstp__mxml__value__u.html#o0">element</a>.<a class="code" href="structstp__mxml__value__s.html#o0">name</a> : <span class="stringliteral">"null"</span>);
00497           <span class="keywordflow">break</span>;
00498         }
00499       }
00500       <span class="keywordflow">else</span> <span class="keywordflow">if</span> (buffer[0] == <span class="charliteral">'!'</span>)
00501       {
00502        <span class="comment">/*</span>
00503 <span class="comment">        * Gather rest of declaration...</span>
00504 <span class="comment">        */</span>
00505 
00506         <span class="keywordflow">do</span>
00507         {
00508           <span class="keywordflow">if</span> (ch == <span class="charliteral">'&gt;'</span>)
00509             <span class="keywordflow">break</span>;
00510           <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<a class="code" href="mxml-file_8c.html#a0">mxml_add_char</a>(ch, &amp;bufptr, &amp;buffer, &amp;bufsize))
00511           {
00512             free(buffer);
00513             <span class="keywordflow">return</span> (NULL);
00514           }
00515         }
00516         <span class="keywordflow">while</span> ((ch = (*getc_cb)(p)) != EOF);
00517 
00518        <span class="comment">/*</span>
00519 <span class="comment">        * Error out if we didn't get the whole declaration...</span>
00520 <span class="comment">        */</span>
00521 
00522         <span class="keywordflow">if</span> (ch != <span class="charliteral">'&gt;'</span>)
00523           <span class="keywordflow">break</span>;
00524 
00525        <span class="comment">/*</span>
00526 <span class="comment">        * Otherwise add this as an element under the current parent...</span>
00527 <span class="comment">        */</span>
00528 
00529         *bufptr = <span class="charliteral">'\0'</span>;
00530 
00531         node = <a class="code" href="mxml-node_8c.html#a3">stp_mxmlNewElement</a>(parent, buffer);
00532         <span class="keywordflow">if</span> (!node)
00533         {
00534          <span class="comment">/*</span>
00535 <span class="comment">          * Just print error for now...</span>
00536 <span class="comment">          */</span>
00537 
00538           fprintf(stderr, <span class="stringliteral">"Unable to add declaration node to parent &lt;%s&gt;!\n"</span>,
00539                   parent ? parent-&gt;<a class="code" href="structstp__mxml__node__s.html#o6">value</a>.<a class="code" href="unionstp__mxml__value__u.html#o0">element</a>.<a class="code" href="structstp__mxml__value__s.html#o0">name</a> : <span class="stringliteral">"null"</span>);
00540           <span class="keywordflow">break</span>;
00541         }
00542 
00543        <span class="comment">/*</span>
00544 <span class="comment">        * Descend into this node, setting the value type as needed...</span>
00545 <span class="comment">        */</span>
00546 
00547         parent = node;
00548 
00549         <span class="keywordflow">if</span> (cb &amp;&amp; parent)
00550           type = (*cb)(parent);
00551       }
00552       <span class="keywordflow">else</span> <span class="keywordflow">if</span> (buffer[0] == <span class="charliteral">'/'</span>)
00553       {
00554        <span class="comment">/*</span>
00555 <span class="comment">        * Handle close tag...</span>
00556 <span class="comment">        */</span>
00557 
00558         <span class="keywordflow">if</span> (!parent || strcmp(buffer + 1, parent-&gt;<a class="code" href="structstp__mxml__node__s.html#o6">value</a>.<a class="code" href="unionstp__mxml__value__u.html#o0">element</a>.<a class="code" href="structstp__mxml__value__s.html#o0">name</a>))
00559         {
00560          <span class="comment">/*</span>
00561 <span class="comment">          * Close tag doesn't match tree; print an error for now...</span>
00562 <span class="comment">          */</span>
00563 
00564           fprintf(stderr, <span class="stringliteral">"Mismatched close tag &lt;%s&gt; under parent &lt;%s&gt;!\n"</span>,
00565                   buffer, parent-&gt;<a class="code" href="structstp__mxml__node__s.html#o6">value</a>.<a class="code" href="unionstp__mxml__value__u.html#o0">element</a>.<a class="code" href="structstp__mxml__value__s.html#o0">name</a>);
00566           <span class="keywordflow">break</span>;
00567         }
00568 
00569        <span class="comment">/*</span>
00570 <span class="comment">        * Keep reading until we see &gt;...</span>
00571 <span class="comment">        */</span>
00572 
00573         <span class="keywordflow">while</span> (ch != <span class="charliteral">'&gt;'</span> &amp;&amp; ch != EOF)
00574           ch = (*getc_cb)(p);
00575 
00576        <span class="comment">/*</span>
00577 <span class="comment">        * Ascend into the parent and set the value type as needed...</span>
00578 <span class="comment">        */</span>
00579 
00580         parent = parent-&gt;<a class="code" href="structstp__mxml__node__s.html#o3">parent</a>;
00581 
00582         <span class="keywordflow">if</span> (cb &amp;&amp; parent)
00583           type = (*cb)(parent);
00584       }
00585       <span class="keywordflow">else</span>
00586       {
00587        <span class="comment">/*</span>
00588 <span class="comment">        * Handle open tag...</span>
00589 <span class="comment">        */</span>
00590 
00591         node = <a class="code" href="mxml-node_8c.html#a3">stp_mxmlNewElement</a>(parent, buffer);
00592 
00593         <span class="keywordflow">if</span> (!node)
00594         {
00595          <span class="comment">/*</span>
00596 <span class="comment">          * Just print error for now...</span>
00597 <span class="comment">          */</span>
00598 
00599           fprintf(stderr, <span class="stringliteral">"Unable to add element node to parent &lt;%s&gt;!\n"</span>,
00600                   parent ? parent-&gt;<a class="code" href="structstp__mxml__node__s.html#o6">value</a>.<a class="code" href="unionstp__mxml__value__u.html#o0">element</a>.<a class="code" href="structstp__mxml__value__s.html#o0">name</a> : <span class="stringliteral">"null"</span>);
00601           <span class="keywordflow">break</span>;
00602         }
00603 
00604         <span class="keywordflow">if</span> (isspace(ch))
00605           ch = <a class="code" href="mxml-file_8c.html#a4">mxml_parse_element</a>(node, p, getc_cb);
00606         <span class="keywordflow">else</span> <span class="keywordflow">if</span> (ch == <span class="charliteral">'/'</span>)
00607         {
00608           <span class="keywordflow">if</span> ((ch = (*getc_cb)(p)) != <span class="charliteral">'&gt;'</span>)
00609           {
00610             fprintf(stderr, <span class="stringliteral">"Expected &gt; but got '%c' instead for element &lt;%s/&gt;!\n"</span>,
00611                     ch, buffer);
00612             <span class="keywordflow">break</span>;
00613           }
00614 
00615           ch = <span class="charliteral">'/'</span>;
00616         }
00617 
00618         <span class="keywordflow">if</span> (ch == EOF)
00619           <span class="keywordflow">break</span>;
00620 
00621         <span class="keywordflow">if</span> (ch != <span class="charliteral">'/'</span>)
00622         {
00623          <span class="comment">/*</span>
00624 <span class="comment">          * Descend into this node, setting the value type as needed...</span>
00625 <span class="comment">          */</span>
00626 
00627           parent = node;
00628 
00629           <span class="keywordflow">if</span> (cb &amp;&amp; parent)
00630             type = (*cb)(parent);
00631         }
00632       }
00633 
00634       bufptr  = buffer;
00635     }
00636     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (ch == <span class="charliteral">'&amp;'</span>)
00637     {
00638      <span class="comment">/*</span>
00639 <span class="comment">      * Add character entity to current buffer...  Currently we only</span>
00640 <span class="comment">      * support &amp;lt;, &amp;amp;, &amp;gt;, &amp;nbsp;, &amp;quot;, &amp;#nnn;, and &amp;#xXXXX;...</span>
00641 <span class="comment">      */</span>
00642 
00643       <span class="keywordtype">char</span>      entity[64],             <span class="comment">/* Entity string */</span>
00644                 *entptr;                <span class="comment">/* Pointer into entity */</span>
00645 
00646 
00647       entity[0] = ch;
00648       entptr    = entity + 1;
00649 
00650       <span class="keywordflow">while</span> ((ch = (*getc_cb)(p)) != EOF)
00651         <span class="keywordflow">if</span> (!isalnum(ch) &amp;&amp; ch != <span class="charliteral">'#'</span>)
00652           <span class="keywordflow">break</span>;
00653         <span class="keywordflow">else</span> <span class="keywordflow">if</span> (entptr &lt; (entity + <span class="keyword">sizeof</span>(entity) - 1))
00654           *entptr++ = ch;
00655         <span class="keywordflow">else</span>
00656         {
00657           fprintf(stderr, <span class="stringliteral">"Entity name too long under parent &lt;%s&gt;!\n"</span>,
00658                   parent ? parent-&gt;<a class="code" href="structstp__mxml__node__s.html#o6">value</a>.<a class="code" href="unionstp__mxml__value__u.html#o0">element</a>.<a class="code" href="structstp__mxml__value__s.html#o0">name</a> : <span class="stringliteral">"null"</span>);
00659           <span class="keywordflow">break</span>;
00660         }
00661 
00662       *entptr = <span class="charliteral">'\0'</span>;
00663 
00664       <span class="keywordflow">if</span> (ch != <span class="charliteral">';'</span>)
00665       {
00666         fprintf(stderr, <span class="stringliteral">"Entity name \"%s\" not terminated under parent &lt;%s&gt;!\n"</span>,
00667                 entity, parent ? parent-&gt;<a class="code" href="structstp__mxml__node__s.html#o6">value</a>.<a class="code" href="unionstp__mxml__value__u.html#o0">element</a>.<a class="code" href="structstp__mxml__value__s.html#o0">name</a> : <span class="stringliteral">"null"</span>);
00668         <span class="keywordflow">break</span>;
00669       }
00670 
00671       <span class="keywordflow">if</span> (entity[1] == <span class="charliteral">'#'</span>)
00672       {
00673         <span class="keywordflow">if</span> (entity[2] == <span class="charliteral">'x'</span>)
00674           ch = strtol(entity + 3, NULL, 16);
00675         <span class="keywordflow">else</span>
00676           ch = strtol(entity + 2, NULL, 10);
00677       }
00678       <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!strcmp(entity, <span class="stringliteral">"&amp;amp"</span>))
00679         ch = <span class="charliteral">'&amp;'</span>;
00680       <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!strcmp(entity, <span class="stringliteral">"&amp;gt"</span>))
00681         ch = <span class="charliteral">'&gt;'</span>;
00682       <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!strcmp(entity, <span class="stringliteral">"&amp;lt"</span>))
00683         ch = <span class="charliteral">'&lt;'</span>;
00684       <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!strcmp(entity, <span class="stringliteral">"&amp;nbsp"</span>))
00685         ch = 0xa0;
00686       <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!strcmp(entity, <span class="stringliteral">"&amp;quot"</span>))
00687         ch = <span class="charliteral">'\"'</span>;
00688       <span class="keywordflow">else</span>
00689       {
00690         fprintf(stderr, <span class="stringliteral">"Entity name \"%s;\" not supported under parent &lt;%s&gt;!\n"</span>,
00691                 entity, parent ? parent-&gt;<a class="code" href="structstp__mxml__node__s.html#o6">value</a>.<a class="code" href="unionstp__mxml__value__u.html#o0">element</a>.<a class="code" href="structstp__mxml__value__s.html#o0">name</a> : <span class="stringliteral">"null"</span>);
00692         <span class="keywordflow">break</span>;
00693       }
00694 
00695       <span class="keywordflow">if</span> (ch &lt; 128)
00696       {
00697        <span class="comment">/*</span>
00698 <span class="comment">        * Plain ASCII doesn't need special encoding...</span>
00699 <span class="comment">        */</span>
00700 
00701         <span class="keywordflow">if</span> (<a class="code" href="mxml-file_8c.html#a0">mxml_add_char</a>(ch, &amp;bufptr, &amp;buffer, &amp;bufsize))
00702         {
00703           free(buffer);
00704           <span class="keywordflow">return</span> (NULL);
00705         }
00706       }
00707       <span class="keywordflow">else</span>
00708       {
00709        <span class="comment">/*</span>
00710 <span class="comment">        * Use UTF-8 encoding for the Unicode char...</span>
00711 <span class="comment">        */</span>
00712 
00713         <span class="keywordflow">if</span> (ch &lt; 2048)
00714         {
00715           <span class="keywordflow">if</span> (<a class="code" href="mxml-file_8c.html#a0">mxml_add_char</a>(0xc0 | (ch &gt;&gt; 6), &amp;bufptr, &amp;buffer, &amp;bufsize))
00716           {
00717             free(buffer);
00718             <span class="keywordflow">return</span> (NULL);
00719           }
00720           <span class="keywordflow">if</span> (<a class="code" href="mxml-file_8c.html#a0">mxml_add_char</a>(0x80 | (ch &amp; 63), &amp;bufptr, &amp;buffer, &amp;bufsize))
00721           {
00722             free(buffer);
00723             <span class="keywordflow">return</span> (NULL);
00724           }
00725         }
00726         <span class="keywordflow">else</span> <span class="keywordflow">if</span> (ch &lt; 65536)
00727         {
00728           <span class="keywordflow">if</span> (<a class="code" href="mxml-file_8c.html#a0">mxml_add_char</a>(0xe0 | (ch &gt;&gt; 12), &amp;bufptr, &amp;buffer, &amp;bufsize))
00729           {
00730             free(buffer);
00731             <span class="keywordflow">return</span> (NULL);
00732           }
00733           <span class="keywordflow">if</span> (<a class="code" href="mxml-file_8c.html#a0">mxml_add_char</a>(0x80 | ((ch &gt;&gt; 6) &amp; 63), &amp;bufptr, &amp;buffer, &amp;bufsize))
00734           {
00735             free(buffer);
00736             <span class="keywordflow">return</span> (NULL);
00737           }
00738           <span class="keywordflow">if</span> (<a class="code" href="mxml-file_8c.html#a0">mxml_add_char</a>(0x80 | (ch &amp; 63), &amp;bufptr, &amp;buffer, &amp;bufsize))
00739           {
00740             free(buffer);
00741             <span class="keywordflow">return</span> (NULL);
00742           }
00743         }
00744         <span class="keywordflow">else</span>
00745         {
00746           <span class="keywordflow">if</span> (<a class="code" href="mxml-file_8c.html#a0">mxml_add_char</a>(0xf0 | (ch &gt;&gt; 18), &amp;bufptr, &amp;buffer, &amp;bufsize))
00747           {
00748             free(buffer);
00749             <span class="keywordflow">return</span> (NULL);
00750           }
00751           <span class="keywordflow">if</span> (<a class="code" href="mxml-file_8c.html#a0">mxml_add_char</a>(0x80 | ((ch &gt;&gt; 12) &amp; 63), &amp;bufptr, &amp;buffer, &amp;bufsize))
00752           {
00753             free(buffer);
00754             <span class="keywordflow">return</span> (NULL);
00755           }
00756           <span class="keywordflow">if</span> (<a class="code" href="mxml-file_8c.html#a0">mxml_add_char</a>(0x80 | ((ch &gt;&gt; 6) &amp; 63), &amp;bufptr, &amp;buffer, &amp;bufsize))
00757           {
00758             free(buffer);
00759             <span class="keywordflow">return</span> (NULL);
00760           }
00761           <span class="keywordflow">if</span> (<a class="code" href="mxml-file_8c.html#a0">mxml_add_char</a>(0x80 | (ch &amp; 63), &amp;bufptr, &amp;buffer, &amp;bufsize))
00762           {
00763             free(buffer);
00764             <span class="keywordflow">return</span> (NULL);
00765           }
00766         }
00767       }
00768     }
00769     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (type == <a class="code" href="mxml_8h.html#a43a22">STP_MXML_OPAQUE</a> || !isspace(ch))
00770     {
00771      <span class="comment">/*</span>
00772 <span class="comment">      * Add character to current buffer...</span>
00773 <span class="comment">      */</span>
00774 
00775       <span class="keywordflow">if</span> (<a class="code" href="mxml-file_8c.html#a0">mxml_add_char</a>(ch, &amp;bufptr, &amp;buffer, &amp;bufsize))
00776       {
00777         free(buffer);
00778         <span class="keywordflow">return</span> (NULL);
00779       }
00780     }
00781   }
00782 
00783  <span class="comment">/*</span>
00784 <span class="comment">  * Free the string buffer - we don't need it anymore...</span>
00785 <span class="comment">  */</span>
00786 
00787   free(buffer);
00788 
00789  <span class="comment">/*</span>
00790 <span class="comment">  * Find the top element and return it...</span>
00791 <span class="comment">  */</span>
00792 
00793   <span class="keywordflow">if</span> (parent)
00794   {
00795     <span class="keywordflow">while</span> (parent-&gt;<a class="code" href="structstp__mxml__node__s.html#o3">parent</a> != top)
00796       parent = parent-&gt;<a class="code" href="structstp__mxml__node__s.html#o3">parent</a>;
00797   }
00798 
00799   <span class="keywordflow">return</span> (parent);
00800 }
00801 
00802 
00803 <span class="comment">/*</span>
00804 <span class="comment"> * 'mxml_parse_element()' - Parse an element for any attributes...</span>
00805 <span class="comment"> */</span>
00806 
00807 <span class="keyword">static</span> <span class="keywordtype">int</span>                              <span class="comment">/* O - Terminating character */</span>
<a name="l00808"></a><a class="code" href="mxml-file_8c.html#a4">00808</a> <a class="code" href="mxml-file_8c.html#a4">mxml_parse_element</a>(stp_mxml_node_t *node,       <span class="comment">/* I - Element node */</span>
00809                    <span class="keywordtype">void</span>        *p,      <span class="comment">/* I - Data to read from */</span>
00810                    <span class="keywordtype">int</span>         (*getc_cb)(<span class="keywordtype">void</span> *))
00811                                         <span class="comment">/* I - Data callback */</span>
00812 {
00813   <span class="keywordtype">int</span>   ch,                             <span class="comment">/* Current character in file */</span>
00814         quote;                          <span class="comment">/* Quoting character */</span>
00815   <span class="keywordtype">char</span>  *name,                          <span class="comment">/* Attribute name */</span>
00816         *value,                         <span class="comment">/* Attribute value */</span>
00817         *ptr;                           <span class="comment">/* Pointer into name/value */</span>
00818   <span class="keywordtype">int</span>   namesize,                       <span class="comment">/* Size of name string */</span>
00819         valsize;                        <span class="comment">/* Size of value string */</span>
00820 
00821 
00822  <span class="comment">/*</span>
00823 <span class="comment">  * Initialize the name and value buffers...</span>
00824 <span class="comment">  */</span>
00825 
00826   <span class="keywordflow">if</span> ((name = malloc(64)) == NULL)
00827   {
00828     fputs(<span class="stringliteral">"Unable to allocate memory for name!\n"</span>, stderr);
00829     <span class="keywordflow">return</span> (EOF);
00830   }
00831 
00832   namesize = 64;
00833 
00834   <span class="keywordflow">if</span> ((value = malloc(64)) == NULL)
00835   {
00836     free(name);
00837     fputs(<span class="stringliteral">"Unable to allocate memory for value!\n"</span>, stderr);
00838     <span class="keywordflow">return</span> (EOF);
00839   }
00840 
00841   valsize = 64;
00842 
00843  <span class="comment">/*</span>
00844 <span class="comment">  * Loop until we hit a &gt;, /, ?, or EOF...</span>
00845 <span class="comment">  */</span>
00846 
00847   <span class="keywordflow">while</span> ((ch = (*getc_cb)(p)) != EOF)
00848   {
00849 <span class="preprocessor">#ifdef DEBUG</span>
00850 <span class="preprocessor"></span>    fprintf(stderr, <span class="stringliteral">"parse_element: ch='%c'\n"</span>, ch);
00851 <span class="preprocessor">#endif </span><span class="comment">/* DEBUG */</span>
00852 
00853    <span class="comment">/*</span>
00854 <span class="comment">    * Skip leading whitespace...</span>
00855 <span class="comment">    */</span>
00856 
00857     <span class="keywordflow">if</span> (isspace(ch))
00858       <span class="keywordflow">continue</span>;
00859 
00860    <span class="comment">/*</span>
00861 <span class="comment">    * Stop at /, ?, or &gt;...</span>
00862 <span class="comment">    */</span>
00863 
00864     <span class="keywordflow">if</span> (ch == <span class="charliteral">'/'</span> || ch == <span class="charliteral">'?'</span>)
00865     {
00866      <span class="comment">/*</span>
00867 <span class="comment">      * Grab the &gt; character and print an error if it isn't there...</span>
00868 <span class="comment">      */</span>
00869 
00870       quote = (*getc_cb)(p);
00871 
00872       <span class="keywordflow">if</span> (quote != <span class="charliteral">'&gt;'</span>)
00873       {
00874         fprintf(stderr, <span class="stringliteral">"Expected '&gt;' after '%c' for element %s, but got '%c'!\n"</span>,
00875                 ch, node-&gt;<a class="code" href="structstp__mxml__node__s.html#o6">value</a>.<a class="code" href="unionstp__mxml__value__u.html#o0">element</a>.<a class="code" href="structstp__mxml__value__s.html#o0">name</a>, quote);
00876         ch = EOF;
00877       }
00878 
00879       <span class="keywordflow">break</span>;
00880     }
00881     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (ch == <span class="charliteral">'&gt;'</span>)
00882       <span class="keywordflow">break</span>;
00883 
00884    <span class="comment">/*</span>
00885 <span class="comment">    * Read the attribute name...</span>
00886 <span class="comment">    */</span>
00887 
00888     name[0] = ch;
00889     ptr     = name + 1;
00890 
00891     <span class="keywordflow">while</span> ((ch = (*getc_cb)(p)) != EOF)
00892       <span class="keywordflow">if</span> (isspace(ch) || ch == <span class="charliteral">'='</span> || ch == <span class="charliteral">'/'</span> || ch == <span class="charliteral">'&gt;'</span> || ch == <span class="charliteral">'?'</span>)
00893         <span class="keywordflow">break</span>;
00894       <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<a class="code" href="mxml-file_8c.html#a0">mxml_add_char</a>(ch, &amp;ptr, &amp;name, &amp;namesize))
00895       {
00896         free(name);
00897         free(value);
00898         <span class="keywordflow">return</span> (EOF);
00899       }
00900 
00901     *ptr = <span class="charliteral">'\0'</span>;
00902 
00903     <span class="keywordflow">if</span> (ch == <span class="charliteral">'='</span>)
00904     {
00905      <span class="comment">/*</span>
00906 <span class="comment">      * Read the attribute value...</span>
00907 <span class="comment">      */</span>
00908 
00909       <span class="keywordflow">if</span> ((ch = (*getc_cb)(p)) == EOF)
00910       {
00911         fprintf(stderr, <span class="stringliteral">"Missing value for attribute '%s' in element %s!\n"</span>,
00912                 name, node-&gt;<a class="code" href="structstp__mxml__node__s.html#o6">value</a>.<a class="code" href="unionstp__mxml__value__u.html#o0">element</a>.<a class="code" href="structstp__mxml__value__s.html#o0">name</a>);
00913         <span class="keywordflow">return</span> (EOF);
00914       }
00915 
00916       <span class="keywordflow">if</span> (ch == <span class="charliteral">'\''</span> || ch == <span class="charliteral">'\"'</span>)
00917       {
00918        <span class="comment">/*</span>
00919 <span class="comment">        * Read quoted value...</span>
00920 <span class="comment">        */</span>
00921 
00922         quote = ch;
00923         ptr   = value;
00924 
00925         <span class="keywordflow">while</span> ((ch = (*getc_cb)(p)) != EOF)
00926           <span class="keywordflow">if</span> (ch == quote)
00927             <span class="keywordflow">break</span>;
00928           <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<a class="code" href="mxml-file_8c.html#a0">mxml_add_char</a>(ch, &amp;ptr, &amp;value, &amp;valsize))
00929           {
00930             free(name);
00931             free(value);
00932             <span class="keywordflow">return</span> (EOF);
00933           }
00934 
00935         *ptr = <span class="charliteral">'\0'</span>;
00936       }
00937       <span class="keywordflow">else</span>
00938       {
00939        <span class="comment">/*</span>
00940 <span class="comment">        * Read unquoted value...</span>
00941 <span class="comment">        */</span>
00942 
00943         value[0] = ch;
00944         ptr      = value + 1;
00945 
00946         <span class="keywordflow">while</span> ((ch = (*getc_cb)(p)) != EOF)
00947           <span class="keywordflow">if</span> (isspace(ch) || ch == <span class="charliteral">'='</span> || ch == <span class="charliteral">'/'</span> || ch == <span class="charliteral">'&gt;'</span>)
00948             <span class="keywordflow">break</span>;
00949           <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<a class="code" href="mxml-file_8c.html#a0">mxml_add_char</a>(ch, &amp;ptr, &amp;value, &amp;valsize))
00950           {
00951             free(name);
00952             free(value);
00953             <span class="keywordflow">return</span> (EOF);
00954           }
00955 
00956         *ptr = <span class="charliteral">'\0'</span>;
00957       }
00958     }
00959     <span class="keywordflow">else</span>
00960       value[0] = <span class="charliteral">'\0'</span>;
00961 
00962    <span class="comment">/*</span>
00963 <span class="comment">    * Save last character in case we need it...</span>
00964 <span class="comment">    */</span>
00965 
00966     <span class="keywordflow">if</span> (ch == <span class="charliteral">'/'</span> || ch == <span class="charliteral">'?'</span>)
00967     {
00968      <span class="comment">/*</span>
00969 <span class="comment">      * Grab the &gt; character and print an error if it isn't there...</span>
00970 <span class="comment">      */</span>
00971 
00972       quote = (*getc_cb)(p);
00973 
00974       <span class="keywordflow">if</span> (quote != <span class="charliteral">'&gt;'</span>)
00975       {
00976         fprintf(stderr, <span class="stringliteral">"Expected '&gt;' after '%c' for element %s, but got '%c'!\n"</span>,
00977                 ch, node-&gt;<a class="code" href="structstp__mxml__node__s.html#o6">value</a>.<a class="code" href="unionstp__mxml__value__u.html#o0">element</a>.<a class="code" href="structstp__mxml__value__s.html#o0">name</a>, quote);
00978         ch = EOF;
00979       }
00980 
00981       <span class="keywordflow">break</span>;
00982     }
00983     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (ch == <span class="charliteral">'&gt;'</span>)
00984       <span class="keywordflow">break</span>;
00985 
00986    <span class="comment">/*</span>
00987 <span class="comment">    * Set the attribute...</span>
00988 <span class="comment">    */</span>
00989 
00990     <a class="code" href="mxml-attr_8c.html#a1">stp_mxmlElementSetAttr</a>(node, name, value);
00991   }
00992 
00993  <span class="comment">/*</span>
00994 <span class="comment">  * Free the name and value buffers and return...</span>
00995 <span class="comment">  */</span>
00996 
00997   free(name);
00998   free(value);
00999 
01000   <span class="keywordflow">return</span> (ch);
01001 }
01002 
01003 
01004 <span class="comment">/*</span>
01005 <span class="comment"> * 'mxml_string_getc()' - Get a character from a string.</span>
01006 <span class="comment"> */</span>
01007 
01008 <span class="keyword">static</span> <span class="keywordtype">int</span>                              <span class="comment">/* O - Character or EOF */</span>
<a name="l01009"></a><a class="code" href="mxml-file_8c.html#a5">01009</a> <a class="code" href="mxml-file_8c.html#a5">mxml_string_getc</a>(<span class="keywordtype">void</span> *p)               <span class="comment">/* I - Pointer to file */</span>
01010 {
01011   <span class="keywordtype">int</span>           ch;                     <span class="comment">/* Character */</span>
01012   <span class="keyword">const</span> <span class="keywordtype">char</span>    **s;                    <span class="comment">/* Pointer to string pointer */</span>
01013 
01014 
01015   s = (<span class="keyword">const</span> <span class="keywordtype">char</span> **)p;
01016 
01017   <span class="keywordflow">if</span> ((ch = *s[0]) != 0)
01018   {
01019     (*s)++;
01020     <span class="keywordflow">return</span> (ch);
01021   }
01022   <span class="keywordflow">else</span>
01023     <span class="keywordflow">return</span> (EOF);
01024 }
01025 
01026 
01027 <span class="comment">/*</span>
01028 <span class="comment"> * 'mxml_string_putc()' - Write a character to a string.</span>
01029 <span class="comment"> */</span>
01030 
01031 <span class="keyword">static</span> <span class="keywordtype">int</span>                              <span class="comment">/* O - 0 on success, -1 on failure */</span>
<a name="l01032"></a><a class="code" href="mxml-file_8c.html#a6">01032</a> <a class="code" href="mxml-file_8c.html#a6">mxml_string_putc</a>(<span class="keywordtype">int</span>  ch,               <span class="comment">/* I - Character to write */</span>
01033                  <span class="keywordtype">void</span> *p)               <span class="comment">/* I - Pointer to string pointers */</span>
01034 {
01035   <span class="keywordtype">char</span>  **pp;                           <span class="comment">/* Pointer to string pointers */</span>
01036 
01037 
01038   pp = (<span class="keywordtype">char</span> **)p;
01039 
01040   <span class="keywordflow">if</span> (pp[0] &lt; pp[1])
01041     pp[0][0] = ch;
01042 
01043   pp[0] ++;
01044 
01045   <span class="keywordflow">return</span> (0);
01046 }
01047 
01048 
01049 <span class="comment">/*</span>
01050 <span class="comment"> * 'mxml_write_node()' - Save an XML node to a file.</span>
01051 <span class="comment"> */</span>
01052 
01053 <span class="keyword">static</span> <span class="keywordtype">int</span>                              <span class="comment">/* O - Column or -1 on error */</span>
<a name="l01054"></a><a class="code" href="mxml-file_8c.html#a7">01054</a> <a class="code" href="mxml-file_8c.html#a7">mxml_write_node</a>(stp_mxml_node_t *node,  <span class="comment">/* I - Node to write */</span>
01055                 <span class="keywordtype">void</span>        *p,         <span class="comment">/* I - File to write to */</span>
01056                 <span class="keywordtype">int</span>         (*cb)(stp_mxml_node_t *, <span class="keywordtype">int</span>),
01057                                         <span class="comment">/* I - Whitespace callback */</span>
01058                 <span class="keywordtype">int</span>         col,        <span class="comment">/* I - Current column */</span>
01059                 <span class="keywordtype">int</span>         (*putc_cb)(<span class="keywordtype">int</span>, <span class="keywordtype">void</span> *))
01060 {
01061   <span class="keywordtype">int</span>           i;                      <span class="comment">/* Looping var */</span>
01062   <a class="code" href="structstp__mxml__attr__s.html">stp_mxml_attr_t</a>       *attr;                  <span class="comment">/* Current attribute */</span>
01063   <span class="keywordtype">char</span>          s[255];                 <span class="comment">/* Temporary string */</span>
01064 
01065 
01066   <span class="keywordflow">while</span> (node != NULL)
01067   {
01068    <span class="comment">/*</span>
01069 <span class="comment">    * Print the node value...</span>
01070 <span class="comment">    */</span>
01071 
01072     <span class="keywordflow">switch</span> (node-&gt;<a class="code" href="structstp__mxml__node__s.html#o0">type</a>)
01073     {
01074       <span class="keywordflow">case</span> <a class="code" href="mxml_8h.html#a43a20">STP_MXML_ELEMENT</a> :
01075           col = <a class="code" href="mxml-file_8c.html#a9">mxml_write_ws</a>(node, p, cb, <a class="code" href="mxml_8h.html#a7">STP_MXML_WS_BEFORE_OPEN</a>, col, putc_cb);
01076 
01077           <span class="keywordflow">if</span> ((*putc_cb)(<span class="charliteral">'&lt;'</span>, p) &lt; 0)
01078             <span class="keywordflow">return</span> (-1);
01079           <span class="keywordflow">if</span> (<a class="code" href="mxml-file_8c.html#a8">mxml_write_string</a>(node-&gt;<a class="code" href="structstp__mxml__node__s.html#o6">value</a>.<a class="code" href="unionstp__mxml__value__u.html#o0">element</a>.<a class="code" href="structstp__mxml__value__s.html#o0">name</a>, p, putc_cb) &lt; 0)
01080             <span class="keywordflow">return</span> (-1);
01081 
01082           col += strlen(node-&gt;<a class="code" href="structstp__mxml__node__s.html#o6">value</a>.<a class="code" href="unionstp__mxml__value__u.html#o0">element</a>.<a class="code" href="structstp__mxml__value__s.html#o0">name</a>) + 1;
01083 
01084           <span class="keywordflow">for</span> (i = node-&gt;<a class="code" href="structstp__mxml__node__s.html#o6">value</a>.<a class="code" href="unionstp__mxml__value__u.html#o0">element</a>.<a class="code" href="structstp__mxml__value__s.html#o1">num_attrs</a>, attr = node-&gt;<a class="code" href="structstp__mxml__node__s.html#o6">value</a>.<a class="code" href="unionstp__mxml__value__u.html#o0">element</a>.<a class="code" href="structstp__mxml__value__s.html#o2">attrs</a>;
01085                i &gt; 0;
01086                i --, attr ++)
01087           {
01088             <span class="keywordflow">if</span> ((col + strlen(attr-&gt;<a class="code" href="structstp__mxml__attr__s.html#o0">name</a>) + strlen(attr-&gt;<a class="code" href="structstp__mxml__attr__s.html#o1">value</a>) + 3) &gt; <a class="code" href="mxml_8h.html#a0">STP_MXML_WRAP</a>)
01089             {
01090               <span class="keywordflow">if</span> ((*putc_cb)(<span class="charliteral">'\n'</span>, p) &lt; 0)
01091                 <span class="keywordflow">return</span> (-1);
01092 
01093               col = 0;
01094             }
01095             <span class="keywordflow">else</span>
01096             {
01097               <span class="keywordflow">if</span> ((*putc_cb)(<span class="charliteral">' '</span>, p) &lt; 0)
01098                 <span class="keywordflow">return</span> (-1);
01099 
01100               col ++;
01101             }
01102 
01103             <span class="keywordflow">if</span> (<a class="code" href="mxml-file_8c.html#a8">mxml_write_string</a>(attr-&gt;<a class="code" href="structstp__mxml__attr__s.html#o0">name</a>, p, putc_cb) &lt; 0)
01104               <span class="keywordflow">return</span> (-1);
01105             <span class="keywordflow">if</span> ((*putc_cb)(<span class="charliteral">'='</span>, p) &lt; 0)
01106               <span class="keywordflow">return</span> (-1);
01107             <span class="keywordflow">if</span> ((*putc_cb)(<span class="charliteral">'\"'</span>, p) &lt; 0)
01108               <span class="keywordflow">return</span> (-1);
01109             <span class="keywordflow">if</span> (<a class="code" href="mxml-file_8c.html#a8">mxml_write_string</a>(attr-&gt;<a class="code" href="structstp__mxml__attr__s.html#o1">value</a>, p, putc_cb) &lt; 0)
01110               <span class="keywordflow">return</span> (-1);
01111             <span class="keywordflow">if</span> ((*putc_cb)(<span class="charliteral">'\"'</span>, p) &lt; 0)
01112               <span class="keywordflow">return</span> (-1);
01113             
01114             col += strlen(attr-&gt;<a class="code" href="structstp__mxml__attr__s.html#o0">name</a>) + strlen(attr-&gt;<a class="code" href="structstp__mxml__attr__s.html#o1">value</a>) + 3;
01115           }
01116 
01117           <span class="keywordflow">if</span> (node-&gt;<a class="code" href="structstp__mxml__node__s.html#o4">child</a>)
01118           {
01119            <span class="comment">/*</span>
01120 <span class="comment">            * The ? and ! elements are special-cases and have no end tags...</span>
01121 <span class="comment">            */</span>
01122 
01123             <span class="keywordflow">if</span> (node-&gt;<a class="code" href="structstp__mxml__node__s.html#o6">value</a>.<a class="code" href="unionstp__mxml__value__u.html#o0">element</a>.<a class="code" href="structstp__mxml__value__s.html#o0">name</a>[0] == <span class="charliteral">'?'</span>)
01124             {
01125               <span class="keywordflow">if</span> ((*putc_cb)(<span class="charliteral">'?'</span>, p) &lt; 0)
01126                 <span class="keywordflow">return</span> (-1);
01127               <span class="keywordflow">if</span> ((*putc_cb)(<span class="charliteral">'&gt;'</span>, p) &lt; 0)
01128                 <span class="keywordflow">return</span> (-1);
01129               <span class="keywordflow">if</span> ((*putc_cb)(<span class="charliteral">'\n'</span>, p) &lt; 0)
01130                 <span class="keywordflow">return</span> (-1);
01131 
01132               col = 0;
01133             }
01134             <span class="keywordflow">else</span> <span class="keywordflow">if</span> ((*putc_cb)(<span class="charliteral">'&gt;'</span>, p) &lt; 0)
01135               <span class="keywordflow">return</span> (-1);
01136             <span class="keywordflow">else</span>
01137               col ++;
01138 
01139             col = <a class="code" href="mxml-file_8c.html#a9">mxml_write_ws</a>(node, p, cb, <a class="code" href="mxml_8h.html#a8">STP_MXML_WS_AFTER_OPEN</a>, col, putc_cb);
01140 
01141             <span class="keywordflow">if</span> ((col = <a class="code" href="mxml-file_8c.html#a7">mxml_write_node</a>(node-&gt;<a class="code" href="structstp__mxml__node__s.html#o4">child</a>, p, cb, col, putc_cb)) &lt; 0)
01142               <span class="keywordflow">return</span> (-1);
01143 
01144             <span class="keywordflow">if</span> (node-&gt;<a class="code" href="structstp__mxml__node__s.html#o6">value</a>.<a class="code" href="unionstp__mxml__value__u.html#o0">element</a>.<a class="code" href="structstp__mxml__value__s.html#o0">name</a>[0] != <span class="charliteral">'?'</span> &amp;&amp;
01145                 node-&gt;<a class="code" href="structstp__mxml__node__s.html#o6">value</a>.<a class="code" href="unionstp__mxml__value__u.html#o0">element</a>.<a class="code" href="structstp__mxml__value__s.html#o0">name</a>[0] != <span class="charliteral">'!'</span>)
01146             {
01147               col = <a class="code" href="mxml-file_8c.html#a9">mxml_write_ws</a>(node, p, cb, <a class="code" href="mxml_8h.html#a9">STP_MXML_WS_BEFORE_CLOSE</a>, col, putc_cb);
01148 
01149               <span class="keywordflow">if</span> ((*putc_cb)(<span class="charliteral">'&lt;'</span>, p) &lt; 0)
01150                 <span class="keywordflow">return</span> (-1);
01151               <span class="keywordflow">if</span> ((*putc_cb)(<span class="charliteral">'/'</span>, p) &lt; 0)
01152                 <span class="keywordflow">return</span> (-1);
01153               <span class="keywordflow">if</span> (<a class="code" href="mxml-file_8c.html#a8">mxml_write_string</a>(node-&gt;<a class="code" href="structstp__mxml__node__s.html#o6">value</a>.<a class="code" href="unionstp__mxml__value__u.html#o0">element</a>.<a class="code" href="structstp__mxml__value__s.html#o0">name</a>, p, putc_cb) &lt; 0)
01154                 <span class="keywordflow">return</span> (-1);
01155               <span class="keywordflow">if</span> ((*putc_cb)(<span class="charliteral">'&gt;'</span>, p) &lt; 0)
01156                 <span class="keywordflow">return</span> (-1);
01157 
01158               col += strlen(node-&gt;<a class="code" href="structstp__mxml__node__s.html#o6">value</a>.<a class="code" href="unionstp__mxml__value__u.html#o0">element</a>.<a class="code" href="structstp__mxml__value__s.html#o0">name</a>) + 3;
01159 
01160               col = <a class="code" href="mxml-file_8c.html#a9">mxml_write_ws</a>(node, p, cb, <a class="code" href="mxml_8h.html#a10">STP_MXML_WS_AFTER_CLOSE</a>, col, putc_cb);
01161             }
01162           }
01163           <span class="keywordflow">else</span> <span class="keywordflow">if</span> (node-&gt;<a class="code" href="structstp__mxml__node__s.html#o6">value</a>.<a class="code" href="unionstp__mxml__value__u.html#o0">element</a>.<a class="code" href="structstp__mxml__value__s.html#o0">name</a>[0] == <span class="charliteral">'!'</span>)
01164           {
01165             <span class="keywordflow">if</span> ((*putc_cb)(<span class="charliteral">'&gt;'</span>, p) &lt; 0)
01166               <span class="keywordflow">return</span> (-1);
01167             <span class="keywordflow">else</span>
01168               col ++;
01169 
01170             col = <a class="code" href="mxml-file_8c.html#a9">mxml_write_ws</a>(node, p, cb, <a class="code" href="mxml_8h.html#a8">STP_MXML_WS_AFTER_OPEN</a>, col, putc_cb);
01171           }
01172           <span class="keywordflow">else</span>
01173           {
01174             <span class="keywordflow">if</span> ((*putc_cb)(<span class="charliteral">'/'</span>, p) &lt; 0)
01175               <span class="keywordflow">return</span> (-1);
01176             <span class="keywordflow">if</span> ((*putc_cb)(<span class="charliteral">'&gt;'</span>, p) &lt; 0)
01177               <span class="keywordflow">return</span> (-1);
01178 
01179             col += 2;
01180 
01181             col = <a class="code" href="mxml-file_8c.html#a9">mxml_write_ws</a>(node, p, cb, <a class="code" href="mxml_8h.html#a8">STP_MXML_WS_AFTER_OPEN</a>, col, putc_cb);
01182           }
01183           <span class="keywordflow">break</span>;
01184 
01185       <span class="keywordflow">case</span> <a class="code" href="mxml_8h.html#a43a21">STP_MXML_INTEGER</a> :
01186           <span class="keywordflow">if</span> (node-&gt;<a class="code" href="structstp__mxml__node__s.html#o2">prev</a>)
01187           {
01188             <span class="keywordflow">if</span> (col &gt; <a class="code" href="mxml_8h.html#a0">STP_MXML_WRAP</a>)
01189             {
01190               <span class="keywordflow">if</span> ((*putc_cb)(<span class="charliteral">'\n'</span>, p) &lt; 0)
01191                 <span class="keywordflow">return</span> (-1);
01192 
01193               col = 0;
01194             }
01195             <span class="keywordflow">else</span> <span class="keywordflow">if</span> ((*putc_cb)(<span class="charliteral">' '</span>, p) &lt; 0)
01196               <span class="keywordflow">return</span> (-1);
01197             <span class="keywordflow">else</span>
01198               col ++;
01199           }
01200 
01201           sprintf(s, <span class="stringliteral">"%d"</span>, node-&gt;<a class="code" href="structstp__mxml__node__s.html#o6">value</a>.<a class="code" href="unionstp__mxml__value__u.html#o1">integer</a>);
01202           <span class="keywordflow">if</span> (<a class="code" href="mxml-file_8c.html#a8">mxml_write_string</a>(s, p, putc_cb) &lt; 0)
01203             <span class="keywordflow">return</span> (-1);
01204 
01205           col += strlen(s);
01206           <span class="keywordflow">break</span>;
01207 
01208       <span class="keywordflow">case</span> <a class="code" href="mxml_8h.html#a43a22">STP_MXML_OPAQUE</a> :
01209           <span class="keywordflow">if</span> (<a class="code" href="mxml-file_8c.html#a8">mxml_write_string</a>(node-&gt;<a class="code" href="structstp__mxml__node__s.html#o6">value</a>.<a class="code" href="unionstp__mxml__value__u.html#o2">opaque</a>, p, putc_cb) &lt; 0)
01210             <span class="keywordflow">return</span> (-1);
01211 
01212           col += strlen(node-&gt;<a class="code" href="structstp__mxml__node__s.html#o6">value</a>.<a class="code" href="unionstp__mxml__value__u.html#o2">opaque</a>);
01213           <span class="keywordflow">break</span>;
01214 
01215       <span class="keywordflow">case</span> <a class="code" href="mxml_8h.html#a43a23">STP_MXML_REAL</a> :
01216           <span class="keywordflow">if</span> (node-&gt;<a class="code" href="structstp__mxml__node__s.html#o2">prev</a>)
01217           {
01218             <span class="keywordflow">if</span> (col &gt; <a class="code" href="mxml_8h.html#a0">STP_MXML_WRAP</a>)
01219             {
01220               <span class="keywordflow">if</span> ((*putc_cb)(<span class="charliteral">'\n'</span>, p) &lt; 0)
01221                 <span class="keywordflow">return</span> (-1);
01222 
01223               col = 0;
01224             }
01225             <span class="keywordflow">else</span> <span class="keywordflow">if</span> ((*putc_cb)(<span class="charliteral">' '</span>, p) &lt; 0)
01226               <span class="keywordflow">return</span> (-1);
01227             <span class="keywordflow">else</span>
01228               col ++;
01229           }
01230 
01231           sprintf(s, <span class="stringliteral">"%f"</span>, node-&gt;<a class="code" href="structstp__mxml__node__s.html#o6">value</a>.<a class="code" href="unionstp__mxml__value__u.html#o3">real</a>);
01232           <span class="keywordflow">if</span> (<a class="code" href="mxml-file_8c.html#a8">mxml_write_string</a>(s, p, putc_cb) &lt; 0)
01233             <span class="keywordflow">return</span> (-1);
01234 
01235           col += strlen(s);
01236           <span class="keywordflow">break</span>;
01237 
01238       <span class="keywordflow">case</span> <a class="code" href="mxml_8h.html#a43a24">STP_MXML_TEXT</a> :
01239           <span class="keywordflow">if</span> (node-&gt;<a class="code" href="structstp__mxml__node__s.html#o6">value</a>.<a class="code" href="unionstp__mxml__value__u.html#o4">text</a>.<a class="code" href="structstp__mxml__text__s.html#o0">whitespace</a> &amp;&amp; col &gt; 0)
01240           {
01241             <span class="keywordflow">if</span> (col &gt; <a class="code" href="mxml_8h.html#a0">STP_MXML_WRAP</a>)
01242             {
01243               <span class="keywordflow">if</span> ((*putc_cb)(<span class="charliteral">'\n'</span>, p) &lt; 0)
01244                 <span class="keywordflow">return</span> (-1);
01245 
01246               col = 0;
01247             }
01248             <span class="keywordflow">else</span> <span class="keywordflow">if</span> ((*putc_cb)(<span class="charliteral">' '</span>, p) &lt; 0)
01249               <span class="keywordflow">return</span> (-1);
01250             <span class="keywordflow">else</span>
01251               col ++;
01252           }
01253 
01254           <span class="keywordflow">if</span> (<a class="code" href="mxml-file_8c.html#a8">mxml_write_string</a>(node-&gt;<a class="code" href="structstp__mxml__node__s.html#o6">value</a>.<a class="code" href="unionstp__mxml__value__u.html#o4">text</a>.<a class="code" href="structstp__mxml__text__s.html#o1">string</a>, p, putc_cb) &lt; 0)
01255             <span class="keywordflow">return</span> (-1);
01256 
01257           col += strlen(node-&gt;<a class="code" href="structstp__mxml__node__s.html#o6">value</a>.<a class="code" href="unionstp__mxml__value__u.html#o4">text</a>.<a class="code" href="structstp__mxml__text__s.html#o1">string</a>);
01258           <span class="keywordflow">break</span>;
01259     }
01260 
01261    <span class="comment">/*</span>
01262 <span class="comment">    * Next node...</span>
01263 <span class="comment">    */</span>
01264 
01265     node = node-&gt;<a class="code" href="structstp__mxml__node__s.html#o1">next</a>;
01266   }
01267 
01268   <span class="keywordflow">return</span> (col);
01269 }
01270 
01271 
01272 <span class="comment">/*</span>
01273 <span class="comment"> * 'mxml_write_string()' - Write a string, escaping &amp; and &lt; as needed.</span>
01274 <span class="comment"> */</span>
01275 
01276 <span class="keyword">static</span> <span class="keywordtype">int</span>                              <span class="comment">/* O - 0 on success, -1 on failure */</span>
<a name="l01277"></a><a class="code" href="mxml-file_8c.html#a8">01277</a> <a class="code" href="mxml-file_8c.html#a8">mxml_write_string</a>(<span class="keyword">const</span> <span class="keywordtype">char</span> *s,        <span class="comment">/* I - String to write */</span>
01278                   <span class="keywordtype">void</span>       *p,        <span class="comment">/* I - Write pointer */</span>
01279                   <span class="keywordtype">int</span>        (*putc_cb)(<span class="keywordtype">int</span>, <span class="keywordtype">void</span> *))
01280                                         <span class="comment">/* I - Write callback */</span>
01281 {
01282   <span class="keywordtype">char</span>  buf[255],                       <span class="comment">/* Buffer */</span>
01283         *bufptr;                        <span class="comment">/* Pointer into buffer */</span>
01284 
01285 
01286   <span class="keywordflow">while</span> (*s)
01287   {
01288     <span class="keywordflow">if</span> (*s == <span class="charliteral">'&amp;'</span>)
01289     {
01290       <span class="keywordflow">if</span> ((*putc_cb)(<span class="charliteral">'&amp;'</span>, p) &lt; 0)
01291         <span class="keywordflow">return</span> (-1);
01292       <span class="keywordflow">if</span> ((*putc_cb)(<span class="charliteral">'a'</span>, p) &lt; 0)
01293         <span class="keywordflow">return</span> (-1);
01294       <span class="keywordflow">if</span> ((*putc_cb)(<span class="charliteral">'m'</span>, p) &lt; 0)
01295         <span class="keywordflow">return</span> (-1);
01296       <span class="keywordflow">if</span> ((*putc_cb)(<span class="charliteral">'p'</span>, p) &lt; 0)
01297         <span class="keywordflow">return</span> (-1);
01298       <span class="keywordflow">if</span> ((*putc_cb)(<span class="charliteral">';'</span>, p) &lt; 0)
01299         <span class="keywordflow">return</span> (-1);
01300     }
01301     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (*s == <span class="charliteral">'&lt;'</span>)
01302     {
01303       <span class="keywordflow">if</span> ((*putc_cb)(<span class="charliteral">'&amp;'</span>, p) &lt; 0)
01304         <span class="keywordflow">return</span> (-1);
01305       <span class="keywordflow">if</span> ((*putc_cb)(<span class="charliteral">'l'</span>, p) &lt; 0)
01306         <span class="keywordflow">return</span> (-1);
01307       <span class="keywordflow">if</span> ((*putc_cb)(<span class="charliteral">'t'</span>, p) &lt; 0)
01308         <span class="keywordflow">return</span> (-1);
01309       <span class="keywordflow">if</span> ((*putc_cb)(<span class="charliteral">';'</span>, p) &lt; 0)
01310         <span class="keywordflow">return</span> (-1);
01311     }
01312     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (*s == <span class="charliteral">'&gt;'</span>)
01313     {
01314       <span class="keywordflow">if</span> ((*putc_cb)(<span class="charliteral">'&amp;'</span>, p) &lt; 0)
01315         <span class="keywordflow">return</span> (-1);
01316       <span class="keywordflow">if</span> ((*putc_cb)(<span class="charliteral">'g'</span>, p) &lt; 0)
01317         <span class="keywordflow">return</span> (-1);
01318       <span class="keywordflow">if</span> ((*putc_cb)(<span class="charliteral">'t'</span>, p) &lt; 0)
01319         <span class="keywordflow">return</span> (-1);
01320       <span class="keywordflow">if</span> ((*putc_cb)(<span class="charliteral">';'</span>, p) &lt; 0)
01321         <span class="keywordflow">return</span> (-1);
01322     }
01323     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (*s == <span class="charliteral">'\"'</span>)
01324     {
01325       <span class="keywordflow">if</span> ((*putc_cb)(<span class="charliteral">'&amp;'</span>, p) &lt; 0)
01326         <span class="keywordflow">return</span> (-1);
01327       <span class="keywordflow">if</span> ((*putc_cb)(<span class="charliteral">'q'</span>, p) &lt; 0)
01328         <span class="keywordflow">return</span> (-1);
01329       <span class="keywordflow">if</span> ((*putc_cb)(<span class="charliteral">'u'</span>, p) &lt; 0)
01330         <span class="keywordflow">return</span> (-1);
01331       <span class="keywordflow">if</span> ((*putc_cb)(<span class="charliteral">'o'</span>, p) &lt; 0)
01332         <span class="keywordflow">return</span> (-1);
01333       <span class="keywordflow">if</span> ((*putc_cb)(<span class="charliteral">'t'</span>, p) &lt; 0)
01334         <span class="keywordflow">return</span> (-1);
01335       <span class="keywordflow">if</span> ((*putc_cb)(<span class="charliteral">';'</span>, p) &lt; 0)
01336         <span class="keywordflow">return</span> (-1);
01337     }
01338     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (*s &amp; 128)
01339     {
01340      <span class="comment">/*</span>
01341 <span class="comment">      * Convert UTF-8 to Unicode constant...</span>
01342 <span class="comment">      */</span>
01343 
01344       <span class="keywordtype">int</span>       ch;                     <span class="comment">/* Unicode character */</span>
01345 
01346 
01347       ch = *s &amp; 255;
01348 
01349       <span class="keywordflow">if</span> ((ch &amp; 0xe0) == 0xc0)
01350       {
01351         ch = ((ch &amp; 0x1f) &lt;&lt; 6) | (s[1] &amp; 0x3f);
01352         s ++;
01353       }
01354       <span class="keywordflow">else</span> <span class="keywordflow">if</span> ((ch &amp; 0xf0) == 0xe0)
01355       {
01356         ch = ((((ch * 0x0f) &lt;&lt; 6) | (s[1] &amp; 0x3f)) &lt;&lt; 6) | (s[2] &amp; 0x3f);
01357         s += 2;
01358       }
01359 
01360       <span class="keywordflow">if</span> (ch == 0xa0)
01361       {
01362        <span class="comment">/*</span>
01363 <span class="comment">        * Handle non-breaking space as-is...</span>
01364 <span class="comment">        */</span>
01365 
01366         <span class="keywordflow">if</span> ((*putc_cb)(<span class="charliteral">'&amp;'</span>, p) &lt; 0)
01367           <span class="keywordflow">return</span> (-1);
01368         <span class="keywordflow">if</span> ((*putc_cb)(<span class="charliteral">'n'</span>, p) &lt; 0)
01369           <span class="keywordflow">return</span> (-1);
01370         <span class="keywordflow">if</span> ((*putc_cb)(<span class="charliteral">'b'</span>, p) &lt; 0)
01371           <span class="keywordflow">return</span> (-1);
01372         <span class="keywordflow">if</span> ((*putc_cb)(<span class="charliteral">'s'</span>, p) &lt; 0)
01373           <span class="keywordflow">return</span> (-1);
01374         <span class="keywordflow">if</span> ((*putc_cb)(<span class="charliteral">'p'</span>, p) &lt; 0)
01375           <span class="keywordflow">return</span> (-1);
01376         <span class="keywordflow">if</span> ((*putc_cb)(<span class="charliteral">';'</span>, p) &lt; 0)
01377           <span class="keywordflow">return</span> (-1);
01378       }
01379       <span class="keywordflow">else</span>
01380       {
01381         sprintf(buf, <span class="stringliteral">"&amp;#x%x;"</span>, ch);
01382 
01383         <span class="keywordflow">for</span> (bufptr = buf; *bufptr; bufptr ++)
01384           <span class="keywordflow">if</span> ((*putc_cb)(*bufptr, p) &lt; 0)
01385             <span class="keywordflow">return</span> (-1);
01386       }
01387     }
01388     <span class="keywordflow">else</span> <span class="keywordflow">if</span> ((*putc_cb)(*s, p) &lt; 0)
01389       <span class="keywordflow">return</span> (-1);
01390 
01391     s ++;
01392   }
01393 
01394   <span class="keywordflow">return</span> (0);
01395 }
01396 
01397 
01398 <span class="comment">/*</span>
01399 <span class="comment"> * 'mxml_write_ws()' - Do whitespace callback...</span>
01400 <span class="comment"> */</span>
01401 
01402 <span class="keyword">static</span> <span class="keywordtype">int</span>                              <span class="comment">/* O - New column */</span>
<a name="l01403"></a><a class="code" href="mxml-file_8c.html#a9">01403</a> <a class="code" href="mxml-file_8c.html#a9">mxml_write_ws</a>(stp_mxml_node_t *node,    <span class="comment">/* I - Current node */</span>
01404               <span class="keywordtype">void</span>        *p,           <span class="comment">/* I - Write pointer */</span>
01405               <span class="keywordtype">int</span>         (*cb)(stp_mxml_node_t *, <span class="keywordtype">int</span>),
01406                                         <span class="comment">/* I - Callback function */</span>
01407               <span class="keywordtype">int</span>         ws,           <span class="comment">/* I - Where value */</span>
01408               <span class="keywordtype">int</span>         col,          <span class="comment">/* I - Current column */</span>
01409               <span class="keywordtype">int</span>         (*putc_cb)(<span class="keywordtype">int</span>, <span class="keywordtype">void</span> *))
01410                                         <span class="comment">/* I - Write callback */</span>
01411 {
01412   <span class="keywordtype">int</span>   ch;                             <span class="comment">/* Whitespace character */</span>
01413 
01414 
01415   <span class="keywordflow">if</span> (cb &amp;&amp; (ch = (*cb)(node, ws)) != 0)
01416   {
01417     <span class="keywordflow">if</span> ((*putc_cb)(ch, p) &lt; 0)
01418       <span class="keywordflow">return</span> (-1);
01419     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (ch == <span class="charliteral">'\n'</span>)
01420       col = 0;
01421     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (ch == <span class="charliteral">'\t'</span>)
01422     {
01423       col += <a class="code" href="mxml_8h.html#a1">STP_MXML_TAB</a>;
01424       col = col - (col % <a class="code" href="mxml_8h.html#a1">STP_MXML_TAB</a>);
01425     }
01426     <span class="keywordflow">else</span>
01427       col ++;
01428   }
01429 
01430   <span class="keywordflow">return</span> (col);
01431 }
01432 
01433 
01434 <span class="comment">/*</span>
01435 <span class="comment"> * End of "$Id: mxml-file_8c-source.html,v 1.1.1.2 2004/12/22 23:49:05 jlovell Exp $".</span>
01436 <span class="comment"> */</span>
</pre></div><hr size="1"><address style="align: right;"><small>Generated on Wed Aug 25 07:56:14 2004 for libgimpprint API Reference by
<a href="http://www.doxygen.org/index.html">
<img src="doxygen.png" alt="doxygen" align="middle" border=0 > </a>1.3.6 </small></address>
</body>
</html>
