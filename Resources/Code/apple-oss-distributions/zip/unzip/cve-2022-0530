diff --git a/fileio.c b/fileio.c
index 36bfea3..6143554 100644
--- a/fileio.c
+++ b/fileio.c
@@ -2347,6 +2347,9 @@ int do_string(__G__ length, option)   /* return PK-type error code */
                   /* convert UTF-8 to local character set */
                   fn = utf8_to_local_string(G.unipath_filename,
                                             G.unicode_escape_all);
+                  if (fn == NULL)
+                    return PK_MEM;
+
                   /* make sure filename is short enough */
                   if (strlen(fn) >= FILNAMSIZ) {
                     fn[FILNAMSIZ - 1] = '\0';
diff --git a/process.c b/process.c
index 82b138e..a7cf982 100644
--- a/process.c
+++ b/process.c
@@ -2587,9 +2587,12 @@ char *utf8_to_local_string(utf8_string, escape_all)
   ZCONST char *utf8_string;
   int escape_all;
 {
+  char *loc = NULL;
   zwchar *wide = utf8_to_wide_string(utf8_string);
-  char *loc = wide_to_local_string(wide, escape_all);
-  free(wide);
+  if (wide != NULL) {
+    loc = wide_to_local_string(wide, escape_all);
+    free(wide);
+  }
   return loc;
 }
 
