Return-Path: bluepeak.westend.com!popeye
Return-Path: <popeye@bluepeak.westend.com>
Received: from popeye.bluepeak.westend.com by bluepeak  with smtp
	(Smail3.2 #1) id m10xvTg-00027XC; Sat, 26 Jun 1999 18:38:52 +0200 (MEST)
Received: from genesis for a.kupries
 with Cubic Circle's cucipop (v1.10 1996/09/06) Sat Jun 26 18:35:55 1999
X-From_: Jan.Nijtmans@wxs.nl  Sat Jun 26 18:31:04 1999
Received: from mail.telekabel.nl (arnhem.telekabel.nl [194.134.132.130])
	by genesis.westend.com (8.8.6/8.8.6) with ESMTP id SAA18232
	for <a.kupries@westend.com>; Sat, 26 Jun 1999 18:31:01 +0200 (MET DST)
Received: from wxs.nl (n20109.telekabel.chello.nl [212.142.20.109])
	by mail.telekabel.nl (8.8.8/8.8/EuroNet) with ESMTP id SAA24430
	from <Jan.Nijtmans@wxs.nl> for <a.kupries@westend.com>; Sat, 26 Jun 1999 18:30:44 +0200 (MET DST)
Message-ID: <3775006D.29ECE269@wxs.nl>
Date: Sat, 26 Jun 1999 18:31:41 +0200
From: Jan Nijtmans <Jan.Nijtmans@wxs.nl>
Organization: C.M.G. Arnhem B.V.
X-Mailer: Mozilla 4.6 [en] (Win95; I)
X-Accept-Language: en
MIME-Version: 1.0
To: Andreas Kupries <a.kupries@westend.com>
Subject: "-nowrap" option for zip
References: <m10xcSW-000288C@bluepeak>
Content-Type: multipart/mixed;
 boundary="------------7195C7FAB56E9BB0000410D5"

This is a multi-part message in MIME format.
--------------7195C7FAB56E9BB0000410D5
Content-Type: text/plain; charset=us-ascii
Content-Transfer-Encoding: 7bit

I finally implemented the idea I already told you. The
option name is "-nowrap", because that's what it is named
in JAVA. The patch is attached to this email.

Normally the compressed stream is "wrapped" between
2 header-bytes (id) and 4 footer-bytes (crc). When using
"-nowrap", those bytes are stripped off the stream. They
are only used for error-checking and not for the actual
compression/decompression. Because the ZIP file format
has its own error-checking already, there is no need
to duplicate it in the stream.

Normally the inflateInit2 and deflateInit2 functions
have a parameter specifying MAX_WBITS. Making this
argument negative results in the "-nowrap" function.
This is an undocumented feature of the zlib library.

The patch implements two extra tests as well.

Good. Luck.
-- 
Jan Nijtmans, CMG Arnhem B.V.
email: Jan.Nijtmans@wxs.nl (private)
       Jan.Nijtmans@cmg.nl (work)
url:   http://home.wxs.nl/~nijtmans/
--------------7195C7FAB56E9BB0000410D5
Content-Type: application/x-unknown-content-type-diff_auto_file;
 name="trf.diff"
Content-Transfer-Encoding: base64
Content-Disposition: inline;
 filename="trf.diff"

KioqIGdlbmVyaWMvdHJhbnNmb3JtSW50Lmgub3JpZwlTYXQgSnVuIDI2IDE1OjI4OjUwIDE5
OTkKLS0tIGdlbmVyaWMvdHJhbnNmb3JtSW50LmgJU2F0IEp1biAyNiAxNTo1MjowNiAxOTk5
CioqKioqKioqKioqKioqKgoqKiogMjE0LDIxOSAqKioqCi0tLSAyMTQsMjIwIC0tLS0KICB0
eXBlZGVmIHN0cnVjdCBfVHJmWmlwT3B0aW9uQmxvY2sgewogICAgaW50IG1vZGU7ICAgLyog
Y29tcHJlc3NvciBtb2RlOiBjb21wcmVzcy9kZWNvbXByZXNzICovCiAgICBpbnQgbGV2ZWw7
ICAvKiBjb21wcmVzc2lvbiBsZXZlbCAoMS4uOSwgLTEgPSBkZWZhdWx0KSAqLworICAgaW50
IG5vd3JhcDsgIC8qIHBremlwLWNvbXBhdGliaWxpdHkgKDAuLjEsIDAgPSBkZWZhdWx0KSAq
LwogIH0gVHJmWmlwT3B0aW9uQmxvY2s7CiAgCiAgRVhURVJOIFRyZl9PcHRpb25WZWN0b3Jz
KgoqKioqKioqKioqKioqKioKKioqIDI0MiwyNTIgKioqKgogICAgVk9JRCAqaGFuZGxlOwog
ICAgaW50ICgqIGRlZmxhdGUpICAgICAgICAgICBfQU5TSV9BUkdTXyAoKHpfc3RyZWFtcCBz
dHJtLCBpbnQgZmx1c2gpKTsKICAgIGludCAoKiBkZWZsYXRlRW5kKSAgICAgICAgX0FOU0lf
QVJHU18gKCh6X3N0cmVhbXAgc3RybSkpOwohICAgaW50ICgqIGRlZmxhdGVJbml0XykgICAg
ICBfQU5TSV9BUkdTXyAoKHpfc3RyZWFtcCBzdHJtLCBpbnQgbGV2ZWwsIENPTlNUIGNoYXIg
KnZlcnNpb24sIGludCBzdHJlYW1fc2l6ZSkpOwogICAgaW50ICgqIGRlZmxhdGVSZXNldCkg
ICAgICBfQU5TSV9BUkdTXyAoKHpfc3RyZWFtcCBzdHJtKSk7CiAgICBpbnQgKCogaW5mbGF0
ZSkgICAgICAgICAgIF9BTlNJX0FSR1NfICgoel9zdHJlYW1wIHN0cm0sIGludCBmbHVzaCkp
OwogICAgaW50ICgqIGluZmxhdGVFbmQpICAgICAgICBfQU5TSV9BUkdTXyAoKHpfc3RyZWFt
cCBzdHJtKSk7CiEgICBpbnQgKCogaW5mbGF0ZUluaXRfKSAgICAgIF9BTlNJX0FSR1NfICgo
el9zdHJlYW1wIHN0cm0sIENPTlNUIGNoYXIgKnZlcnNpb24sIGludCBzdHJlYW1fc2l6ZSkp
OwogICAgaW50ICgqIGluZmxhdGVSZXNldCkgICAgICBfQU5TSV9BUkdTXyAoKHpfc3RyZWFt
cCBzdHJtKSk7CiAgICB1bnNpZ25lZCBsb25nICgqIGFkbGVyMzIpIF9BTlNJX0FSR1NfICgo
dW5zaWduZWQgbG9uZyBhZGxlciwgQ09OU1QgdW5zaWduZWQgY2hhciAqYnVmLCB1bnNpZ25l
ZCBpbnQgbGVuKSk7CiAgICB1bnNpZ25lZCBsb25nICgqIGNyYzMyKSAgIF9BTlNJX0FSR1Nf
ICgodW5zaWduZWQgbG9uZyBjcmMsIENPTlNUIHVuc2lnbmVkIGNoYXIgKmJ1ZiwgdW5zaWdu
ZWQgaW50IGxlbikpOwotLS0gMjQzLDI1MyAtLS0tCiAgICBWT0lEICpoYW5kbGU7CiAgICBp
bnQgKCogZGVmbGF0ZSkgICAgICAgICAgIF9BTlNJX0FSR1NfICgoel9zdHJlYW1wIHN0cm0s
IGludCBmbHVzaCkpOwogICAgaW50ICgqIGRlZmxhdGVFbmQpICAgICAgICBfQU5TSV9BUkdT
XyAoKHpfc3RyZWFtcCBzdHJtKSk7CiEgICBpbnQgKCogZGVmbGF0ZUluaXQyXykgICAgICBf
QU5TSV9BUkdTXyAoKHpfc3RyZWFtcCBzdHJtLCBpbnQgbGV2ZWwsIGludCAgbWV0aG9kLCBp
bnQgd2luZG93Qml0cywgaW50IG1lbUxldmVsLCBpbnQgc3RyYXRlZ3ksIENPTlNUIGNoYXIg
KnZlcnNpb24sIGludCBzdHJlYW1fc2l6ZSkpOwogICAgaW50ICgqIGRlZmxhdGVSZXNldCkg
ICAgICBfQU5TSV9BUkdTXyAoKHpfc3RyZWFtcCBzdHJtKSk7CiAgICBpbnQgKCogaW5mbGF0
ZSkgICAgICAgICAgIF9BTlNJX0FSR1NfICgoel9zdHJlYW1wIHN0cm0sIGludCBmbHVzaCkp
OwogICAgaW50ICgqIGluZmxhdGVFbmQpICAgICAgICBfQU5TSV9BUkdTXyAoKHpfc3RyZWFt
cCBzdHJtKSk7CiEgICBpbnQgKCogaW5mbGF0ZUluaXQyXykgICAgICBfQU5TSV9BUkdTXyAo
KHpfc3RyZWFtcCBzdHJtLCBpbnQgIHdpbmRvd0JpdHMsIENPTlNUIGNoYXIgKnZlcnNpb24s
IGludCBzdHJlYW1fc2l6ZSkpOwogICAgaW50ICgqIGluZmxhdGVSZXNldCkgICAgICBfQU5T
SV9BUkdTXyAoKHpfc3RyZWFtcCBzdHJtKSk7CiAgICB1bnNpZ25lZCBsb25nICgqIGFkbGVy
MzIpIF9BTlNJX0FSR1NfICgodW5zaWduZWQgbG9uZyBhZGxlciwgQ09OU1QgdW5zaWduZWQg
Y2hhciAqYnVmLCB1bnNpZ25lZCBpbnQgbGVuKSk7CiAgICB1bnNpZ25lZCBsb25nICgqIGNy
YzMyKSAgIF9BTlNJX0FSR1NfICgodW5zaWduZWQgbG9uZyBjcmMsIENPTlNUIHVuc2lnbmVk
IGNoYXIgKmJ1ZiwgdW5zaWduZWQgaW50IGxlbikpOwoqKiogZ2VuZXJpYy96aXAuYy5vcmln
CVNhdCBKdW4gMjYgMTU6MzY6MDIgMTk5OQotLS0gZ2VuZXJpYy96aXAuYwlTYXQgSnVuIDI2
IDE2OjA2OjE1IDE5OTkKKioqKioqKioqKioqKioqCioqKiAyMTcsMjIzICoqKioKICAgICAg
cmV0dXJuIChDbGllbnREYXRhKSBOVUxMOwogICAgfQogIAohICAgcmVzID0gei5kZWZsYXRl
SW5pdF8gKCZjLT5zdGF0ZSwgby0+bGV2ZWwsIFpMSUJfVkVSU0lPTiwgc2l6ZW9mKHpfc3Ry
ZWFtKSk7CiAgCiAgICBpZiAocmVzICE9IFpfT0spIHsKICAgICAgaWYgKGludGVycCkgewot
LS0gMjE3LDIyMyAtLS0tCiAgICAgIHJldHVybiAoQ2xpZW50RGF0YSkgTlVMTDsKICAgIH0K
ICAKISAgIHJlcyA9IHouZGVmbGF0ZUluaXQyXyAoJmMtPnN0YXRlLCBvLT5sZXZlbCwgWl9E
RUZMQVRFRCwgby0+bm93cmFwPy1NQVhfV0JJVFM6TUFYX1dCSVRTLCBNQVhfTUVNX0xFVkVM
LCBaX0RFRkFVTFRfU1RSQVRFR1ksIFpMSUJfVkVSU0lPTiwgc2l6ZW9mKHpfc3RyZWFtKSk7
CiAgCiAgICBpZiAocmVzICE9IFpfT0spIHsKICAgICAgaWYgKGludGVycCkgewoqKioqKioq
KioqKioqKioKKioqIDUyNiw1MzEgKioqKgotLS0gNTI2LDUzMiAtLS0tCiAgQ2xpZW50RGF0
YSAgICAgY2xpZW50RGF0YTsKICB7CiAgICBEZWNvZGVyQ29udHJvbCogICAgYzsKKyAgIFRy
ZlppcE9wdGlvbkJsb2NrKiBvID0gKFRyZlppcE9wdGlvbkJsb2NrKikgb3B0SW5mbzsKICAg
IGludCByZXM7CiAgCiAgICBjID0gKERlY29kZXJDb250cm9sKikgVGNsX0FsbG9jIChzaXpl
b2YgKERlY29kZXJDb250cm9sKSk7CioqKioqKioqKioqKioqKgoqKiogNTQ1LDU1MSAqKioq
CiAgICAgIHJldHVybiAoQ2xpZW50RGF0YSkgTlVMTDsKICAgIH0KICAKISAgIHJlcyA9IHou
aW5mbGF0ZUluaXRfICgmYy0+c3RhdGUsIFpMSUJfVkVSU0lPTiwgc2l6ZW9mICh6X3N0cmVh
bSkpOwogIAogICAgaWYgKHJlcyAhPSBaX09LKSB7CiAgICAgIGlmIChpbnRlcnApIHsKLS0t
IDU0Niw1NTIgLS0tLQogICAgICByZXR1cm4gKENsaWVudERhdGEpIE5VTEw7CiAgICB9CiAg
CiEgICByZXMgPSB6LmluZmxhdGVJbml0Ml8gKCZjLT5zdGF0ZSwgby0+bm93cmFwPy1NQVhf
V0JJVFM6TUFYX1dCSVRTLCBaTElCX1ZFUlNJT04sIHNpemVvZiAoel9zdHJlYW0pKTsKICAK
ICAgIGlmIChyZXMgIT0gWl9PSykgewogICAgICBpZiAoaW50ZXJwKSB7CioqKiBnZW5lcmlj
L3ppcF9vcHQuYy5vcmlnCVNhdCBKdW4gMjYgMTU6NTI6MzkgMTk5OQotLS0gZ2VuZXJpYy96
aXBfb3B0LmMJU2F0IEp1biAyNiAxNjowMToxNiAxOTk5CioqKioqKioqKioqKioqKgoqKiog
MTMyLDEzNyAqKioqCi0tLSAxMzIsMTM4IC0tLS0KICAKICAgIG8tPm1vZGUgID0gVFJGX1VO
S05PV05fTU9ERTsKICAgIG8tPmxldmVsID0gVFJGX0RFRkFVTFRfTEVWRUw7CisgICBvLT5u
b3dyYXAgPSAwOwogIAogICAgcmV0dXJuIChUcmZfT3B0aW9ucykgbzsKICB9CioqKioqKioq
KioqKioqKgoqKiogMjU0LDI1OSAqKioqCi0tLSAyNTUsMjYyIC0tLS0KICAgICAqIC1sZXZl
bCA8bnVtYmVyPgogICAgICogLWxldmVsIGRlZmF1bHQKICAgICAqIC1tb2RlIGNvbXByZXNz
fGRlY29tcHJlc3MKKyAgICAqIC1ub3dyYXAgPGJvb2xlYW4+CisgICAgKiAtbm93cmFwIGRl
ZmF1bHQKICAgICAqLwogIAogICAgVHJmWmlwT3B0aW9uQmxvY2sqIG8gPSAoVHJmWmlwT3B0
aW9uQmxvY2sqKSBvcHRpb25zOwoqKioqKioqKioqKioqKioKKioqIDMzNSwzNDAgKioqKgot
LS0gMzM4LDM3NSAtLS0tCiAgICAgICAgcmV0dXJuIFRDTF9FUlJPUjsKICAgICAgICBicmVh
azsKICAgICAgfSAvKiBzd2l0Y2ggb3B0dmFsdWUgKi8KKyAgICAgYnJlYWs7CisgCisgICBj
YXNlICduJzoKKyAgICAgaWYgKDAgIT0gc3RybmNtcCAob3B0bmFtZSwgIi1ub3dyYXAiLCBs
ZW4pKQorICAgICAgIGdvdG8gdW5rbm93bl9vcHRpb247CisgCisgI2lmIChUQ0xfTUFKT1Jf
VkVSU0lPTiA+PSA4KQorICAgICB2YWx1ZSA9IFRjbF9HZXRTdHJpbmdGcm9tT2JqICgoVGNs
X09iaiopIG9wdHZhbHVlLCBOVUxMKTsKKyAjZWxzZQorICAgICB2YWx1ZSA9IG9wdHZhbHVl
OworICNlbmRpZgorICAgICAKKyAgICAgbGVuID0gc3RybGVuICh2YWx1ZSk7CisgICAgIGlm
ICgwID09IHN0cm5jbXAgKHZhbHVlLCAiZGVmYXVsdCIsIGxlbikpIHsKKyAgICAgICBvLT5u
b3dyYXAgPSAwOworICAgICB9IGVsc2UgeworICAgICAgIGludCByZXMsIHZhbDsKKyAKKyAj
aWYgKFRDTF9NQUpPUl9WRVJTSU9OID49IDgpCisgICAgICAgaW50IHY7CisgICAgICAgcmVz
ID0gVGNsX0dldEJvb2xlYW5Gcm9tT2JqIChpbnRlcnAsIChUY2xfT2JqKikgb3B0dmFsdWUs
ICZ2KTsKKyAgICAgICB2YWwgPSB2OworICNlbHNlCisgICAgICAgcmVzID0gVGNsX0dldEJv
b2xlYW4gICAgICAgIChpbnRlcnAsIChjaGFyKikgb3B0dmFsdWUsICZ2YWwpOworICNlbmRp
ZgorIAorICAgICAgIGlmIChyZXMgIT0gVENMX09LKSB7CisgCXJldHVybiByZXM7CisgICAg
ICAgfQorIAorICAgICAgIG8tPm5vd3JhcCA9IHZhbDsKKyAgICAgfQogICAgICBicmVhazsK
ICAKICAgIGRlZmF1bHQ6CioqKiBnZW5lcmljL3psaWIuYy5vcmlnCVNhdCBKdW4gMjYgMTU6
MzY6MDcgMTk5OQotLS0gZ2VuZXJpYy96bGliLmMJU2F0IEp1biAyNiAxNTozNjo1MiAxOTk5
CioqKioqKioqKioqKioqKgoqKiogMjMsMzMgKioqKgogIHN0YXRpYyBjaGFyKiBzeW1ib2xz
IFtdID0gewogICAgImRlZmxhdGUiLAogICAgImRlZmxhdGVFbmQiLAohICAgImRlZmxhdGVJ
bml0XyIsCiAgICAiZGVmbGF0ZVJlc2V0IiwKICAgICJpbmZsYXRlIiwKICAgICJpbmZsYXRl
RW5kIiwKISAgICJpbmZsYXRlSW5pdF8iLAogICAgImluZmxhdGVSZXNldCIsCiAgICAiYWRs
ZXIzMiIsCiAgICAiY3JjMzIiLAotLS0gMjMsMzMgLS0tLQogIHN0YXRpYyBjaGFyKiBzeW1i
b2xzIFtdID0gewogICAgImRlZmxhdGUiLAogICAgImRlZmxhdGVFbmQiLAohICAgImRlZmxh
dGVJbml0Ml8iLAogICAgImRlZmxhdGVSZXNldCIsCiAgICAiaW5mbGF0ZSIsCiAgICAiaW5m
bGF0ZUVuZCIsCiEgICAiaW5mbGF0ZUluaXQyXyIsCiAgICAiaW5mbGF0ZVJlc2V0IiwKICAg
ICJhZGxlcjMyIiwKICAgICJjcmMzMiIsCioqKiB0ZXN0cy96aXAudGVzdC5vcmlnCVNhdCBK
dW4gMjYgMTY6MTA6MzkgMTk5OQotLS0gdGVzdHMvemlwLnRlc3QJU2F0IEp1biAyNiAxNjox
NjoyNSAxOTk5CioqKioqKioqKioqKioqKgoqKiogMTcsMjIgKioqKgotLS0gMTcsMjMgLS0t
LQogIAogIHNldCB0ZXh0ICAgICAgICAgICAgICAgICAgICJoZWxsbywgaGVsbG8hIgogIHNl
dCB0ZXh0X2NvbXByZXNzZWRfYXNfaGV4ICI3ODlDQ0I0OENEQzlDOUQ3NTFDODAwNTE4QTAw
MjE3MDA0OTYiCisgc2V0IHRleHRfY29tcHJlc3NlZF9hc19oZXhfd2l0aF9ub3dyYXAgIkNC
NDhDREM5QzlENzUxQzgwMDUxOEEwMCIKICAKICAKICAjIGRpZmZlcmVudGlhdGUgdGNsIHZl
cnNpb25zCioqKioqKioqKioqKioqKgoqKiogNjUsNjkgKioqKgotLS0gNjYsNzcgLS0tLQog
IAogICAgICB0ZXN0IHppcC0xLjEtOC54IHt6aXAgZGVjb21wcmVzc2lvbn0gewogIAl6aXAg
LW1vZGUgZGVjb21wcmVzcyBbaGV4IC1tb2RlIGRlY29kZSAkdGV4dF9jb21wcmVzc2VkX2Fz
X2hleF0KKyAgICAgfSAkdGV4dAk7ICN7fQorICAgICB0ZXN0IHppcC0xLjItOC54IHt6aXAg
Y29tcHJlc3Npb24gd2l0aCBub3dyYXB9IHsKKyAJaGV4IC1tb2RlIGVuY29kZSBbemlwIC1t
b2RlIGNvbXByZXNzIC1ub3dyYXAgdHJ1ZSAkdGV4dF0KKyAgICAgfSAkdGV4dF9jb21wcmVz
c2VkX2FzX2hleF93aXRoX25vd3JhcAk7ICN7fQorIAorICAgICB0ZXN0IHppcC0xLjMtOC54
IHt6aXAgZGVjb21wcmVzc2lvbiB3aXRoIG5vd3JhcH0geworIAl6aXAgLW1vZGUgZGVjb21w
cmVzcyAtbm93cmFwIHRydWUgW2hleCAtbW9kZSBkZWNvZGUgJHRleHRfY29tcHJlc3NlZF9h
c19oZXhfd2l0aF9ub3dyYXBdCiAgICAgIH0gJHRleHQJOyAje30KICB9Cg==
--------------7195C7FAB56E9BB0000410D5--
